<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Security Ninja Ltd | XDR Compliance Centre</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>
<style>
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f7fafd;
  --bg-card: #ffffff;
  --bg-card-hover: #f3f8fd;
  --bg-elevated: #eaf3fb;
  --border: #c8d9ea;
  --border-subtle: #dce8f3;
  --text-primary: #13263c;
  --text-secondary: #42617f;
  --text-muted: #6683a1;
  --accent-ninja: #1e3a5a;
  --accent-ninja-dim: rgba(30,58,90,0.12);
  --accent-ninja-glow: rgba(30,58,90,0.25);
  --cell-grad-main: linear-gradient(135deg, #0B1726 0%, #12263C 60%, #1E3A5A 100%);
  --cell-grad-sub: linear-gradient(135deg, #edf5fc 0%, #e1edf8 100%);
  --cell-grad-sub-hover: linear-gradient(135deg, #e5f0fb 0%, #d7e7f6 100%);
  --severity-critical: #ff3b5c;
  --severity-high: #ff7b42;
  --severity-medium: #ffb830;
  --severity-low: #4dc9f6;
  --severity-info: #7c8db0;
  --status-compliant: #00e5a0;
  --status-warning: #ffb830;
  --status-noncompliant: #ff3b5c;
  --chart-1: #00e5a0;
  --chart-2: #4dc9f6;
  --chart-3: #a78bfa;
  --chart-4: #ff7b42;
  --chart-5: #ff3b5c;
  --radius: 10px;
  --radius-sm: 6px;
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  overflow-x: hidden;
  min-height: 100vh;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #edf4fb; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

/* ===== TOP NAV ===== */
.topnav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: 90px;
  background: var(--cell-grad-main);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid #21486d;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px;
}

.topnav-brand {
  display: flex; align-items: center; gap: 12px;
  font-weight: 700; font-size: 15px; letter-spacing: -0.3px;
}

.topnav-logo {
  width: 180px;
  height: 180px;
  object-fit: contain;
  display: block;
}

.topnav-brand span.ninja-text {
  background: linear-gradient(135deg, #ffffff 0%, #cfe6fb 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.topnav-center {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(189, 213, 234, 0.35);
  border-radius: 8px; padding: 4px;
}

.topnav-tab {
  padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500;
  color: #c6daee; cursor: pointer; transition: var(--transition);
  border: none; background: none; font-family: inherit;
}

.topnav-tab:hover { color: #ffffff; }
.topnav-tab.active {
  background: rgba(255,255,255,0.16);
  color: #ffffff;
}

.topnav-right {
  display: flex; align-items: center; gap: 16px;
}

.topnav-status {
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; color: #c6daee;
  font-family: 'JetBrains Mono', monospace;
}

.status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--accent-ninja);
  box-shadow: 0 0 8px var(--accent-ninja-glow);
  animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.btn-connect {
  padding: 7px 16px; border-radius: 6px; font-size: 12px; font-weight: 600;
  font-family: inherit; cursor: pointer; transition: var(--transition);
  border: 1px solid #c0d7ee;
  background: rgba(255,255,255,0.14);
  color: #ffffff;
}

.btn-connect:hover {
  background: rgba(255,255,255,0.24);
}

/* ===== MAIN LAYOUT ===== */
.main-content {
  margin-top: 90px;
  padding: 20px 24px 40px;
}

/* ===== EXECUTIVE SUMMARY STRIP ===== */
.exec-strip {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  margin-bottom: 20px;
}

.exec-card {
  background: var(--cell-grad-main);
  border: 1px solid #21486d;
  border-radius: var(--radius);
  padding: 16px 18px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
  cursor: pointer;
}

.exec-card:hover {
  border-color: #2d5a84;
  background: linear-gradient(135deg, #0f2135 0%, #17304b 60%, #284f77 100%);
  transform: translateY(-1px);
}

.exec-card::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0; height: 2px;
}

.exec-card.critical::before { background: var(--severity-critical); }
.exec-card.warning::before { background: var(--severity-high); }
.exec-card.good::before { background: var(--status-compliant); }
.exec-card.info::before { background: var(--chart-2); }
.exec-card.neutral::before { background: var(--chart-3); }
.exec-card.mixed::before { background: var(--severity-medium); }

.exec-label {
  font-size: 11px; font-weight: 500; color: #c9dbee;
  text-transform: uppercase; letter-spacing: 0.8px;
  margin-bottom: 8px;
}

.exec-value {
  font-size: 28px; font-weight: 800; letter-spacing: -1px;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1;
}

.exec-value.critical { color: var(--severity-critical); }
.exec-value.warning { color: var(--severity-high); }
.exec-value.good { color: var(--status-compliant); }
.exec-value.info { color: var(--chart-2); }
.exec-value.neutral { color: var(--chart-3); }
.exec-value.mixed { color: var(--severity-medium); }

.exec-sub {
  font-size: 11px; color: #c0d4e8;
  margin-top: 6px; display: flex; align-items: center; gap: 4px;
}

.exec-sub .trend-up { color: var(--severity-critical); }
.exec-sub .trend-down { color: var(--status-compliant); }

/* ===== GRID LAYOUT ===== */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  grid-template-rows: auto auto auto;
  gap: 16px;
}

/* ===== CARD COMPONENT ===== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  transition: var(--transition);
}

.card:hover {
  border-color: var(--border);
}

.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid #21486d;
  background: var(--cell-grad-main);
  display: flex; align-items: center; justify-content: space-between;
}

.card-title {
  font-size: 13px; font-weight: 600; letter-spacing: -0.2px;
  display: flex; align-items: center; gap: 8px;
  color: #e9f3fc;
}

.card-title .icon {
  width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
  color: #8fc0ef;
}

.card-actions {
  display: flex; align-items: center; gap: 6px;
}

.card-action-btn {
  padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 500;
  color: #c9def1; background: rgba(255,255,255,0.08); border: 1px solid rgba(189,213,234,0.32);
  cursor: pointer; transition: var(--transition); font-family: inherit;
}

.card-action-btn:hover { color: #ffffff; border-color: #b9d4ee; }
.card-action-btn.active { color: #ffffff; border-color: #b9d4ee; background: rgba(255,255,255,0.2); }

.card-body { padding: 16px 18px; }

/* ===== VULNERABILITY SEVERITY HEATMAP ===== */
.vuln-severity-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.severity-cell {
  background: linear-gradient(145deg, #15314d 0%, #214768 100%);
  border: 1px solid #2e5b84;
  border-radius: var(--radius-sm);
  padding: 14px 12px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.severity-cell:hover { transform: scale(1.03); }

.severity-cell::after {
  content: '';
  position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
}

.severity-cell.crit::after { background: var(--severity-critical); }
.severity-cell.high::after { background: var(--severity-high); }
.severity-cell.med::after { background: var(--severity-medium); }
.severity-cell.low::after { background: var(--severity-low); }

.severity-cell .sev-count {
  font-size: 24px; font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1;
  color: #ffffff;
}

.severity-cell .sev-label {
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: #c8dcf0;
  margin-top: 6px;
}

/* ===== VULNERABILITY LIST ===== */
.vuln-list { max-height: 340px; overflow-y: auto; }

.vuln-item {
  padding: 10px 0;
  border-bottom: 1px solid #e3edf6;
  display: flex; align-items: center; gap: 12px;
  cursor: pointer; transition: var(--transition);
}

.vuln-item:hover { padding-left: 4px; background: #f5f9fd; }
.vuln-item:last-child { border-bottom: none; }

.vuln-sev-badge {
  width: 6px; min-height: 32px; border-radius: 3px; flex-shrink: 0;
}

.vuln-sev-badge.critical { background: var(--severity-critical); }
.vuln-sev-badge.high { background: var(--severity-high); }
.vuln-sev-badge.medium { background: var(--severity-medium); }
.vuln-sev-badge.low { background: var(--severity-low); }

.vuln-info { flex: 1; min-width: 0; }

.vuln-cve {
  font-size: 12px; font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-primary);
}

.vuln-desc {
  font-size: 11px; color: var(--text-secondary);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-top: 2px;
}

.vuln-meta {
  display: flex; align-items: center; gap: 12px; flex-shrink: 0;
}

.vuln-devices {
  font-size: 11px; color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}

.vuln-cvss {
  font-size: 11px; font-weight: 700; padding: 2px 8px;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
}

.vuln-cvss.critical { background: rgba(255,59,92,0.15); color: var(--severity-critical); }
.vuln-cvss.high { background: rgba(255,123,66,0.15); color: var(--severity-high); }
.vuln-cvss.medium { background: rgba(255,184,48,0.15); color: var(--severity-medium); }
.vuln-cvss.low { background: rgba(77,201,246,0.15); color: var(--severity-low); }

/* ===== UNLICENSED THREAT RELEVANCE ===== */
.threat-list { display: grid; gap: 8px; max-height: 300px; overflow-y: auto; }
.threat-item {
  padding: 10px 12px;
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}
.threat-item:hover { border-color: var(--border); transform: translateY(-1px); }
.threat-head { display: flex; justify-content: space-between; gap: 8px; align-items: center; margin-bottom: 5px; }
.threat-cve { font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--text-primary); }
.threat-score {
  font-size: 10px; font-family: 'JetBrains Mono', monospace; font-weight: 700;
  padding: 3px 8px; border-radius: 999px;
}
.threat-score.critical { color: #8F1D1D; background: #FEE2E2; border: 1px solid #FCA5A5; }
.threat-score.high { color: #8A4B00; background: #FFEDD5; border: 1px solid #FDBA74; }
.threat-score.medium { color: #0B4F6C; background: #E0F2FE; border: 1px solid #93C5FD; }
.threat-meta { font-size: 11px; color: var(--text-secondary); line-height: 1.45; }

.remediation-list { display: grid; gap: 8px; max-height: 320px; overflow-y: auto; }
.remediation-item {
  padding: 10px 12px;
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: var(--transition);
}
.remediation-item:hover { border-color: var(--border); transform: translateY(-1px); }
.remediation-head { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 5px; }
.remediation-title { font-size: 12px; font-weight: 700; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
.prio-tag {
  font-size: 10px; font-family: 'JetBrains Mono', monospace; font-weight: 700;
  padding: 3px 8px; border-radius: 999px;
}
.prio-tag.p1 { color: #7F1D1D; background: #FECACA; border: 1px solid #F87171; }
.prio-tag.p2 { color: #854D0E; background: #FDE68A; border: 1px solid #F59E0B; }
.prio-tag.p3 { color: #14532D; background: #BBF7D0; border: 1px solid #4ADE80; }
.remediation-meta { font-size: 11px; color: var(--text-secondary); line-height: 1.45; }
.remediation-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 6px; }
.remediation-pill {
  font-size: 9px; font-family: 'JetBrains Mono', monospace; font-weight: 600;
  border: 1px solid var(--border-subtle); border-radius: 999px; padding: 2px 7px; color: var(--text-muted);
  background: #f3f8fd;
}
.remediation-pill.critical { color: #7F1D1D; background: #FECACA; border-color: #F87171; }
.remediation-pill.high { color: #854D0E; background: #FDE68A; border-color: #F59E0B; }
.remediation-pill.medium { color: #0B4F6C; background: #E0F2FE; border-color: #93C5FD; }
.remediation-pill.low { color: #14532D; background: #BBF7D0; border-color: #4ADE80; }

.defender-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 10px;
}
.defender-cell {
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  border-radius: var(--radius-sm);
  padding: 10px 12px;
}
.defender-cell .k { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.7px; margin-bottom: 5px; }
.defender-cell .v { font-size: 22px; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
.defender-cell .s { font-size: 11px; color: var(--text-secondary); margin-top: 4px; line-height: 1.4; }
.defender-list { margin-top: 10px; display: grid; gap: 6px; }
.defender-row {
  padding: 8px 10px; border: 1px solid var(--border-subtle); border-radius: 6px; background: #f4f9ff;
  font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between; gap: 8px;
}

.mitre-wrap { display: grid; gap: 12px; }
.mitre-tactic-list { display: grid; gap: 8px; }
.mitre-tactic-row {
  border: 1px solid var(--border-subtle); border-radius: 8px; background: #f6faff; padding: 8px 10px;
  cursor: pointer;
  transition: var(--transition);
}
.mitre-tactic-row:hover { border-color: var(--border); transform: translateY(-1px); background: #eef6ff; }
.mitre-top { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 6px; }
.mitre-name { font-size: 12px; font-weight: 700; color: var(--text-primary); }
.mitre-gap { font-size: 10px; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); }
.mitre-bar { height: 8px; border-radius: 999px; background: #deebf7; overflow: hidden; }
.mitre-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #1e3a5a 0%, #2f6fa8 100%); }
.mitre-heatmap {
  display: grid;
  grid-template-columns: repeat(6, minmax(0, 1fr));
  gap: 6px;
}
.mitre-cell {
  border-radius: 6px;
  padding: 8px 6px;
  text-align: center;
  font-size: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}
.mitre-cell:hover { transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(30,58,90,0.15) inset; }
.hidden { display: none !important; }

.policy-gap-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px;
  margin-bottom: 12px;
}

.policy-gap-cell {
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  border-radius: 8px;
  padding: 10px 12px;
}

.policy-gap-cell .k {
  font-size: 10px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.7px;
  margin-bottom: 5px;
}

.policy-gap-cell .v {
  font-size: 24px;
  font-weight: 800;
  font-family: 'JetBrains Mono', monospace;
  color: var(--text-primary);
}

.policy-gap-cell .s {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}

.policy-gap-list,
.policy-mitre-list {
  display: grid;
  gap: 8px;
}

.policy-filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
}

.policy-gap-item,
.policy-mitre-item {
  border: 1px solid var(--border-subtle);
  background: var(--bg-elevated);
  border-radius: 8px;
  padding: 10px 12px;
}

.policy-gap-head,
.policy-mitre-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.policy-gap-title,
.policy-mitre-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-primary);
}

.policy-gap-meta,
.policy-mitre-meta {
  font-size: 11px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.policy-pill {
  font-size: 9px;
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  border-radius: 999px;
  padding: 2px 7px;
  border: 1px solid var(--border-subtle);
}

.policy-pill.critical { color: #7F1D1D; background: #FECACA; border-color: #F87171; }
.policy-pill.high { color: #854D0E; background: #FDE68A; border-color: #F59E0B; }
.policy-pill.medium { color: #0B4F6C; background: #E0F2FE; border-color: #93C5FD; }
.policy-pill.low { color: #14532D; background: #BBF7D0; border-color: #4ADE80; }

/* ===== DEVICE TABLE ===== */
.device-table-wrap { max-height: 380px; overflow-y: auto; }

.device-table {
  width: 100%; border-collapse: collapse; font-size: 12px;
}

.device-table thead { position: sticky; top: 0; z-index: 2; }

.device-table th {
  padding: 8px 12px; text-align: left;
  font-size: 10px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text-muted);
  background: #f3f8fd;
  border-bottom: 1px solid var(--border-subtle);
}

.device-table td {
  padding: 10px 12px; border-bottom: 1px solid #e3edf6;
  color: var(--text-secondary);
}

.device-table tr { transition: var(--transition); cursor: pointer; }
.device-table tbody tr:hover { background: #eef5fc; }

.device-name {
  font-weight: 600; color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
}

.device-type-badge {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;
  background: #eaf3fb; color: #2f5578;
}

.health-indicator {
  display: inline-flex; align-items: center; gap: 5px; font-size: 11px;
}

.health-dot {
  width: 6px; height: 6px; border-radius: 50%;
}

.health-dot.healthy { background: var(--status-compliant); box-shadow: 0 0 6px rgba(0,229,160,0.4); }
.health-dot.warning { background: var(--status-warning); box-shadow: 0 0 6px rgba(255,184,48,0.4); }
.health-dot.critical { background: var(--status-noncompliant); box-shadow: 0 0 6px rgba(255,59,92,0.4); }

.version-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 10px;
  padding: 2px 6px; border-radius: 3px;
}

.version-badge.current { background: rgba(0,229,160,0.12); color: var(--status-compliant); }
.version-badge.outdated { background: rgba(255,184,48,0.12); color: var(--status-warning); }
.version-badge.critical { background: rgba(255,59,92,0.12); color: var(--status-noncompliant); }

/* ===== CA POLICY COVERAGE ===== */
.ca-policy-list { max-height: 340px; overflow-y: auto; }

.ca-item {
  padding: 12px 14px;
  background: var(--cell-grad-sub);
  border: 1px solid #d8e7f5;
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  cursor: pointer;
  transition: var(--transition);
  border-left: 3px solid transparent;
}

.ca-item:hover { border-left-color: var(--accent-ninja); background: var(--cell-grad-sub-hover); }

.ca-item-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 6px;
}

.ca-item-name {
  font-size: 12px; font-weight: 600; color: var(--text-primary);
}

.ca-status-badge {
  padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
}

.ca-status-badge.enabled { background: rgba(0,229,160,0.12); color: var(--status-compliant); }
.ca-status-badge.report-only { background: rgba(255,184,48,0.12); color: var(--status-warning); }
.ca-status-badge.disabled { background: rgba(255,59,92,0.12); color: var(--status-noncompliant); }

.ca-detail-row {
  display: flex; gap: 16px; font-size: 11px; color: var(--text-muted);
}

.ca-detail-row span { display: flex; align-items: center; gap: 4px; }

.ca-coverage-bar {
  margin-top: 8px; height: 4px; background: #d6e5f3;
  border-radius: 2px; overflow: hidden;
}

.ca-coverage-fill {
  height: 100%; border-radius: 2px; transition: width 0.8s ease;
}

.ca-coverage-fill.high { background: var(--status-compliant); }
.ca-coverage-fill.medium { background: var(--status-warning); }
.ca-coverage-fill.low { background: var(--status-noncompliant); }

/* ===== RISK MATRIX ===== */
.risk-matrix {
  display: grid;
  grid-template-columns: 40px repeat(5, 1fr);
  grid-template-rows: repeat(5, 1fr) 30px;
  gap: 4px;
  aspect-ratio: 1.2;
}

.risk-matrix.compact {
  grid-template-columns: 22px repeat(5, minmax(0, 1fr));
  grid-template-rows: repeat(5, 22px) 16px;
  gap: 2px;
  aspect-ratio: auto;
}

.risk-cell {
  border-radius: 4px; display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; cursor: pointer;
  transition: var(--transition); position: relative;
  font-family: 'JetBrains Mono', monospace;
}

.risk-cell:hover { transform: scale(1.08); z-index: 2; }

.risk-cell.r5 { background: rgba(255,59,92,0.78); color: #fff; }
.risk-cell.r4 { background: rgba(255,123,66,0.72); color: #fff; }
.risk-cell.r3 { background: rgba(255,184,48,0.72); color: #fff; }
.risk-cell.r2 { background: rgba(77,201,246,0.62); color: #0f2437; }
.risk-cell.r1 { background: rgba(0,229,160,0.55); color: #0f2437; }

.risk-label {
  font-size: 9px; color: var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  text-transform: uppercase; letter-spacing: 0.5px;
  writing-mode: vertical-rl; transform: rotate(180deg);
}

.risk-label-x {
  font-size: 9px; color: var(--text-muted);
  display: flex; align-items: center; justify-content: center;
  text-transform: uppercase; letter-spacing: 0.5px;
}

.risk-matrix.compact .risk-cell {
  font-size: 0;
  border-radius: 3px;
}

.risk-matrix.compact .risk-cell.has-count::after {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,0.9);
}

.risk-matrix.compact .risk-label,
.risk-matrix.compact .risk-label-x {
  font-size: 8px;
  letter-spacing: 0.2px;
}

/* ===== EXPOSURE TREND CHART ===== */
.trend-chart-area {
  position: relative;
  height: 180px;
  margin-top: 8px;
}

.trend-chart-svg { width: 100%; height: 100%; }

/* ===== LOCATION MAP (Simplified) ===== */
.location-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.location-item {
  background: var(--cell-grad-sub);
  border: 1px solid #d8e7f5;
  border-radius: var(--radius-sm);
  padding: 12px;
  display: flex; align-items: center; justify-content: space-between;
  cursor: pointer; transition: var(--transition);
}

.location-item:hover { background: var(--cell-grad-sub-hover); }

.location-info { display: flex; align-items: center; gap: 10px; }

.location-flag { font-size: 20px; }

.location-name { font-size: 12px; font-weight: 600; }
.location-count { font-size: 11px; color: var(--text-muted); }

.location-health {
  display: flex; flex-direction: column; align-items: flex-end; gap: 3px;
}

.location-bar {
  display: flex; gap: 2px;
}

.loc-bar-seg {
  width: 4px; height: 18px; border-radius: 2px;
}

/* ===== SOFTWARE / APP INVENTORY ===== */
.app-grid {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 8px; max-height: 340px; overflow-y: auto;
}

.app-item {
  background: var(--cell-grad-sub);
  border: 1px solid #d8e7f5;
  border-radius: var(--radius-sm);
  padding: 12px;
  cursor: pointer; transition: var(--transition);
}

.app-item:hover { background: var(--cell-grad-sub-hover); }

.app-name { font-size: 12px; font-weight: 600; color: var(--text-primary); }
.app-vendor { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

.app-stats {
  display: flex; gap: 12px; margin-top: 8px;
}

.app-stat {
  font-size: 10px; color: var(--text-secondary);
  display: flex; align-items: center; gap: 4px;
}

.app-stat .num {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
}

/* ===== DETAIL PANEL (Drill-down Flyout) ===== */
.detail-overlay {
  position: fixed; inset: 0; background: rgba(11,23,38,0.35);
  z-index: 200; display: none; align-items: stretch; justify-content: flex-end;
  animation: fadeIn 0.2s ease;
}

.detail-overlay.visible { display: flex; }

.detail-panel {
  width: 520px; max-width: 90vw;
  background: #ffffff;
  border-left: 1px solid var(--border);
  overflow-y: auto;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.detail-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; background: #f8fbff; z-index: 3;
}

.detail-title { font-size: 16px; font-weight: 700; }

.detail-close {
  width: 32px; height: 32px; border-radius: 6px;
  background: #edf5fc; border: 1px solid var(--border-subtle);
  color: var(--text-muted); cursor: pointer; transition: var(--transition);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; font-family: inherit;
}

.detail-close:hover { color: var(--text-primary); border-color: var(--border); }

.detail-body { padding: 20px 24px; }

.detail-section {
  margin-bottom: 20px;
}

.detail-section-title {
  font-size: 11px; font-weight: 600; text-transform: uppercase;
  letter-spacing: 0.8px; color: var(--text-muted);
  margin-bottom: 10px; padding-bottom: 6px;
  border-bottom: 1px solid var(--border-subtle);
}

.detail-row {
  display: flex; justify-content: space-between; padding: 6px 0;
  font-size: 12px;
}

.detail-row .label { color: var(--text-muted); }
.detail-row .value { color: var(--text-primary); font-weight: 500; }

.detail-tag-list {
  display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
}

.detail-tag {
  padding: 3px 10px; border-radius: 4px; font-size: 10px; font-weight: 500;
  background: #eaf3fb; color: var(--text-secondary);
  border: 1px solid var(--border-subtle);
}

/* ===== SPAN CARDS ===== */
.span-2 { grid-column: span 2; }
.span-3 { grid-column: span 3; }
.os-card { grid-column: 2; }
.view-hidden { display: none !important; }

body[data-active-view="threat"] .dashboard-grid {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}
body[data-active-view="threat"] .threat-relevance-card,
body[data-active-view="threat"] .remediation-card {
  grid-column: span 1 !important;
}
body[data-active-view="threat"] .mitre-card {
  grid-column: span 2 !important;
}
body[data-active-view="vulnerabilities"] .dashboard-grid {
  grid-template-columns: 1.35fr 1fr;
  grid-auto-rows: auto;
  align-items: start;
}
body[data-active-view="vulnerabilities"] .vuln-main-card {
  grid-column: 1;
  grid-row: 1 / span 2;
  display: flex;
  flex-direction: column;
}
body[data-active-view="vulnerabilities"] .vuln-main-card .card-body {
  display: flex;
  flex-direction: column;
  min-height: 0;
}
body[data-active-view="vulnerabilities"] .vuln-main-card .vuln-list-wrap {
  margin-top: 14px;
  flex: 1;
  min-height: 0;
}
body[data-active-view="vulnerabilities"] .vuln-main-card .vuln-list {
  max-height: 100%;
}
body[data-active-view="vulnerabilities"] .remediation-card {
  grid-column: 2 !important;
  grid-row: 1;
}
body[data-active-view="vulnerabilities"] .risk-matrix-card {
  grid-column: 2;
  grid-row: 2;
}
body[data-active-view="vulnerabilities"] .risk-matrix-card .card-body {
  padding: 10px 12px;
}
body[data-active-view="vulnerabilities"] .software-card {
  grid-column: 1 / span 2 !important;
  grid-row: 3;
}
body[data-active-view="devices"] .dashboard-grid {
  grid-template-columns: 1.35fr 1fr;
  grid-auto-rows: auto;
  align-items: start;
}
body[data-active-view="devices"] .device-inventory-card {
  grid-column: 1;
  grid-row: 1 / span 2;
}
body[data-active-view="devices"] .device-type-card {
  grid-column: 2;
  grid-row: 1;
}
body[data-active-view="devices"] .os-card {
  grid-column: 2;
  grid-row: 2;
}
body[data-active-view="devices"] .location-card {
  grid-column: 1 / span 2;
  grid-row: 3;
}
body[data-active-view="policies"] .dashboard-grid {
  grid-template-columns: 1.3fr 1fr;
  grid-auto-rows: auto;
}
body[data-active-view="policies"] .ca-policy-card {
  grid-column: 1;
  grid-row: 1 / span 2;
}
body[data-active-view="policies"] .policy-gaps-card {
  grid-column: 2;
  grid-row: 1;
}
body[data-active-view="policies"] .policy-mitre-card {
  grid-column: 2;
  grid-row: 2;
}
body[data-active-view="policies"] .ca-policy-card .ca-policy-list {
  max-height: none;
}

@media (min-width: 1201px) {
  :root { --vuln-stack-height: 720px; }
  .dashboard-grid.overview-layout {
    grid-template-rows: repeat(2, calc((var(--vuln-stack-height) - 16px) / 2)) auto auto;
    grid-auto-rows: auto;
  }
  .dashboard-grid.overview-layout .vuln-main-card {
    grid-column: 1;
    grid-row: 1 / span 2;
    height: auto;
    display: flex;
    flex-direction: column;
  }
  .dashboard-grid.overview-layout .device-type-card {
    grid-column: 2;
    grid-row: 1;
  }
  .dashboard-grid.overview-layout .os-card {
    grid-column: 2;
    grid-row: 2;
  }
  .dashboard-grid.overview-layout .risk-matrix-card {
    grid-column: 3;
    grid-row: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  .dashboard-grid.overview-layout .exposure-card {
    grid-column: 3;
    grid-row: 2;
  }
  .dashboard-grid.overview-layout .software-card {
    grid-column: 1 / span 2;
    grid-row: 3;
  }
  .dashboard-grid.overview-layout .ca-policy-card {
    grid-column: 3;
    grid-row: 3;
  }
  .dashboard-grid.overview-layout .location-card {
    grid-column: 1 / span 3;
    grid-row: 4;
  }
  .dashboard-grid.overview-layout .vuln-main-card .card-body {
    display: flex;
    flex-direction: column;
    min-height: 0;
  }
  .dashboard-grid.overview-layout .vuln-main-card .vuln-list-wrap {
    margin-top: 16px;
    flex: 1;
    min-height: 0;
  }
  .dashboard-grid.overview-layout .vuln-main-card .vuln-list {
    max-height: none;
    height: 100%;
  }
  .dashboard-grid.overview-layout .device-type-card,
  .dashboard-grid.overview-layout .os-card {
    height: 100%;
  }
  .dashboard-grid.overview-layout .device-type-card .card-body,
  .dashboard-grid.overview-layout .os-card .card-body {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    overflow-y: auto;
  }
  .dashboard-grid.overview-layout .risk-matrix-card .card-body {
    flex: 1;
    min-height: 0;
    display: flex;
  }
  .dashboard-grid.overview-layout .risk-matrix-card .risk-matrix {
    width: 100%;
    height: 100%;
    aspect-ratio: auto;
  }
  .dashboard-grid.overview-layout .location-card .card-body {
    max-height: none;
  }
}

/* ===== CHART BARS ===== */
.bar-chart { display: flex; flex-direction: column; gap: 8px; }

.bar-row {
  display: flex; align-items: center; gap: 10px;
}
.bar-row.interactive { cursor: pointer; }
.bar-row.interactive .bar-track { transition: var(--transition); }
.bar-row.interactive:hover .bar-track {
  box-shadow: 0 0 0 2px rgba(30,58,90,0.14) inset;
}
.bar-row.interactive:focus-within .bar-track {
  box-shadow: 0 0 0 2px rgba(30,58,90,0.22) inset;
}

.bar-label {
  width: 100px; font-size: 11px; color: var(--text-secondary);
  text-align: right; flex-shrink: 0;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

.bar-track {
  flex: 1; height: 22px; background: #e3edf7;
  border-radius: 4px; overflow: hidden; position: relative;
}

.bar-fill {
  height: 100%; border-radius: 4px;
  display: flex; align-items: center; justify-content: flex-end;
  padding-right: 8px; font-size: 10px; font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
  color: rgba(255,255,255,0.9);
  transition: width 0.8s ease;
}

/* ===== PIE/DONUT CHART ===== */
.donut-container {
  display: flex; align-items: center; gap: 20px;
}

.donut-svg { width: 120px; height: 120px; flex-shrink: 0; }

.donut-legend { display: flex; flex-direction: column; gap: 6px; }

.legend-item {
  display: flex; align-items: center; gap: 8px; font-size: 11px;
}

.legend-color {
  width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0;
}

.legend-label { color: var(--text-secondary); }
.legend-value { font-weight: 600; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }

/* ===== FILTER BAR ===== */
.filter-bar {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 16px; flex-wrap: wrap;
}

.filter-chip {
  padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 500;
  background: #f1f7fd; border: 1px solid var(--border-subtle);
  color: var(--text-secondary); cursor: pointer; transition: var(--transition);
  font-family: inherit;
}

.filter-chip:hover { border-color: var(--border); color: var(--text-primary); }
.filter-chip.active { border-color: var(--accent-ninja); color: var(--accent-ninja); background: var(--accent-ninja-dim); }

.filter-label {
  font-size: 11px; font-weight: 600; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.6px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 1200px) {
  .exec-strip { grid-template-columns: repeat(3, 1fr); }
  .dashboard-grid { grid-template-columns: 1fr 1fr; }
  .span-3 { grid-column: span 2; }
  body[data-active-view="devices"] .dashboard-grid { grid-template-columns: 1fr; }
  body[data-active-view="devices"] .device-inventory-card,
  body[data-active-view="devices"] .device-type-card,
  body[data-active-view="devices"] .os-card,
  body[data-active-view="devices"] .location-card { grid-column: 1 !important; grid-row: auto; }
  body[data-active-view="vulnerabilities"] .dashboard-grid { grid-template-columns: 1fr; }
  body[data-active-view="vulnerabilities"] .vuln-main-card,
  body[data-active-view="vulnerabilities"] .remediation-card,
  body[data-active-view="vulnerabilities"] .risk-matrix-card,
  body[data-active-view="vulnerabilities"] .software-card { grid-column: 1 !important; grid-row: auto; }
  body[data-active-view="policies"] .dashboard-grid { grid-template-columns: 1fr; }
  body[data-active-view="policies"] .ca-policy-card,
  body[data-active-view="policies"] .policy-gaps-card,
  body[data-active-view="policies"] .policy-mitre-card { grid-column: 1; grid-row: auto; }
}

@media (max-width: 768px) {
  .exec-strip { grid-template-columns: repeat(2, 1fr); }
  .dashboard-grid { grid-template-columns: 1fr; }
  .span-2, .span-3 { grid-column: span 1; }
  .os-card { grid-column: span 1; }
  .defender-grid { grid-template-columns: 1fr; }
  .mitre-heatmap { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .topnav-center { display: none; }
}
</style>
</head>
<body>

<!-- ===== TOP NAVIGATION ===== -->
<nav class="topnav">
  <div class="topnav-brand">
    <img src="Website Logo 2.png" alt="Security Ninja logo" class="topnav-logo">
    <span style="color: var(--text-muted); font-weight: 400;">XDR Compliance Centre</span>
  </div>

  <div class="topnav-center">
    <button class="topnav-tab active" onclick="switchView('overview', this)">Overview</button>
    <button class="topnav-tab" onclick="switchView('vulnerabilities', this)">Vulnerabilities</button>
    <button class="topnav-tab" onclick="switchView('devices', this)">Devices</button>
    <button class="topnav-tab" onclick="switchView('policies', this)">Policies</button>
    <button class="topnav-tab" onclick="switchView('defender', this)">Defender</button>
    <button class="topnav-tab" onclick="switchView('threat', this)">Threat</button>
  </div>

  <div class="topnav-right">
    <div class="topnav-status">
      <span class="status-dot"></span>
      <span>MOCK DATA</span>
    </div>
    <button class="btn-connect" onclick="showConnectInfo()">Connect Tenant</button>
  </div>
</nav>

<!-- ===== MAIN CONTENT ===== -->
<main class="main-content">

  <!-- Filter Bar -->
  <div class="filter-bar">
    <span class="filter-label">Filter:</span>
    <button class="filter-chip active" data-filter="all">All Data</button>
    <button class="filter-chip" data-filter="critical">Critical Only</button>
    <button class="filter-chip" data-filter="last7">Last 7 Days</button>
    <button class="filter-chip" data-filter="last30">Last 30 Days</button>
    <span style="flex:1;"></span>
    <span class="filter-label">Severity:</span>
    <button class="filter-chip active" data-sev="all">All</button>
    <button class="filter-chip" data-sev="critical" style="color:var(--severity-critical);">Critical</button>
    <button class="filter-chip" data-sev="high" style="color:var(--severity-high);">High</button>
    <button class="filter-chip" data-sev="medium" style="color:var(--severity-medium);">Medium</button>
    <button class="filter-chip" data-sev="low" style="color:var(--severity-low);">Low</button>
  </div>

  <!-- Executive Summary Strip -->
  <div class="exec-strip">
    <div class="exec-card critical" onclick="openDetail('exposure')">
      <div class="exec-label">Exposure Score</div>
      <div class="exec-value critical">72.4</div>
      <div class="exec-sub"><span class="trend-up">▲ 3.2</span> vs last week</div>
    </div>
    <div class="exec-card warning" onclick="openDetail('criticalVulns')">
      <div class="exec-label">Critical Vulns</div>
      <div class="exec-value warning">23</div>
      <div class="exec-sub"><span class="trend-up">▲ 5</span> new this week</div>
    </div>
    <div class="exec-card good" onclick="openDetail('deviceCompliance')">
      <div class="exec-label">Device Compliance</div>
      <div class="exec-value good">87%</div>
      <div class="exec-sub"><span class="trend-down">▼ 2%</span> improvement</div>
    </div>
    <div class="exec-card info" onclick="openDetail('totalDevices')">
      <div class="exec-label">Managed Devices</div>
      <div class="exec-value info">1,247</div>
      <div class="exec-sub">across 6 locations</div>
    </div>
    <div class="exec-card neutral" onclick="openDetail('caPolicies')">
      <div class="exec-label">CA Policies Active</div>
      <div class="exec-value neutral">18</div>
      <div class="exec-sub">3 in report-only</div>
    </div>
    <div class="exec-card mixed" onclick="openDetail('defenderCoverage')">
      <div class="exec-label">Defender Coverage</div>
      <div class="exec-value mixed">94%</div>
      <div class="exec-sub">78 devices outdated</div>
    </div>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- Vulnerability Severity Breakdown -->
    <div class="card vuln-main-card" data-views="overview,vulnerabilities">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14.5 13H1.5L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 6V9M8 11V11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Vulnerability Severity
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Summary</button>
          <button class="card-action-btn">By OS</button>
        </div>
      </div>
      <div class="card-body">
        <div class="vuln-severity-grid">
          <div class="severity-cell crit" onclick="openDetail('vulnCritical')">
            <div class="sev-count">23</div>
            <div class="sev-label">Critical</div>
          </div>
          <div class="severity-cell high" onclick="openDetail('vulnHigh')">
            <div class="sev-count">67</div>
            <div class="sev-label">High</div>
          </div>
          <div class="severity-cell med" onclick="openDetail('vulnMedium')">
            <div class="sev-count">142</div>
            <div class="sev-label">Medium</div>
          </div>
          <div class="severity-cell low" onclick="openDetail('vulnLow')">
            <div class="sev-count">89</div>
            <div class="sev-label">Low</div>
          </div>
        </div>
        <div class="vuln-list-wrap">
          <div class="vuln-list" id="vulnList"></div>
        </div>
      </div>
    </div>

    <!-- Device Health by Type (Donut) -->
    <div class="card device-type-card" data-views="overview,devices">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 14H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Devices by Type
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:4px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Total Devices</div>
          <div id="deviceTypeTotal" style="font-size:28px;font-weight:800;line-height:1;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0</div>
          <div style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Across all device types</div>
        </div>
        <div style="margin-top: 2px;">
          <div class="bar-chart" id="deviceTypeChart"></div>
        </div>
      </div>
    </div>

    <!-- Risk Matrix -->
    <div class="card risk-matrix-card" data-views="overview,vulnerabilities">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="1" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M1 5H15M1 9H15M5 1V15M9 1V15" stroke="currentColor" stroke-width="0.7" opacity="0.4"/></svg>
          </span>
          Risk Matrix
        </div>
      </div>
      <div class="card-body">
        <div class="risk-matrix" id="riskMatrix"></div>
      </div>
    </div>

    <!-- Devices by OS -->
    <div class="card os-card" data-views="overview,devices">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h9A1.5 1.5 0 0 1 14 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 12.5v-9Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6h12" stroke="currentColor" stroke-width="1.5"/><path d="M5 9.5h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Devices by OS
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:4px;margin-bottom:2px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Total Devices</div>
          <div id="deviceOsTotal" style="font-size:28px;font-weight:800;line-height:1;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0</div>
          <div style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Across all operating systems</div>
        </div>
        <div class="bar-chart" id="deviceOsChart"></div>
      </div>
    </div>

    <!-- Top Vulnerable Software -->
    <div class="card span-2 software-card" data-views="overview,vulnerabilities">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3C2 2.44772 2.44772 2 3 2Z" stroke="currentColor" stroke-width="1.5"/><path d="M5 6L7 8L5 10M9 10H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Vulnerable Software Inventory
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Grid</button>
          <button class="card-action-btn">List</button>
        </div>
      </div>
      <div class="card-body">
        <div class="app-grid" id="appGrid"></div>
      </div>
    </div>

    <!-- Exposure Trend -->
    <div class="card exposure-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><polyline points="1,12 4,8 7,10 10,4 13,6 15,2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Exposure Trend (90 Days)
        </div>
      </div>
      <div class="card-body">
        <div class="trend-chart-area">
          <svg class="trend-chart-svg" id="trendChart" viewBox="0 0 400 180" preserveAspectRatio="none"></svg>
        </div>
      </div>
    </div>

    <!-- Threat Relevance (Unlicensed Mode) -->
    <div class="card span-2 threat-relevance-card" data-views="threat">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 5V8.5M8 10.8V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Threat Relevance (Unlicensed Mode)
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Top 10</button>
          <button class="card-action-btn">Scoring Model</button>
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Prioritised from Defender vulnerability + device exposure data (CVSS, exploited flag, affected endpoints, business criticality proxy).
        </div>
        <div class="threat-list" id="threatRelevanceList"></div>
      </div>
    </div>

    <!-- Prioritized Remediation Queue -->
    <div class="card span-2 remediation-card" data-views="threat,vulnerabilities">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h9A1.5 1.5 0 0 1 14 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 12.5v-9Z" stroke="currentColor" stroke-width="1.5"/><path d="M5 8L7 10L11 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Prioritized Remediation Queue
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Actionable Queue</button>
          <button class="card-action-btn">Risk Reduction</button>
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Ranking uses exploit status, CVSS, exposed device volume, and average impacted device risk to prioritize remediation sequencing.
        </div>
        <div class="remediation-list" id="remediationQueueList"></div>
      </div>
    </div>

    <!-- MITRE ATT&CK Coverage Map -->
    <div class="card span-3 mitre-card" data-views="threat">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2H14V14H2V2Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6H14M2 10H14M6 2V14M10 2V14" stroke="currentColor" stroke-width="1" opacity="0.6"/></svg>
          </span>
          MITRE ATT&CK Coverage Map
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Tactics</button>
          <button class="card-action-btn">Heatmap</button>
        </div>
      </div>
      <div class="card-body">
        <div class="mitre-wrap">
          <div style="font-size:11px;color:var(--text-muted);">
            Visual coverage of ATT&CK tactics based on current detection and control posture. Lower coverage and higher observed activity indicate higher risk.
          </div>
          <div class="mitre-tactic-list" id="mitreTacticList"></div>
          <div class="mitre-heatmap" id="mitreHeatmap"></div>
        </div>
      </div>
    </div>

    <!-- Device Inventory Table -->
    <div class="card span-2 device-inventory-card" data-views="devices">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="14" height="12" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M1 5.5H15" stroke="currentColor" stroke-width="1"/></svg>
          </span>
          Device Inventory
        </div>
        <div class="card-actions">
          <button class="card-action-btn">Export CSV</button>
          <button class="card-action-btn active">All Devices</button>
          <button class="card-action-btn">Non-Compliant</button>
        </div>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="device-table-wrap">
          <table class="device-table" id="deviceTable">
            <thead>
              <tr>
                <th>Device Name</th>
                <th>Type</th>
                <th>OS</th>
                <th>Location</th>
                <th>Health</th>
                <th>Defender Ver.</th>
                <th>Vulns</th>
                <th>CA Policies</th>
              </tr>
            </thead>
            <tbody id="deviceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CA Policy Coverage -->
    <div class="card ca-policy-card" data-views="policies,overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M6 8L7.5 9.5L10 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Conditional Access Policies
        </div>
      </div>
      <div class="card-body">
        <div class="ca-policy-list" id="caPolicyList"></div>
      </div>
    </div>

    <!-- Policy Gap Intelligence -->
    <div class="card policy-gaps-card" data-views="policies">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14.5 13H1.5L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 6V9M8 11V11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Policy Gap Intelligence
        </div>
      </div>
      <div class="card-body">
        <div class="policy-filter-row">
          <button class="filter-chip active" data-policy-filter="all">All</button>
          <button class="filter-chip" data-policy-filter="high-gap">High Gap</button>
          <button class="filter-chip" data-policy-filter="report-only">Report-only</button>
          <button class="filter-chip" data-policy-filter="low-coverage">Low Coverage</button>
        </div>
        <div class="policy-gap-grid" id="policyGapSummary"></div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Priority policy gaps based on state, coverage, and missing controls that increase attack-path exposure.
        </div>
        <div class="policy-gap-list" id="policyGapList"></div>
      </div>
    </div>

    <!-- Policy to MITRE ATT&CK Mapping -->
    <div class="card policy-mitre-card" data-views="policies">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2H14V14H2V2Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6H14M2 10H14M6 2V14M10 2V14" stroke="currentColor" stroke-width="1" opacity="0.6"/></svg>
          </span>
          Policy-to-MITRE Threat Coverage
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Shows ATT&amp;CK tactics and threat patterns each control is reducing; highlights gaps where controls are weak or not enforced.
        </div>
        <div class="policy-mitre-list" id="policyMitreList"></div>
      </div>
    </div>

    <!-- Location Breakdown -->
    <div class="card location-card" data-views="devices,overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="6.5" stroke="currentColor" stroke-width="1.5"/><path d="M1.5 8H14.5M8 1.5C8 1.5 5 4.5 5 8C5 11.5 8 14.5 8 14.5M8 1.5C8 1.5 11 4.5 11 8C11 11.5 8 14.5 8 14.5" stroke="currentColor" stroke-width="1"/></svg>
          </span>
          Devices by Location
        </div>
      </div>
      <div class="card-body">
        <div class="location-grid" id="locationGrid"></div>
      </div>
    </div>

    <!-- Defender Stack Compliance -->
    <div class="card span-2" data-views="defender">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M5.5 8L7.4 9.9L10.8 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Defender Stack Compliance
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Health</button>
          <button class="card-action-btn">Signals</button>
        </div>
      </div>
      <div class="card-body">
        <div class="defender-grid" id="defenderStackGrid"></div>
        <div class="defender-list" id="defenderCommIssues"></div>
      </div>
    </div>

    <!-- Defender Version Distribution -->
    <div class="card" data-views="defender">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </span>
          Defender Version Health
        </div>
      </div>
      <div class="card-body">
        <div class="bar-chart" id="defenderVersionChart"></div>
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-sm); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 11px; color: var(--text-muted);">Latest Platform Version</div>
            <div style="font-size: 13px; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px;">4.18.24110.7</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-muted);">Coverage</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--status-warning); font-family: 'JetBrains Mono', monospace; margin-top: 2px;">94.2%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- ===== DETAIL FLYOUT PANEL ===== -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="detail-panel" onclick="event.stopPropagation()">
    <div class="detail-header">
      <div class="detail-title" id="detailTitle">Detail View</div>
      <button class="detail-close" onclick="closeDetail()">&times;</button>
    </div>
    <div class="detail-body" id="detailBody"></div>
  </div>
</div>

<script>
// ===== MOCK DATA (Structured to match Microsoft Graph / Defender APIs) =====

const vulnerabilities = [
  { id: "CVE-2024-38063", title: "Windows TCP/IP Remote Code Execution", severity: "Critical", cvss: 9.8, affectedDevices: 187, software: "Windows 11 23H2", published: "2024-08-13", exploited: true },
  { id: "CVE-2024-43491", title: "Microsoft Windows Update RCE", severity: "Critical", cvss: 9.8, affectedDevices: 52, software: "Windows 10", published: "2024-09-10", exploited: true },
  { id: "CVE-2024-49138", title: "Windows CLFS Driver Elevation of Privilege", severity: "Critical", cvss: 7.8, affectedDevices: 312, software: "Windows Server 2022", published: "2024-12-10", exploited: true },
  { id: "CVE-2024-30088", title: "Windows Kernel Elevation of Privilege", severity: "High", cvss: 8.8, affectedDevices: 445, software: "Windows 11", published: "2024-06-11", exploited: false },
  { id: "CVE-2024-38178", title: "Scripting Engine Memory Corruption", severity: "High", cvss: 7.5, affectedDevices: 203, software: "Edge Chromium", published: "2024-08-13", exploited: true },
  { id: "CVE-2024-43572", title: "Microsoft Management Console RCE", severity: "High", cvss: 7.8, affectedDevices: 178, software: "Windows 11 23H2", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-43573", title: "Windows MSHTML Platform Spoofing", severity: "Medium", cvss: 6.5, affectedDevices: 890, software: "Windows 10/11", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-38202", title: "Windows Update Stack EoP", severity: "High", cvss: 7.3, affectedDevices: 134, software: "Windows 11", published: "2024-08-08", exploited: false },
  { id: "CVE-2024-21447", title: "Windows Enroll Engine SFP", severity: "Medium", cvss: 5.9, affectedDevices: 67, software: "Windows Server", published: "2024-04-09", exploited: false },
  { id: "CVE-2024-38199", title: "Windows LPD Service RCE", severity: "Critical", cvss: 9.8, affectedDevices: 23, software: "Windows Server 2019", published: "2024-08-13", exploited: false },
  { id: "CVE-2024-43583", title: "Winlogon Elevation of Privilege", severity: "High", cvss: 7.8, affectedDevices: 567, software: "Windows 11", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-20674", title: "Windows Kerberos SFP Bypass", severity: "Critical", cvss: 9.0, affectedDevices: 89, software: "Windows Server 2022", published: "2024-01-09", exploited: false },
];

const KB_PATCH_MAP = {
  "CVE-2024-38063": [
    { kb: "KB5041585", target: "Windows 11 23H2", note: "2024-08 cumulative security update" },
    { kb: "KB5041580", target: "Windows 10 22H2", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-43491": [
    { kb: "KB5043064", target: "Windows 10 22H2", note: "2024-09 cumulative security update" },
    { kb: "KB5043076", target: "Windows 11 23H2", note: "2024-09 cumulative security update" }
  ],
  "CVE-2024-49138": [
    { kb: "KB5048654", target: "Windows Server 2022", note: "2024-12 cumulative security update" }
  ],
  "CVE-2024-30088": [
    { kb: "KB5039212", target: "Windows 11", note: "2024-06 cumulative security update" }
  ],
  "CVE-2024-38178": [
    { kb: "KB5041585", target: "Windows 11 23H2", note: "OS cumulative update path" },
    { kb: "Edge Stable latest", target: "Microsoft Edge Chromium", note: "Browser patch required in parallel" }
  ],
  "CVE-2024-43572": [
    { kb: "KB5044285", target: "Windows 11 23H2", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-43573": [
    { kb: "KB5044285", target: "Windows 11", note: "2024-10 cumulative security update" },
    { kb: "KB5044273", target: "Windows 10", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-38202": [
    { kb: "KB5041585", target: "Windows 11", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-21447": [
    { kb: "KB5034441", target: "Windows Server", note: "2024-04 security update line" }
  ],
  "CVE-2024-38199": [
    { kb: "KB5041773", target: "Windows Server 2019", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-43583": [
    { kb: "KB5044285", target: "Windows 11", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-20674": [
    { kb: "KB5034129", target: "Windows Server 2022", note: "2024-01 cumulative security update" }
  ]
};

const devices = [
  { name: "WKS-LON-001", type: "Workstation", os: "Windows 11 23H2", location: "London", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 3, caPolicies: 5, riskScore: 24, lastSeen: "2025-02-20T09:15:00Z" },
  { name: "WKS-LON-042", type: "Workstation", os: "Windows 11 23H2", location: "London", health: "Warning", defenderVer: "4.18.24090.3", vulns: 8, caPolicies: 5, riskScore: 58, lastSeen: "2025-02-20T08:30:00Z" },
  { name: "SRV-AZ-DC01", type: "Server", os: "Windows Server 2022", location: "Azure UK South", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 2, caPolicies: 3, riskScore: 15, lastSeen: "2025-02-20T09:20:00Z" },
  { name: "SRV-AZ-SQL01", type: "Server", os: "Windows Server 2022", location: "Azure UK South", health: "Critical", defenderVer: "4.18.23110.2", vulns: 14, caPolicies: 2, riskScore: 82, lastSeen: "2025-02-19T22:10:00Z" },
  { name: "WKS-NYC-015", type: "Workstation", os: "Windows 11 22H2", location: "New York", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 5, caPolicies: 5, riskScore: 31, lastSeen: "2025-02-20T14:05:00Z" },
  { name: "MBL-LON-089", type: "Mobile", os: "iOS 18.2", location: "London", health: "Healthy", defenderVer: "1.1.62120101", vulns: 0, caPolicies: 4, riskScore: 8, lastSeen: "2025-02-20T09:00:00Z" },
  { name: "WKS-BER-007", type: "Workstation", os: "Windows 10 22H2", location: "Berlin", health: "Warning", defenderVer: "4.18.24050.9", vulns: 12, caPolicies: 4, riskScore: 67, lastSeen: "2025-02-20T08:45:00Z" },
  { name: "SRV-AZ-WEB01", type: "Server", os: "Ubuntu 22.04", location: "Azure West Europe", health: "Healthy", defenderVer: "101.24112.0001", vulns: 1, caPolicies: 1, riskScore: 12, lastSeen: "2025-02-20T09:18:00Z" },
  { name: "MAC-LON-023", type: "Workstation", os: "macOS 15.2", location: "London", health: "Healthy", defenderVer: "101.24112.0003", vulns: 2, caPolicies: 5, riskScore: 18, lastSeen: "2025-02-20T09:12:00Z" },
  { name: "WKS-SYD-003", type: "Workstation", os: "Windows 11 23H2", location: "Sydney", health: "Warning", defenderVer: "4.18.24090.3", vulns: 7, caPolicies: 5, riskScore: 52, lastSeen: "2025-02-20T01:30:00Z" },
  { name: "MBL-NYC-112", type: "Mobile", os: "Android 14", location: "New York", health: "Warning", defenderVer: "1.0.7122.0101", vulns: 1, caPolicies: 3, riskScore: 25, lastSeen: "2025-02-19T20:15:00Z" },
  { name: "SRV-AZ-APP02", type: "Server", os: "Windows Server 2019", location: "Azure UK South", health: "Critical", defenderVer: "4.18.23080.1", vulns: 18, caPolicies: 2, riskScore: 91, lastSeen: "2025-02-20T09:05:00Z" },
  { name: "WKS-TKY-001", type: "Workstation", os: "Windows 11 23H2", location: "Tokyo", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 4, caPolicies: 5, riskScore: 22, lastSeen: "2025-02-20T02:45:00Z" },
  { name: "WKS-LON-099", type: "Workstation", os: "Windows 10 21H2", location: "London", health: "Critical", defenderVer: "4.18.23050.5", vulns: 21, caPolicies: 4, riskScore: 88, lastSeen: "2025-02-18T16:30:00Z" },
];

const caPolicies = [
  { name: "Require MFA for All Users", state: "enabled", coverage: 98, users: 1247, apps: "All cloud apps", conditions: "All platforms", grantControls: "Require MFA", sessionControls: "Sign-in frequency: 24h" },
  { name: "Block Legacy Authentication", state: "enabled", coverage: 100, users: 1247, apps: "Exchange Online, SharePoint", conditions: "Other clients", grantControls: "Block access", sessionControls: "None" },
  { name: "Compliant Device Required", state: "enabled", coverage: 87, users: 1089, apps: "Office 365", conditions: "Windows, macOS, iOS, Android", grantControls: "Require compliant device", sessionControls: "None" },
  { name: "High Risk Sign-in Block", state: "enabled", coverage: 100, users: 1247, apps: "All cloud apps", conditions: "High risk sign-in", grantControls: "Block access", sessionControls: "None" },
  { name: "Named Location - Corp Network Trust", state: "enabled", coverage: 72, users: 896, apps: "All cloud apps", conditions: "Trusted locations excluded", grantControls: "Require MFA", sessionControls: "Persistent browser session" },
  { name: "Admin MFA Enforcement", state: "enabled", coverage: 100, users: 23, apps: "Microsoft Admin Portals", conditions: "All platforms", grantControls: "Require MFA + Compliant device", sessionControls: "Sign-in frequency: 4h" },
  { name: "BYOD App Protection", state: "report-only", coverage: 45, users: 567, apps: "Office 365, Teams", conditions: "Unmanaged devices", grantControls: "Require app protection policy", sessionControls: "App enforced restrictions" },
  { name: "Guest Access Restrictions", state: "enabled", coverage: 100, users: 156, apps: "SharePoint, Teams", conditions: "Guest users", grantControls: "Require MFA", sessionControls: "Sign-in frequency: 8h" },
  { name: "Token Protection (Preview)", state: "report-only", coverage: 34, users: 423, apps: "Exchange Online", conditions: "Windows", grantControls: "Require token protection", sessionControls: "None" },
  { name: "Phishing-Resistant MFA for Admins", state: "report-only", coverage: 65, users: 23, apps: "All cloud apps", conditions: "Directory roles", grantControls: "Require authentication strength", sessionControls: "Sign-in frequency: 4h" },
];

const POLICY_MITRE_MAP = {
  "Require MFA for All Users": {
    tactics: ["Credential Access", "Initial Access"],
    techniques: ["T1110 Brute Force", "T1078 Valid Accounts"],
    threats: ["Password spray", "Credential stuffing"]
  },
  "Block Legacy Authentication": {
    tactics: ["Credential Access", "Defense Evasion"],
    techniques: ["T1556 Modify Authentication Process", "T1078 Valid Accounts"],
    threats: ["Basic auth bypass", "Legacy protocol abuse"]
  },
  "Compliant Device Required": {
    tactics: ["Execution", "Persistence"],
    techniques: ["T1204 User Execution", "T1547 Boot or Logon Autostart"],
    threats: ["Unmanaged endpoint access", "Persistent malware on non-compliant hosts"]
  },
  "High Risk Sign-in Block": {
    tactics: ["Initial Access", "Credential Access"],
    techniques: ["T1078 Valid Accounts", "T1110 Brute Force"],
    threats: ["Impossible travel sign-ins", "Compromised account takeover"]
  },
  "Named Location - Corp Network Trust": {
    tactics: ["Command and Control", "Lateral Movement"],
    techniques: ["T1133 External Remote Services", "T1021 Remote Services"],
    threats: ["Suspicious geolocation access", "Remote pivoting from unmanaged networks"]
  },
  "Admin MFA Enforcement": {
    tactics: ["Privilege Escalation", "Credential Access"],
    techniques: ["T1078.004 Cloud Accounts", "T1068 Exploitation for Privilege Escalation"],
    threats: ["Admin session hijack", "Privileged account abuse"]
  },
  "BYOD App Protection": {
    tactics: ["Exfiltration", "Impact"],
    techniques: ["T1041 Exfiltration Over C2 Channel", "T1567 Exfiltration to Cloud Storage"],
    threats: ["Data leakage via unmanaged mobile", "Copy/paste exfiltration"]
  },
  "Guest Access Restrictions": {
    tactics: ["Initial Access", "Lateral Movement"],
    techniques: ["T1078 Valid Accounts", "T1021 Remote Services"],
    threats: ["Excessive guest privilege", "Third-party collaborator abuse"]
  },
  "Token Protection (Preview)": {
    tactics: ["Defense Evasion", "Credential Access"],
    techniques: ["T1528 Steal Application Access Token", "T1550 Use Alternate Authentication Material"],
    threats: ["Token replay", "Session token theft"]
  },
  "Phishing-Resistant MFA for Admins": {
    tactics: ["Credential Access", "Privilege Escalation"],
    techniques: ["T1110 Brute Force", "T1078.004 Cloud Accounts"],
    threats: ["AiTM phishing", "Privileged identity compromise"]
  }
};

const locations = [
  { name: "London", flag: "🇬🇧", devices: 487, healthy: 412, warning: 58, critical: 17 },
  { name: "New York", flag: "🇺🇸", devices: 312, healthy: 278, warning: 28, critical: 6 },
  { name: "Berlin", flag: "🇩🇪", devices: 156, healthy: 132, warning: 19, critical: 5 },
  { name: "Azure UK South", flag: "☁️", devices: 134, healthy: 118, warning: 10, critical: 6 },
  { name: "Sydney", flag: "🇦🇺", devices: 89, healthy: 74, warning: 12, critical: 3 },
  { name: "Tokyo", flag: "🇯🇵", devices: 69, healthy: 61, warning: 7, critical: 1 },
];

const softwareInventory = [
  { name: "Microsoft Edge", vendor: "Microsoft", devices: 1180, vulns: 12, version: "131.0.2903.70" },
  { name: "Windows 11 23H2", vendor: "Microsoft", devices: 678, vulns: 23, version: "10.0.22631" },
  { name: "Microsoft 365 Apps", vendor: "Microsoft", devices: 1150, vulns: 8, version: "2411" },
  { name: "Windows 10 22H2", vendor: "Microsoft", devices: 234, vulns: 31, version: "10.0.19045" },
  { name: "Teams (New)", vendor: "Microsoft", devices: 1098, vulns: 3, version: "24295.606.3238" },
  { name: "Windows Server 2022", vendor: "Microsoft", devices: 67, vulns: 14, version: "10.0.20348" },
  { name: "Adobe Acrobat Reader", vendor: "Adobe", devices: 890, vulns: 7, version: "2024.004.20272" },
  { name: "Zoom Workplace", vendor: "Zoom", devices: 756, vulns: 4, version: "6.3.0" },
  { name: "Chrome", vendor: "Google", devices: 342, vulns: 9, version: "131.0.6778.109" },
  { name: "Windows Server 2019", vendor: "Microsoft", devices: 23, vulns: 18, version: "10.0.17763" },
  { name: "Visual Studio Code", vendor: "Microsoft", devices: 234, vulns: 2, version: "1.95.3" },
  { name: "Python 3.12", vendor: "Python.org", devices: 89, vulns: 5, version: "3.12.7" },
];

// ===== RENDER FUNCTIONS =====

const DEVICE_TYPE_DATA = [
  { label: 'Workstations', count: 842, color: '#1E3A5A' },
  { label: 'Servers', count: 224, color: '#2F6FA8' },
  { label: 'Mobile', count: 156, color: '#6A93B9' },
  { label: 'IoT / Other', count: 25, color: '#9CB7D1' },
];

const DEVICE_OS_DATA = [
  { label: 'Win 11 23H2', value: 678, color: '#0EA5E9' },
  { label: 'Win 10 22H2', value: 234, color: '#22C55E' },
  { label: 'macOS 15', value: 89, color: '#A855F7' },
  { label: 'Server 2022', value: 67, color: '#F59E0B' },
  { label: 'iOS/Android', value: 156, color: '#EF4444' },
];

let riskCellCache = {};
let riskMatrixMode = 'full';
let msalInstance = null;
let msalLoadPromise = null;

const GRAPH_CONNECT_SCOPES = [
  'SecurityAlert.Read.All',
  'ThreatHunting.Read.All',
  'Policy.Read.All',
  'DeviceManagementManagedDevices.Read.All'
];

function resolveRedirectUri() {
  if (window.location.hostname === 'tools.security-ninja.com') {
    return 'https://tools.security-ninja.com/XDR/';
  }
  return window.location.origin;
}

function loadScriptOnce(src) {
  return new Promise((resolve, reject) => {
    const existing = document.querySelector(`script[data-src="${src}"]`);
    if (existing && existing.dataset.loaded === 'true') {
      resolve();
      return;
    }
    if (existing && existing.dataset.loaded !== 'true') {
      existing.addEventListener('load', () => resolve(), { once: true });
      existing.addEventListener('error', () => reject(new Error(`Failed to load ${src}`)), { once: true });
      return;
    }

    const script = document.createElement('script');
    script.src = src;
    script.async = true;
    script.dataset.src = src;
    script.onload = () => {
      script.dataset.loaded = 'true';
      resolve();
    };
    script.onerror = () => reject(new Error(`Failed to load ${src}`));
    document.head.appendChild(script);
  });
}

async function ensureMsalLoaded() {
  if (window.msal && window.msal.PublicClientApplication) return;
  if (msalLoadPromise) {
    await msalLoadPromise;
    return;
  }

  const sources = [
    'https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js',
    'https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.39.0/lib/msal-browser.min.js',
    'https://unpkg.com/@azure/msal-browser@2.39.0/lib/msal-browser.min.js'
  ];

  msalLoadPromise = (async () => {
    let lastErr = null;
    for (const src of sources) {
      try {
        await loadScriptOnce(src);
        if (window.msal && window.msal.PublicClientApplication) return;
      } catch (err) {
        lastErr = err;
      }
    }
    throw lastErr || new Error('MSAL library not loaded');
  })();

  await msalLoadPromise;
}

async function getOrCreateMsalInstance(tenantId, clientId) {
  if (msalInstance) return msalInstance;

  await ensureMsalLoaded();
  if (!window.msal || !window.msal.PublicClientApplication) throw new Error('MSAL library not loaded');

  msalInstance = new window.msal.PublicClientApplication({
    auth: {
      clientId,
      authority: `https://login.microsoftonline.com/${tenantId}`,
      redirectUri: resolveRedirectUri()
    },
    cache: {
      cacheLocation: 'sessionStorage'
    }
  });

  if (typeof msalInstance.initialize === 'function') {
    await msalInstance.initialize();
  }

  return msalInstance;
}
let activePolicyFilter = 'all';

function renderVulnList() {
  const container = document.getElementById('vulnList');
  container.innerHTML = vulnerabilities.slice(0, 8).map(v => {
    const sevClass = v.severity.toLowerCase();
    return `<div class="vuln-item" onclick="openVulnDetail('${v.id}')">
      <div class="vuln-sev-badge ${sevClass}"></div>
      <div class="vuln-info">
        <div class="vuln-cve">${v.id}${v.exploited ? ' <span style="color:var(--severity-critical);font-size:10px;">⚡ EXPLOITED</span>' : ''}</div>
        <div class="vuln-desc">${v.title}</div>
      </div>
      <div class="vuln-meta">
        <div class="vuln-devices">${v.affectedDevices} devices</div>
        <div class="vuln-cvss ${sevClass}">${v.cvss.toFixed(1)}</div>
      </div>
    </div>`;
  }).join('');
}

function renderDeviceTypeSummary() {
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  document.getElementById('deviceTypeTotal').textContent = total.toLocaleString();
}

function renderDeviceOsSummary() {
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  document.getElementById('deviceOsTotal').textContent = total.toLocaleString();
}

function renderDeviceTypeChart() {
  const data = DEVICE_TYPE_DATA.map(item => ({ label: item.label, value: item.count, color: item.color }));
  const maxVal = Math.max(...data.map(d => d.value));
  document.getElementById('deviceTypeChart').innerHTML = `
    ${data.map(d => `
    <div class="bar-row interactive" role="button" tabindex="0" onclick="openDeviceTypeDetail('${d.label}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDeviceTypeDetail('${d.label}')}">
      <div class="bar-label" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
        <span style="width:8px;height:8px;border-radius:2px;background:${d.color};display:inline-block;flex-shrink:0;"></span>
        <span>${d.label}</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('')}
  `;
}

function openDeviceTypeDetail(typeLabel) {
  const typeData = DEVICE_TYPE_DATA.find(item => item.label === typeLabel);
  if (!typeData) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  const pct = ((typeData.count / total) * 100).toFixed(1);

  const matchingDevices = devices.filter(device => {
    if (typeLabel === 'Workstations') return device.type === 'Workstation';
    if (typeLabel === 'Servers') return device.type === 'Server';
    if (typeLabel === 'Mobile') return device.type === 'Mobile';
    if (typeLabel === 'IoT / Other') return !['Workstation', 'Server', 'Mobile'].includes(device.type);
    return false;
  });

  const health = { healthy: 0, warning: 0, critical: 0 };
  matchingDevices.forEach(device => {
    const key = device.health.toLowerCase();
    if (health[key] !== undefined) health[key] += 1;
  });

  const topOs = {};
  matchingDevices.forEach(device => {
    topOs[device.os] = (topOs[device.os] || 0) + 1;
  });
  const topOsList = Object.entries(topOs).sort((a, b) => b[1] - a[1]).slice(0, 3);

  const impactedDevices = matchingDevices
    .filter(device => device.vulns > 0)
    .sort((a, b) => b.vulns - a.vulns)
    .slice(0, 8)
    .map(device => {
      const mappedVulns = vulnerabilities
        .filter(vuln => {
          const osNorm = device.os.toLowerCase();
          const swNorm = vuln.software.toLowerCase();
          if (osNorm.includes('windows') && swNorm.includes('windows')) return true;
          if (osNorm.includes('macos') && swNorm.includes('macos')) return true;
          if ((osNorm.includes('ios') || osNorm.includes('android')) && (swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile'))) return true;
          return false;
        })
        .sort((a, b) => b.cvss - a.cvss)
        .slice(0, 3);
      return { device, mappedVulns };
    });

  title.textContent = `${typeLabel} Fleet Detail`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Coverage</div>
      <div style="font-size:40px;font-weight:800;color:${typeData.color};font-family:'JetBrains Mono';margin:6px 0;">${typeData.count.toLocaleString()}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${pct}% of total managed estate</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Health Snapshot (Sample Device Data)</div>
      <div class="detail-row"><span class="label">Healthy</span><span class="value">${health.healthy}</span></div>
      <div class="detail-row"><span class="label">Warning</span><span class="value" style="color:var(--status-warning);">${health.warning}</span></div>
      <div class="detail-row"><span class="label">Critical</span><span class="value" style="color:var(--status-noncompliant);">${health.critical}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Operating Systems (Sample)</div>
      ${topOsList.length ? topOsList.map(([os, count]) => `<div class="detail-row"><span class="label">${os}</span><span class="value">${count}</span></div>`).join('') : '<div style="font-size:12px;color:var(--text-muted);">No sample devices mapped for this type in prototype data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Action Focus</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        Prioritise patching and Defender version currency for this device class, then validate conditional access coverage and exposure-score contributors specific to ${typeLabel.toLowerCase()}.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Impacted Devices and Associated Vulnerabilities</div>
      ${
        impactedDevices.length
          ? impactedDevices.map(({ device, mappedVulns }) => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.vulns > 7 ? 'var(--severity-critical)' : device.vulns > 3 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">${device.vulns} vulns</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">${device.os} · ${device.location}</div>
                ${
                  mappedVulns.length
                    ? `<div style="font-size:11px;color:var(--text-secondary);line-height:1.55;">
                        ${mappedVulns.map(v => `<div>• <span style=\"font-family:'JetBrains Mono',monospace;color:var(--text-primary);\">${v.id}</span> (${v.cvss.toFixed(1)}) - ${v.title}</div>`).join('')}
                      </div>`
                    : `<div style="font-size:11px;color:var(--text-muted);">No direct vulnerability mapping available in sample data.</div>`
                }
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No impacted devices in this device type based on current sample dataset.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function renderDeviceOsChart() {
  const data = DEVICE_OS_DATA;
  const maxVal = Math.max(...data.map(d => d.value));
  document.getElementById('deviceOsChart').innerHTML = `
    ${data.map(d => `
    <div class="bar-row interactive" role="button" tabindex="0" onclick="openDeviceOsDetail('${d.label}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDeviceOsDetail('${d.label}')}">
      <div class="bar-label" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
        <span style="width:8px;height:8px;border-radius:2px;background:${d.color};display:inline-block;flex-shrink:0;"></span>
        <span>${d.label}</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('')}
  `;
}

function getDevicesForOsLabel(osLabel) {
  return devices.filter(device => {
    const os = device.os.toLowerCase();
    if (osLabel === 'Win 11 23H2') return os.includes('windows 11 23h2');
    if (osLabel === 'Win 10 22H2') return os.includes('windows 10 22h2');
    if (osLabel === 'macOS 15') return os.includes('macos 15');
    if (osLabel === 'Server 2022') return os.includes('server 2022');
    if (osLabel === 'iOS/Android') return os.includes('ios') || os.includes('android');
    return false;
  });
}

function openDeviceOsDetail(osLabel) {
  const osData = DEVICE_OS_DATA.find(item => item.label === osLabel);
  if (!osData) return;

  const matchingDevices = getDevicesForOsLabel(osLabel);
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  const pct = ((osData.value / total) * 100).toFixed(1);

  const health = { healthy: 0, warning: 0, critical: 0 };
  matchingDevices.forEach(device => {
    const key = device.health.toLowerCase();
    if (health[key] !== undefined) health[key] += 1;
  });

  const avgRisk = matchingDevices.length
    ? (matchingDevices.reduce((sum, device) => sum + device.riskScore, 0) / matchingDevices.length).toFixed(1)
    : '0.0';
  const avgVulns = matchingDevices.length
    ? (matchingDevices.reduce((sum, device) => sum + device.vulns, 0) / matchingDevices.length).toFixed(1)
    : '0.0';
  const staleTelemetry = matchingDevices.filter(device => {
    const seen = new Date(device.lastSeen).getTime();
    const now = Date.now();
    return (now - seen) > (24 * 60 * 60 * 1000);
  }).length;
  const outdatedDefender = matchingDevices.filter(device => !device.defenderVer.includes('24110') && !device.defenderVer.includes('24112')).length;

  const relatedVulns = vulnerabilities
    .filter(vuln => {
      const text = `${vuln.software} ${vuln.title}`.toLowerCase();
      if (osLabel === 'Win 11 23H2') return text.includes('windows 11') || text.includes('windows 10/11') || text.includes('edge');
      if (osLabel === 'Win 10 22H2') return text.includes('windows 10') || text.includes('windows 10/11') || text.includes('edge');
      if (osLabel === 'macOS 15') return text.includes('macos');
      if (osLabel === 'Server 2022') return text.includes('server 2022') || text.includes('server') || text.includes('windows');
      if (osLabel === 'iOS/Android') return text.includes('ios') || text.includes('android') || text.includes('mobile');
      return false;
    })
    .sort((a, b) => (b.exploited === a.exploited ? b.cvss - a.cvss : (b.exploited ? 1 : -1)))
    .slice(0, 8);

  const impactedDevices = matchingDevices
    .filter(device => device.vulns > 0)
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${osLabel} — OS Risk & Exposure`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Coverage</div>
      <div style="font-size:40px;font-weight:800;color:${osData.color};font-family:'JetBrains Mono';margin:6px 0;">${osData.value}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${pct}% of total managed estate</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Security Posture</div>
      <div class="detail-row"><span class="label">Healthy</span><span class="value">${health.healthy}</span></div>
      <div class="detail-row"><span class="label">Warning</span><span class="value" style="color:var(--status-warning);">${health.warning}</span></div>
      <div class="detail-row"><span class="label">Critical</span><span class="value" style="color:var(--status-noncompliant);">${health.critical}</span></div>
      <div class="detail-row"><span class="label">Average Risk Score</span><span class="value" style="font-family:JetBrains Mono;">${avgRisk}</span></div>
      <div class="detail-row"><span class="label">Average Open Vulns / Device</span><span class="value" style="font-family:JetBrains Mono;">${avgVulns}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Telemetry & Agent Health</div>
      <div class="detail-row"><span class="label">Devices with outdated Defender versions</span><span class="value" style="font-family:JetBrains Mono;${outdatedDefender ? 'color:var(--severity-high);' : ''}">${outdatedDefender}</span></div>
      <div class="detail-row"><span class="label">Devices stale >24h (last check-in)</span><span class="value" style="font-family:JetBrains Mono;${staleTelemetry ? 'color:var(--severity-high);' : ''}">${staleTelemetry}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Related Vulnerabilities & KB Updates</div>
      ${
        relatedVulns.length
          ? relatedVulns.map(v => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${v.id}</div>
                  <div style="font-size:10px;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;font-weight:700;">CVSS ${v.cvss.toFixed(1)}${v.exploited ? ' · Exploited' : ''}</div>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;">${v.title}</div>
                <div style="font-size:10px;color:var(--text-muted);line-height:1.5;">
                  ${(KB_PATCH_MAP[v.id] && KB_PATCH_MAP[v.id].length)
                    ? `KB/Update: ${KB_PATCH_MAP[v.id].map(k => `${k.kb} (${k.target})`).join(' · ')}`
                    : 'KB/Update: Validate in Microsoft Security Update Guide'}
                </div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No mapped vulnerabilities for this OS group in current sample data.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Highest-Risk Devices in this OS Group</div>
      ${
        impactedDevices.length
          ? impactedDevices.map(device => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
                <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${device.name}</span>
                <span>${device.location} · Risk ${device.riskScore} · ${device.vulns} vuln(s)</span>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No impacted devices in this OS group based on current sample dataset.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        1. Patch exploited/high-CVSS vulnerabilities first using mapped KB/update packages.<br>
        2. Upgrade outdated Defender engines/signatures and confirm heartbeat health.<br>
        3. Prioritize high-risk devices for remediation and re-scan to validate closure.<br>
        4. Review CA policy coverage for this OS cohort (especially unmanaged or stale devices).
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function mapVulnerabilitiesForDevice(device) {
  return vulnerabilities
    .filter(vuln => {
      const osNorm = device.os.toLowerCase();
      const swNorm = vuln.software.toLowerCase();
      if (osNorm.includes('windows') && swNorm.includes('windows')) return true;
      if (osNorm.includes('macos') && swNorm.includes('macos')) return true;
      if ((osNorm.includes('ios') || osNorm.includes('android')) && (swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile'))) return true;
      return false;
    })
    .sort((a, b) => b.cvss - a.cvss)
    .slice(0, 3);
}

function getRelatedDevicesForVulnerability(vuln) {
  const swNorm = vuln.software.toLowerCase();
  return devices.filter(device => {
    const osNorm = device.os.toLowerCase();
    if (swNorm.includes('windows') && osNorm.includes('windows')) return true;
    if (swNorm.includes('server') && device.type === 'Server') return true;
    if (swNorm.includes('edge') && osNorm.includes('windows')) return true;
    if (swNorm.includes('macos') && osNorm.includes('macos')) return true;
    if ((swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile')) && (osNorm.includes('ios') || osNorm.includes('android') || device.type === 'Mobile')) return true;
    return false;
  });
}

function threatRelevanceScore(vuln) {
  const relatedDevices = getRelatedDevicesForVulnerability(vuln);
  const avgRisk = relatedDevices.length
    ? relatedDevices.reduce((sum, device) => sum + device.riskScore, 0) / relatedDevices.length
    : 30;
  const exposureFactor = Math.min(1, vuln.affectedDevices / 500);
  const exploitFactor = vuln.exploited ? 1 : 0.55;
  const cvssFactor = Math.min(1, vuln.cvss / 10);
  const businessFactor = Math.min(1, avgRisk / 100);
  const score = Math.round((cvssFactor * 0.35 + exploitFactor * 0.25 + exposureFactor * 0.20 + businessFactor * 0.20) * 100);
  return { score, relatedDevices, avgRisk };
}

function scoreBand(score) {
  if (score >= 80) return 'critical';
  if (score >= 65) return 'high';
  return 'medium';
}

function renderThreatRelevance() {
  const ranked = vulnerabilities
    .map(vuln => ({ vuln, ...threatRelevanceScore(vuln) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);

  document.getElementById('threatRelevanceList').innerHTML = ranked.map(item => {
    const sevClass = scoreBand(item.score);
    return `
      <article class="threat-item" onclick="openThreatRelevanceDetail('${item.vuln.id}')">
        <div class="threat-head">
          <div class="threat-cve">${item.vuln.id}</div>
          <span class="threat-score ${sevClass}">Score ${item.score}</span>
        </div>
        <div class="threat-meta">
          ${item.vuln.title}<br>
          CVSS ${item.vuln.cvss.toFixed(1)} · ${item.vuln.exploited ? 'Actively exploited' : 'No active exploitation flag'} · ${item.vuln.affectedDevices} affected devices
        </div>
      </article>
    `;
  }).join('');
}

function remediationPriority(vuln) {
  const { score, relatedDevices, avgRisk } = threatRelevanceScore(vuln);
  const reductionEstimate = Math.round(Math.min(18, (vuln.cvss * 0.9) + (vuln.exploited ? 5 : 1) + (Math.min(vuln.affectedDevices, 500) / 120)));
  const action = vuln.exploited
    ? 'Patch in emergency window and isolate high-risk devices.'
    : vuln.cvss >= 8
      ? 'Patch in next maintenance cycle and verify compensating controls.'
      : 'Schedule normal patch cycle and monitor exploit telemetry.';
  const priority = score >= 80 ? 'P1' : score >= 65 ? 'P2' : 'P3';
  const cvssTone = vuln.cvss >= 9 ? 'critical' : vuln.cvss >= 7 ? 'high' : vuln.cvss >= 4 ? 'medium' : 'low';
  const exposureTone = vuln.affectedDevices >= 300 ? 'critical' : vuln.affectedDevices >= 150 ? 'high' : vuln.affectedDevices >= 60 ? 'medium' : 'low';
  const riskTone = avgRisk >= 70 ? 'critical' : avgRisk >= 55 ? 'high' : avgRisk >= 40 ? 'medium' : 'low';
  const tags = [
    { text: vuln.exploited ? 'Actively exploited' : 'No active exploit', tone: vuln.exploited ? 'critical' : 'low' },
    { text: `CVSS ${vuln.cvss.toFixed(1)}`, tone: cvssTone },
    { text: `${vuln.affectedDevices} exposed`, tone: exposureTone },
    { text: `Avg device risk ${avgRisk.toFixed(0)}`, tone: riskTone }
  ];
  return { priority, score, reductionEstimate, action, relatedDevices, tags };
}

function priorityLabel(priority) {
  if (priority === 'P1') return 'Critical';
  if (priority === 'P2') return 'Important';
  return 'Planned';
}

function remediationPlaybook(vuln) {
  const text = `${vuln.title} ${vuln.software}`.toLowerCase();
  const actions = [];

  if (text.includes('windows') || text.includes('server')) {
    actions.push('Apply latest Microsoft cumulative security update (Patch Tuesday baseline) for impacted Windows/Server builds.');
    actions.push('Expedite deployment to internet-facing and privileged endpoints first; enforce reboot completion SLA.');
    actions.push('Verify KB deployment success and vulnerability closure via post-patch rescans.');
  }
  if (text.includes('edge') || text.includes('browser') || text.includes('mshtml') || text.includes('scripting')) {
    actions.push('Update Microsoft Edge/WebView2 runtime to latest stable build across all affected devices.');
    actions.push('Temporarily enforce attack surface reduction and SmartScreen/URL filtering hardening for browser-origin threats.');
  }
  if (text.includes('kernel') || text.includes('elevation') || text.includes('privilege') || text.includes('winlogon')) {
    actions.push('Harden privileged access: enforce MFA/PAW for admins and reduce local admin assignments pending patch completion.');
    actions.push('Enable enhanced EDR blocking mode and monitor suspicious token or privilege escalation behaviors.');
  }
  if (text.includes('update') || text.includes('stack') || text.includes('driver') || text.includes('clfs')) {
    actions.push('Validate update orchestration health (WSUS/Intune/ConfigMgr) and remediate failed deployment rings.');
    actions.push('Block vulnerable legacy drivers/modules where possible using endpoint protection configuration.');
  }
  if (!actions.length) {
    actions.push('Apply vendor security patch to affected software versions and validate closure through rescanning.');
    actions.push('Apply compensating controls (isolation, policy restrictions, IOC blocking) until full patch coverage is achieved.');
  }

  return actions.slice(0, 5);
}

function renderRemediationQueue() {
  const ranked = vulnerabilities
    .map(vuln => ({ vuln, ...remediationPriority(vuln) }))
    .sort((a, b) => {
      const order = { P1: 3, P2: 2, P3: 1 };
      return (order[b.priority] - order[a.priority]) || (b.score - a.score);
    })
    .slice(0, 12);

  document.getElementById('remediationQueueList').innerHTML = ranked.map(item => `
    <article class="remediation-item" onclick="openRemediationDetail('${item.vuln.id}')">
      <div class="remediation-head">
        <div class="remediation-title">${item.vuln.id}</div>
        <span class="prio-tag ${item.priority.toLowerCase()}">${item.priority} · ${priorityLabel(item.priority)}</span>
      </div>
      <div class="remediation-meta">
        ${item.vuln.title}<br>
        Suggested action: ${item.action}<br>
        Est. exposure score reduction if fixed: ${item.reductionEstimate} pts
      </div>
      <div class="remediation-tags">
        ${item.tags.map(tag => `<span class="remediation-pill ${tag.tone}">${tag.text}</span>`).join('')}
      </div>
    </article>
  `).join('');
}

function renderRiskMatrix() {
  const matrix = document.getElementById('riskMatrix');
  const data = Array.from({ length: 5 }, () => Array.from({ length: 5 }, () => 0));
  riskCellCache = {};

  const likelihoodFromVulns = (vulns) => {
    if (vulns >= 10) return 5;
    if (vulns >= 7) return 4;
    if (vulns >= 4) return 3;
    if (vulns >= 2) return 2;
    return 1;
  };
  const impactFromRiskScore = (riskScore) => {
    if (riskScore >= 75) return 5;
    if (riskScore >= 55) return 4;
    if (riskScore >= 40) return 3;
    if (riskScore >= 25) return 2;
    return 1;
  };

  devices.forEach(device => {
    const likelihood = likelihoodFromVulns(device.vulns);
    const impact = impactFromRiskScore(device.riskScore);
    const li = 5 - likelihood;
    const im = impact - 1;
    data[li][im] += 1;
    const key = `${li}-${im}`;
    if (!riskCellCache[key]) riskCellCache[key] = [];
    riskCellCache[key].push(device);
  });

  const riskLevel = (li, im) => {
    const score = (5 - li) * (im + 1);
    if (score >= 20) return 'r5';
    if (score >= 15) return 'r4';
    if (score >= 10) return 'r3';
    if (score >= 5) return 'r2';
    return 'r1';
  };

  const yLabels = ['5', '4', '3', '2', '1'];
  let html = '';

  for (let li = 0; li < 5; li++) {
    html += `<div class="risk-label">${yLabels[li]}</div>`;
    for (let im = 0; im < 5; im++) {
      const count = data[li][im];
      const countClass = count ? 'has-count' : '';
      const content = riskMatrixMode === 'compact' ? '' : (count || '');
      html += `<div class="risk-cell ${riskLevel(li, im)} ${countClass}" title="Likelihood ${5-li}, Impact ${im+1}: ${count} device(s)" onclick="openRiskCellDetail(${li}, ${im})">${content}</div>`;
    }
  }

  // Bottom labels
  html += `<div></div>`;
  for (let i = 1; i <= 5; i++) {
    html += `<div class="risk-label-x">${i}</div>`;
  }

  matrix.className = `risk-matrix ${riskMatrixMode === 'compact' ? 'compact' : ''}`.trim();
  matrix.innerHTML = html;
}

function openRiskCellDetail(li, im) {
  const key = `${li}-${im}`;
  const cellDevices = riskCellCache[key] || [];
  const likelihood = 5 - li;
  const impact = im + 1;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  const severityRank = { Critical: 4, High: 3, Medium: 2, Low: 1 };

  const items = cellDevices.map(device => {
    const mappedVulns = mapVulnerabilitiesForDevice(device)
      .sort((a, b) => (severityRank[b.severity] || 0) - (severityRank[a.severity] || 0) || b.cvss - a.cvss);
    return { device, mappedVulns };
  });

  title.textContent = `Risk Matrix Cell — Likelihood ${likelihood}, Impact ${impact}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Cell Summary</div>
      <div class="detail-row"><span class="label">Devices in Cell</span><span class="value" style="font-family:JetBrains Mono;">${cellDevices.length}</span></div>
      <div class="detail-row"><span class="label">Likelihood</span><span class="value">${likelihood}</span></div>
      <div class="detail-row"><span class="label">Impact</span><span class="value">${impact}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Devices and Vulnerabilities</div>
      ${
        items.length
          ? items.map(({ device, mappedVulns }) => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore >= 75 ? 'var(--severity-critical)' : device.riskScore >= 55 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">${device.os} · ${device.location} · ${device.vulns} vuln(s)</div>
                ${
                  mappedVulns.length
                    ? `<div style="font-size:11px;color:var(--text-secondary);line-height:1.5;">
                        ${mappedVulns.map(v => `<div>• <span style=\"font-family:'JetBrains Mono',monospace;color:var(--text-primary);\">${v.id}</span> (${v.severity}, ${v.cvss.toFixed(1)}) - ${v.title}</div>`).join('')}
                      </div>`
                    : `<div style="font-size:11px;color:var(--text-muted);">No direct vulnerability mapping available in sample data.</div>`
                }
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No devices are currently mapped to this matrix cell.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function renderDeviceTable() {
  const tbody = document.getElementById('deviceTableBody');
  tbody.innerHTML = devices.map(d => {
    const healthClass = d.health.toLowerCase();
    let verClass = 'current';
    if (d.defenderVer.includes('2309') || d.defenderVer.includes('2305') || d.defenderVer.includes('2308')) verClass = 'critical';
    else if (!d.defenderVer.includes('24110') && !d.defenderVer.includes('24112')) verClass = 'outdated';

    return `<tr onclick="openDeviceDetail('${d.name}')">
      <td><span class="device-name">${d.name}</span></td>
      <td><span class="device-type-badge">${d.type === 'Server' ? '🖥' : d.type === 'Mobile' ? '📱' : '💻'} ${d.type}</span></td>
      <td style="font-size:11px;">${d.os}</td>
      <td style="font-size:11px;">${d.location}</td>
      <td><span class="health-indicator"><span class="health-dot ${healthClass}"></span>${d.health}</span></td>
      <td><span class="version-badge ${verClass}">${d.defenderVer}</span></td>
      <td style="font-family:'JetBrains Mono';font-size:11px;${d.vulns > 10 ? 'color:var(--severity-critical);font-weight:600;' : ''}">${d.vulns}</td>
      <td style="font-family:'JetBrains Mono';font-size:11px;">${d.caPolicies}</td>
    </tr>`;
  }).join('');
}

function renderCAPolicies() {
  const filteredPolicies = getFilteredPolicies();
  const container = document.getElementById('caPolicyList');
  container.innerHTML = filteredPolicies.map(p => {
    const stateClass = p.state === 'enabled' ? 'enabled' : p.state === 'report-only' ? 'report-only' : 'disabled';
    const coverageClass = p.coverage >= 90 ? 'high' : p.coverage >= 60 ? 'medium' : 'low';
    return `<div class="ca-item" onclick="openCADetail('${p.name}')">
      <div class="ca-item-header">
        <div class="ca-item-name">${p.name}</div>
        <span class="ca-status-badge ${stateClass}">${p.state === 'report-only' ? 'Report Only' : p.state.charAt(0).toUpperCase() + p.state.slice(1)}</span>
      </div>
      <div class="ca-detail-row">
        <span>👥 ${p.users.toLocaleString()} users</span>
        <span>📱 ${p.apps.length > 25 ? p.apps.substring(0,25)+'...' : p.apps}</span>
      </div>
      <div class="ca-coverage-bar">
        <div class="ca-coverage-fill ${coverageClass}" style="width:${p.coverage}%"></div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">${p.coverage}% coverage</div>
    </div>`;
  }).join('');

  if (!filteredPolicies.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px 2px;">No policies match the selected filter.</div>';
  }
}

function getFilteredPolicies() {
  if (activePolicyFilter === 'all') return caPolicies;
  if (activePolicyFilter === 'report-only') return caPolicies.filter(p => p.state === 'report-only');
  if (activePolicyFilter === 'low-coverage') return caPolicies.filter(p => p.coverage < 80);
  if (activePolicyFilter === 'high-gap') {
    return caPolicies.filter(p => assessPolicyGap(p).score >= 35);
  }
  return caPolicies;
}

function assessPolicyGap(policy) {
  const gaps = [];
  let score = 0;

  if (policy.state === 'report-only') {
    gaps.push('Policy is report-only and not enforcing control outcomes.');
    score += 40;
  }
  if (policy.coverage < 80) {
    gaps.push(`Coverage is ${policy.coverage}% and leaves broad user/app segments unprotected.`);
    score += 28;
  } else if (policy.coverage < 95) {
    gaps.push(`Coverage is ${policy.coverage}% and should be extended to close residual access paths.`);
    score += 14;
  }
  if (policy.grantControls.toLowerCase().includes('mfa') === false) {
    gaps.push('No explicit MFA/authentication-strength requirement in grant controls.');
    score += 18;
  }
  if (policy.sessionControls.toLowerCase() === 'none') {
    gaps.push('No session controls configured for token/session risk reduction.');
    score += 12;
  }

  const severity = score >= 55 ? 'critical' : score >= 35 ? 'high' : score >= 20 ? 'medium' : 'low';
  const mitre = POLICY_MITRE_MAP[policy.name] || { tactics: [], techniques: [], threats: [] };
  const recommendations = [];

  if (policy.state === 'report-only') recommendations.push('Move from report-only to enabled after pilot validation.');
  if (policy.coverage < 95) recommendations.push('Expand scope with phased rollout groups until >=95% coverage.');
  if (policy.grantControls.toLowerCase().includes('mfa') === false) recommendations.push('Add MFA or phishing-resistant authentication strength as a grant control.');
  if (policy.sessionControls.toLowerCase() === 'none') recommendations.push('Apply sign-in frequency/token protection/session restrictions for risky scenarios.');
  if (!recommendations.length) recommendations.push('Maintain current policy baseline and monitor exceptions weekly.');

  return { score, severity, gaps, mitre, recommendations };
}

function renderPolicyGapInsights() {
  const assessed = getFilteredPolicies().map(policy => ({ policy, ...assessPolicyGap(policy) }));
  const criticalCount = assessed.filter(x => x.severity === 'critical').length;
  const highCount = assessed.filter(x => x.severity === 'high').length;
  const reportOnlyCount = assessed.filter(x => x.policy.state === 'report-only').length;
  const avgCoverage = assessed.length ? Math.round(assessed.reduce((sum, x) => sum + x.policy.coverage, 0) / assessed.length) : 0;

  const summary = document.getElementById('policyGapSummary');
  if (summary) {
    summary.innerHTML = `
      <article class="policy-gap-cell">
        <div class="k">Critical Gaps</div>
        <div class="v" style="color:var(--severity-critical);">${criticalCount}</div>
        <div class="s">Immediate policy hardening required</div>
      </article>
      <article class="policy-gap-cell">
        <div class="k">High Gaps</div>
        <div class="v" style="color:var(--severity-high);">${highCount}</div>
        <div class="s">Address in current sprint</div>
      </article>
      <article class="policy-gap-cell">
        <div class="k">Avg Coverage</div>
        <div class="v">${avgCoverage}%</div>
        <div class="s">${reportOnlyCount} policies still report-only</div>
      </article>
    `;
  }

  const gapList = document.getElementById('policyGapList');
  if (gapList) {
    const top = assessed.sort((a, b) => b.score - a.score).slice(0, 5);
    gapList.innerHTML = top.length ? top.map(item => `
      <article class="policy-gap-item" role="button" tabindex="0" onclick="openCADetail('${item.policy.name}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openCADetail('${item.policy.name}')}">
        <div class="policy-gap-head">
          <div class="policy-gap-title">${item.policy.name}</div>
          <span class="policy-pill ${item.severity}">Gap ${item.score}</span>
        </div>
        <div class="policy-gap-meta">
          ${item.gaps[0] || 'No material gaps identified.'}<br>
          Recommended: ${item.recommendations[0]}
        </div>
      </article>
    `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No policy gaps match the selected filter.</div>';
  }
}

function renderPolicyMitreCoverage() {
  const container = document.getElementById('policyMitreList');
  if (!container) return;

  const rows = caPolicies
    .filter(policy => getFilteredPolicies().some(fp => fp.name === policy.name))
    .map(policy => ({ policy, ...assessPolicyGap(policy) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 6);

  container.innerHTML = rows.length ? rows.map(item => `
    <article class="policy-mitre-item" role="button" tabindex="0" onclick="openCADetail('${item.policy.name}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openCADetail('${item.policy.name}')}">
      <div class="policy-mitre-head">
        <div class="policy-mitre-title">${item.policy.name}</div>
        <span class="policy-pill ${item.severity}">${item.policy.coverage}%</span>
      </div>
      <div class="policy-mitre-meta">
        <strong>Tactics:</strong> ${item.mitre.tactics.join(', ') || 'Not mapped'}<br>
        <strong>Threats reduced:</strong> ${item.mitre.threats.join(', ') || 'Not mapped'}<br>
        <strong>Primary recommendation:</strong> ${item.recommendations[0]}
      </div>
    </article>
  `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No MITRE policy mappings match the selected filter.</div>';
}

function renderLocations() {
  const container = document.getElementById('locationGrid');
  container.innerHTML = locations.map(loc => {
    const total = loc.devices;
    const bars = [];
    for (let i = 0; i < Math.round(loc.healthy / total * 10); i++) bars.push(`<div class="loc-bar-seg" style="background:var(--status-compliant);"></div>`);
    for (let i = 0; i < Math.round(loc.warning / total * 10); i++) bars.push(`<div class="loc-bar-seg" style="background:var(--status-warning);"></div>`);
    for (let i = 0; i < Math.round(loc.critical / total * 10); i++) bars.push(`<div class="loc-bar-seg" style="background:var(--status-noncompliant);"></div>`);

    return `<div class="location-item" onclick="openDetail('location-${loc.name}')">
      <div class="location-info">
        <div class="location-flag">${loc.flag}</div>
        <div>
          <div class="location-name">${loc.name}</div>
          <div class="location-count">${loc.devices} devices</div>
        </div>
      </div>
      <div class="location-health">
        <div class="location-bar">${bars.join('')}</div>
        <div style="font-size:9px;color:var(--text-muted);">${loc.critical} critical</div>
      </div>
    </div>`;
  }).join('');
}

function renderAppGrid() {
  const container = document.getElementById('appGrid');
  container.innerHTML = softwareInventory.map(app => `
    <div class="app-item" onclick="openDetail('app-${app.name}')">
      <div class="app-name">${app.name}</div>
      <div class="app-vendor">${app.vendor} · v${app.version}</div>
      <div class="app-stats">
        <div class="app-stat">💻 <span class="num">${app.devices}</span> devices</div>
        <div class="app-stat" style="${app.vulns > 10 ? 'color:var(--severity-critical);' : app.vulns > 5 ? 'color:var(--severity-high);' : ''}">⚠ <span class="num">${app.vulns}</span> vulns</div>
      </div>
    </div>
  `).join('');
}

function renderDefenderVersionChart() {
  const data = [
    { label: '4.18.24110.x', value: 1089, color: 'var(--status-compliant)' },
    { label: '4.18.24090.x', value: 78, color: 'var(--status-warning)' },
    { label: '4.18.24050.x', value: 34, color: 'var(--severity-high)' },
    { label: '< 4.18.24000', value: 21, color: 'var(--status-noncompliant)' },
    { label: 'Linux/Mac agents', value: 25, color: 'var(--chart-3)' },
  ];
  const maxVal = Math.max(...data.map(d => d.value));
  document.getElementById('defenderVersionChart').innerHTML = data.map(d => `
    <div class="bar-row">
      <div class="bar-label">${d.label}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('');
}

function renderTrendChart() {
  const svg = document.getElementById('trendChart');
  // Generate 90 days of mock exposure score data
  const points = [];
  let score = 65;
  for (let i = 0; i < 90; i++) {
    score += (Math.random() - 0.45) * 3;
    score = Math.max(40, Math.min(85, score));
    points.push(score);
  }

  const w = 400, h = 180, padding = 20;
  const xStep = (w - padding * 2) / (points.length - 1);
  const minY = 35, maxY = 90;
  const scaleY = (v) => h - padding - ((v - minY) / (maxY - minY)) * (h - padding * 2);

  let pathD = '';
  let areaD = '';
  points.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = scaleY(p);
    if (i === 0) { pathD += `M ${x} ${y}`; areaD += `M ${x} ${h - padding} L ${x} ${y}`; }
    else { pathD += ` L ${x} ${y}`; areaD += ` L ${x} ${y}`; }
  });
  areaD += ` L ${padding + (points.length - 1) * xStep} ${h - padding} Z`;

  // Grid lines
  let grid = '';
  for (let v = 40; v <= 85; v += 15) {
    const y = scaleY(v);
    grid += `<line x1="${padding}" y1="${y}" x2="${w - padding}" y2="${y}" stroke="var(--border-subtle)" stroke-width="0.5"/>`;
    grid += `<text x="${padding - 4}" y="${y + 3}" text-anchor="end" fill="var(--text-muted)" font-size="8" font-family="JetBrains Mono">${v}</text>`;
  }

  // Month labels
  const months = ['Nov', 'Dec', 'Jan', 'Feb'];
  months.forEach((m, i) => {
    const x = padding + (i / (months.length - 1)) * (w - padding * 2);
    grid += `<text x="${x}" y="${h - 4}" text-anchor="middle" fill="var(--text-muted)" font-size="8" font-family="JetBrains Mono">${m}</text>`;
  });

  // Current value indicator
  const lastX = padding + (points.length - 1) * xStep;
  const lastY = scaleY(points[points.length - 1]);

  svg.innerHTML = `
    ${grid}
    <defs>
      <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--severity-high)" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="var(--severity-high)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <path d="${areaD}" fill="url(#areaGrad)"/>
    <path d="${pathD}" fill="none" stroke="var(--severity-high)" stroke-width="2" stroke-linecap="round"/>
    <circle cx="${lastX}" cy="${lastY}" r="4" fill="var(--severity-high)" stroke="var(--bg-card)" stroke-width="2"/>
    <text x="${lastX + 8}" y="${lastY + 4}" fill="var(--severity-high)" font-size="11" font-weight="700" font-family="JetBrains Mono">${points[points.length - 1].toFixed(1)}</text>
  `;
}

function renderDefenderStack() {
  const stack = [
    { label: 'Defender for Endpoint Coverage', value: '94.2%', sub: '1,169 / 1,241 devices healthy telemetry' },
    { label: 'Defender for Identity Sensor Coverage', value: '88.6%', sub: '31 / 35 domain controllers reporting' },
    { label: 'Engine / Signature Currency', value: '92.1%', sub: 'Engine 1.1.24090.11 · Sig 1.421.1889.0 baseline' },
  ];

  document.getElementById('defenderStackGrid').innerHTML = stack.map(item => `
    <article class="defender-cell">
      <div class="k">${item.label}</div>
      <div class="v">${item.value}</div>
      <div class="s">${item.sub}</div>
    </article>
  `).join('');

  const issues = [
    { issue: 'Endpoint sensor heartbeat delay >15m', impact: '22 devices', severity: 'var(--severity-high)' },
    { issue: 'Outdated endpoint engine versions', impact: '34 devices', severity: 'var(--severity-medium)' },
    { issue: 'Defender for Identity sensor disconnected', impact: '4 domain controllers', severity: 'var(--severity-critical)' },
    { issue: 'Conditional Access signal ingestion latency', impact: '11 mins avg', severity: 'var(--severity-medium)' },
    { issue: 'Proxy/TLS inspection causing telemetry drop', impact: '7 network segments', severity: 'var(--severity-high)' },
  ];
  document.getElementById('defenderCommIssues').innerHTML = issues.map(i => `
    <div class="defender-row">
      <span>${i.issue}</span>
      <span style="color:${i.severity};font-family:'JetBrains Mono',monospace;font-weight:700;">${i.impact}</span>
    </div>
  `).join('');
}

function renderMitreCoverage() {
  const tactics = [
    { name: 'Initial Access', coverage: 72, gaps: 5 },
    { name: 'Execution', coverage: 81, gaps: 3 },
    { name: 'Persistence', coverage: 68, gaps: 7 },
    { name: 'Privilege Escalation', coverage: 61, gaps: 8 },
    { name: 'Defense Evasion', coverage: 58, gaps: 10 },
    { name: 'Credential Access', coverage: 66, gaps: 6 },
    { name: 'Lateral Movement', coverage: 54, gaps: 9 },
    { name: 'Command and Control', coverage: 79, gaps: 4 },
    { name: 'Exfiltration', coverage: 63, gaps: 5 },
    { name: 'Impact', coverage: 74, gaps: 4 },
  ];

  document.getElementById('mitreTacticList').innerHTML = tactics.map(t => `
    <article class="mitre-tactic-row" role="button" tabindex="0" onclick="openMitreTacticDetail('${t.name}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openMitreTacticDetail('${t.name}')}">
      <div class="mitre-top">
        <div class="mitre-name">${t.name}</div>
        <div class="mitre-gap">${t.coverage}% coverage · ${t.gaps} gaps</div>
      </div>
      <div class="mitre-bar"><div class="mitre-fill" style="width:${t.coverage}%"></div></div>
    </article>
  `).join('');

  const heatCells = tactics.slice(0, 6).concat(tactics.slice(6, 10)).map(t => {
    const bg = t.coverage >= 80 ? '#bbf7d0' : t.coverage >= 65 ? '#fde68a' : '#fecaca';
    const color = t.coverage >= 80 ? '#14532D' : t.coverage >= 65 ? '#854D0E' : '#7F1D1D';
    return `<div class="mitre-cell" data-tactic="${t.name}" role="button" tabindex="0" style="background:${bg};color:${color};">${t.name}<br>${t.coverage}%</div>`;
  });
  document.getElementById('mitreHeatmap').innerHTML = heatCells.join('');
}

function setMitreMode(mode) {
  const list = document.getElementById('mitreTacticList');
  const heatmap = document.getElementById('mitreHeatmap');
  const card = document.querySelector('.mitre-card');
  if (!list || !heatmap || !card) return;

  const buttons = card.querySelectorAll('.card-actions .card-action-btn');
  const tacticsBtn = buttons[0];
  const heatmapBtn = buttons[1];

  if (mode === 'heatmap') {
    list.classList.add('hidden');
    heatmap.classList.remove('hidden');
    tacticsBtn.classList.remove('active');
    heatmapBtn.classList.add('active');
  } else {
    heatmap.classList.add('hidden');
    list.classList.remove('hidden');
    heatmapBtn.classList.remove('active');
    tacticsBtn.classList.add('active');
  }
}

function setupMitreInteractions() {
  const card = document.querySelector('.mitre-card');
  const heatmap = document.getElementById('mitreHeatmap');
  if (!card || !heatmap) return;

  const buttons = card.querySelectorAll('.card-actions .card-action-btn');
  const tacticsBtn = buttons[0];
  const heatmapBtn = buttons[1];

  tacticsBtn.onclick = () => setMitreMode('tactics');
  heatmapBtn.onclick = () => setMitreMode('heatmap');

  heatmap.addEventListener('click', (event) => {
    const cell = event.target.closest('.mitre-cell');
    if (!cell) return;
    const tactic = cell.dataset.tactic;
    if (tactic) openMitreTacticDetail(tactic);
  });

  heatmap.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    const cell = event.target.closest('.mitre-cell');
    if (!cell) return;
    event.preventDefault();
    const tactic = cell.dataset.tactic;
    if (tactic) openMitreTacticDetail(tactic);
  });

  setMitreMode('tactics');
}

function openMitreTacticDetail(tacticName) {
  const tacticMap = {
    'Initial Access': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['edge', 'windows', 'browser'], identitySignals: ['MFA gaps', 'Legacy auth attempts'], policyFilters: ['phishing', 'mfa', 'admin'] },
    'Execution': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['windows', 'management', 'kernel'], identitySignals: ['Suspicious process execution'], policyFilters: ['compliant', 'device'] },
    'Persistence': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['kernel', 'update', 'driver'], identitySignals: ['Service account anomalies'], policyFilters: ['admin', 'session'] },
    'Privilege Escalation': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['kernel', 'elevation', 'privilege'], identitySignals: ['Privileged role activations'], policyFilters: ['directory roles', 'admin'] },
    'Defense Evasion': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['spoofing', 'management', 'update'], identitySignals: ['Sensor tamper alerts'], policyFilters: ['token', 'sign-in'] },
    'Credential Access': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['winlogon', 'auth', 'credential'], identitySignals: ['Password spray / impossible travel'], policyFilters: ['mfa', 'authentication strength'] },
    'Lateral Movement': { deviceTypes: ['Server', 'Workstation'], cveKeywords: ['tcp/ip', 'remote', 'rce'], identitySignals: ['Abnormal east-west authentication'], policyFilters: ['network', 'location'] },
    'Command and Control': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['scripting', 'browser', 'remote'], identitySignals: ['Beaconing / anomalous outbound'], policyFilters: ['session controls', 'sign-in frequency'] },
    'Exfiltration': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['management', 'edge', 'windows'], identitySignals: ['Large data egress by identity'], policyFilters: ['app protection', 'session controls'] },
    'Impact': { deviceTypes: ['Server', 'Workstation'], cveKeywords: ['rce', 'critical', 'kernel'], identitySignals: ['Business-critical service disruption'], policyFilters: ['break-glass', 'incident response'] }
  };

  const map = tacticMap[tacticName] || { deviceTypes: [], cveKeywords: [], identitySignals: [], policyFilters: [] };

  const relatedDevices = devices
    .filter(device => map.deviceTypes.includes(device.type))
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const relatedVulns = vulnerabilities
    .filter(vuln => {
      const t = `${vuln.title} ${vuln.software}`.toLowerCase();
      return map.cveKeywords.some(key => t.includes(key));
    })
    .sort((a, b) => (b.exploited === a.exploited ? b.cvss - a.cvss : (b.exploited ? 1 : -1)))
    .slice(0, 8);

  const tacticKbRows = relatedVulns
    .flatMap(v => (KB_PATCH_MAP[v.id] || []).map(kb => ({ cveId: v.id, ...kb })))
    .slice(0, 12);

  const tacticRemediationActions = relatedVulns
    .slice(0, 4)
    .map(v => ({ cveId: v.id, actions: remediationPlaybook(v).slice(0, 2) }));

  const relatedPolicies = caPolicies
    .filter(policy => {
      const text = `${policy.name} ${policy.conditions} ${policy.grantControls} ${policy.sessionControls}`.toLowerCase();
      return map.policyFilters.some(key => text.includes(key.toLowerCase()));
    })
    .slice(0, 6);

  const identityFindings = map.identitySignals.map((signal, idx) => ({
    signal,
    value: idx === 0 ? `${Math.max(3, relatedDevices.length)} events` : idx === 1 ? `${Math.max(2, relatedPolicies.length)} control gaps` : `${Math.max(1, Math.round(relatedVulns.length / 2))} high-risk clusters`
  }));

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `MITRE ATT&CK — ${tacticName}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Tactic Context</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.65;">
        This view maps relevant devices, vulnerabilities, and identity/policy signals for the <strong style="color:var(--text-primary);">${tacticName}</strong> tactic to help identify detection and control gaps quickly.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Identity and Policy Signals</div>
      ${identityFindings.map(f => `<div class="detail-row"><span class="label">${f.signal}</span><span class="value">${f.value}</span></div>`).join('')}
      ${relatedPolicies.length ? `<div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Mapped CA policies: ${relatedPolicies.map(p => p.name).join(', ')}</div>` : '<div style="margin-top:8px;font-size:11px;color:var(--text-muted);">No directly mapped CA policies in sample data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Vulnerabilities</div>
      ${relatedVulns.length ? relatedVulns.map(v => `
        <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);">
          <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${v.id}</span>
          · ${v.title}
          <span style="float:right;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;">CVSS ${v.cvss.toFixed(1)}${v.exploited ? ' · Exploited' : ''}</span>
          <div style="margin-top:6px;color:var(--text-muted);font-size:10px;">
            ${(KB_PATCH_MAP[v.id] && KB_PATCH_MAP[v.id].length)
              ? `KB/Update: ${KB_PATCH_MAP[v.id].map(k => `${k.kb} (${k.target})`).join(' · ')}`
              : 'KB/Update: Validate in Microsoft Security Update Guide'}
          </div>
        </div>
      `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No mapped CVEs in sample data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Packages</div>
      ${
        tacticKbRows.length
          ? tacticKbRows.map(item => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
                <span><span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${item.cveId}</span> · <strong>${item.kb}</strong> · ${item.note}</span>
                <span style="font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">${item.target}</span>
              </div>
            `).join('')
          : `<div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
               No KB mapped in current tactic sample. Validate exact packages in
               <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>.
             </div>`
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      ${
        tacticRemediationActions.length
          ? tacticRemediationActions.map(item => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);line-height:1.6;">
                <div style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;margin-bottom:4px;">${item.cveId}</div>
                ${item.actions.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No patch actions available for mapped vulnerabilities.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Devices</div>
      ${relatedDevices.length ? relatedDevices.map(d => `
        <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
          <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${d.name}</span>
          <span>${d.os} · ${d.location} · Risk ${d.riskScore} · ${d.vulns} vuln(s)</span>
        </div>
      `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No related devices for this tactic in sample mapping.</div>'}
    </div>
  `;

  overlay.classList.add('visible');
}

// ===== DETAIL PANEL / DRILL-DOWN =====

function openDetail(type) {
  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  let html = '';

  if (type === 'exposure') {
    title.textContent = 'Exposure Score Breakdown';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Score</div>
        <div style="font-size:48px;font-weight:800;color:var(--severity-high);font-family:'JetBrains Mono';margin:8px 0;">72.4</div>
        <div style="font-size:12px;color:var(--text-secondary);">Your exposure score has increased by 3.2 points this week, primarily driven by 5 new critical CVEs affecting Windows endpoints.</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Contributing Factors</div>
        <div class="detail-row"><span class="label">Unpatched Critical CVEs</span><span class="value" style="color:var(--severity-critical);">23 (High Impact)</span></div>
        <div class="detail-row"><span class="label">Outdated Defender Agents</span><span class="value" style="color:var(--severity-high);">78 devices</span></div>
        <div class="detail-row"><span class="label">Non-compliant Devices</span><span class="value" style="color:var(--severity-medium);">162 devices</span></div>
        <div class="detail-row"><span class="label">Legacy OS (Unsupported)</span><span class="value" style="color:var(--severity-high);">23 devices</span></div>
        <div class="detail-row"><span class="label">Missing CA Policy Coverage</span><span class="value" style="color:var(--severity-medium);">3 gaps identified</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Recommendations</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
          1. Prioritise patching CVE-2024-38063 and CVE-2024-43491 — both are actively exploited.<br>
          2. Update Defender agents on 78 devices running versions older than 4.18.24090.<br>
          3. Migrate 23 Windows Server 2019 instances to Server 2022.<br>
          4. Enable the BYOD App Protection CA policy (currently report-only).
        </div>
      </div>
    `;
  } else {
    title.textContent = type;
    html = `<div class="detail-section">
      <div class="detail-section-title">Information</div>
      <div style="font-size:12px;color:var(--text-secondary);">
        Click any item in the dashboard to see detailed drill-down information here.
        In the live version, this panel will show real-time data from Microsoft Defender XDR via the Graph Security API.
      </div>
    </div>`;
  }

  body.innerHTML = html;
  overlay.classList.add('visible');
}

function openVulnDetail(cveId) {
  const vuln = vulnerabilities.find(v => v.id === cveId);
  if (!vuln) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = vuln.id;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Vulnerability Details</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:8px;">${vuln.title}</div>
      ${vuln.exploited ? '<div style="padding:6px 12px;background:rgba(255,59,92,0.12);border-radius:6px;color:var(--severity-critical);font-size:12px;font-weight:600;margin-bottom:12px;">⚡ Actively Exploited in the Wild</div>' : ''}
      <div class="detail-row"><span class="label">CVE ID</span><span class="value" style="font-family:JetBrains Mono;">${vuln.id}</span></div>
      <div class="detail-row"><span class="label">Severity</span><span class="value" style="color:var(--severity-${vuln.severity.toLowerCase()});">${vuln.severity}</span></div>
      <div class="detail-row"><span class="label">CVSS Score</span><span class="value" style="font-family:JetBrains Mono;">${vuln.cvss.toFixed(1)}</span></div>
      <div class="detail-row"><span class="label">Affected Software</span><span class="value">${vuln.software}</span></div>
      <div class="detail-row"><span class="label">Affected Devices</span><span class="value" style="font-family:JetBrains Mono;">${vuln.affectedDevices}</span></div>
      <div class="detail-row"><span class="label">Published</span><span class="value">${vuln.published}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Affected Device Types</div>
      <div class="bar-chart">
        <div class="bar-row"><div class="bar-label">Workstations</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.6 / 5)}%;background:var(--chart-1);">${Math.round(vuln.affectedDevices * 0.6)}</div></div></div>
        <div class="bar-row"><div class="bar-label">Servers</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.3 / 5)}%;background:var(--chart-2);">${Math.round(vuln.affectedDevices * 0.3)}</div></div></div>
        <div class="bar-row"><div class="bar-label">Other</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.1 / 5)}%;background:var(--chart-3);">${Math.round(vuln.affectedDevices * 0.1)}</div></div></div>
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Remediation</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        Apply the latest security update from Microsoft. This vulnerability is addressed in the ${vuln.published.substring(0,7)} Patch Tuesday cumulative update. Prioritise deployment to internet-facing devices and servers.
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function openThreatRelevanceDetail(cveId) {
  const vuln = vulnerabilities.find(v => v.id === cveId);
  if (!vuln) return;

  const { score, relatedDevices, avgRisk } = threatRelevanceScore(vuln);
  const kbPatches = KB_PATCH_MAP[vuln.id] || [];
  const playbook = remediationPlaybook(vuln);
  const topDevices = relatedDevices
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 8);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${vuln.id} — Threat Relevance`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Priority Summary</div>
      <div style="font-size:40px;font-weight:800;color:${score >= 80 ? 'var(--severity-critical)' : score >= 65 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono';margin:6px 0;">${score}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${vuln.title}</div>
      <div class="detail-row"><span class="label">CVSS</span><span class="value">${vuln.cvss.toFixed(1)}</span></div>
      <div class="detail-row"><span class="label">Exploit Status</span><span class="value" style="color:${vuln.exploited ? 'var(--severity-critical)' : 'var(--text-primary)'};">${vuln.exploited ? 'Actively exploited' : 'Not currently flagged as exploited'}</span></div>
      <div class="detail-row"><span class="label">Affected Devices (global estimate)</span><span class="value">${vuln.affectedDevices}</span></div>
      <div class="detail-row"><span class="label">Avg Risk of Related Devices</span><span class="value">${avgRisk.toFixed(1)}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Impacted Devices in Environment (Sample Mapping)</div>
      ${
        topDevices.length
          ? topDevices.map(device => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${device.os} · ${device.location} · ${device.vulns} vuln(s)</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No matching devices found in current sample data mapping.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Package</div>
      ${
        kbPatches.length
          ? kbPatches.map(item => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${item.kb}</div>
                  <div style="font-size:10px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${item.target}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${item.note}</div>
              </div>
            `).join('')
          : `
              <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
                No KB mapped in local model. Validate exact package in Microsoft Security Update Guide:
                <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>
              </div>
            `
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        ${playbook.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function openRemediationDetail(cveId) {
  const vuln = vulnerabilities.find(v => v.id === cveId);
  if (!vuln) return;

  const details = remediationPriority(vuln);
  const playbook = remediationPlaybook(vuln);
  const kbPatches = KB_PATCH_MAP[vuln.id] || [];
  const impacted = details.relatedDevices
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${vuln.id} — Remediation Plan`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Priority Decision</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <span class="prio-tag ${details.priority.toLowerCase()}">${details.priority} · ${priorityLabel(details.priority)}</span>
        <span style="font-size:12px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Score ${details.score}</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        ${details.action}
      </div>
      <div class="detail-row"><span class="label">Estimated Risk Reduction</span><span class="value" style="font-family:JetBrains Mono;">${details.reductionEstimate} pts</span></div>
      <div class="detail-row"><span class="label">Exploit Status</span><span class="value" style="color:${vuln.exploited ? 'var(--severity-critical)' : 'var(--text-primary)'};">${vuln.exploited ? 'Actively exploited' : 'Not currently flagged as exploited'}</span></div>
      <div class="detail-row"><span class="label">Affected Devices</span><span class="value">${vuln.affectedDevices}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Sequence</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        1. Validate patch/package availability and rollback plan.<br>
        2. Patch highest risk devices first (critical or internet-facing cohorts).<br>
        3. Apply compensating controls until patch completion (CA policy, isolation, block indicators).<br>
        4. Recalculate exposure and confirm reduction target.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Package</div>
      ${
        kbPatches.length
          ? kbPatches.map(item => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${item.kb}</div>
                  <div style="font-size:10px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${item.target}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${item.note}</div>
              </div>
            `).join('')
          : `
              <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
                No KB mapped in local model. Validate exact package in Microsoft Security Update Guide:
                <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>
              </div>
            `
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        ${playbook.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Impacted Devices (Sample Mapping)</div>
      ${
        impacted.length
          ? impacted.map(device => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${device.os} · ${device.location} · ${device.vulns} vuln(s)</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No matching impacted devices in current sample data mapping.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function openDeviceDetail(deviceName) {
  const device = devices.find(d => d.name === deviceName);
  if (!device) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = device.name;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Device Information</div>
      <div class="detail-row"><span class="label">Device Name</span><span class="value" style="font-family:JetBrains Mono;">${device.name}</span></div>
      <div class="detail-row"><span class="label">Type</span><span class="value">${device.type}</span></div>
      <div class="detail-row"><span class="label">Operating System</span><span class="value">${device.os}</span></div>
      <div class="detail-row"><span class="label">Location</span><span class="value">${device.location}</span></div>
      <div class="detail-row"><span class="label">Last Seen</span><span class="value">${new Date(device.lastSeen).toLocaleString()}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Security Posture</div>
      <div class="detail-row"><span class="label">Health Status</span><span class="value"><span class="health-indicator"><span class="health-dot ${device.health.toLowerCase()}"></span>${device.health}</span></span></div>
      <div class="detail-row"><span class="label">Risk Score</span><span class="value" style="font-family:JetBrains Mono;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--status-compliant)'};">${device.riskScore}/100</span></div>
      <div class="detail-row"><span class="label">Defender Version</span><span class="value" style="font-family:JetBrains Mono;">${device.defenderVer}</span></div>
      <div class="detail-row"><span class="label">Open Vulnerabilities</span><span class="value" style="font-family:JetBrains Mono;${device.vulns > 10 ? 'color:var(--severity-critical);' : ''}">${device.vulns}</span></div>
      <div class="detail-row"><span class="label">CA Policies Applied</span><span class="value" style="font-family:JetBrains Mono;">${device.caPolicies}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Applied Conditional Access Policies</div>
      <div class="detail-tag-list">
        ${caPolicies.slice(0, device.caPolicies).map(p => `<div class="detail-tag">${p.name}</div>`).join('')}
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function openCADetail(policyName) {
  const policy = caPolicies.find(p => p.name === policyName);
  if (!policy) return;
  const assessment = assessPolicyGap(policy);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = policy.name;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Policy Configuration</div>
      <div class="detail-row"><span class="label">State</span><span class="value"><span class="ca-status-badge ${policy.state === 'enabled' ? 'enabled' : 'report-only'}">${policy.state === 'report-only' ? 'Report Only' : 'Enabled'}</span></span></div>
      <div class="detail-row"><span class="label">Coverage</span><span class="value" style="font-family:JetBrains Mono;">${policy.coverage}%</span></div>
      <div class="detail-row"><span class="label">Affected Users</span><span class="value" style="font-family:JetBrains Mono;">${policy.users.toLocaleString()}</span></div>
      <div class="detail-row"><span class="label">Gap Score</span><span class="value"><span class="policy-pill ${assessment.severity}">${assessment.score}</span></span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Conditions</div>
      <div class="detail-row"><span class="label">Cloud Apps</span><span class="value">${policy.apps}</span></div>
      <div class="detail-row"><span class="label">Platforms / Conditions</span><span class="value">${policy.conditions}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Controls</div>
      <div class="detail-row"><span class="label">Grant Controls</span><span class="value">${policy.grantControls}</span></div>
      <div class="detail-row"><span class="label">Session Controls</span><span class="value">${policy.sessionControls}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Identified Gaps</div>
      ${
        assessment.gaps.length
          ? assessment.gaps.map(gap => `<div style="font-size:12px;color:var(--text-secondary);line-height:1.6;margin-bottom:6px;">• ${gap}</div>`).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No significant gaps detected in current model.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        ${assessment.recommendations.map((action, idx) => `${idx + 1}. ${action}`).join('<br>')}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">MITRE ATT&amp;CK References</div>
      <div class="detail-row"><span class="label">Tactics</span><span class="value">${assessment.mitre.tactics.join(', ') || 'Not mapped'}</span></div>
      <div class="detail-row"><span class="label">Techniques</span><span class="value">${assessment.mitre.techniques.join(', ') || 'Not mapped'}</span></div>
      <div class="detail-row"><span class="label">Threat Patterns</span><span class="value">${assessment.mitre.threats.join(', ') || 'Not mapped'}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">API Reference</div>
      <div style="font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono';background:var(--bg-elevated);padding:10px;border-radius:6px;word-break:break-all;">
        GET https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies/{id}
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function closeDetail(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('detailOverlay').classList.remove('visible');
}

// ===== FILTER CHIPS =====
document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-filter]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
  });
});

document.querySelectorAll('.filter-chip[data-sev]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-sev]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
  });
});

document.querySelectorAll('.filter-chip[data-policy-filter]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-policy-filter]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    activePolicyFilter = chip.dataset.policyFilter || 'all';
    renderCAPolicies();
    renderPolicyGapInsights();
    renderPolicyMitreCoverage();
  });
});

// ===== VIEW SWITCHING =====
function applyView(view) {
  const grid = document.querySelector('.dashboard-grid');
  if (grid) {
    if (view === 'overview') grid.classList.add('overview-layout');
    else grid.classList.remove('overview-layout');
  }

  document.body.setAttribute('data-active-view', view);

  document.querySelectorAll('.dashboard-grid .card').forEach(card => {
    const views = (card.dataset.views || 'overview').split(',').map(v => v.trim());
    if (views.includes(view)) card.classList.remove('view-hidden');
    else card.classList.add('view-hidden');
  });
}

function switchView(view, el) {
  document.querySelectorAll('.topnav-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  applyView(view);
}

// ===== CONNECT TENANT =====
function showConnectInfo() {
  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = 'Connect to Microsoft Tenant';
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Prerequisites</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
        To connect live Defender XDR data, you need an <strong style="color:var(--text-primary);">Entra ID App Registration</strong> configured with permissions against <strong style="color:var(--text-primary);">two separate API resources</strong>. A tenant admin must grant consent for the application permissions.
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">API Resource 1: Microsoft Graph</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Resource: <span style="font-family:JetBrains Mono;color:var(--text-secondary);">https://graph.microsoft.com</span></div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Select "Microsoft Graph" when adding permissions in the App Registration.</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;"><strong style="color:var(--text-primary);">Required for current endpoints:</strong></div>
      <div style="font-family:'JetBrains Mono';font-size:11px;background:var(--bg-elevated);padding:12px;border-radius:6px;line-height:2;">
        <span style="color:var(--accent-ninja);">SecurityAlert.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— XDR alert data (alerts_v2)</span><br>
        <span style="color:var(--accent-ninja);">ThreatHunting.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Advanced hunting via Graph</span><br>
        <span style="color:var(--accent-ninja);">Policy.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Conditional Access policies</span><br>
        <span style="color:var(--accent-ninja);">DeviceManagementManagedDevices.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Intune device inventory</span>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin:10px 0 6px;"><strong style="color:var(--text-primary);">Optional (add only if feature is enabled):</strong></div>
      <div style="font-family:'JetBrains Mono';font-size:11px;background:var(--bg-elevated);padding:12px;border-radius:6px;line-height:2;">
        <span style="color:var(--accent-ninja);">SecurityEvents.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— only if ingesting incident/event APIs</span><br>
        <span style="color:var(--accent-ninja);">Directory.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— only if reading directory objects beyond CA policy payload</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">API Resource 2: WindowsDefenderATP</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Resource: <span style="font-family:JetBrains Mono;color:var(--text-secondary);">https://api.securitycenter.microsoft.com</span></div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">Search "WindowsDefenderATP" under <em>APIs my organization uses</em> in the App Registration.</div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;"><strong style="color:var(--text-primary);">Required for currently listed Defender endpoints:</strong></div>
      <div style="font-family:'JetBrains Mono';font-size:11px;background:var(--bg-elevated);padding:12px;border-radius:6px;line-height:2;">
        <span style="color:var(--chart-2);">Machine.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Device inventory, health</span><br>
        <span style="color:var(--chart-2);">Vulnerability.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— CVE data per device</span><br>
        <span style="color:var(--chart-2);">Software.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Software inventory</span><br>
        <span style="color:var(--chart-2);">Score.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— Exposure &amp; Secure Score</span><br>
        <span style="color:var(--chart-2);">AdvancedQuery.Read.All</span> <span style="color:var(--text-muted);font-size:9px;">— KQL advanced hunting</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">API Endpoints Used by This Dashboard</div>
      <div style="font-family:'JetBrains Mono';font-size:10px;background:var(--bg-elevated);padding:12px;border-radius:6px;line-height:2.4;word-break:break-all;">
        <span style="color:var(--text-muted);font-size:9px;">── Microsoft Graph ──</span><br>
        <span style="color:var(--accent-ninja);">GET</span> <span style="color:var(--text-secondary);">graph.microsoft.com/v1.0/security/alerts_v2</span><br>
        <span style="color:var(--accent-ninja);">POST</span> <span style="color:var(--text-secondary);">graph.microsoft.com/v1.0/security/runHuntingQuery</span><br>
        <span style="color:var(--accent-ninja);">GET</span> <span style="color:var(--text-secondary);">graph.microsoft.com/v1.0/identity/conditionalAccess/policies</span><br>
        <span style="color:var(--accent-ninja);">GET</span> <span style="color:var(--text-secondary);">graph.microsoft.com/v1.0/deviceManagement/managedDevices</span><br>
        <br>
        <span style="color:var(--text-muted);font-size:9px;">── Defender for Endpoint ──</span><br>
        <span style="color:var(--chart-2);">GET</span> <span style="color:var(--text-secondary);">api.securitycenter.microsoft.com/api/machines</span><br>
        <span style="color:var(--chart-2);">GET</span> <span style="color:var(--text-secondary);">api.securitycenter.microsoft.com/api/vulnerabilities</span><br>
        <span style="color:var(--chart-2);">GET</span> <span style="color:var(--text-secondary);">api.securitycenter.microsoft.com/api/Software</span><br>
        <span style="color:var(--chart-2);">POST</span> <span style="color:var(--text-secondary);">api.securitycenter.microsoft.com/api/advancedqueries/run</span><br>
        <span style="color:var(--chart-2);">GET</span> <span style="color:var(--text-secondary);">api.securitycenter.microsoft.com/api/exposureScore</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">Hosting &amp; Authentication</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
        <strong style="color:var(--text-primary);">Option A — Browser-Only (MSAL.js)</strong><br>
        The user authenticates via MSAL.js with their Microsoft 365 credentials. The dashboard acquires tokens for both <em>Microsoft Graph</em> and <em>WindowsDefenderATP</em> resource scopes. Data flows directly from the APIs to the browser — no backend server, no data leaves the customer's control.<br><br>
        <strong style="color:var(--text-primary);">Option B — Backend Proxy (Recommended for Production)</strong><br>
        A lightweight Azure App Service or Azure Static Web Apps API handles the OAuth2 client credentials flow, acquires tokens for both API resources, caches responses, and serves aggregated data to the frontend. Avoids Graph API rate limits and allows scheduled data refresh.<br><br>
        <span style="color:var(--text-muted);font-size:11px;">Both options require a tenant admin to grant admin consent for the application permissions listed above.</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">Setup Steps</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;">
        <span style="color:var(--accent-ninja);font-weight:600;">1.</span> Register an app in <strong style="color:var(--text-primary);">Entra ID → App registrations → New registration</strong><br>
        <span style="color:var(--accent-ninja);font-weight:600;">2.</span> Under <strong style="color:var(--text-primary);">API permissions → Add permission</strong>, add only the <strong style="color:var(--text-primary);">required</strong> Microsoft Graph permissions first<br>
        <span style="color:var(--accent-ninja);font-weight:600;">3.</span> Under <strong style="color:var(--text-primary);">API permissions → Add permission → APIs my organization uses</strong>, search "WindowsDefenderATP" and add only required Defender permissions for enabled endpoints<br>
        <span style="color:var(--accent-ninja);font-weight:600;">4.</span> Click <strong style="color:var(--text-primary);">Grant admin consent</strong> for your tenant<br>
        <span style="color:var(--accent-ninja);font-weight:600;">5.</span> Note the <strong style="color:var(--text-primary);">Application (client) ID</strong> and <strong style="color:var(--text-primary);">Directory (tenant) ID</strong><br>
        <span style="color:var(--accent-ninja);font-weight:600;">6.</span> Configure the Redirect URI to match your dashboard hosting URL<br>
        <span style="color:var(--accent-ninja);font-weight:600;">7.</span> Enter your Client ID and Tenant ID below to connect
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--text-muted);">
        Expected redirect URI for this deployment:
        <span style="display:block;margin-top:4px;font-family:'JetBrains Mono',monospace;background:var(--bg-elevated);padding:8px 10px;border-radius:6px;color:var(--text-secondary);word-break:break-all;">${resolveRedirectUri()}</span>
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-section-title">Connect Your Tenant</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div>
          <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Tenant ID</label>
          <input type="text" id="tenantIdInput" placeholder="e.g. 72f988bf-86f1-41af-91ab-2d7cd011db47" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;" onfocus="this.style.borderColor='var(--accent-ninja)'" onblur="this.style.borderColor='var(--border)'">
        </div>
        <div>
          <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Application (Client) ID</label>
          <input type="text" id="clientIdInput" placeholder="e.g. 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d" style="width:100%;padding:8px 12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;" onfocus="this.style.borderColor='var(--accent-ninja)'" onblur="this.style.borderColor='var(--border)'">
        </div>
        <button onclick="attemptConnect()" style="padding:10px 20px;background:var(--accent-ninja);color:var(--bg-primary);border:none;border-radius:6px;font-weight:700;font-size:13px;font-family:inherit;cursor:pointer;margin-top:4px;transition:var(--transition);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
          Authenticate with Microsoft
        </button>
        <div id="connectStatus" style="font-size:11px;color:var(--text-muted);"></div>
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

async function attemptConnect() {
  const tenantId = document.getElementById('tenantIdInput').value.trim();
  const clientId = document.getElementById('clientIdInput').value.trim();
  const status = document.getElementById('connectStatus');

  if (!tenantId || !clientId) {
    status.innerHTML = '<span style="color:var(--severity-high);">Please enter both Tenant ID and Client ID.</span>';
    return;
  }

  // Validate GUID format
  const guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!guidRegex.test(tenantId) || !guidRegex.test(clientId)) {
    status.innerHTML = '<span style="color:var(--severity-high);">IDs must be valid GUIDs (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx).</span>';
    return;
  }

  status.innerHTML = '<span style="color:var(--text-secondary);">Authenticating with Microsoft...</span>';

  try {
    const app = await getOrCreateMsalInstance(tenantId, clientId);

    const loginResponse = await app.loginPopup({
      scopes: GRAPH_CONNECT_SCOPES,
      prompt: 'select_account'
    });

    const account = loginResponse.account || app.getActiveAccount() || app.getAllAccounts()[0];
    if (account) app.setActiveAccount(account);

    const tokenResponse = await app.acquireTokenSilent({
      scopes: GRAPH_CONNECT_SCOPES,
      account
    });

    const expiresOn = tokenResponse.expiresOn
      ? new Date(tokenResponse.expiresOn).toLocaleString()
      : 'n/a';
    status.innerHTML = `<span style="color:var(--status-compliant);">Connected as ${account?.username || 'authenticated user'}. Graph token acquired (expires ${expiresOn}).</span>`;
  } catch (err) {
    const message = err && err.message ? err.message : 'Authentication failed.';
    const hint = message.includes('MSAL library not loaded')
      ? ' Check internet access, browser/content-blockers, CSP policy, and that this page is served over http/https (not restricted local mode).'
      : '';
    status.innerHTML = `<span style="color:var(--severity-high);">Connection failed: ${message}.${hint}</span>`;
  }
}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeDetail();
});

// ===== INIT =====
function init() {
  renderVulnList();
  renderDeviceTypeSummary();
  renderDeviceOsSummary();
  renderDeviceTypeChart();
  renderDeviceOsChart();
  renderThreatRelevance();
  renderRemediationQueue();
  renderRiskMatrix();
  renderDeviceTable();
  renderCAPolicies();
  renderPolicyGapInsights();
  renderPolicyMitreCoverage();
  renderLocations();
  renderAppGrid();
  renderDefenderVersionChart();
  renderDefenderStack();
  renderMitreCoverage();
  setupMitreInteractions();
  renderTrendChart();
  applyView('overview');
}

init();
</script>
</body>
</html>
