<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Security Ninja Ltd | XDR Compliance Centre</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://alcdn.msauth.net/browser/2.39.0/js/msal-browser.min.js"></script>
<link rel="stylesheet" href="styles/main.css">
</head>
<body>

<!-- ===== TOP NAVIGATION ===== -->
<nav class="topnav">
  <div class="topnav-brand">
    <img src="Website Logo 2.png" alt="Security Ninja logo" class="topnav-logo">
    <div class="topnav-subtitle">XDR Compliance Centre</div>
  </div>

  <div class="topnav-center">
    <button class="topnav-tab active" data-view="overview" onclick="switchView('overview', this)">Overview</button>
    <button class="topnav-tab" data-view="devices" onclick="switchView('devices', this)">Devices</button>
    <button class="topnav-tab" data-view="policies" onclick="switchView('policies', this)">Policies</button>
    <button class="topnav-tab" data-view="threat" onclick="switchView('threat', this)">Vulnerabilities</button>
    <button class="topnav-tab" data-view="standards" onclick="switchView('standards', this)">Standards</button>
  </div>

  <div class="topnav-right">
    <button class="theme-toggle-btn" type="button" id="nightModeBtn" aria-label="Enable dark mode" title="Toggle dark mode">
      <svg class="icon-moon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M20 14.2A8 8 0 1 1 9.8 4a6.5 6.5 0 1 0 10.2 10.2Z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <svg class="icon-sun" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.8"/>
        <path d="M12 2v2.4M12 19.6V22M4.9 4.9l1.7 1.7M17.4 17.4l1.7 1.7M2 12h2.4M19.6 12H22M4.9 19.1l1.7-1.7M17.4 6.6l1.7-1.7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      </svg>
    </button>
    <div class="topnav-status">
      <span class="status-dot"></span>
      <span id="dataModeLabel">MOCK DATA</span>
    </div>
    <button class="theme-toggle-btn btn-help-icon" type="button" onclick="openHelpPanel()" aria-label="Open help" title="Open help">?</button>
    <div class="connect-tenant-wrap">
      <button class="btn-connect" onclick="showConnectInfo()">Connect Tenant</button>
      <div class="portal-version">Portal ver 1.0</div>
    </div>
  </div>
</nav>

<!-- ===== MAIN CONTENT ===== -->
<main class="main-content">
  <div class="auth-banner" id="authBanner" role="alert" aria-live="polite">
    <div class="auth-banner-text" id="authBannerText">Session expired. Reconnect tenant to resume live updates.</div>
    <button class="auth-banner-btn" type="button" onclick="showConnectInfo()">Reconnect Tenant</button>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <span class="filter-label">Filter:</span>
    <button class="filter-chip active" data-filter="all">All Data</button>
    <button class="filter-chip" data-filter="critical">Critical Only</button>
    <button class="filter-chip" data-filter="last7">Last 7 Days</button>
    <button class="filter-chip" data-filter="last30">Last 30 Days</button>
    <span style="flex:1;"></span>
    <span class="filter-label">Severity:</span>
    <button class="filter-chip active" data-sev="all">All</button>
    <button class="filter-chip" data-sev="critical" style="color:var(--severity-critical);">Critical</button>
    <button class="filter-chip" data-sev="high" style="color:var(--severity-high);">High</button>
    <button class="filter-chip" data-sev="medium" style="color:var(--severity-medium);">Medium</button>
    <button class="filter-chip" data-sev="low" style="color:var(--severity-low);">Low</button>
  </div>

  <!-- Executive Summary Strip -->
  <div class="exec-strip">
    <div class="exec-card critical" onclick="openDetail('exposure')">
      <div class="exec-label">Exposure Score</div>
      <div class="exec-value critical" id="execExposureValue">72.4</div>
      <div class="exec-sub" id="execExposureSub"><span class="trend-up">â–² 3.2</span> vs last week</div>
    </div>
    <div class="exec-card info" onclick="openDetail('mitreCompliance')">
      <div class="exec-label">MITRE ATT&CK Compliance</div>
      <div class="exec-value info" id="execMitreComplianceValue">68%</div>
      <div class="exec-sub" id="execMitreComplianceSub">6 tactics below 70%</div>
    </div>
    <div class="exec-card warning" onclick="openDetail('criticalVulns')">
      <div class="exec-label">Critical Vulns</div>
      <div class="exec-value warning" id="execCriticalVulnsValue">23</div>
      <div class="exec-sub" id="execCriticalVulnsSub"><span class="trend-up">â–² 5</span> new this week</div>
    </div>
    <div class="exec-card good" onclick="openDetail('deviceCompliance')">
      <div class="exec-label">Device Compliance</div>
      <div class="exec-value good" id="execDeviceComplianceValue">87%</div>
      <div class="exec-sub" id="execDeviceComplianceSub"><span class="trend-down">â–¼ 2%</span> improvement</div>
    </div>
    <div class="exec-card info" onclick="openDetail('totalDevices')">
      <div class="exec-label">Managed Devices</div>
      <div class="exec-value info" id="execManagedDevicesValue">1,247</div>
      <div class="exec-sub" id="execManagedDevicesSub"></div>
    </div>
    <div class="exec-card neutral" onclick="openDetail('caPolicies')">
      <div class="exec-label">CA Policies Active</div>
      <div class="exec-value neutral" id="execPoliciesValue">18</div>
      <div class="exec-sub" id="execPoliciesSub">3 in report-only</div>
    </div>
    <div class="exec-card mixed" onclick="openDetail('defenderCoverage')">
      <div class="exec-label">Defender Coverage</div>
      <div class="exec-value mixed" id="execDefenderCoverageValue">94%</div>
      <div class="exec-sub" id="execDefenderCoverageSub">78 devices outdated</div>
    </div>
  </div>

  <!-- Dashboard Grid -->
  <div class="dashboard-grid">

    <!-- Vulnerability Severity Breakdown -->
    <div class="card vuln-main-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14.5 13H1.5L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 6V9M8 11V11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Vulnerability Severity
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="vulnViewSummaryBtn" type="button">Summary</button>
          <button class="card-action-btn" id="vulnViewByOsBtn" type="button">By OS</button>
        </div>
      </div>
      <div class="card-body">
        <div class="vuln-severity-grid" id="vulnSeverityGrid">
          <div class="severity-cell crit" onclick="openDetail('vulnCritical')">
            <div class="sev-count" id="sevCountCritical">23</div>
            <div class="sev-label">Critical</div>
          </div>
          <div class="severity-cell high" onclick="openDetail('vulnHigh')">
            <div class="sev-count" id="sevCountHigh">67</div>
            <div class="sev-label">High</div>
          </div>
          <div class="severity-cell med" onclick="openDetail('vulnMedium')">
            <div class="sev-count" id="sevCountMedium">142</div>
            <div class="sev-label">Medium</div>
          </div>
          <div class="severity-cell low" onclick="openDetail('vulnLow')">
            <div class="sev-count" id="sevCountLow">89</div>
            <div class="sev-label">Low</div>
          </div>
        </div>
        <div class="vuln-list-wrap">
          <div class="vuln-list" id="vulnList"></div>
        </div>
      </div>
    </div>

    <!-- Device Health by Type (Donut) -->
    <div class="card device-type-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 14H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Devices by Type
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:4px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Total Devices</div>
          <div id="deviceTypeTotal" style="font-size:28px;font-weight:800;line-height:1;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0</div>
          <div style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Across all device types</div>
        </div>
        <div style="margin-top: 2px;">
          <div class="bar-chart" id="deviceTypeChart"></div>
        </div>
      </div>
    </div>

    <!-- Risk Matrix -->
    <div class="card risk-matrix-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="1" width="14" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M1 5H15M1 9H15M5 1V15M9 1V15" stroke="currentColor" stroke-width="0.7" opacity="0.4"/></svg>
          </span>
          Risk Matrix
        </div>
      </div>
      <div class="card-body">
        <div class="risk-matrix" id="riskMatrix"></div>
      </div>
    </div>

    <!-- Devices by OS -->
    <div class="card os-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h9A1.5 1.5 0 0 1 14 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 12.5v-9Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6h12" stroke="currentColor" stroke-width="1.5"/><path d="M5 9.5h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Devices by OS
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:4px;margin-bottom:2px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Total Devices</div>
          <div id="deviceOsTotal" style="font-size:28px;font-weight:800;line-height:1;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0</div>
          <div style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Across all operating systems</div>
        </div>
        <div class="bar-chart" id="deviceOsChart"></div>
      </div>
    </div>

    <!-- Top Vulnerable Software -->
    <div class="card span-2 software-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3C2 2.44772 2.44772 2 3 2Z" stroke="currentColor" stroke-width="1.5"/><path d="M5 6L7 8L5 10M9 10H11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Vulnerable Software Inventory
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="appViewGridBtn" type="button">Grid</button>
          <button class="card-action-btn" id="appViewListBtn" type="button">List</button>
        </div>
      </div>
      <div class="card-body">
        <div class="app-grid" id="appGrid"></div>
      </div>
    </div>

    <!-- Microsoft Secure Score Trend -->
    <div class="card secure-score-card" data-views="overview" onclick="openDetail('secureScore')" style="cursor:pointer;">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 13.5H14M3.5 12V8M7 12V5M10.5 12V6.5M14 12V3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Microsoft Secure Score
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
          Rolling 6-month secure score trend with current snapshot and target threshold.
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <div style="font-size:11px;color:var(--text-secondary);">Current</div>
          <div id="secureScoreCurrentValue" style="font-size:26px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0%</div>
        </div>
        <div class="secure-score-chart" id="secureScoreChart"></div>
      </div>
    </div>

    <!-- Exposure Trend -->
    <div class="card exposure-card" data-views="overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><polyline points="1,12 4,8 7,10 10,4 13,6 15,2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Exposure Trend (90 Days)
        </div>
      </div>
      <div class="card-body">
        <div class="trend-chart-area">
          <svg class="trend-chart-svg" id="trendChart" viewBox="0 0 400 180" preserveAspectRatio="none"></svg>
        </div>
      </div>
    </div>

    <!-- Threat Prioritization Workbench -->
    <div class="card span-2 threat-workbench-card" data-views="threat">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 5V8.5M8 10.8V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Threat Prioritization Workbench
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="threatWorkbenchRiskBtn" type="button">Risk Ranking</button>
          <button class="card-action-btn" id="threatWorkbenchRemediationBtn" type="button">Action Queue</button>
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Switch between threat-driven ranking and remediation-focused action sequencing without leaving the Threat view.
        </div>
        <div class="threat-workbench-list" id="threatWorkbenchList"></div>
      </div>
    </div>

    <!-- Missing Patches -->
    <div class="card threat-missing-patches-card" data-views="threat">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 5V8.5M8 10.8V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Missing Patches
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Patch backlog ranked with the same threat relevance and remediation-priority signals used in the workbench.
        </div>
        <div class="threat-workbench-list" id="missingPatchesList"></div>
      </div>
    </div>

    <!-- Threat Scoring Key -->
    <div class="card span-2 threat-key-card" data-views="threat">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 5V8.5M8 10.8V11" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Threat Scoring Key
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Legend for the badges and tags used in Threat Prioritization and Missing Patches.
        </div>
        <div class="threat-key-grid">
          <section class="threat-key-section">
            <div class="threat-key-title">Priority Tag</div>
            <div class="threat-key-list">
              <div class="threat-key-row">
                <span class="prio-tag p1">P1 Â· Critical</span>
                <span class="threat-key-text">Immediate remediation required</span>
              </div>
              <div class="threat-key-row">
                <span class="prio-tag p2">P2 Â· Important</span>
                <span class="threat-key-text">Fix in next planned window</span>
              </div>
              <div class="threat-key-row">
                <span class="prio-tag p3">P3 Â· Planned</span>
                <span class="threat-key-text">Track in standard cycle</span>
              </div>
            </div>
          </section>

          <section class="threat-key-section">
            <div class="threat-key-title">Exploit Status</div>
            <div class="threat-key-list">
              <div class="threat-key-row">
                <span class="remediation-pill critical">Actively exploited</span>
                <span class="threat-key-text">Known exploit activity in the wild</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill low">No active exploit</span>
                <span class="threat-key-text">No current exploitation signal</span>
              </div>
            </div>
          </section>

          <section class="threat-key-section">
            <div class="threat-key-title">CVSS Severity</div>
            <div class="threat-key-list">
              <div class="threat-key-row">
                <span class="remediation-pill critical">CVSS 9.0-10.0</span>
                <span class="threat-key-text">Critical severity</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill high">CVSS 7.0-8.9</span>
                <span class="threat-key-text">High severity</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill medium">CVSS 4.0-6.9</span>
                <span class="threat-key-text">Medium severity</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill low">CVSS 0.1-3.9</span>
                <span class="threat-key-text">Low severity</span>
              </div>
            </div>
          </section>

          <section class="threat-key-section">
            <div class="threat-key-title">Other Tags</div>
            <div class="threat-key-list">
              <div class="threat-key-row">
                <span class="remediation-pill critical">300+ affected</span>
                <span class="threat-key-text">Large exposure blast radius</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill high">Avg device risk 55+</span>
                <span class="threat-key-text">Higher business/endpoint risk concentration</span>
              </div>
              <div class="threat-key-row">
                <span class="remediation-pill medium">2+ vulnerabilities mapped</span>
                <span class="threat-key-text">Single patch may remediate multiple CVEs</span>
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- MITRE ATT&CK Coverage + Heatmap -->
    <div class="card standards-mitre-card" data-views="standards">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2H14V14H2V2Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6H14M2 10H14M6 2V14M10 2V14" stroke="currentColor" stroke-width="1" opacity="0.6"/></svg>
          </span>
          MITRE ATT&CK Coverage + Heatmap
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="mitreViewCoverageBtn" type="button">Coverage</button>
          <button class="card-action-btn" id="mitreViewHeatmapBtn" type="button">Heatmap</button>
        </div>
      </div>
      <div class="card-body">
        <div class="standards-mitre-split">
          <section class="standards-mitre-section" id="mitreCoverageSection">
            <div class="standards-mitre-section-title">Tactic Coverage</div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
              Coverage bars by ATT&CK tactic with mapped gap counts.
            </div>
            <div class="mitre-tactic-list" id="mitreTacticList"></div>
          </section>
          <section class="standards-mitre-section" id="mitreHeatmapSection">
            <div class="standards-mitre-section-title">Heatmap</div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">
              Hotspot matrix for rapid detection of lower-coverage tactics.
            </div>
            <div class="mitre-heatmap" id="mitreHeatmap"></div>
          </section>
        </div>
      </div>
    </div>

    <!-- Standards: CIS -->
    <div class="card standards-cis-card" data-views="standards">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </span>
          CIS Controls (v8) Coverage
        </div>
      </div>
      <div class="card-body">
        <div class="standards-kpi">
          <div class="label">Estimated coverage</div>
          <div class="value" id="cisCoverageValue">0%</div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;" id="cisCoverageSub">Based on control telemetry and policy posture.</div>
        <div class="standards-list" id="cisControlList"></div>
      </div>
    </div>

    <!-- Standards: NIST CSF -->
    <div class="card standards-nist-card" data-views="standards">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="12" height="12" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M2 6H14M2 10H14" stroke="currentColor" stroke-width="1"/></svg>
          </span>
          NIST CSF 2.0 Snapshot
        </div>
      </div>
      <div class="card-body">
        <div class="standards-kpi">
          <div class="label">Estimated function coverage</div>
          <div class="value" id="nistCoverageValue">0%</div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;" id="nistCoverageSub">Based on function telemetry and control posture.</div>
        <div class="standards-list" id="nistFunctionList"></div>
      </div>
    </div>

    <!-- Standards: Identity -->
    <div class="card standards-identity-card" data-views="standards">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="5" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M2.5 14C3.2 10.9 5.2 9.5 8 9.5C10.8 9.5 12.8 10.9 13.5 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Identity Security Baseline
        </div>
      </div>
      <div class="card-body">
        <div class="identity-list" id="identityBaselineList"></div>
      </div>
    </div>

    <!-- Standards: NIS2 -->
    <div class="card standards-nis2-card" data-views="standards">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 13.5H14M3.5 12V8M7 12V6M10.5 12V4M14 12V7" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          NIS2.0 Essential Measures
        </div>
      </div>
      <div class="card-body">
        <div class="standards-kpi">
          <div class="label">Estimated NIS2 alignment</div>
          <div class="value" id="nis2OverallValue">0%</div>
        </div>
        <div class="standards-list" id="nis2List"></div>
      </div>
    </div>

    <!-- Device Inventory Table -->
    <div class="card span-2 device-inventory-card" data-views="devices">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="2" width="14" height="12" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M1 5.5H15" stroke="currentColor" stroke-width="1"/></svg>
          </span>
          Device Inventory
        </div>
        <div class="card-actions">
          <button class="card-action-btn" id="deviceExportCsvBtn" type="button">Export CSV</button>
          <button class="card-action-btn active" id="deviceFilterAllBtn" type="button">All Devices</button>
          <button class="card-action-btn" id="deviceFilterNonCompliantBtn" type="button">Non-Compliant</button>
        </div>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="device-table-wrap">
          <table class="device-table" id="deviceTable">
            <thead>
              <tr>
                <th>Device Name</th>
                <th>Type</th>
                <th>OS</th>
                <th>Health</th>
                <th>Platform Ver.</th>
                <th>Engine Ver.</th>
                <th>Security Intel Ver.</th>
                <th>Missing OS Patches</th>
                <th>Vulns</th>
                <th>CA Policies</th>
              </tr>
            </thead>
            <tbody id="deviceTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- CA Policy Coverage -->
    <div class="card ca-policy-card" data-views="policies,overview">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M6 8L7.5 9.5L10 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Conditional Access Policies
        </div>
      </div>
      <div class="card-body">
        <div class="ca-coverage-key">
          <div class="ca-coverage-key-text">Compliance scale: 0% Low (Red) -> 100% High (Green)</div>
          <div class="ca-coverage-key-bar" aria-hidden="true"></div>
        </div>
        <div class="ca-policy-list" id="caPolicyList"></div>
      </div>
    </div>

    <!-- Policy Gap Intelligence -->
    <div class="card policy-gaps-card" data-views="policies">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14.5 13H1.5L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M8 6V9M8 11V11.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Policy Gap Intelligence
        </div>
      </div>
      <div class="card-body">
        <div class="policy-filter-row">
          <button class="filter-chip active" data-policy-filter="all">All</button>
          <button class="filter-chip" data-policy-filter="high-gap">High Gap</button>
          <button class="filter-chip" data-policy-filter="report-only">Report-only</button>
          <button class="filter-chip" data-policy-filter="low-coverage">Low Coverage</button>
        </div>
        <div class="policy-filter-row" style="margin-top:-2px;">
          <span class="filter-label">Compensation</span>
          <button class="filter-chip" data-comp-strictness="lenient">Lenient</button>
          <button class="filter-chip active" data-comp-strictness="standard">Standard</button>
          <button class="filter-chip" data-comp-strictness="strict">Strict</button>
        </div>
        <div class="policy-gap-grid" id="policyGapSummary"></div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Priority policy gaps based on state, coverage, and missing controls that increase attack-path exposure.
        </div>
        <div class="policy-section-label">Policy Overlap &amp; Duplication</div>
        <div class="policy-gap-grid" id="policyOverlapSummary"></div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          Detects exact duplicates, high overlap, and conflicting controls to reduce policy sprawl and simplify CA design.
        </div>
        <div class="policy-gap-list" id="policyOverlapList"></div>
        <div class="policy-section-label">Priority Gap Queue</div>
        <div class="policy-gap-list" id="policyGapList"></div>
      </div>
    </div>

    <!-- Policy to MITRE ATT&CK Mapping -->
    <div class="card policy-mitre-card" data-views="policies">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 2H14V14H2V2Z" stroke="currentColor" stroke-width="1.5"/><path d="M2 6H14M2 10H14M6 2V14M10 2V14" stroke="currentColor" stroke-width="1" opacity="0.6"/></svg>
          </span>
          Conditional Access Journey Map
        </div>
      </div>
      <div class="card-body">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">
          End-to-end policy journey from identity to enforcement, with misconfiguration hotspots, best-practice validation, and ATT&amp;CK mapping.
        </div>
        <div id="policyFocusPanel"></div>
      </div>
    </div>

    <!-- Defender Stack Compliance -->
    <div class="card span-2 defender-stack-card" data-views="defender">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M5.5 8L7.4 9.9L10.8 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
          Defender Stack Compliance
        </div>
        <div class="card-actions">
          <button class="card-action-btn active">Health</button>
          <button class="card-action-btn">Signals</button>
        </div>
      </div>
      <div class="card-body">
        <div class="defender-grid" id="defenderStackGrid"></div>
        <div class="defender-list" id="defenderCommIssues"></div>
      </div>
    </div>

    <!-- Defender Version Distribution -->
    <div class="card defender-version-card" data-views="devices" onclick="openDetail('defenderVersionHealth')" style="cursor:pointer;">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1L14 4V8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8V4L8 1Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
          </span>
          Defender Health
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="defenderMetricPlatformBtn" type="button" onclick="event.stopPropagation();">Platform</button>
          <button class="card-action-btn" id="defenderMetricEngineBtn" type="button" onclick="event.stopPropagation();">Engine</button>
          <button class="card-action-btn" id="defenderMetricIntelBtn" type="button" onclick="event.stopPropagation();">Security Intel</button>
        </div>
      </div>
      <div class="card-body">
        <div class="bar-chart" id="defenderVersionChart"></div>
        <div style="margin-top: 16px; padding: 12px; background: var(--bg-elevated); border-radius: var(--radius-sm); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="font-size: 11px; color: var(--text-muted);" id="defenderMetricLatestLabel">Latest Platform Version</div>
            <div style="font-size: 13px; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-top: 2px;" id="defenderMetricLatestValue">n/a</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-muted);">Coverage</div>
            <div style="font-size: 13px; font-weight: 600; color: var(--status-warning); font-family: 'JetBrains Mono', monospace; margin-top: 2px;" id="defenderMetricCoverageValue">0.0%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card device-mix-card" data-views="devices">
      <div class="card-header">
        <div class="card-title">
          <span class="icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1.5" y="2" width="13" height="11" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M5 14h6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </span>
          Device Distribution
        </div>
        <div class="card-actions">
          <button class="card-action-btn active" id="deviceMixTypeBtn" type="button">By Type</button>
          <button class="card-action-btn" id="deviceMixOsBtn" type="button">By OS</button>
        </div>
      </div>
      <div class="card-body">
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:4px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600;">Total Devices</div>
          <div id="deviceMixTotal" style="font-size:28px;font-weight:800;line-height:1;font-family:'JetBrains Mono',monospace;color:var(--text-primary);">0</div>
          <div id="deviceMixSub" style="font-size:11px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Across all device types</div>
        </div>
        <div style="margin-top: 6px;">
          <div class="bar-chart" id="deviceMixChart"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="help-overlay" id="helpOverlay" onclick="closeHelpPanel(event)">
  <aside class="help-panel" role="dialog" aria-modal="true" aria-labelledby="helpPanelTitle">
    <div class="help-header">
      <div class="help-title" id="helpPanelTitle">Help Centre</div>
      <button class="detail-close" type="button" onclick="closeHelpPanel()" aria-label="Close help">&times;</button>
    </div>
    <div class="help-layout">
      <nav class="help-nav" aria-label="Help topics">
        <div class="help-topic-list" id="helpTopicList"></div>
      </nav>
      <section class="help-content" id="helpContentBody">
        <div class="help-loading">Select a help topic to get started.</div>
      </section>
    </div>
  </aside>
</div>

<!-- ===== DETAIL FLYOUT PANEL ===== -->
<div class="detail-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="detail-panel" onclick="event.stopPropagation()">
    <div class="detail-header">
      <div class="detail-title" id="detailTitle">Detail View</div>
      <button class="detail-close" onclick="closeDetail()">&times;</button>
    </div>
    <div class="detail-body" id="detailBody"></div>
  </div>
</div>

<script src="scripts/help.js"></script>
<script src="scripts/auth.js"></script>
<script>
// ===== MOCK DATA (Structured to match Microsoft Graph / Defender APIs) =====

const vulnerabilities = [
  { id: "CVE-2024-38063", title: "Windows TCP/IP Remote Code Execution", severity: "Critical", cvss: 9.8, affectedDevices: 187, software: "Windows 11 23H2", published: "2024-08-13", exploited: true },
  { id: "CVE-2024-43491", title: "Microsoft Windows Update RCE", severity: "Critical", cvss: 9.8, affectedDevices: 52, software: "Windows 10", published: "2024-09-10", exploited: true },
  { id: "CVE-2024-49138", title: "Windows CLFS Driver Elevation of Privilege", severity: "Critical", cvss: 7.8, affectedDevices: 312, software: "Windows Server 2022", published: "2024-12-10", exploited: true },
  { id: "CVE-2024-30088", title: "Windows Kernel Elevation of Privilege", severity: "High", cvss: 8.8, affectedDevices: 445, software: "Windows 11", published: "2024-06-11", exploited: false },
  { id: "CVE-2024-38178", title: "Scripting Engine Memory Corruption", severity: "High", cvss: 7.5, affectedDevices: 203, software: "Edge Chromium", published: "2024-08-13", exploited: true },
  { id: "CVE-2024-43572", title: "Microsoft Management Console RCE", severity: "High", cvss: 7.8, affectedDevices: 178, software: "Windows 11 23H2", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-43573", title: "Windows MSHTML Platform Spoofing", severity: "Medium", cvss: 6.5, affectedDevices: 890, software: "Windows 10/11", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-38202", title: "Windows Update Stack EoP", severity: "High", cvss: 7.3, affectedDevices: 134, software: "Windows 11", published: "2024-08-08", exploited: false },
  { id: "CVE-2024-21447", title: "Windows Enroll Engine SFP", severity: "Medium", cvss: 5.9, affectedDevices: 67, software: "Windows Server", published: "2024-04-09", exploited: false },
  { id: "CVE-2024-38199", title: "Windows LPD Service RCE", severity: "Critical", cvss: 9.8, affectedDevices: 23, software: "Windows Server 2019", published: "2024-08-13", exploited: false },
  { id: "CVE-2024-43583", title: "Winlogon Elevation of Privilege", severity: "High", cvss: 7.8, affectedDevices: 567, software: "Windows 11", published: "2024-10-08", exploited: false },
  { id: "CVE-2024-20674", title: "Windows Kerberos SFP Bypass", severity: "Critical", cvss: 9.0, affectedDevices: 89, software: "Windows Server 2022", published: "2024-01-09", exploited: false },
];

const KB_PATCH_MAP = {
  "CVE-2024-38063": [
    { kb: "KB5041585", target: "Windows 11 23H2", note: "2024-08 cumulative security update" },
    { kb: "KB5041580", target: "Windows 10 22H2", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-43491": [
    { kb: "KB5043064", target: "Windows 10 22H2", note: "2024-09 cumulative security update" },
    { kb: "KB5043076", target: "Windows 11 23H2", note: "2024-09 cumulative security update" }
  ],
  "CVE-2024-49138": [
    { kb: "KB5048654", target: "Windows Server 2022", note: "2024-12 cumulative security update" }
  ],
  "CVE-2024-30088": [
    { kb: "KB5039212", target: "Windows 11", note: "2024-06 cumulative security update" }
  ],
  "CVE-2024-38178": [
    { kb: "KB5041585", target: "Windows 11 23H2", note: "OS cumulative update path" },
    { kb: "Edge Stable latest", target: "Microsoft Edge Chromium", note: "Browser patch required in parallel" }
  ],
  "CVE-2024-43572": [
    { kb: "KB5044285", target: "Windows 11 23H2", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-43573": [
    { kb: "KB5044285", target: "Windows 11", note: "2024-10 cumulative security update" },
    { kb: "KB5044273", target: "Windows 10", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-38202": [
    { kb: "KB5041585", target: "Windows 11", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-21447": [
    { kb: "KB5034441", target: "Windows Server", note: "2024-04 security update line" }
  ],
  "CVE-2024-38199": [
    { kb: "KB5041773", target: "Windows Server 2019", note: "2024-08 cumulative security update" }
  ],
  "CVE-2024-43583": [
    { kb: "KB5044285", target: "Windows 11", note: "2024-10 cumulative security update" }
  ],
  "CVE-2024-20674": [
    { kb: "KB5034129", target: "Windows Server 2022", note: "2024-01 cumulative security update" }
  ]
};

const devices = [
  { name: "WKS-LON-001", type: "Workstation", os: "Windows 11 23H2", location: "London", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 3, caPolicies: 5, riskScore: 24, lastSeen: "2025-02-20T09:15:00Z" },
  { name: "WKS-LON-042", type: "Workstation", os: "Windows 11 23H2", location: "London", health: "Warning", defenderVer: "4.18.24090.3", vulns: 8, caPolicies: 5, riskScore: 58, lastSeen: "2025-02-20T08:30:00Z" },
  { name: "SRV-AZ-DC01", type: "Server", os: "Windows Server 2022", location: "Azure UK South", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 2, caPolicies: 3, riskScore: 15, lastSeen: "2025-02-20T09:20:00Z" },
  { name: "SRV-AZ-SQL01", type: "Server", os: "Windows Server 2022", location: "Azure UK South", health: "Critical", defenderVer: "4.18.23110.2", vulns: 14, caPolicies: 2, riskScore: 82, lastSeen: "2025-02-19T22:10:00Z" },
  { name: "WKS-NYC-015", type: "Workstation", os: "Windows 11 22H2", location: "New York", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 5, caPolicies: 5, riskScore: 31, lastSeen: "2025-02-20T14:05:00Z" },
  { name: "MBL-LON-089", type: "Mobile", os: "iOS 18.2", location: "London", health: "Healthy", defenderVer: "1.1.62120101", vulns: 0, caPolicies: 4, riskScore: 8, lastSeen: "2025-02-20T09:00:00Z" },
  { name: "WKS-BER-007", type: "Workstation", os: "Windows 10 22H2", location: "Berlin", health: "Warning", defenderVer: "4.18.24050.9", vulns: 12, caPolicies: 4, riskScore: 67, lastSeen: "2025-02-20T08:45:00Z" },
  { name: "SRV-AZ-WEB01", type: "Server", os: "Ubuntu 22.04", location: "Azure West Europe", health: "Healthy", defenderVer: "101.24112.0001", vulns: 1, caPolicies: 1, riskScore: 12, lastSeen: "2025-02-20T09:18:00Z" },
  { name: "MAC-LON-023", type: "Workstation", os: "macOS 15.2", location: "London", health: "Healthy", defenderVer: "101.24112.0003", vulns: 2, caPolicies: 5, riskScore: 18, lastSeen: "2025-02-20T09:12:00Z" },
  { name: "WKS-SYD-003", type: "Workstation", os: "Windows 11 23H2", location: "Sydney", health: "Warning", defenderVer: "4.18.24090.3", vulns: 7, caPolicies: 5, riskScore: 52, lastSeen: "2025-02-20T01:30:00Z" },
  { name: "MBL-NYC-112", type: "Mobile", os: "Android 14", location: "New York", health: "Warning", defenderVer: "1.0.7122.0101", vulns: 1, caPolicies: 3, riskScore: 25, lastSeen: "2025-02-19T20:15:00Z" },
  { name: "SRV-AZ-APP02", type: "Server", os: "Windows Server 2019", location: "Azure UK South", health: "Critical", defenderVer: "4.18.23080.1", vulns: 18, caPolicies: 2, riskScore: 91, lastSeen: "2025-02-20T09:05:00Z" },
  { name: "WKS-TKY-001", type: "Workstation", os: "Windows 11 23H2", location: "Tokyo", health: "Healthy", defenderVer: "4.18.24110.7", vulns: 4, caPolicies: 5, riskScore: 22, lastSeen: "2025-02-20T02:45:00Z" },
  { name: "WKS-LON-099", type: "Workstation", os: "Windows 10 21H2", location: "London", health: "Critical", defenderVer: "4.18.23050.5", vulns: 21, caPolicies: 4, riskScore: 88, lastSeen: "2025-02-18T16:30:00Z" },
];
for (let i = 0; i < devices.length; i += 1) {
  devices[i] = withDefenderVersionDetails(devices[i]);
}

const caPolicies = [
  { name: "Require MFA for All Users", state: "enabled", coverage: 98, users: 1247, apps: "All cloud apps", conditions: "All platforms", grantControls: "Require MFA", sessionControls: "Sign-in frequency: 24h" },
  { name: "Block Legacy Authentication", state: "enabled", coverage: 100, users: 1247, apps: "Exchange Online, SharePoint", conditions: "Other clients", grantControls: "Block access", sessionControls: "None" },
  { name: "Compliant Device Required", state: "enabled", coverage: 87, users: 1089, apps: "Office 365", conditions: "Windows, macOS, iOS, Android", grantControls: "Require compliant device", sessionControls: "None" },
  { name: "High Risk Sign-in Block", state: "enabled", coverage: 100, users: 1247, apps: "All cloud apps", conditions: "High risk sign-in", grantControls: "Block access", sessionControls: "None" },
  { name: "Named Location - Corp Network Trust", state: "enabled", coverage: 72, users: 896, apps: "All cloud apps", conditions: "Trusted locations excluded", grantControls: "Require MFA", sessionControls: "Persistent browser session" },
  { name: "Admin MFA Enforcement", state: "enabled", coverage: 100, users: 23, apps: "Microsoft Admin Portals", conditions: "All platforms", grantControls: "Require MFA + Compliant device", sessionControls: "Sign-in frequency: 4h" },
  { name: "BYOD App Protection", state: "report-only", coverage: 45, users: 567, apps: "Office 365, Teams", conditions: "Unmanaged devices", grantControls: "Require app protection policy", sessionControls: "App enforced restrictions" },
  { name: "Guest Access Restrictions", state: "enabled", coverage: 100, users: 156, apps: "SharePoint, Teams", conditions: "Guest users", grantControls: "Require MFA", sessionControls: "Sign-in frequency: 8h" },
  { name: "Token Protection (Preview)", state: "report-only", coverage: 34, users: 423, apps: "Exchange Online", conditions: "Windows", grantControls: "Require token protection", sessionControls: "None" },
  { name: "Phishing-Resistant MFA for Admins", state: "report-only", coverage: 65, users: 23, apps: "All cloud apps", conditions: "Directory roles", grantControls: "Require authentication strength", sessionControls: "Sign-in frequency: 4h" },
];

const POLICY_MITRE_MAP = {
  "Require MFA for All Users": {
    tactics: ["Credential Access", "Initial Access"],
    techniques: ["T1110 Brute Force", "T1078 Valid Accounts"],
    threats: ["Password spray", "Credential stuffing"]
  },
  "Block Legacy Authentication": {
    tactics: ["Credential Access", "Defense Evasion"],
    techniques: ["T1556 Modify Authentication Process", "T1078 Valid Accounts"],
    threats: ["Basic auth bypass", "Legacy protocol abuse"]
  },
  "Compliant Device Required": {
    tactics: ["Execution", "Persistence"],
    techniques: ["T1204 User Execution", "T1547 Boot or Logon Autostart"],
    threats: ["Unmanaged endpoint access", "Persistent malware on non-compliant hosts"]
  },
  "High Risk Sign-in Block": {
    tactics: ["Initial Access", "Credential Access"],
    techniques: ["T1078 Valid Accounts", "T1110 Brute Force"],
    threats: ["Impossible travel sign-ins", "Compromised account takeover"]
  },
  "Named Location - Corp Network Trust": {
    tactics: ["Command and Control", "Lateral Movement"],
    techniques: ["T1133 External Remote Services", "T1021 Remote Services"],
    threats: ["Suspicious geolocation access", "Remote pivoting from unmanaged networks"]
  },
  "Admin MFA Enforcement": {
    tactics: ["Privilege Escalation", "Credential Access"],
    techniques: ["T1078.004 Cloud Accounts", "T1068 Exploitation for Privilege Escalation"],
    threats: ["Admin session hijack", "Privileged account abuse"]
  },
  "BYOD App Protection": {
    tactics: ["Exfiltration", "Impact"],
    techniques: ["T1041 Exfiltration Over C2 Channel", "T1567 Exfiltration to Cloud Storage"],
    threats: ["Data leakage via unmanaged mobile", "Copy/paste exfiltration"]
  },
  "Guest Access Restrictions": {
    tactics: ["Initial Access", "Lateral Movement"],
    techniques: ["T1078 Valid Accounts", "T1021 Remote Services"],
    threats: ["Excessive guest privilege", "Third-party collaborator abuse"]
  },
  "Token Protection (Preview)": {
    tactics: ["Defense Evasion", "Credential Access"],
    techniques: ["T1528 Steal Application Access Token", "T1550 Use Alternate Authentication Material"],
    threats: ["Token replay", "Session token theft"]
  },
  "Phishing-Resistant MFA for Admins": {
    tactics: ["Credential Access", "Privilege Escalation"],
    techniques: ["T1110 Brute Force", "T1078.004 Cloud Accounts"],
    threats: ["AiTM phishing", "Privileged identity compromise"]
  }
};

const locations = [
  { name: "London", flag: "ðŸ‡¬ðŸ‡§", devices: 487, healthy: 412, warning: 58, critical: 17 },
  { name: "New York", flag: "ðŸ‡ºðŸ‡¸", devices: 312, healthy: 278, warning: 28, critical: 6 },
  { name: "Berlin", flag: "ðŸ‡©ðŸ‡ª", devices: 156, healthy: 132, warning: 19, critical: 5 },
  { name: "Azure UK South", flag: "â˜ï¸", devices: 134, healthy: 118, warning: 10, critical: 6 },
  { name: "Sydney", flag: "ðŸ‡¦ðŸ‡º", devices: 89, healthy: 74, warning: 12, critical: 3 },
  { name: "Tokyo", flag: "ðŸ‡¯ðŸ‡µ", devices: 69, healthy: 61, warning: 7, critical: 1 },
];

const softwareInventory = [
  { name: "Microsoft Edge", vendor: "Microsoft", devices: 1180, vulns: 12, version: "131.0.2903.70" },
  { name: "Windows 11 23H2", vendor: "Microsoft", devices: 678, vulns: 23, version: "10.0.22631" },
  { name: "Microsoft 365 Apps", vendor: "Microsoft", devices: 1150, vulns: 8, version: "2411" },
  { name: "Windows 10 22H2", vendor: "Microsoft", devices: 234, vulns: 31, version: "10.0.19045" },
  { name: "Teams (New)", vendor: "Microsoft", devices: 1098, vulns: 3, version: "24295.606.3238" },
  { name: "Windows Server 2022", vendor: "Microsoft", devices: 67, vulns: 14, version: "10.0.20348" },
  { name: "Adobe Acrobat Reader", vendor: "Adobe", devices: 890, vulns: 7, version: "2024.004.20272" },
  { name: "Zoom Workplace", vendor: "Zoom", devices: 756, vulns: 4, version: "6.3.0" },
  { name: "Chrome", vendor: "Google", devices: 342, vulns: 9, version: "131.0.6778.109" },
  { name: "Windows Server 2019", vendor: "Microsoft", devices: 23, vulns: 18, version: "10.0.17763" },
  { name: "Visual Studio Code", vendor: "Microsoft", devices: 234, vulns: 2, version: "1.95.3" },
  { name: "Python 3.12", vendor: "Python.org", devices: 89, vulns: 5, version: "3.12.7" },
];

// ===== RENDER FUNCTIONS =====

const DEVICE_TYPE_DATA = [
  { label: 'Workstations', count: 842, color: '#1E3A5A' },
  { label: 'Servers', count: 224, color: '#2F6FA8' },
  { label: 'Mobile', count: 156, color: '#6A93B9' },
  { label: 'IoT / Other', count: 25, color: '#9CB7D1' },
];

const DEVICE_OS_DATA = [
  { label: 'Win 11 23H2', value: 678, color: '#0EA5E9' },
  { label: 'Win 10 22H2', value: 234, color: '#22C55E' },
  { label: 'macOS 15', value: 89, color: '#A855F7' },
  { label: 'Server 2022', value: 67, color: '#F59E0B' },
  { label: 'iOS/Android', value: 156, color: '#EF4444' },
];

const MITRE_TACTICS = [
  { name: 'Initial Access', coverage: 72, gaps: 5 },
  { name: 'Execution', coverage: 81, gaps: 3 },
  { name: 'Persistence', coverage: 68, gaps: 7 },
  { name: 'Privilege Escalation', coverage: 61, gaps: 8 },
  { name: 'Defense Evasion', coverage: 58, gaps: 10 },
  { name: 'Credential Access', coverage: 66, gaps: 6 },
  { name: 'Lateral Movement', coverage: 54, gaps: 9 },
  { name: 'Command and Control', coverage: 79, gaps: 4 },
  { name: 'Exfiltration', coverage: 63, gaps: 5 },
  { name: 'Impact', coverage: 74, gaps: 4 },
];

const NIST_FUNCTION_DETAILS = {
  govern: {
    focus: 'Policy ownership, risk governance, and control oversight.',
    primaryGap: 'Inconsistent policy enforcement and role accountability across all control domains.',
    priorityAction: 'Set quarterly governance reviews with named control owners and tracked exceptions.'
  },
  identify: {
    focus: 'Asset visibility, risk analysis, and security context completeness.',
    primaryGap: 'Asset and risk records are present, but not all services are fully mapped to risk owners.',
    priorityAction: 'Complete business-service to asset mapping and tie each to a risk register owner.'
  },
  protect: {
    focus: 'Preventive controls for identity, endpoint, and platform hardening.',
    primaryGap: 'Control coverage is broad but still uneven for unhealthy endpoints and partial policy states.',
    priorityAction: 'Move high-impact controls from report-only to enforce mode after validation.'
  },
  detect: {
    focus: 'Monitoring depth, anomaly detection confidence, and detection process maturity.',
    primaryGap: 'Detection quality is reduced by critical backlog and inconsistent endpoint signal quality.',
    priorityAction: 'Improve sensor quality baseline and prioritize high-risk detection engineering gaps.'
  },
  respond: {
    focus: 'Incident planning, triage quality, and mitigation execution speed.',
    primaryGap: 'Response pressure remains high while exploited findings remain open.',
    priorityAction: 'Run a fast-track workflow for exploited vulnerabilities and major incident classes.'
  },
  recover: {
    focus: 'Recovery readiness, continuous improvement, and communication discipline.',
    primaryGap: 'Recovery confidence is constrained by inconsistent remediation outcomes.',
    priorityAction: 'Define recovery KPIs and run regular resilience/tabletop validation exercises.'
  }
};

const NIST_CONTROL_DETAILS = {
  'GV.OC': { owner: 'Security Governance', cadence: 'Quarterly', whyLow: 'Risk context is not fully normalized across all business services.', action: 'Standardize risk taxonomy and map all critical services to owners.' },
  'GV.RR': { owner: 'CISO Office', cadence: 'Monthly', whyLow: 'Role handoffs for response and exceptions are not uniformly codified.', action: 'Publish and enforce RACI for risk acceptance and incident decisions.' },
  'GV.PO': { owner: 'Policy & Compliance', cadence: 'Monthly', whyLow: 'Some controls remain report-only and reduce governance assurance.', action: 'Convert validated report-only policies into enforced controls.' },
  'ID.AM': { owner: 'Asset Management', cadence: 'Weekly', whyLow: 'Inventory coverage exists but still misses some transient or stale assets.', action: 'Reconcile endpoint, identity, and CMDB inventories on a fixed cycle.' },
  'ID.RA': { owner: 'Vulnerability Management', cadence: 'Weekly', whyLow: 'Open critical vulnerabilities are driving residual risk.', action: 'Apply critical risk burn-down targets with tracked SLA breaches.' },
  'ID.IM': { owner: 'Security Engineering', cadence: 'Monthly', whyLow: 'Telemetry freshness is uneven across endpoint cohorts.', action: 'Fix stale telemetry sources and enforce heartbeat compliance.' },
  'PR.AA': { owner: 'Identity & Access', cadence: 'Weekly', whyLow: 'Authentication policy strength is strong but not fully universal.', action: 'Expand strong-auth controls to all privileged and high-risk cohorts.' },
  'PR.PS': { owner: 'Endpoint Engineering', cadence: 'Weekly', whyLow: 'Endpoint health inconsistency reduces platform hardening confidence.', action: 'Remediate unhealthy endpoints and enforce minimum baseline posture.' },
  'PR.DS': { owner: 'Security Architecture', cadence: 'Monthly', whyLow: 'Safeguards are broad but not consistently enforced across all paths.', action: 'Close control exceptions and validate safeguard effectiveness by segment.' },
  'DE.CM': { owner: 'SOC Detection Team', cadence: 'Daily', whyLow: 'Monitoring coverage is impacted by sensor quality variance.', action: 'Harden sensor deployment standards and alert on telemetry drop-offs.' },
  'DE.AE': { owner: 'Threat Detection', cadence: 'Daily', whyLow: 'Critical backlog lowers confidence in anomaly baselines.', action: 'Prioritize exploit-relevant detections and reduce severe exposure backlog.' },
  'DE.DP': { owner: 'SOC Engineering', cadence: 'Weekly', whyLow: 'Detection process maturity varies by platform and tactic.', action: 'Implement a unified detection QA cycle and ATT&CK coverage reviews.' },
  'RS.RP': { owner: 'Incident Response', cadence: 'Quarterly', whyLow: 'Planning quality depends on remediation speed and scenario readiness.', action: 'Refresh playbooks and validate against top threat scenarios.' },
  'RS.AN': { owner: 'Threat Intel / IR', cadence: 'Daily', whyLow: 'Active exploitation creates sustained triage pressure.', action: 'Create exploit-priority queues and reduce time-to-containment targets.' },
  'RS.MI': { owner: 'Remediation Operations', cadence: 'Weekly', whyLow: 'Mitigation consistency is constrained by high-severity closure rates.', action: 'Track mitigation completion per severity and enforce escalation gates.' },
  'RC.RP': { owner: 'Business Resilience', cadence: 'Quarterly', whyLow: 'Recovery posture is tied to overall control maturity variance.', action: 'Define measurable recovery readiness criteria and validate quarterly.' },
  'RC.IM': { owner: 'Continuous Improvement', cadence: 'Monthly', whyLow: 'Lessons learned are not yet fully reflected in closure consistency.', action: 'Feed incident findings directly into remediation and policy updates.' },
  'RC.CO': { owner: 'Crisis Communications', cadence: 'Quarterly', whyLow: 'Recovery communications are not always aligned to technical recovery state.', action: 'Align communication triggers to objective recovery milestones and KPIs.' }
};

let riskCellCache = {};
let riskMatrixMode = 'full';
let msalInstance = null;
let msalLoadPromise = null;
let msalInstanceTenantId = '';
let msalInstanceClientId = '';
let lastConnectedContext = null;
let liveExposureScore = null;
let liveSecureScore = null;
let standardsDetailModel = { cis: {}, nist: {}, identity: {}, nis2: {} };
let exposureTrendPoints = [];
let exposureTrendAnchorScore = null;
let exposureTrendSignature = '';
let autoRefreshTimer = null;
const AUTO_REFRESH_MS = 5 * 60 * 1000;
let authInProgress = false;

async function graphGetAll(url, accessToken, maxPages = 10) {
  let nextUrl = url;
  let pages = 0;
  const items = [];

  while (nextUrl && pages < maxPages) {
    const res = await fetch(nextUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        Accept: 'application/json'
      }
    });

    if (!res.ok) {
      const body = await res.text();
      throw new Error(`Graph request failed (${res.status}): ${body || res.statusText}`);
    }

    const payload = await res.json();
    if (Array.isArray(payload.value)) items.push(...payload.value);
    nextUrl = payload['@odata.nextLink'] || null;
    pages += 1;
  }

  return items;
}

async function defenderGetAll(url, accessToken, maxPages = 10) {
  let nextUrl = url;
  let pages = 0;
  const items = [];

  while (nextUrl && pages < maxPages) {
    const res = await fetch(nextUrl, {
      headers: {
        Authorization: `Bearer ${accessToken}`,
        Accept: 'application/json'
      }
    });

    if (!res.ok) {
      const body = await res.text();
      throw new Error(`Defender API request failed (${res.status}): ${body || res.statusText}`);
    }

    const payload = await res.json();
    if (Array.isArray(payload.value)) items.push(...payload.value);
    else if (Array.isArray(payload.results)) items.push(...payload.results);
    else if (Array.isArray(payload)) items.push(...payload);

    nextUrl = payload['@odata.nextLink'] || payload.nextLink || null;
    pages += 1;
  }

  return items;
}

async function defenderGetJson(url, accessToken) {
  const res = await fetch(url, {
    headers: {
      Authorization: `Bearer ${accessToken}`,
      Accept: 'application/json'
    }
  });

  if (!res.ok) {
    const body = await res.text();
    throw new Error(`Defender API request failed (${res.status}): ${body || res.statusText}`);
  }

  return res.json();
}

function classifyDeviceType(osText = '') {
  const os = osText.toLowerCase();
  if (os.includes('ios') || os.includes('android')) return 'Mobile';
  if (os.includes('server')) return 'Server';
  return 'Workstation';
}

function complianceToHealth(state = '') {
  const s = String(state).toLowerCase();
  if (s === 'compliant') return 'Healthy';
  if (s === 'noncompliant' || s === 'error') return 'Critical';
  return 'Warning';
}

function healthToRisk(health, isJailBroken) {
  if (isJailBroken) return 90;
  if (health === 'Critical') return 80;
  if (health === 'Warning') return 52;
  return 20;
}

function defaultDefenderVersionDetails(device) {
  const os = String(device?.os || '').toLowerCase();
  if (os.includes('windows')) {
    return {
      defenderPlatformVer: '4.18.24110.7',
      defenderEngineVer: '1.1.24110.5',
      defenderSecurityIntelVer: '1.421.312.0'
    };
  }
  if (os.includes('mac')) {
    return {
      defenderPlatformVer: '101.24112.0003',
      defenderEngineVer: '1.1.24112.2',
      defenderSecurityIntelVer: '1.421.298.0'
    };
  }
  if (os.includes('ubuntu') || os.includes('linux')) {
    return {
      defenderPlatformVer: '101.24112.0001',
      defenderEngineVer: '1.1.24112.1',
      defenderSecurityIntelVer: '1.421.284.0'
    };
  }
  if (os.includes('ios') || os.includes('android')) {
    return {
      defenderPlatformVer: 'n/a',
      defenderEngineVer: 'n/a',
      defenderSecurityIntelVer: 'n/a'
    };
  }
  return {
    defenderPlatformVer: 'n/a',
    defenderEngineVer: 'n/a',
    defenderSecurityIntelVer: 'n/a'
  };
}

function withDefenderVersionDetails(device) {
  const defaults = defaultDefenderVersionDetails(device);
  return {
    ...device,
    defenderPlatformVer: String(device?.defenderPlatformVer || defaults.defenderPlatformVer || 'n/a'),
    defenderEngineVer: String(device?.defenderEngineVer || defaults.defenderEngineVer || 'n/a'),
    defenderSecurityIntelVer: String(device?.defenderSecurityIntelVer || defaults.defenderSecurityIntelVer || 'n/a')
  };
}

function applyLiveDevices(managedDevices) {
  if (!Array.isArray(managedDevices) || !managedDevices.length) return false;

  const mapped = managedDevices.map((d, idx) => {
    const osBase = d.operatingSystem || 'Unknown OS';
    const osVersion = d.osVersion ? ` ${d.osVersion}` : '';
    const os = `${osBase}${osVersion}`.trim();
    const type = classifyDeviceType(osBase);
    const health = complianceToHealth(d.complianceState);
    const riskScore = healthToRisk(health, d.jailBroken);
    const staleDays = d.lastSyncDateTime
      ? Math.max(0, Math.floor((Date.now() - new Date(d.lastSyncDateTime).getTime()) / (24 * 60 * 60 * 1000)))
      : 0;
    const vulns = health === 'Critical' ? 10 + Math.min(12, staleDays) : health === 'Warning' ? 3 + Math.min(6, staleDays) : Math.min(2, staleDays);
    const location = d.userPrincipalName && d.userPrincipalName.includes('@')
      ? d.userPrincipalName.split('@')[1]
      : 'Tenant';

    return withDefenderVersionDetails({
      name: d.deviceName || d.managedDeviceName || `DEVICE-${idx + 1}`,
      type,
      os,
      location,
      health,
      defenderVer: d.osVersion || d.partnerReportedThreatState || 'n/a',
      defenderPlatformVer: d.defenderAvPlatformVersion || d.defenderPlatformVersion || d.partnerReportedThreatState,
      defenderEngineVer: d.defenderAvEngineVersion || d.defenderEngineVersion,
      defenderSecurityIntelVer: d.defenderAvSecurityIntelVersion || d.defenderSecurityIntelVersion || d.defenderSignatureVersion,
      vulns,
      caPolicies: 1,
      riskScore,
      lastSeen: d.lastSyncDateTime || new Date().toISOString()
    });
  });

  devices.splice(0, devices.length, ...mapped);
  return true;
}

function summarizeDeviceDistributions() {
  if (!devices.length) return;

  const typeCounts = { Workstation: 0, Server: 0, Mobile: 0, Other: 0 };
  const osCounts = {};
  const healthCounts = { healthy: 0, warning: 0, critical: 0 };

  devices.forEach(d => {
    if (d.type === 'Workstation') typeCounts.Workstation += 1;
    else if (d.type === 'Server') typeCounts.Server += 1;
    else if (d.type === 'Mobile') typeCounts.Mobile += 1;
    else typeCounts.Other += 1;

    osCounts[d.os] = (osCounts[d.os] || 0) + 1;
    const hk = String(d.health || '').toLowerCase();
    if (healthCounts[hk] !== undefined) healthCounts[hk] += 1;
  });

  DEVICE_TYPE_DATA.splice(0, DEVICE_TYPE_DATA.length,
    { label: 'Workstations', count: typeCounts.Workstation, color: '#1E3A5A' },
    { label: 'Servers', count: typeCounts.Server, color: '#2F6FA8' },
    { label: 'Mobile', count: typeCounts.Mobile, color: '#6A93B9' },
    { label: 'IoT / Other', count: typeCounts.Other, color: '#9CB7D1' }
  );

  const topOs = Object.entries(osCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
  const osColors = ['#0EA5E9', '#22C55E', '#A855F7', '#F59E0B', '#EF4444'];
  DEVICE_OS_DATA.splice(0, DEVICE_OS_DATA.length, ...topOs.map(([label, value], idx) => ({ label, value, color: osColors[idx] || '#6B7280' })));

  const total = devices.length;
  locations.splice(0, locations.length, {
    name: 'Tenant',
    flag: 'ðŸ¢',
    devices: total,
    healthy: healthCounts.healthy,
    warning: healthCounts.warning,
    critical: healthCounts.critical
  });

  softwareInventory.splice(0, softwareInventory.length, ...topOs.map(([label, count], idx) => ({
    name: label,
    vendor: 'Microsoft Intune',
    devices: count,
    vulns: Math.max(0, Math.round(count * (idx < 2 ? 0.06 : 0.03))),
    version: label.split(' ').slice(-1)[0] || 'n/a'
  })));
}

function mapPolicyState(rawState) {
  const s = String(rawState || '').toLowerCase();
  if (s === 'enabledforreportingbutnotenforced') return 'report-only';
  if (s === 'disabled') return 'disabled';
  return 'enabled';
}

function normalizePolicyApplications(apps) {
  if (!apps || !Array.isArray(apps.includeApplications) || !apps.includeApplications.length) return 'All cloud apps';
  if (apps.includeApplications.includes('All')) return 'All cloud apps';
  return apps.includeApplications.slice(0, 3).join(', ');
}

function normalizePolicyConditions(conditions) {
  if (!conditions) return 'All platforms';
  const p = conditions.platforms;
  if (!p || !Array.isArray(p.includePlatforms) || !p.includePlatforms.length) return 'All platforms';
  if (p.includePlatforms.includes('all')) return 'All platforms';
  return p.includePlatforms.join(', ');
}

function normalizeGrantControls(grantControls) {
  if (!grantControls) return 'None';
  const controls = Array.isArray(grantControls.builtInControls) ? grantControls.builtInControls : [];
  if (!controls.length) return 'None';
  return controls.join(', ');
}

function normalizeSessionControls(sessionControls) {
  if (!sessionControls || typeof sessionControls !== 'object') return 'None';
  const enabled = Object.keys(sessionControls).filter(k => sessionControls[k] && sessionControls[k].isEnabled);
  return enabled.length ? enabled.join(', ') : 'None';
}

function applyLivePolicies(policies) {
  if (!Array.isArray(policies) || !policies.length) return false;
  const totalUsers = Math.max(devices.length, 1);

  const mapped = policies.map(p => {
    const state = mapPolicyState(p.state);
    const coverage = state === 'enabled' ? 95 : state === 'report-only' ? 65 : 5;
    return {
      name: p.displayName || p.id || 'Unnamed policy',
      state,
      coverage,
      users: totalUsers,
      apps: normalizePolicyApplications(p.conditions?.applications),
      conditions: normalizePolicyConditions(p.conditions),
      grantControls: normalizeGrantControls(p.grantControls),
      sessionControls: normalizeSessionControls(p.sessionControls)
    };
  });

  caPolicies.splice(0, caPolicies.length, ...mapped);
  return true;
}

function alertSeverityToVulnSeverity(severity) {
  const s = String(severity || '').toLowerCase();
  if (s === 'high') return 'Critical';
  if (s === 'medium') return 'High';
  if (s === 'low') return 'Medium';
  return 'Low';
}

function defenderSeverityToVulnSeverity(severity) {
  const s = String(severity || '').toLowerCase();
  if (s.includes('critical') || s.includes('high')) return 'Critical';
  if (s.includes('medium')) return 'High';
  if (s.includes('low')) return 'Medium';
  return 'Low';
}

function defenderMachineHealth(machine = {}) {
  const healthSignal = `${machine.healthStatus || ''} ${machine.machineHealthStatus || ''} ${machine.exposureLevel || ''}`.toLowerCase();
  if (healthSignal.includes('critical') || healthSignal.includes('high') || healthSignal.includes('inactive')) return 'Critical';
  if (healthSignal.includes('medium') || healthSignal.includes('warning') || healthSignal.includes('low')) return 'Warning';
  return 'Healthy';
}

function defenderMachineRisk(machine = {}, health = 'Healthy') {
  const numeric = Number(machine.riskScore);
  if (Number.isFinite(numeric) && numeric > 0) return Math.max(1, Math.min(100, Math.round(numeric)));

  const exposure = String(machine.exposureLevel || '').toLowerCase();
  if (exposure.includes('high')) return 82;
  if (exposure.includes('medium')) return 58;
  if (exposure.includes('low')) return 34;

  if (health === 'Critical') return 80;
  if (health === 'Warning') return 52;
  return 20;
}

function applyLiveDefenderMachines(machines) {
  if (!Array.isArray(machines) || !machines.length) return false;

  const mapped = machines.map((m, idx) => {
    const os = [m.osPlatform || m.osDistribution || 'Unknown OS', m.version || m.osVersion || ''].filter(Boolean).join(' ').trim();
    const type = classifyDeviceType(`${m.osPlatform || ''} ${m.osDistribution || ''}`);
    const health = defenderMachineHealth(m);
    const riskScore = defenderMachineRisk(m, health);

    const location = m.lastIpCountry || m.lastExternalIpAddress || m.rbacGroupName || 'Tenant';
    const lastSeen = m.lastSeen || m.lastSeenDateTime || new Date().toISOString();
    const staleDays = lastSeen
      ? Math.max(0, Math.floor((Date.now() - new Date(lastSeen).getTime()) / (24 * 60 * 60 * 1000)))
      : 0;
    const vulns = health === 'Critical' ? 10 + Math.min(12, staleDays) : health === 'Warning' ? 3 + Math.min(6, staleDays) : Math.min(2, staleDays);

    return withDefenderVersionDetails({
      name: m.computerDnsName || m.deviceName || m.id || `MACHINE-${idx + 1}`,
      type,
      os,
      location,
      health,
      defenderVer: m.version || m.agentVersion || m.osVersion || 'n/a',
      defenderPlatformVer: m.defenderAvPlatformVersion || m.platformVersion || m.productVersion,
      defenderEngineVer: m.defenderAvEngineVersion || m.engineVersion,
      defenderSecurityIntelVer: m.defenderAvSignatureVersion || m.signatureVersion || m.securityIntelligenceVersion,
      vulns,
      caPolicies: 1,
      riskScore,
      lastSeen
    });
  });

  devices.splice(0, devices.length, ...mapped);
  return true;
}

function applyLiveDefenderVulnerabilities(vulns) {
  if (!Array.isArray(vulns) || !vulns.length) return false;

  const byId = new Map();
  vulns.forEach((v, idx) => {
    const id = (v.cveId || v.id || `DEFENDER-VULN-${idx + 1}`).toString().toUpperCase();
    const severity = defenderSeverityToVulnSeverity(v.severity || v.vulnerabilitySeverityLevel || v.severityLevel);
    const existing = byId.get(id) || {
      id,
      title: v.name || v.title || 'Defender vulnerability',
      severity,
      cvss: Number(v.cvssScore) || severityToCvss(severity),
      affectedDevices: 0,
      software: v.productName || v.softwareName || 'Microsoft Defender',
      published: (v.publishedOn || v.firstSeen || v.createdOn || new Date().toISOString()).slice(0, 10),
      exploited: Boolean(v.exploitVerified || v.publicExploit || v.isExploited)
    };

    const affected = Number(v.exposedMachines || v.devicesCount || v.affectedMachines || v.machinesCount || 1);
    existing.affectedDevices += Number.isFinite(affected) && affected > 0 ? affected : 1;

    byId.set(id, existing);
  });

  const mapped = Array.from(byId.values())
    .sort((a, b) => b.cvss - a.cvss || b.affectedDevices - a.affectedDevices)
    .slice(0, 30);

  vulnerabilities.splice(0, vulnerabilities.length, ...mapped);
  return true;
}

function applyLiveDefenderSoftware(softwareRows) {
  if (!Array.isArray(softwareRows) || !softwareRows.length) return false;

  const mapped = softwareRows
    .map((s, idx) => ({
      name: s.name || s.softwareName || `Software ${idx + 1}`,
      vendor: s.vendor || s.publisher || 'Unknown vendor',
      devices: Number(s.deviceCount || s.exposedMachines || s.machinesCount || 0),
      vulns: Number(s.vulnerabilitiesCount || s.cveCount || s.weaknesses || 0),
      version: s.version || s.softwareVersion || 'n/a'
    }))
    .sort((a, b) => b.vulns - a.vulns || b.devices - a.devices)
    .slice(0, 24);

  softwareInventory.splice(0, softwareInventory.length, ...mapped);
  return true;
}

function applyLiveExposureScore(payload) {
  if (!payload) return false;

  let score = null;
  let secureScore = null;
  if (typeof payload.score === 'number') score = payload.score;
  if (typeof payload.currentScore === 'number') score = payload.currentScore;
  if (typeof payload.secureScore === 'number') secureScore = payload.secureScore;
  if (typeof payload.scorePercentage === 'number') secureScore = payload.scorePercentage;
  if (score === null && Array.isArray(payload.value) && payload.value.length) {
    const row = payload.value[0] || {};
    if (typeof row.score === 'number') score = row.score;
    if (typeof row.currentScore === 'number') score = row.currentScore;
    if (typeof row.secureScore === 'number') secureScore = row.secureScore;
    if (typeof row.scorePercentage === 'number') secureScore = row.scorePercentage;
  }

  if (!Number.isFinite(score)) return false;
  liveExposureScore = Number(score);
  if (Number.isFinite(secureScore)) liveSecureScore = Number(secureScore);

  const valueEl = document.querySelector('.exec-card.critical .exec-value');
  if (valueEl) valueEl.textContent = Number(score).toFixed(1);
  return true;
}

function severityToCvss(sev) {
  if (sev === 'Critical') return 9.0;
  if (sev === 'High') return 7.5;
  if (sev === 'Medium') return 5.5;
  return 3.5;
}

function applyLiveAlerts(alerts) {
  if (!Array.isArray(alerts) || !alerts.length) return false;

  const byId = new Map();
  alerts.forEach((a, idx) => {
    const text = `${a.title || ''} ${a.description || ''}`;
    const cveMatch = text.match(/CVE-\d{4}-\d{4,7}/i);
    const id = cveMatch ? cveMatch[0].toUpperCase() : `ALERT-${String(a.id || idx + 1).slice(0, 8).toUpperCase()}`;
    const severity = alertSeverityToVulnSeverity(a.severity);
    const record = byId.get(id) || {
      id,
      title: a.title || 'Security alert',
      severity,
      cvss: severityToCvss(severity),
      affectedDevices: 0,
      software: a.productName || a.serviceSource || 'Microsoft 365',
      published: (a.createdDateTime || new Date().toISOString()).slice(0, 10),
      exploited: /exploited|zero-day|0day/i.test(text)
    };

    record.affectedDevices += Math.max(1, Array.isArray(a.evidence) ? a.evidence.length : 1);
    byId.set(id, record);
  });

  const mapped = Array.from(byId.values())
    .sort((a, b) => b.cvss - a.cvss || b.affectedDevices - a.affectedDevices)
    .slice(0, 20);

  vulnerabilities.splice(0, vulnerabilities.length, ...mapped);
  return true;
}

async function loadLiveTenantData(graphAccessToken, defenderAccessToken) {
  const tasks = [];

  if (graphAccessToken) {
    tasks.push(
      { key: 'graphDevices', run: () => graphGetAll('https://graph.microsoft.com/v1.0/deviceManagement/managedDevices?$top=300', graphAccessToken, 10) },
      { key: 'graphPolicies', run: () => graphGetAll('https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies?$top=100', graphAccessToken, 5) },
      { key: 'graphAlerts', run: () => graphGetAll('https://graph.microsoft.com/v1.0/security/alerts_v2?$top=100', graphAccessToken, 5) }
    );
  }

  if (defenderAccessToken) {
    tasks.push(
      { key: 'defenderMachines', run: () => defenderGetAll('https://api.securitycenter.microsoft.com/api/machines?$top=300', defenderAccessToken, 10) },
      { key: 'defenderVulns', run: () => defenderGetAll('https://api.securitycenter.microsoft.com/api/vulnerabilities?$top=300', defenderAccessToken, 10) },
      { key: 'defenderSoftware', run: () => defenderGetAll('https://api.securitycenter.microsoft.com/api/Software?$top=300', defenderAccessToken, 10) },
      { key: 'defenderExposure', run: () => defenderGetJson('https://api.securitycenter.microsoft.com/api/exposureScore', defenderAccessToken) }
    );
  }

  if (!tasks.length) {
    throw new Error('No API tokens available for Graph or Defender resources.');
  }

  const settled = await Promise.allSettled(tasks.map(t => t.run()));
  const resultsByKey = {};
  const errors = [];
  const succeeded = [];

  settled.forEach((result, idx) => {
    const key = tasks[idx].key;
    if (result.status === 'fulfilled') {
      resultsByKey[key] = result.value;
      succeeded.push(key);
    }
    else errors.push(result.reason?.message || `${key} failed`);
  });

  const updated = {
    graphDevices: resultsByKey.graphDevices ? applyLiveDevices(resultsByKey.graphDevices) : false,
    defenderMachines: resultsByKey.defenderMachines ? applyLiveDefenderMachines(resultsByKey.defenderMachines) : false,
    graphPolicies: resultsByKey.graphPolicies ? applyLivePolicies(resultsByKey.graphPolicies) : false,
    graphAlerts: resultsByKey.graphAlerts ? applyLiveAlerts(resultsByKey.graphAlerts) : false,
    defenderVulns: resultsByKey.defenderVulns ? applyLiveDefenderVulnerabilities(resultsByKey.defenderVulns) : false,
    defenderSoftware: resultsByKey.defenderSoftware ? applyLiveDefenderSoftware(resultsByKey.defenderSoftware) : false,
    defenderExposure: resultsByKey.defenderExposure ? applyLiveExposureScore(resultsByKey.defenderExposure) : false
  };

  if (updated.graphDevices || updated.defenderMachines) summarizeDeviceDistributions();
  if (updated.defenderSoftware && resultsByKey.defenderSoftware) {
    applyLiveDefenderSoftware(resultsByKey.defenderSoftware);
  }
  rerenderDashboard();

  const sourceLabels = {
    graphDevices: 'Graph managed devices',
    graphPolicies: 'Graph conditional access',
    graphAlerts: 'Graph alerts',
    defenderMachines: 'Defender machines',
    defenderVulns: 'Defender vulnerabilities',
    defenderSoftware: 'Defender software inventory',
    defenderExposure: 'Defender exposure score'
  };

  const sources = Object.entries(updated)
    .filter(([, ok]) => ok)
    .map(([key]) => sourceLabels[key] || key);

  if (!sources.length) {
    if (!succeeded.length) {
      throw new Error(`Authenticated, but no supported live datasets were returned. ${errors.slice(0, 3).join(' | ')}`);
    }
    const fallbackSources = succeeded.map(key => sourceLabels[key] || key);
    setDataModeLabel(errors.length ? 'PARTIAL LIVE' : 'LIVE DATA');
    return { sources: fallbackSources, errors, noRows: true };
  }

  setDataModeLabel(errors.length ? 'PARTIAL LIVE' : 'LIVE DATA');
  return { sources, errors, noRows: false };
}
let activePolicyFilter = 'all';
let compensationStrictness = 'standard';
let activeDataFilter = 'all';
let activeSeverityFilter = 'all';
let appInventoryViewMode = 'grid';
let vulnSeverityViewMode = 'summary';
let remediationViewMode = 'actionable';
let threatWorkbenchMode = 'risk';
let deviceInventoryFilterMode = 'all';
let deviceMixMode = 'type';
let defenderVersionMetricMode = 'platform';
let selectedPolicyName = '';
let policyJourneyModel = null;
let uiShowTopRow = true;
const uiHiddenViews = new Set();
let uiTheme = 'light';
let standardsMitreView = 'coverage';
function applyUiTheme() {
  const dark = uiTheme === 'dark-mode';
  document.body.setAttribute('data-theme', dark ? 'dark-mode' : 'light');
  const btn = document.getElementById('nightModeBtn');
  if (btn) {
    btn.classList.toggle('active', dark);
    btn.setAttribute('aria-label', dark ? 'Enable light mode' : 'Enable dark mode');
    btn.setAttribute('title', dark ? 'Switch to light mode' : 'Switch to dark mode');
  }
}

function applyStandardsMitreView() {
  const split = document.querySelector('.standards-mitre-split');
  const coverageSection = document.getElementById('mitreCoverageSection');
  const heatmapSection = document.getElementById('mitreHeatmapSection');
  const coverageBtn = document.getElementById('mitreViewCoverageBtn');
  const heatmapBtn = document.getElementById('mitreViewHeatmapBtn');
  if (!split || !coverageSection || !heatmapSection || !coverageBtn || !heatmapBtn) return;

  const showCoverage = standardsMitreView !== 'heatmap';
  coverageSection.classList.toggle('view-hidden', !showCoverage);
  heatmapSection.classList.toggle('view-hidden', showCoverage);
  split.classList.add('single-view');

  coverageBtn.classList.toggle('active', showCoverage);
  heatmapBtn.classList.toggle('active', !showCoverage);
}

function applyUiPreferences() {
  document.body.classList.toggle('ui-hide-toprow', !uiShowTopRow);
  document.querySelectorAll('.topnav-tab[data-view]').forEach(btn => {
    const view = btn.dataset.view;
    const visible = !uiHiddenViews.has(view);
    btn.style.display = visible ? '' : 'none';
  });
  document.querySelectorAll('.customize-option input[data-ui-option]').forEach(input => {
    const option = input.dataset.uiOption;
    input.checked = option === 'toprow' ? uiShowTopRow : !uiHiddenViews.has(option);
  });

  const currentView = document.body.getAttribute('data-active-view') || 'overview';
  if (uiHiddenViews.has(currentView)) {
    const fallback = document.querySelector('.topnav-tab[data-view]:not([style*="display: none"])');
    if (fallback) switchView(fallback.dataset.view, fallback);
  }
}

function loadUiPreferences() {
  try {
    const raw = localStorage.getItem('xdr_ui_prefs');
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (typeof parsed.showTopRow === 'boolean') uiShowTopRow = parsed.showTopRow;
    if (typeof parsed.theme === 'string' && parsed.theme) {
      uiTheme = parsed.theme === 'cyber-mode' ? 'dark-mode' : parsed.theme;
    }
    if (parsed.mitreView === 'coverage' || parsed.mitreView === 'heatmap') {
      standardsMitreView = parsed.mitreView;
    }
    if (Array.isArray(parsed.hiddenViews)) {
      uiHiddenViews.clear();
      parsed.hiddenViews.forEach(v => {
        if (typeof v === 'string' && v) uiHiddenViews.add(v);
      });
    }
  } catch (_err) {
    // Ignore malformed local preferences.
  }
}

function saveUiPreferences() {
  try {
    localStorage.setItem('xdr_ui_prefs', JSON.stringify({
      showTopRow: uiShowTopRow,
      hiddenViews: Array.from(uiHiddenViews),
      theme: uiTheme,
      mitreView: standardsMitreView
    }));
  } catch (_err) {
    // Ignore storage write issues.
  }
}

function toDateSafe(value) {
  const d = new Date(value);
  return Number.isNaN(d.getTime()) ? null : d;
}

function getSeverityBucket(vuln) {
  const raw = String(vuln?.severity || '').toLowerCase();
  if (raw.includes('critical')) return 'critical';
  if (raw.includes('high')) return 'high';
  if (raw.includes('medium') || raw.includes('moderate')) return 'medium';
  if (raw.includes('low') || raw.includes('info')) return 'low';

  const cvss = Number(vuln?.cvss);
  if (Number.isFinite(cvss)) {
    if (cvss >= 9) return 'critical';
    if (cvss >= 7) return 'high';
    if (cvss >= 4) return 'medium';
  }
  return 'low';
}

function getSeverityLabel(bucket) {
  if (bucket === 'critical') return 'Critical';
  if (bucket === 'high') return 'High';
  if (bucket === 'medium') return 'Medium';
  return 'Low';
}

function getSeverityRank(vuln) {
  const bucket = getSeverityBucket(vuln);
  if (bucket === 'critical') return 4;
  if (bucket === 'high') return 3;
  if (bucket === 'medium') return 2;
  return 1;
}

function getEffectiveFilterAnchor(vulnList) {
  const dates = vulnList
    .map(v => toDateSafe(v.published))
    .filter(Boolean)
    .map(d => d.getTime());
  if (!dates.length) return new Date();
  return new Date(Math.max(...dates));
}

function getFilteredVulnerabilities() {
  let filtered = [...vulnerabilities];

  if (activeDataFilter === 'critical') {
    filtered = filtered.filter(v => getSeverityBucket(v) === 'critical');
  } else if (activeDataFilter === 'last7' || activeDataFilter === 'last30') {
    const days = activeDataFilter === 'last7' ? 7 : 30;
    const anchor = getEffectiveFilterAnchor(filtered);
    const from = new Date(anchor);
    from.setDate(from.getDate() - days);
    filtered = filtered.filter(v => {
      const date = toDateSafe(v.published);
      return date && date >= from && date <= anchor;
    });
  }

  if (activeSeverityFilter !== 'all') {
    filtered = filtered.filter(v => getSeverityBucket(v) === activeSeverityFilter);
  }

  return filtered;
}

function renderVulnSeverityPanel() {
  const grid = document.getElementById('vulnSeverityGrid');
  if (!grid) return;

  const summaryBtn = document.getElementById('vulnViewSummaryBtn');
  const byOsBtn = document.getElementById('vulnViewByOsBtn');
  if (summaryBtn) summaryBtn.classList.toggle('active', vulnSeverityViewMode === 'summary');
  if (byOsBtn) byOsBtn.classList.toggle('active', vulnSeverityViewMode === 'os');

  if (vulnSeverityViewMode === 'os') {
    const osAgg = {};
    devices.forEach(d => {
      const key = d.os || 'Unknown OS';
      osAgg[key] = (osAgg[key] || 0) + Number(d.vulns || 0);
    });
    const topOs = Object.entries(osAgg)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 4);
    const classes = ['crit', 'high', 'med', 'low'];

    grid.innerHTML = topOs.map(([os, total], idx) => `
      <div class="severity-cell ${classes[idx] || 'low'}" onclick="openDetail('os-${os.replace(/'/g, '')}')">
        <div class="sev-count">${total}</div>
        <div class="sev-label">${os.length > 20 ? `${os.slice(0, 19)}â€¦` : os}</div>
      </div>
    `).join('');
    return;
  }

  grid.innerHTML = `
    <div class="severity-cell crit" onclick="openDetail('vulnCritical')">
      <div class="sev-count" id="sevCountCritical">0</div>
      <div class="sev-label">Critical</div>
    </div>
    <div class="severity-cell high" onclick="openDetail('vulnHigh')">
      <div class="sev-count" id="sevCountHigh">0</div>
      <div class="sev-label">High</div>
    </div>
    <div class="severity-cell med" onclick="openDetail('vulnMedium')">
      <div class="sev-count" id="sevCountMedium">0</div>
      <div class="sev-label">Medium</div>
    </div>
    <div class="severity-cell low" onclick="openDetail('vulnLow')">
      <div class="sev-count" id="sevCountLow">0</div>
      <div class="sev-label">Low</div>
    </div>
  `;
  renderVulnSeveritySummary();
}

function renderVulnSeveritySummary() {
  const counts = { critical: 0, high: 0, medium: 0, low: 0 };
  getFilteredVulnerabilities().forEach(v => {
    const key = getSeverityBucket(v);
    if (counts[key] !== undefined) counts[key] += 1;
  });

  const criticalEl = document.getElementById('sevCountCritical');
  const highEl = document.getElementById('sevCountHigh');
  const mediumEl = document.getElementById('sevCountMedium');
  const lowEl = document.getElementById('sevCountLow');

  if (criticalEl) criticalEl.textContent = counts.critical.toLocaleString();
  if (highEl) highEl.textContent = counts.high.toLocaleString();
  if (mediumEl) mediumEl.textContent = counts.medium.toLocaleString();
  if (lowEl) lowEl.textContent = counts.low.toLocaleString();
}

function renderExecutiveSummary() {
  const filteredVulns = getFilteredVulnerabilities();
  const criticalVulns = filteredVulns.filter(v => getSeverityBucket(v) === 'critical').length;
  const totalDevices = devices.length;
  const healthyDevices = devices.filter(d => String(d.health).toLowerCase() === 'healthy').length;
  const compliancePct = totalDevices ? Math.round((healthyDevices / totalDevices) * 100) : 0;
  const enabledPolicies = caPolicies.filter(p => p.state === 'enabled').length;
  const reportOnlyPolicies = caPolicies.filter(p => p.state === 'report-only').length;
  const likelyCurrentDefender = devices.filter(d => String(d.defenderVer).includes('24110') || String(d.defenderVer).includes('24112')).length;
  const defenderCoverage = totalDevices ? Math.round((likelyCurrentDefender / totalDevices) * 100) : 0;
  const outdatedDefender = Math.max(0, totalDevices - likelyCurrentDefender);
  const mitreCompliance = MITRE_TACTICS.length
    ? Math.round(MITRE_TACTICS.reduce((sum, tactic) => sum + tactic.coverage, 0) / MITRE_TACTICS.length)
    : 0;
  const mitreLowCoverageCount = MITRE_TACTICS.filter(tactic => tactic.coverage < 70).length;
  const avgRisk = totalDevices ? (devices.reduce((sum, d) => sum + Number(d.riskScore || 0), 0) / totalDevices) : 0;
  const displayExposure = Number.isFinite(liveExposureScore) ? liveExposureScore : avgRisk;

  const exposureValue = document.getElementById('execExposureValue');
  const exposureSub = document.getElementById('execExposureSub');
  const mitreComplianceValue = document.getElementById('execMitreComplianceValue');
  const mitreComplianceSub = document.getElementById('execMitreComplianceSub');
  const criticalValue = document.getElementById('execCriticalVulnsValue');
  const criticalSub = document.getElementById('execCriticalVulnsSub');
  const complianceValue = document.getElementById('execDeviceComplianceValue');
  const complianceSub = document.getElementById('execDeviceComplianceSub');
  const devicesValue = document.getElementById('execManagedDevicesValue');
  const devicesSub = document.getElementById('execManagedDevicesSub');
  const policiesValue = document.getElementById('execPoliciesValue');
  const policiesSub = document.getElementById('execPoliciesSub');
  const defenderValue = document.getElementById('execDefenderCoverageValue');
  const defenderSub = document.getElementById('execDefenderCoverageSub');

  if (exposureValue) exposureValue.textContent = displayExposure.toFixed(1);
  if (exposureSub) exposureSub.innerHTML = `<span class="${displayExposure >= 60 ? 'trend-up' : 'trend-down'}">${displayExposure >= 60 ? 'â–²' : 'â–¼'} ${Math.abs(displayExposure - 50).toFixed(1)}</span> risk index`;
  if (mitreComplianceValue) mitreComplianceValue.textContent = `${mitreCompliance}%`;
  if (mitreComplianceSub) mitreComplianceSub.textContent = `${mitreLowCoverageCount} tactics below 70%`;
  if (criticalValue) criticalValue.textContent = criticalVulns.toLocaleString();
  if (criticalSub) criticalSub.innerHTML = `${filteredVulns.length.toLocaleString()} total tracked vulnerabilities`;
  if (complianceValue) complianceValue.textContent = `${compliancePct}%`;
  if (complianceSub) complianceSub.innerHTML = `${healthyDevices.toLocaleString()} healthy of ${totalDevices.toLocaleString()} devices`;
  if (devicesValue) devicesValue.textContent = totalDevices.toLocaleString();
  if (devicesSub) devicesSub.textContent = '';
  if (policiesValue) policiesValue.textContent = enabledPolicies.toLocaleString();
  if (policiesSub) policiesSub.textContent = `${reportOnlyPolicies.toLocaleString()} in report-only`;
  if (defenderValue) defenderValue.textContent = `${defenderCoverage}%`;
  if (defenderSub) defenderSub.textContent = `${outdatedDefender.toLocaleString()} devices outdated`;
  if (devicesSub) {
    const serverCount = devices.filter(d => d.type === 'Server').length;
    const workstationCount = devices.filter(d => d.type === 'Workstation').length;
    devicesSub.textContent = `${workstationCount.toLocaleString()} workstations Â· ${serverCount.toLocaleString()} servers`;
  }
}

function renderVulnList() {
  const container = document.getElementById('vulnList');
  if (!container) return;

  if (vulnSeverityViewMode === 'os') {
    const byOs = {};
    devices.forEach(device => {
      const key = device.os || 'Unknown OS';
      if (!byOs[key]) byOs[key] = { os: key, devices: 0, vulns: 0, highRisk: 0 };
      byOs[key].devices += 1;
      byOs[key].vulns += Number(device.vulns || 0);
      if (Number(device.riskScore || 0) >= 60) byOs[key].highRisk += 1;
    });

    const rows = Object.values(byOs)
      .sort((a, b) => b.vulns - a.vulns || b.devices - a.devices)
      .slice(0, 8);

    if (!rows.length) {
      container.innerHTML = `<div style="padding:10px 0;font-size:12px;color:var(--text-muted);">No OS vulnerability data available.</div>`;
      return;
    }

    container.innerHTML = rows.map(row => `
      <div class="vuln-item" onclick="openDetail('os-${row.os.replace(/'/g, '')}')">
        <div class="vuln-sev-badge ${row.vulns >= 20 ? 'critical' : row.vulns >= 12 ? 'high' : row.vulns >= 6 ? 'medium' : 'low'}"></div>
        <div class="vuln-info">
          <div class="vuln-cve">${row.os}</div>
          <div class="vuln-desc">${row.devices} device(s) Â· ${row.highRisk} high-risk endpoint(s)</div>
        </div>
        <div class="vuln-meta">
          <div class="vuln-devices">${row.devices} assets</div>
          <div class="vuln-cvss ${row.vulns >= 20 ? 'critical' : row.vulns >= 12 ? 'high' : row.vulns >= 6 ? 'medium' : 'low'}">${row.vulns}</div>
        </div>
      </div>
    `).join('');
    return;
  }

  const filteredVulns = getFilteredVulnerabilities();
  if (!filteredVulns.length) {
    container.innerHTML = `<div style="padding:10px 0;font-size:12px;color:var(--text-muted);">No vulnerabilities match the selected filters.</div>`;
    return;
  }

  container.innerHTML = filteredVulns.slice(0, 8).map(v => {
    const sevClass = getSeverityBucket(v);
    return `<div class="vuln-item" onclick="openVulnDetail('${encodeURIComponent(v.id)}')">
      <div class="vuln-sev-badge ${sevClass}"></div>
      <div class="vuln-info">
        <div class="vuln-cve">${v.id}${v.exploited ? ' <span style="color:var(--severity-critical);font-size:10px;">âš¡ EXPLOITED</span>' : ''}</div>
        <div class="vuln-desc">${v.title}</div>
      </div>
      <div class="vuln-meta">
        <div class="vuln-devices">${v.affectedDevices} devices</div>
        <div class="vuln-cvss ${sevClass}">${v.cvss.toFixed(1)}</div>
      </div>
    </div>`;
  }).join('');
}

function renderDeviceTypeSummary() {
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  document.getElementById('deviceTypeTotal').textContent = total.toLocaleString();
}

function renderDeviceOsSummary() {
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  document.getElementById('deviceOsTotal').textContent = total.toLocaleString();
}

function renderDeviceTypeChart() {
  const data = DEVICE_TYPE_DATA.map(item => ({ label: item.label, value: item.count, color: item.color }));
  const maxVal = Math.max(...data.map(d => d.value));
  document.getElementById('deviceTypeChart').innerHTML = `
    ${data.map(d => `
    <div class="bar-row interactive" role="button" tabindex="0" onclick="openDeviceTypeDetail('${d.label}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDeviceTypeDetail('${d.label}')}">
      <div class="bar-label" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
        <span style="width:8px;height:8px;border-radius:2px;background:${d.color};display:inline-block;flex-shrink:0;"></span>
        <span>${d.label}</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('')}
  `;
}

function openDeviceTypeDetail(typeLabel) {
  const typeData = DEVICE_TYPE_DATA.find(item => item.label === typeLabel);
  if (!typeData) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  const pct = ((typeData.count / total) * 100).toFixed(1);

  const matchingDevices = devices.filter(device => {
    if (typeLabel === 'Workstations') return device.type === 'Workstation';
    if (typeLabel === 'Servers') return device.type === 'Server';
    if (typeLabel === 'Mobile') return device.type === 'Mobile';
    if (typeLabel === 'IoT / Other') return !['Workstation', 'Server', 'Mobile'].includes(device.type);
    return false;
  });

  const health = { healthy: 0, warning: 0, critical: 0 };
  matchingDevices.forEach(device => {
    const key = device.health.toLowerCase();
    if (health[key] !== undefined) health[key] += 1;
  });

  const topOs = {};
  matchingDevices.forEach(device => {
    topOs[device.os] = (topOs[device.os] || 0) + 1;
  });
  const topOsList = Object.entries(topOs).sort((a, b) => b[1] - a[1]).slice(0, 3);
  const typeVulnMap = new Map();
  matchingDevices.forEach(device => {
    mapVulnerabilitiesForDevice(device).forEach(v => {
      const existing = typeVulnMap.get(v.id);
      if (!existing) {
        typeVulnMap.set(v.id, { ...v, mappedCount: 1 });
      } else {
        existing.mappedCount += 1;
      }
    });
  });
  const topTypeVulns = Array.from(typeVulnMap.values())
    .sort((a, b) => {
      if (a.exploited !== b.exploited) return a.exploited ? -1 : 1;
      return Number(b.cvss || 0) - Number(a.cvss || 0) || Number(b.mappedCount || 0) - Number(a.mappedCount || 0);
    })
    .slice(0, 8);

  const impactedDevices = matchingDevices
    .filter(device => device.vulns > 0)
    .sort((a, b) => b.vulns - a.vulns)
    .slice(0, 8)
    .map(device => {
      const mappedVulns = vulnerabilities
        .filter(vuln => {
          const osNorm = device.os.toLowerCase();
          const swNorm = vuln.software.toLowerCase();
          if (osNorm.includes('windows') && swNorm.includes('windows')) return true;
          if (osNorm.includes('macos') && swNorm.includes('macos')) return true;
          if ((osNorm.includes('ios') || osNorm.includes('android')) && (swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile'))) return true;
          return false;
        })
        .sort((a, b) => b.cvss - a.cvss)
        .slice(0, 3);
      return { device, mappedVulns };
    });

  title.textContent = `${typeLabel} Fleet Detail`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Coverage</div>
      <div style="font-size:40px;font-weight:800;color:${typeData.color};font-family:'JetBrains Mono';margin:6px 0;">${typeData.count.toLocaleString()}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${pct}% of total managed estate</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Health Snapshot (Sample Device Data)</div>
      <div class="detail-row"><span class="label">Healthy</span><span class="value">${health.healthy}</span></div>
      <div class="detail-row"><span class="label">Warning</span><span class="value" style="color:var(--status-warning);">${health.warning}</span></div>
      <div class="detail-row"><span class="label">Critical</span><span class="value" style="color:var(--status-noncompliant);">${health.critical}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Operating Systems (Sample)</div>
      ${topOsList.length ? topOsList.map(([os, count]) => `<div class="detail-row"><span class="label">${os}</span><span class="value">${count}</span></div>`).join('') : '<div style="font-size:12px;color:var(--text-muted);">No sample devices mapped for this type in prototype data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">${typeLabel === 'Workstations' ? 'PC Vulnerability List' : `${typeLabel} Vulnerability List`}</div>
      ${
        topTypeVulns.length
          ? topTypeVulns.map(v => `
              <div style="padding:9px 11px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:7px;">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-size:11px;font-weight:700;">${v.id}</span>
                  <span style="font-family:'JetBrains Mono',monospace;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-size:10px;font-weight:700;">CVSS ${Number(v.cvss || 0).toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);line-height:1.5;">${v.title}</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No mapped vulnerabilities for this device type in current sample data.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Action Focus</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        Prioritise patching and Defender version currency for this device class, then validate conditional access coverage and exposure-score contributors specific to ${typeLabel.toLowerCase()}.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Impacted Devices and Associated Vulnerabilities</div>
      ${
        impactedDevices.length
          ? impactedDevices.map(({ device, mappedVulns }) => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.vulns > 7 ? 'var(--severity-critical)' : device.vulns > 3 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">${device.vulns} vulns</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">${device.os} Â· ${device.location}</div>
                ${
                  mappedVulns.length
                    ? `<div style="font-size:11px;color:var(--text-secondary);line-height:1.55;">
                        ${mappedVulns.map(v => `<div>â€¢ <span style=\"font-family:'JetBrains Mono',monospace;color:var(--text-primary);\">${v.id}</span> (${v.cvss.toFixed(1)}) - ${v.title}</div>`).join('')}
                      </div>`
                    : `<div style="font-size:11px;color:var(--text-muted);">No direct vulnerability mapping available in sample data.</div>`
                }
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No impacted devices in this device type based on current sample dataset.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function renderDeviceOsChart() {
  const data = DEVICE_OS_DATA;
  const maxVal = Math.max(...data.map(d => d.value));
  document.getElementById('deviceOsChart').innerHTML = `
    ${data.map(d => `
    <div class="bar-row interactive" role="button" tabindex="0" onclick="openDeviceOsDetail('${d.label}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openDeviceOsDetail('${d.label}')}">
      <div class="bar-label" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
        <span style="width:8px;height:8px;border-radius:2px;background:${d.color};display:inline-block;flex-shrink:0;"></span>
        <span>${d.label}</span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('')}
  `;
}

function renderDeviceMixCard() {
  const chart = document.getElementById('deviceMixChart');
  const totalEl = document.getElementById('deviceMixTotal');
  const subEl = document.getElementById('deviceMixSub');
  const typeBtn = document.getElementById('deviceMixTypeBtn');
  const osBtn = document.getElementById('deviceMixOsBtn');
  if (!chart || !totalEl || !subEl) return;

  if (typeBtn) typeBtn.classList.toggle('active', deviceMixMode === 'type');
  if (osBtn) osBtn.classList.toggle('active', deviceMixMode === 'os');

  const rows = deviceMixMode === 'os'
    ? DEVICE_OS_DATA.map(item => ({ label: item.label, value: item.value, color: item.color, action: 'os' }))
    : DEVICE_TYPE_DATA.map(item => ({ label: item.label, value: item.count, color: item.color, action: 'type' }));
  const total = rows.reduce((sum, row) => sum + Number(row.value || 0), 0);
  totalEl.textContent = total.toLocaleString();
  subEl.textContent = deviceMixMode === 'os' ? 'Across all operating systems' : 'Across all device types';

  const maxVal = Math.max(1, ...rows.map(row => Number(row.value || 0)));
  chart.innerHTML = rows.map(row => {
    const label = String(row.label || '').replace(/'/g, "\\'");
    const handler = row.action === 'os' ? `openDeviceOsDetail('${label}')` : `openDeviceTypeDetail('${label}')`;
    return `
      <div class="bar-row interactive" role="button" tabindex="0" onclick="${handler}" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();${handler}}">
        <div class="bar-label" style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
          <span style="width:8px;height:8px;border-radius:2px;background:${row.color};display:inline-block;flex-shrink:0;"></span>
          <span>${row.label}</span>
        </div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${(row.value / maxVal) * 100}%;background:${row.color};">${row.value}</div>
        </div>
      </div>
    `;
  }).join('');
}

function getDevicesForOsLabel(osLabel) {
  return devices.filter(device => {
    const os = device.os.toLowerCase();
    if (osLabel === 'Win 11 23H2') return os.includes('windows 11 23h2');
    if (osLabel === 'Win 10 22H2') return os.includes('windows 10 22h2');
    if (osLabel === 'macOS 15') return os.includes('macos 15');
    if (osLabel === 'Server 2022') return os.includes('server 2022');
    if (osLabel === 'iOS/Android') return os.includes('ios') || os.includes('android');
    return false;
  });
}

function openDeviceOsDetail(osLabel) {
  const osData = DEVICE_OS_DATA.find(item => item.label === osLabel);
  if (!osData) return;

  const matchingDevices = getDevicesForOsLabel(osLabel);
  const total = DEVICE_TYPE_DATA.reduce((sum, item) => sum + item.count, 0);
  const pct = ((osData.value / total) * 100).toFixed(1);

  const health = { healthy: 0, warning: 0, critical: 0 };
  matchingDevices.forEach(device => {
    const key = device.health.toLowerCase();
    if (health[key] !== undefined) health[key] += 1;
  });

  const avgRisk = matchingDevices.length
    ? (matchingDevices.reduce((sum, device) => sum + device.riskScore, 0) / matchingDevices.length).toFixed(1)
    : '0.0';
  const avgVulns = matchingDevices.length
    ? (matchingDevices.reduce((sum, device) => sum + device.vulns, 0) / matchingDevices.length).toFixed(1)
    : '0.0';
  const staleTelemetry = matchingDevices.filter(device => {
    const seen = new Date(device.lastSeen).getTime();
    const now = Date.now();
    return (now - seen) > (24 * 60 * 60 * 1000);
  }).length;
  const outdatedDefender = matchingDevices.filter(device => !device.defenderVer.includes('24110') && !device.defenderVer.includes('24112')).length;

  const relatedVulns = vulnerabilities
    .filter(vuln => {
      const text = `${vuln.software} ${vuln.title}`.toLowerCase();
      if (osLabel === 'Win 11 23H2') return text.includes('windows 11') || text.includes('windows 10/11') || text.includes('edge');
      if (osLabel === 'Win 10 22H2') return text.includes('windows 10') || text.includes('windows 10/11') || text.includes('edge');
      if (osLabel === 'macOS 15') return text.includes('macos');
      if (osLabel === 'Server 2022') return text.includes('server 2022') || text.includes('server') || text.includes('windows');
      if (osLabel === 'iOS/Android') return text.includes('ios') || text.includes('android') || text.includes('mobile');
      return false;
    })
    .sort((a, b) => (b.exploited === a.exploited ? b.cvss - a.cvss : (b.exploited ? 1 : -1)))
    .slice(0, 8);

  const impactedDevices = matchingDevices
    .filter(device => device.vulns > 0)
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${osLabel} â€” OS Risk & Exposure`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Coverage</div>
      <div style="font-size:40px;font-weight:800;color:${osData.color};font-family:'JetBrains Mono';margin:6px 0;">${osData.value}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${pct}% of total managed estate</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Security Posture</div>
      <div class="detail-row"><span class="label">Healthy</span><span class="value">${health.healthy}</span></div>
      <div class="detail-row"><span class="label">Warning</span><span class="value" style="color:var(--status-warning);">${health.warning}</span></div>
      <div class="detail-row"><span class="label">Critical</span><span class="value" style="color:var(--status-noncompliant);">${health.critical}</span></div>
      <div class="detail-row"><span class="label">Average Risk Score</span><span class="value" style="font-family:JetBrains Mono;">${avgRisk}</span></div>
      <div class="detail-row"><span class="label">Average Open Vulns / Device</span><span class="value" style="font-family:JetBrains Mono;">${avgVulns}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Telemetry & Agent Health</div>
      <div class="detail-row"><span class="label">Devices with outdated Defender versions</span><span class="value" style="font-family:JetBrains Mono;${outdatedDefender ? 'color:var(--severity-high);' : ''}">${outdatedDefender}</span></div>
      <div class="detail-row"><span class="label">Devices stale >24h (last check-in)</span><span class="value" style="font-family:JetBrains Mono;${staleTelemetry ? 'color:var(--severity-high);' : ''}">${staleTelemetry}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Related Vulnerabilities & KB Updates</div>
      ${
        relatedVulns.length
          ? relatedVulns.map(v => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${v.id}</div>
                  <div style="font-size:10px;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;font-weight:700;">CVSS ${v.cvss.toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</div>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;">${v.title}</div>
                <div style="font-size:10px;color:var(--text-muted);line-height:1.5;">
                  ${(KB_PATCH_MAP[v.id] && KB_PATCH_MAP[v.id].length)
                    ? `KB/Update: ${KB_PATCH_MAP[v.id].map(k => `${k.kb} (${k.target})`).join(' Â· ')}`
                    : 'KB/Update: Validate in Microsoft Security Update Guide'}
                </div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No mapped vulnerabilities for this OS group in current sample data.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Highest-Risk Devices in this OS Group</div>
      ${
        impactedDevices.length
          ? impactedDevices.map(device => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
                <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${device.name}</span>
                <span>${device.location} Â· Risk ${device.riskScore} Â· ${device.vulns} vuln(s)</span>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No impacted devices in this OS group based on current sample dataset.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        1. Patch exploited/high-CVSS vulnerabilities first using mapped KB/update packages.<br>
        2. Upgrade outdated Defender engines/signatures and confirm heartbeat health.<br>
        3. Prioritize high-risk devices for remediation and re-scan to validate closure.<br>
        4. Review CA policy coverage for this OS cohort (especially unmanaged or stale devices).
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function mapVulnerabilitiesForDevice(device) {
  return vulnerabilities
    .filter(vuln => {
      const osNorm = device.os.toLowerCase();
      const swNorm = vuln.software.toLowerCase();
      if (osNorm.includes('windows') && swNorm.includes('windows')) return true;
      if (osNorm.includes('macos') && swNorm.includes('macos')) return true;
      if ((osNorm.includes('ios') || osNorm.includes('android')) && (swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile'))) return true;
      return false;
    })
    .sort((a, b) => b.cvss - a.cvss)
    .slice(0, 3);
}

function getRelatedDevicesForVulnerability(vuln) {
  const swNorm = vuln.software.toLowerCase();
  return devices.filter(device => {
    const osNorm = device.os.toLowerCase();
    if (swNorm.includes('windows') && osNorm.includes('windows')) return true;
    if (swNorm.includes('server') && device.type === 'Server') return true;
    if (swNorm.includes('edge') && osNorm.includes('windows')) return true;
    if (swNorm.includes('macos') && osNorm.includes('macos')) return true;
    if ((swNorm.includes('ios') || swNorm.includes('android') || swNorm.includes('mobile')) && (osNorm.includes('ios') || osNorm.includes('android') || device.type === 'Mobile')) return true;
    return false;
  });
}

function threatRelevanceScore(vuln) {
  const relatedDevices = getRelatedDevicesForVulnerability(vuln);
  const avgRisk = relatedDevices.length
    ? relatedDevices.reduce((sum, device) => sum + device.riskScore, 0) / relatedDevices.length
    : 30;
  const exposureFactor = Math.min(1, vuln.affectedDevices / 500);
  const exploitFactor = vuln.exploited ? 1 : 0.55;
  const cvssFactor = Math.min(1, vuln.cvss / 10);
  const businessFactor = Math.min(1, avgRisk / 100);
  const score = Math.round((cvssFactor * 0.35 + exploitFactor * 0.25 + exposureFactor * 0.20 + businessFactor * 0.20) * 100);
  return { score, relatedDevices, avgRisk };
}

function renderThreatWorkbench() {
  const riskBtn = document.getElementById('threatWorkbenchRiskBtn');
  const remediationBtn = document.getElementById('threatWorkbenchRemediationBtn');
  if (riskBtn) riskBtn.classList.toggle('active', threatWorkbenchMode === 'risk');
  if (remediationBtn) remediationBtn.classList.toggle('active', threatWorkbenchMode === 'remediation');

  const container = document.getElementById('threatWorkbenchList');
  if (!container) return;

  const ranked = getFilteredVulnerabilities()
    .map(vuln => ({ vuln, ...remediationPriority(vuln) }))
    .sort((a, b) => {
      if (threatWorkbenchMode === 'remediation') {
        const order = { P1: 3, P2: 2, P3: 1 };
        return (order[b.priority] - order[a.priority]) || (b.reductionEstimate - a.reductionEstimate) || (b.score - a.score);
      }
      return b.score - a.score;
    })
    .slice(0, 10);

  if (!ranked.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);">No threat items match the selected filters.</div>';
    return;
  }

  container.innerHTML = ranked.map(item => `
    <article class="remediation-item" onclick="${threatWorkbenchMode === 'remediation' ? 'openRemediationDetail' : 'openThreatRelevanceDetail'}('${item.vuln.id}')">
      <div class="remediation-head">
        <div class="remediation-title">${item.vuln.id}</div>
        <span class="prio-tag ${item.priority.toLowerCase()}">${item.priority} Â· ${priorityLabel(item.priority)}</span>
      </div>
      <div class="remediation-meta">
        ${item.vuln.title}<br>
        ${threatWorkbenchMode === 'remediation'
          ? `Suggested action: ${item.action}<br>Est. exposure score reduction if fixed: ${item.reductionEstimate} pts Â· Threat relevance score: ${item.score}/100`
          : `Threat relevance score: ${item.score}/100 Â· ${item.vuln.exploited ? 'Actively exploited' : 'No active exploitation flag'} Â· ${item.vuln.affectedDevices} affected endpoints`}
      </div>
      <div class="remediation-tags">
        ${item.tags.map(tag => `<span class="remediation-pill ${tag.tone}">${tag.text}</span>`).join('')}
      </div>
    </article>
  `).join('');
}

function renderMissingPatchesCard() {
  const container = document.getElementById('missingPatchesList');
  if (!container) return;

  const priorityWeight = { P1: 3, P2: 2, P3: 1 };
  const patchMap = new Map();

  getFilteredVulnerabilities().forEach(vuln => {
    const model = remediationPriority(vuln);
    const patchRefs = (KB_PATCH_MAP[vuln.id] && KB_PATCH_MAP[vuln.id].length)
      ? KB_PATCH_MAP[vuln.id]
      : [{ kb: `Patch for ${vuln.software}`, target: vuln.software, note: 'Vendor security update required' }];

    patchRefs.forEach(ref => {
      const key = `${ref.kb}__${ref.target}`;
      const published = toDateSafe(vuln.published);
      const existing = patchMap.get(key) || {
        kb: ref.kb,
        target: ref.target,
        note: ref.note || 'Security update required',
        priority: model.priority,
        score: 0,
        reductionEstimate: 0,
        maxCvss: 0,
        affectedDevices: 0,
        vulnCount: 0,
        exploitedCount: 0,
        primaryVulnId: vuln.id,
        oldestPublished: published,
        latestPublished: published,
        action: model.action
      };

      if (priorityWeight[model.priority] > priorityWeight[existing.priority]) existing.priority = model.priority;
      if (model.score > existing.score) {
        existing.score = model.score;
        existing.primaryVulnId = vuln.id;
        existing.action = model.action;
      }

      existing.reductionEstimate = Math.min(35, existing.reductionEstimate + model.reductionEstimate);
      existing.maxCvss = Math.max(existing.maxCvss, Number(vuln.cvss) || 0);
      existing.affectedDevices += Number(vuln.affectedDevices) || 0;
      existing.vulnCount += 1;
      existing.exploitedCount += vuln.exploited ? 1 : 0;

      if (published) {
        if (!existing.oldestPublished || published < existing.oldestPublished) existing.oldestPublished = published;
        if (!existing.latestPublished || published > existing.latestPublished) existing.latestPublished = published;
      }

      patchMap.set(key, existing);
    });
  });

  const ranked = Array.from(patchMap.values())
    .map(item => {
      const ageDays = item.oldestPublished ? Math.max(0, Math.floor((Date.now() - item.oldestPublished.getTime()) / 86400000)) : null;
      const cvssTone = item.maxCvss >= 9 ? 'critical' : item.maxCvss >= 7 ? 'high' : item.maxCvss >= 4 ? 'medium' : 'low';
      const exposureTone = item.affectedDevices >= 300 ? 'critical' : item.affectedDevices >= 150 ? 'high' : item.affectedDevices >= 60 ? 'medium' : 'low';
      const backlogTone = item.vulnCount >= 4 ? 'critical' : item.vulnCount >= 2 ? 'high' : 'medium';
      const tags = [
        { text: item.exploitedCount > 0 ? 'Exploit-linked patch' : 'No active exploit', tone: item.exploitedCount > 0 ? 'critical' : 'low' },
        { text: `Max CVSS ${item.maxCvss.toFixed(1)}`, tone: cvssTone },
        { text: `${item.affectedDevices} affected`, tone: exposureTone },
        { text: `${item.vulnCount} vulnerabilities mapped`, tone: backlogTone }
      ];
      return { ...item, ageDays, tags };
    })
    .sort((a, b) =>
      (priorityWeight[b.priority] - priorityWeight[a.priority]) ||
      (b.reductionEstimate - a.reductionEstimate) ||
      (b.score - a.score)
    )
    .slice(0, 10);

  if (!ranked.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);">No patch gaps match the selected filters.</div>';
    return;
  }

  container.innerHTML = ranked.map(item => `
    <article class="remediation-item" onclick="openRemediationDetail('${item.primaryVulnId}')">
      <div class="remediation-head">
        <div class="remediation-title">${item.kb}</div>
        <span class="prio-tag ${item.priority.toLowerCase()}">${item.priority} Â· ${priorityLabel(item.priority)}</span>
      </div>
      <div class="remediation-meta">
        ${item.target} Â· ${item.note}<br>
        Suggested action: ${item.action}<br>
        Exposure reduction if deployed: ${item.reductionEstimate} pts Â· Threat relevance: ${item.score}/100 Â· ${item.ageDays === null ? 'Advisory date unavailable' : `${item.ageDays} days since earliest advisory`}
      </div>
      <div class="remediation-tags">
        ${item.tags.map(tag => `<span class="remediation-pill ${tag.tone}">${tag.text}</span>`).join('')}
      </div>
    </article>
  `).join('');
}

function remediationPriority(vuln) {
  const { score, relatedDevices, avgRisk } = threatRelevanceScore(vuln);
  const reductionEstimate = Math.round(Math.min(18, (vuln.cvss * 0.9) + (vuln.exploited ? 5 : 1) + (Math.min(vuln.affectedDevices, 500) / 120)));
  const action = vuln.exploited
    ? 'Patch in emergency window and isolate high-risk devices.'
    : vuln.cvss >= 8
      ? 'Patch in next maintenance cycle and verify compensating controls.'
      : 'Schedule normal patch cycle and monitor exploit telemetry.';
  const priority = score >= 80 ? 'P1' : score >= 65 ? 'P2' : 'P3';
  const cvssTone = vuln.cvss >= 9 ? 'critical' : vuln.cvss >= 7 ? 'high' : vuln.cvss >= 4 ? 'medium' : 'low';
  const exposureTone = vuln.affectedDevices >= 300 ? 'critical' : vuln.affectedDevices >= 150 ? 'high' : vuln.affectedDevices >= 60 ? 'medium' : 'low';
  const riskTone = avgRisk >= 70 ? 'critical' : avgRisk >= 55 ? 'high' : avgRisk >= 40 ? 'medium' : 'low';
  const tags = [
    { text: vuln.exploited ? 'Actively exploited' : 'No active exploit', tone: vuln.exploited ? 'critical' : 'low' },
    { text: `CVSS ${vuln.cvss.toFixed(1)}`, tone: cvssTone },
    { text: `${vuln.affectedDevices} exposed`, tone: exposureTone },
    { text: `Avg device risk ${avgRisk.toFixed(0)}`, tone: riskTone }
  ];
  return { priority, score, reductionEstimate, action, relatedDevices, tags };
}

function priorityLabel(priority) {
  if (priority === 'P1') return 'Critical';
  if (priority === 'P2') return 'Important';
  return 'Planned';
}

function remediationPlaybook(vuln) {
  const text = `${vuln.title} ${vuln.software}`.toLowerCase();
  const actions = [];

  if (text.includes('windows') || text.includes('server')) {
    actions.push('Apply latest Microsoft cumulative security update (Patch Tuesday baseline) for impacted Windows/Server builds.');
    actions.push('Expedite deployment to internet-facing and privileged endpoints first; enforce reboot completion SLA.');
    actions.push('Verify KB deployment success and vulnerability closure via post-patch rescans.');
  }
  if (text.includes('edge') || text.includes('browser') || text.includes('mshtml') || text.includes('scripting')) {
    actions.push('Update Microsoft Edge/WebView2 runtime to latest stable build across all affected devices.');
    actions.push('Temporarily enforce attack surface reduction and SmartScreen/URL filtering hardening for browser-origin threats.');
  }
  if (text.includes('kernel') || text.includes('elevation') || text.includes('privilege') || text.includes('winlogon')) {
    actions.push('Harden privileged access: enforce MFA/PAW for admins and reduce local admin assignments pending patch completion.');
    actions.push('Enable enhanced EDR blocking mode and monitor suspicious token or privilege escalation behaviors.');
  }
  if (text.includes('update') || text.includes('stack') || text.includes('driver') || text.includes('clfs')) {
    actions.push('Validate update orchestration health (WSUS/Intune/ConfigMgr) and remediate failed deployment rings.');
    actions.push('Block vulnerable legacy drivers/modules where possible using endpoint protection configuration.');
  }
  if (!actions.length) {
    actions.push('Apply vendor security patch to affected software versions and validate closure through rescanning.');
    actions.push('Apply compensating controls (isolation, policy restrictions, IOC blocking) until full patch coverage is achieved.');
  }

  return actions.slice(0, 5);
}

function renderRemediationQueue() {
  const actionableBtn = document.getElementById('remediationActionableBtn');
  const reductionBtn = document.getElementById('remediationReductionBtn');
  const container = document.getElementById('remediationQueueList');
  if (!container) return;
  if (actionableBtn) actionableBtn.classList.toggle('active', remediationViewMode === 'actionable');
  if (reductionBtn) reductionBtn.classList.toggle('active', remediationViewMode === 'reduction');

  let ranked = getFilteredVulnerabilities().map(vuln => ({ vuln, ...remediationPriority(vuln) }));
  if (remediationViewMode === 'reduction') {
    ranked = ranked
      .sort((a, b) => b.reductionEstimate - a.reductionEstimate || b.score - a.score)
      .slice(0, 12);
  } else {
    ranked = ranked
      .sort((a, b) => {
        const order = { P1: 3, P2: 2, P3: 1 };
        return (order[b.priority] - order[a.priority]) || (b.score - a.score);
      })
      .slice(0, 12);
  }

  if (!ranked.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);">No remediation items match the selected filters.</div>';
    return;
  }

  container.innerHTML = ranked.map(item => `
    <article class="remediation-item" onclick="openRemediationDetail('${item.vuln.id}')">
      <div class="remediation-head">
        <div class="remediation-title">${item.vuln.id}</div>
        <span class="prio-tag ${item.priority.toLowerCase()}">${remediationViewMode === 'reduction' ? `${item.reductionEstimate}pts` : `${item.priority} Â· ${priorityLabel(item.priority)}`}</span>
      </div>
      <div class="remediation-meta">
        ${item.vuln.title}<br>
        Suggested action: ${item.action}<br>
        ${remediationViewMode === 'reduction'
          ? `Risk reduction potential: ${item.reductionEstimate} points if remediated promptly`
          : `Est. exposure score reduction if fixed: ${item.reductionEstimate} pts`}
      </div>
      <div class="remediation-tags">
        ${item.tags.map(tag => `<span class="remediation-pill ${tag.tone}">${tag.text}</span>`).join('')}
      </div>
    </article>
  `).join('');
}

function renderRiskMatrix() {
  const matrix = document.getElementById('riskMatrix');
  const data = Array.from({ length: 5 }, () => Array.from({ length: 5 }, () => 0));
  riskCellCache = {};

  const likelihoodFromVulns = (vulns) => {
    if (vulns >= 10) return 5;
    if (vulns >= 7) return 4;
    if (vulns >= 4) return 3;
    if (vulns >= 2) return 2;
    return 1;
  };
  const impactFromRiskScore = (riskScore) => {
    if (riskScore >= 75) return 5;
    if (riskScore >= 55) return 4;
    if (riskScore >= 40) return 3;
    if (riskScore >= 25) return 2;
    return 1;
  };

  devices.forEach(device => {
    const likelihood = likelihoodFromVulns(device.vulns);
    const impact = impactFromRiskScore(device.riskScore);
    const li = 5 - likelihood;
    const im = impact - 1;
    data[li][im] += 1;
    const key = `${li}-${im}`;
    if (!riskCellCache[key]) riskCellCache[key] = [];
    riskCellCache[key].push(device);
  });

  const riskLevel = (li, im) => {
    const score = (5 - li) * (im + 1);
    if (score >= 20) return 'r5';
    if (score >= 15) return 'r4';
    if (score >= 10) return 'r3';
    if (score >= 5) return 'r2';
    return 'r1';
  };

  const yLabels = ['5', '4', '3', '2', '1'];
  let html = '';

  for (let li = 0; li < 5; li++) {
    html += `<div class="risk-label">${yLabels[li]}</div>`;
    for (let im = 0; im < 5; im++) {
      const count = data[li][im];
      const countClass = count ? 'has-count' : '';
      const content = riskMatrixMode === 'compact' ? '' : (count || '');
      html += `<div class="risk-cell ${riskLevel(li, im)} ${countClass}" title="Likelihood ${5-li}, Impact ${im+1}: ${count} device(s)" onclick="openRiskCellDetail(${li}, ${im})">${content}</div>`;
    }
  }

  // Bottom labels
  html += `<div></div>`;
  for (let i = 1; i <= 5; i++) {
    html += `<div class="risk-label-x">${i}</div>`;
  }

  matrix.className = `risk-matrix ${riskMatrixMode === 'compact' ? 'compact' : ''}`.trim();
  matrix.innerHTML = html;
}

function openRiskCellDetail(li, im) {
  const key = `${li}-${im}`;
  const cellDevices = riskCellCache[key] || [];
  const likelihood = 5 - li;
  const impact = im + 1;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  const items = cellDevices.map(device => {
    const mappedVulns = mapVulnerabilitiesForDevice(device)
      .sort((a, b) => getSeverityRank(b) - getSeverityRank(a) || b.cvss - a.cvss);
    return { device, mappedVulns };
  });

  title.textContent = `Risk Matrix Cell â€” Likelihood ${likelihood}, Impact ${impact}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Cell Summary</div>
      <div class="detail-row"><span class="label">Devices in Cell</span><span class="value" style="font-family:JetBrains Mono;">${cellDevices.length}</span></div>
      <div class="detail-row"><span class="label">Likelihood</span><span class="value">${likelihood}</span></div>
      <div class="detail-row"><span class="label">Impact</span><span class="value">${impact}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Devices and Vulnerabilities</div>
      ${
        items.length
          ? items.map(({ device, mappedVulns }) => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore >= 75 ? 'var(--severity-critical)' : device.riskScore >= 55 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">${device.os} Â· ${device.location} Â· ${device.vulns} vuln(s)</div>
                ${
                  mappedVulns.length
                    ? `<div style="font-size:11px;color:var(--text-secondary);line-height:1.5;">
                        ${mappedVulns.map(v => `<div>â€¢ <span style=\"font-family:'JetBrains Mono',monospace;color:var(--text-primary);\">${v.id}</span> (${getSeverityLabel(getSeverityBucket(v))}, ${v.cvss.toFixed(1)}) - ${v.title}</div>`).join('')}
                      </div>`
                    : `<div style="font-size:11px;color:var(--text-muted);">No direct vulnerability mapping available in sample data.</div>`
                }
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No devices are currently mapped to this matrix cell.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function renderDeviceTable() {
  const tbody = document.getElementById('deviceTableBody');
  if (!tbody) return;

  const allBtn = document.getElementById('deviceFilterAllBtn');
  const nonCompliantBtn = document.getElementById('deviceFilterNonCompliantBtn');
  if (allBtn) allBtn.classList.toggle('active', deviceInventoryFilterMode === 'all');
  if (nonCompliantBtn) nonCompliantBtn.classList.toggle('active', deviceInventoryFilterMode === 'non-compliant');

  const rows = getFilteredDevicesForInventory();

  tbody.innerHTML = rows.map(d => {
    const healthClass = d.health.toLowerCase();
    const platformClass = classifyVersionBadge(d.defenderPlatformVer, 'platform');
    const engineClass = classifyVersionBadge(d.defenderEngineVer, 'engine');
    const intelClass = classifyVersionBadge(d.defenderSecurityIntelVer, 'security-intel');
    const missingPatchCount = getMissingOsPatchesForDevice(d).length;

    return `<tr onclick="openDeviceDetail('${encodeURIComponent(d.name)}')">
      <td><span class="device-name">${d.name}</span></td>
      <td><span class="device-type-badge">${d.type === 'Server' ? 'ðŸ–¥' : d.type === 'Mobile' ? 'ðŸ“±' : 'ðŸ’»'} ${d.type}</span></td>
      <td style="font-size:11px;">${d.os}</td>
      <td><span class="health-indicator"><span class="health-dot ${healthClass}"></span>${d.health}</span></td>
      <td><span class="version-badge ${platformClass}">${d.defenderPlatformVer || 'n/a'}</span></td>
      <td><span class="version-badge ${engineClass}">${d.defenderEngineVer || 'n/a'}</span></td>
      <td><span class="version-badge ${intelClass}">${d.defenderSecurityIntelVer || 'n/a'}</span></td>
      <td style="font-family:'JetBrains Mono';font-size:11px;color:${missingPatchCount > 0 ? 'var(--severity-high)' : 'var(--status-compliant)'};font-weight:${missingPatchCount > 0 ? '700' : '600'};">${missingPatchCount}</td>
      <td style="font-family:'JetBrains Mono';font-size:11px;${d.vulns > 10 ? 'color:var(--severity-critical);font-weight:600;' : ''}">${d.vulns}</td>
      <td style="font-family:'JetBrains Mono';font-size:11px;">${d.caPolicies}</td>
    </tr>`;
  }).join('');

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="10" style="font-size:12px;color:var(--text-muted);padding:14px 12px;">No devices match the selected inventory filter.</td></tr>`;
  }
}

function isDeviceNonCompliant(device) {
  const health = String(device.health || '').toLowerCase();
  const defenderVer = String(device.defenderVer || '');
  const outdatedDefender = !defenderVer.includes('24110') && !defenderVer.includes('24112');
  return health !== 'healthy' || Number(device.riskScore || 0) >= 55 || outdatedDefender;
}

function classifyVersionBadge(version, flavor = 'generic') {
  const value = String(version || '').trim();
  if (!value || value.toLowerCase() === 'n/a' || value.toLowerCase() === 'unknown') return 'outdated';

  if (flavor === 'security-intel') {
    const match = value.match(/^1\.(\d+)\./);
    const signatureTrain = match ? Number(match[1]) : NaN;
    if (Number.isFinite(signatureTrain)) {
      if (signatureTrain >= 420) return 'current';
      if (signatureTrain >= 400) return 'outdated';
      return 'critical';
    }
  }

  if (value.includes('2309') || value.includes('2308') || value.includes('2305')) return 'critical';
  if (value.includes('24110') || value.includes('24112')) return 'current';
  return 'outdated';
}

function compareVersionStrings(a, b) {
  const left = String(a || '').split(/[^0-9]+/).filter(Boolean).map(Number);
  const right = String(b || '').split(/[^0-9]+/).filter(Boolean).map(Number);
  const length = Math.max(left.length, right.length);
  for (let i = 0; i < length; i += 1) {
    const l = left[i] || 0;
    const r = right[i] || 0;
    if (l !== r) return l - r;
  }
  return 0;
}

function getMissingOsPatchesForDevice(device, providedMappedVulns = null) {
  const osNorm = String(device?.os || '').toLowerCase();
  const mappedVulns = Array.isArray(providedMappedVulns) ? providedMappedVulns : mapVulnerabilitiesForDevice(device);
  const missingOsPatches = new Map();

  mappedVulns.forEach(vuln => {
    (KB_PATCH_MAP[vuln.id] || []).forEach(patch => {
      const target = String(patch.target || '').toLowerCase();
      const isOsPatchTarget = target.includes('windows') || target.includes('server') || target.includes('ubuntu') || target.includes('linux') || target.includes('mac') || target.includes('ios') || target.includes('android');
      if (!isOsPatchTarget) return;

      let match = false;
      if (osNorm.includes('windows') && target.includes('windows')) {
        match = true;
        if (target.includes('11') && !osNorm.includes('11')) match = false;
        if (target.includes('10') && !osNorm.includes('10')) match = false;
      } else if (osNorm.includes('server') && target.includes('server')) {
        match = true;
      } else if (osNorm.includes('ubuntu') && target.includes('ubuntu')) {
        match = true;
      } else if (osNorm.includes('linux') && target.includes('linux')) {
        match = true;
      } else if (osNorm.includes('mac') && target.includes('mac')) {
        match = true;
      } else if (osNorm.includes('ios') && target.includes('ios')) {
        match = true;
      } else if (osNorm.includes('android') && target.includes('android')) {
        match = true;
      }
      if (!match) return;

      const key = `${patch.kb}::${patch.target}`;
      if (!missingOsPatches.has(key)) {
        missingOsPatches.set(key, {
          kb: patch.kb,
          target: patch.target,
          note: patch.note,
          cveId: vuln.id
        });
      }
    });
  });

  return Array.from(missingOsPatches.values());
}

function getFilteredDevicesForInventory() {
  if (deviceInventoryFilterMode === 'non-compliant') {
    return devices.filter(isDeviceNonCompliant);
  }
  return devices;
}

function exportDeviceInventoryCsv() {
  const rows = getFilteredDevicesForInventory();
  const headers = ['Device Name', 'Type', 'OS', 'Health', 'Defender Platform Version', 'Defender Engine Version', 'Defender Security Intelligence Version', 'Missing OS Patches', 'Vulnerabilities', 'CA Policies', 'Risk Score', 'Last Seen'];
  const csvRows = [
    headers.join(','),
    ...rows.map(d => ([
      d.name,
      d.type,
      d.os,
      d.health,
      d.defenderPlatformVer || 'n/a',
      d.defenderEngineVer || 'n/a',
      d.defenderSecurityIntelVer || 'n/a',
      getMissingOsPatchesForDevice(d).length,
      d.vulns,
      d.caPolicies,
      d.riskScore,
      d.lastSeen
    ]).map(value => `"${String(value).replace(/"/g, '""')}"`).join(','))
  ];

  const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0, 10);
  a.href = url;
  a.download = `device-inventory-${deviceInventoryFilterMode}-${stamp}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function renderCAPolicies() {
  const filteredPolicies = getFilteredPolicies();
  if (!selectedPolicyName || !filteredPolicies.some(p => p.name === selectedPolicyName)) {
    selectedPolicyName = filteredPolicies.length ? filteredPolicies[0].name : '';
  }
  const container = document.getElementById('caPolicyList');
  container.innerHTML = filteredPolicies.map(p => {
    const stateClass = p.state === 'enabled' ? 'enabled' : p.state === 'report-only' ? 'report-only' : 'disabled';
    const coverageBand = p.coverage >= 90 ? 'High' : p.coverage >= 60 ? 'Medium' : 'Low';
    const escapedName = p.name.replace(/'/g, "\\'");
    return `<div class="ca-item ${selectedPolicyName === p.name ? 'selected' : ''}" role="button" tabindex="0" onclick="openPolicyDetailFromList('${escapedName}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyDetailFromList('${escapedName}')}">
      <div class="ca-item-header">
        <div class="ca-item-name">${p.name}</div>
        <span class="ca-status-badge ${stateClass}">${p.state === 'report-only' ? 'Report Only' : p.state.charAt(0).toUpperCase() + p.state.slice(1)}</span>
      </div>
      <div class="ca-detail-row">
        <span>ðŸ‘¥ ${p.users.toLocaleString()} users</span>
        <span>ðŸ“± ${p.apps.length > 25 ? p.apps.substring(0,25)+'...' : p.apps}</span>
      </div>
      <div class="ca-coverage-bar">
        <div class="ca-coverage-fill" style="width:${p.coverage}%"></div>
      </div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:4px;">${p.coverage}% coverage (${coverageBand})</div>
    </div>`;
  }).join('');

  if (!filteredPolicies.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:8px 2px;">No policies match the selected filter.</div>';
  }
}

function getFilteredPolicies() {
  if (activePolicyFilter === 'all') return caPolicies;
  if (activePolicyFilter === 'report-only') return caPolicies.filter(p => p.state === 'report-only');
  if (activePolicyFilter === 'low-coverage') return caPolicies.filter(p => p.coverage < 80);
  if (activePolicyFilter === 'high-gap') {
    return caPolicies.filter(p => assessPolicyGap(p).score >= 35);
  }
  return caPolicies;
}

function assessPolicyGap(policy) {
  const gaps = [];
  let score = 0;

  if (policy.state === 'report-only') {
    gaps.push('Policy is report-only and not enforcing control outcomes.');
    score += 40;
  }
  if (policy.coverage < 80) {
    gaps.push(`Coverage is ${policy.coverage}% and leaves broad user/app segments unprotected.`);
    score += 28;
  } else if (policy.coverage < 95) {
    gaps.push(`Coverage is ${policy.coverage}% and should be extended to close residual access paths.`);
    score += 14;
  }
  if (policy.grantControls.toLowerCase().includes('mfa') === false) {
    gaps.push('No explicit MFA/authentication-strength requirement in grant controls.');
    score += 18;
  }
  if (policy.sessionControls.toLowerCase() === 'none') {
    gaps.push('No session controls configured for token/session risk reduction.');
    score += 12;
  }

  const severity = score >= 55 ? 'critical' : score >= 35 ? 'high' : score >= 20 ? 'medium' : 'low';
  const mitre = POLICY_MITRE_MAP[policy.name] || { tactics: [], techniques: [], threats: [] };
  const recommendations = [];

  if (policy.state === 'report-only') recommendations.push('Move from report-only to enabled after pilot validation.');
  if (policy.coverage < 95) recommendations.push('Expand scope with phased rollout groups until >=95% coverage.');
  if (policy.grantControls.toLowerCase().includes('mfa') === false) recommendations.push('Add MFA or phishing-resistant authentication strength as a grant control.');
  if (policy.sessionControls.toLowerCase() === 'none') recommendations.push('Apply sign-in frequency/token protection/session restrictions for risky scenarios.');
  if (!recommendations.length) recommendations.push('Maintain current policy baseline and monitor exceptions weekly.');

  return { score, severity, gaps, mitre, recommendations };
}

function normalizePolicyTextSet(value) {
  const text = String(value || '').toLowerCase();
  if (!text || text === 'none') return [];
  return Array.from(new Set(
    text
      .split(',')
      .map(part => part.trim())
      .filter(Boolean)
  )).sort();
}

function jaccardSimilarity(setA, setB) {
  const a = Array.isArray(setA) ? setA : [];
  const b = Array.isArray(setB) ? setB : [];
  if (!a.length && !b.length) return 1;
  const aa = new Set(a);
  const bb = new Set(b);
  const intersection = Array.from(aa).filter(x => bb.has(x)).length;
  const union = new Set([...a, ...b]).size;
  if (!union) return 0;
  return intersection / union;
}

function tokenizeConditions(value) {
  const text = String(value || '').toLowerCase();
  if (!text || text === 'none') return [];
  return Array.from(new Set(
    text
      .split(/[,/()Â·]+/)
      .map(part => part.trim())
      .filter(Boolean)
  )).sort();
}

function getCompensationStrictnessConfig() {
  if (compensationStrictness === 'lenient') {
    return {
      evidenceMinOverlap: 40,
      strongMinOverlap: 60
    };
  }
  if (compensationStrictness === 'strict') {
    return {
      evidenceMinOverlap: 55,
      strongMinOverlap: 80
    };
  }
  return {
    evidenceMinOverlap: 45,
    strongMinOverlap: 70
  };
}

function policyHasControl(policy, controlKey) {
  const name = String(policy?.name || '').toLowerCase();
  const apps = String(policy?.apps || '').toLowerCase();
  const cond = String(policy?.conditions || '').toLowerCase();
  const grant = String(policy?.grantControls || '').toLowerCase();
  const session = String(policy?.sessionControls || '').toLowerCase();
  const combined = `${name} ${apps} ${cond} ${grant} ${session}`;

  if (controlKey === 'guestExternal') return /guest|external|b2b/i.test(combined);
  if (controlKey === 'authStrength') return /mfa|authentication strength|phishing-resistant/i.test(grant);
  if (controlKey === 'deviceCompliance') return /compliant|hybrid/i.test(grant);
  if (controlKey === 'sessionToken') return session !== 'none' && session.trim() !== '';
  if (controlKey === 'riskSignals') return /risk|token protection|phishing-resistant/i.test(combined);
  if (controlKey === 'enforcementState') return String(policy?.state || '').toLowerCase() === 'enabled';
  return false;
}

function policyScopeOverlapScore(policyA, policyB) {
  const appsA = normalizePolicyTextSet(policyA?.apps);
  const appsB = normalizePolicyTextSet(policyB?.apps);
  const condA = tokenizeConditions(policyA?.conditions);
  const condB = tokenizeConditions(policyB?.conditions);
  const coverageA = Number(policyA?.coverage || 0);
  const coverageB = Number(policyB?.coverage || 0);

  const appsSim = jaccardSimilarity(appsA, appsB);
  const condSim = jaccardSimilarity(condA, condB);
  const coverageSim = 1 - Math.min(1, Math.abs(coverageA - coverageB) / 100);

  return {
    appsSim,
    condSim,
    coverageSim,
    score: Math.round((appsSim * 45) + (condSim * 45) + (coverageSim * 10))
  };
}

function evaluateControlCompensation(primaryPolicy, controlKey, controlPresent) {
  const cfg = getCompensationStrictnessConfig();
  const primaryEnabled = String(primaryPolicy?.state || '').toLowerCase() === 'enabled';
  if (controlPresent && primaryEnabled) {
    return {
      status: 'covered',
      tone: 'good',
      label: 'Covered',
      residual: 'Control is directly enforced in this policy.',
      evidence: []
    };
  }

  const candidates = (Array.isArray(caPolicies) ? caPolicies : [])
    .filter(p => p && p.name !== primaryPolicy?.name)
    .map(p => {
      if (!policyHasControl(p, controlKey)) return null;
      const overlap = policyScopeOverlapScore(primaryPolicy, p);
      const state = String(p.state || '').toLowerCase();
      const stateWeight = state === 'enabled' ? 1 : state === 'report-only' ? 0.45 : 0;
      const coverageWeight = Math.max(0, Math.min(1, Number(p.coverage || 0) / 100));
      const overlapWeight = Math.max(0, Math.min(1, overlap.score / 100));
      const contribution = overlapWeight * coverageWeight * stateWeight;
      return {
        name: p.name,
        state: p.state || 'unknown',
        overlap: overlap.score,
        contribution: Math.round(contribution * 100),
        appsOverlap: Math.round(overlap.appsSim * 100),
        condOverlap: Math.round(overlap.condSim * 100)
      };
    })
    .filter(Boolean)
    .filter(item => item.overlap >= cfg.evidenceMinOverlap)
    .sort((a, b) => b.contribution - a.contribution || b.overlap - a.overlap);

  const combinedCoverage = candidates.length
    ? (1 - candidates.reduce((product, item) => product * (1 - Math.max(0, Math.min(1, item.contribution / 100))), 1))
    : 0;
  const combinedPct = Math.round(combinedCoverage * 100);
  if (combinedPct >= cfg.strongMinOverlap) {
    return {
      status: 'compensated',
      tone: 'warn',
      label: 'Compensated',
      residual: `Aggregate overlap-weighted coverage from ${candidates.length} policy${candidates.length === 1 ? '' : 'ies'} is ${combinedPct}%. Residual risk remains for uncovered segments outside overlap scope.`,
      evidence: candidates.slice(0, 3)
    };
  }

  return {
    status: 'unmitigated',
    tone: 'bad',
    label: 'Unmitigated Gap',
    residual: candidates.length
      ? `Aggregate overlap-weighted coverage across matching policies is ${combinedPct}%, below the ${cfg.strongMinOverlap}% threshold.`
      : 'No overlapping enforced policy was found for this control path.',
    evidence: candidates.slice(0, 3)
  };
}

function buildPolicyOverlapInsights(policies) {
  const list = Array.isArray(policies) ? policies : [];
  const pairs = [];
  for (let i = 0; i < list.length; i += 1) {
    for (let j = i + 1; j < list.length; j += 1) {
      const a = list[i];
      const b = list[j];
      const appsA = normalizePolicyTextSet(a.apps);
      const appsB = normalizePolicyTextSet(b.apps);
      const grantA = normalizePolicyTextSet(a.grantControls);
      const grantB = normalizePolicyTextSet(b.grantControls);
      const sessionA = normalizePolicyTextSet(a.sessionControls);
      const sessionB = normalizePolicyTextSet(b.sessionControls);
      const condA = tokenizeConditions(a.conditions);
      const condB = tokenizeConditions(b.conditions);

      const appsSim = jaccardSimilarity(appsA, appsB);
      const grantSim = jaccardSimilarity(grantA, grantB);
      const sessionSim = jaccardSimilarity(sessionA, sessionB);
      const conditionSim = jaccardSimilarity(condA, condB);
      const stateSim = String(a.state || '') === String(b.state || '') ? 1 : 0;
      const coverageSim = 1 - Math.min(1, Math.abs(Number(a.coverage || 0) - Number(b.coverage || 0)) / 100);

      const overlapScore = Math.round(
        (appsSim * 24)
        + (conditionSim * 24)
        + (grantSim * 22)
        + (sessionSim * 15)
        + (stateSim * 10)
        + (coverageSim * 5)
      );

      const sameScope = appsSim >= 0.75 && conditionSim >= 0.75;
      const differentOutcome = grantSim < 0.45 || sessionSim < 0.45 || stateSim === 0;
      const exactDuplicate = overlapScore >= 95 && grantSim >= 0.95 && sessionSim >= 0.95 && stateSim === 1;
      const conflict = sameScope && differentOutcome;
      const highOverlap = overlapScore >= 80 && !exactDuplicate;
      const classification = exactDuplicate ? 'exact' : conflict ? 'conflict' : highOverlap ? 'high' : 'low';
      if (classification === 'low') continue;

      const reasons = [];
      if (appsSim >= 0.8) reasons.push('Cloud app scope substantially overlaps.');
      if (conditionSim >= 0.8) reasons.push('Condition targeting is near-identical.');
      if (grantSim < 0.45) reasons.push('Grant controls diverge for similar scope (potential conflict).');
      if (sessionSim < 0.45) reasons.push('Session control behavior differs for overlapping scope.');
      if (stateSim === 0) reasons.push('Policy states differ (enabled/report-only/disabled).');

      const actions = [];
      if (exactDuplicate) {
        actions.push(`Retire one duplicate policy after confirming there are no hidden exclusions in ${a.name} or ${b.name}.`);
        actions.push('Keep a single owner-assigned baseline policy and document the retained policy as source of truth.');
      } else if (conflict) {
        actions.push('Split baseline and exception intent clearly: one baseline policy, one narrowly scoped exception policy.');
        actions.push('Align grant/session outcomes for common scope or reduce overlap by narrowing assignments/conditions.');
      } else {
        actions.push('Merge overlapping controls into one policy where outcomes are materially the same.');
        actions.push('Convert one candidate policy to report-only temporarily, validate no impact, then remove.');
      }
      actions.push('Validate with Conditional Access insights and sign-in logs before final retirement.');

      pairs.push({
        id: `${encodeURIComponent(a.name)}::${encodeURIComponent(b.name)}`,
        a,
        b,
        overlapScore,
        classification,
        reasons,
        actions,
        metrics: {
          appsSim: Math.round(appsSim * 100),
          conditionSim: Math.round(conditionSim * 100),
          grantSim: Math.round(grantSim * 100),
          sessionSim: Math.round(sessionSim * 100),
          coverageSim: Math.round(coverageSim * 100)
        }
      });
    }
  }

  pairs.sort((x, y) => y.overlapScore - x.overlapScore);

  const summary = {
    exact: pairs.filter(item => item.classification === 'exact').length,
    high: pairs.filter(item => item.classification === 'high').length,
    conflict: pairs.filter(item => item.classification === 'conflict').length
  };

  return { summary, pairs };
}

function overlapClassLabel(classification) {
  if (classification === 'exact') return 'Exact Duplicate';
  if (classification === 'conflict') return 'Conflicting Overlap';
  return 'High Overlap';
}

function overlapPillClass(classification) {
  if (classification === 'exact') return 'critical';
  if (classification === 'conflict') return 'high';
  return 'medium';
}

function renderPolicyOverlapInsights() {
  const filteredPolicies = getFilteredPolicies();
  const overlap = buildPolicyOverlapInsights(filteredPolicies);
  const summaryEl = document.getElementById('policyOverlapSummary');
  const listEl = document.getElementById('policyOverlapList');

  if (summaryEl) {
    summaryEl.innerHTML = `
      <article class="policy-gap-cell">
        <div class="k">Exact Duplicates</div>
        <div class="v" style="color:var(--severity-critical);">${overlap.summary.exact}</div>
        <div class="s">Same control path and same outcome</div>
      </article>
      <article class="policy-gap-cell">
        <div class="k">High Overlap</div>
        <div class="v" style="color:var(--severity-high);">${overlap.summary.high}</div>
        <div class="s">Likely merge candidates</div>
      </article>
      <article class="policy-gap-cell">
        <div class="k">Conflicting Overlap</div>
        <div class="v" style="color:var(--severity-medium);">${overlap.summary.conflict}</div>
        <div class="s">Same scope with different control outcomes</div>
      </article>
    `;
  }

  if (listEl) {
    const top = overlap.pairs.slice(0, 6);
    listEl.innerHTML = top.length
      ? top.map(item => `
          <article class="policy-gap-item" role="button" tabindex="0" onclick="openPolicyOverlapDetail('${item.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyOverlapDetail('${item.id}')}">
            <div class="policy-gap-head">
              <div class="policy-gap-title">${item.a.name} <span style="color:var(--text-muted);">vs</span> ${item.b.name}</div>
              <span class="policy-pill ${overlapPillClass(item.classification)}">${overlapClassLabel(item.classification)} Â· ${item.overlapScore}%</span>
            </div>
            <div class="policy-gap-meta">
              App overlap ${item.metrics.appsSim}% Â· Conditions ${item.metrics.conditionSim}% Â· Grant ${item.metrics.grantSim}% Â· Session ${item.metrics.sessionSim}%<br>
              ${item.reasons[0] || 'Review for consolidation opportunity.'}
            </div>
          </article>
        `).join('')
      : '<div style="font-size:12px;color:var(--text-muted);">No overlap or duplication risks detected in the current policy filter.</div>';
  }
}

function renderPolicyGapInsights() {
  const assessed = getFilteredPolicies().map(policy => ({ policy, ...assessPolicyGap(policy) }));
  const criticalCount = assessed.filter(x => x.severity === 'critical').length;
  const highCount = assessed.filter(x => x.severity === 'high').length;
  const reportOnlyCount = assessed.filter(x => x.policy.state === 'report-only').length;
  const avgCoverage = assessed.length ? Math.round(assessed.reduce((sum, x) => sum + x.policy.coverage, 0) / assessed.length) : 0;

  const summary = document.getElementById('policyGapSummary');
  if (summary) {
    summary.innerHTML = `
      <article class="policy-gap-cell" role="button" tabindex="0" onclick="openPolicyGapBucketDetail('critical')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyGapBucketDetail('critical')}">
        <div class="k">Critical Gaps</div>
        <div class="v" style="color:var(--severity-critical);">${criticalCount}</div>
        <div class="s">Immediate policy hardening required</div>
      </article>
      <article class="policy-gap-cell" role="button" tabindex="0" onclick="openPolicyGapBucketDetail('high')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyGapBucketDetail('high')}">
        <div class="k">High Gaps</div>
        <div class="v" style="color:var(--severity-high);">${highCount}</div>
        <div class="s">Address in current sprint</div>
      </article>
      <article class="policy-gap-cell" role="button" tabindex="0" onclick="openPolicyGapBucketDetail('coverage')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyGapBucketDetail('coverage')}">
        <div class="k">Avg Coverage</div>
        <div class="v">${avgCoverage}%</div>
        <div class="s">${reportOnlyCount} policies still report-only</div>
      </article>
    `;
  }

  const gapList = document.getElementById('policyGapList');
  if (gapList) {
    const top = assessed.sort((a, b) => b.score - a.score).slice(0, 5);
    gapList.innerHTML = top.length ? top.map(item => `
      <article class="policy-gap-item ${selectedPolicyName === item.policy.name ? 'selected' : ''}" role="button" tabindex="0" onclick="openPolicyDetailFromList('${item.policy.name.replace(/'/g, "\\'")}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyDetailFromList('${item.policy.name.replace(/'/g, "\\'")}')}">
        <div class="policy-gap-head">
          <div class="policy-gap-title">${item.policy.name}</div>
          <span class="policy-pill ${item.severity}">Gap ${item.score}</span>
        </div>
        <div class="policy-gap-meta">
          ${item.gaps[0] || 'No material gaps identified.'}<br>
      Recommended: ${item.recommendations[0]}
        </div>
      </article>
    `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No policy gaps match the selected filter.</div>';
  }

  renderPolicyOverlapInsights();
}

function renderPolicyMitreCoverage() {
  const container = document.getElementById('policyFocusPanel');
  if (!container) return;

  const filteredPolicies = getFilteredPolicies();
  const selected = caPolicies.find(p => p.name === selectedPolicyName && filteredPolicies.some(fp => fp.name === p.name))
    || filteredPolicies[0]
    || null;

  if (!selected) {
    container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);">No policy selected in the current filter context.</div>';
    policyJourneyModel = null;
    return;
  }
  if (selectedPolicyName !== selected.name) selectedPolicyName = selected.name;

  const assessment = assessPolicyGap(selected);
  const hasMfa = String(selected.grantControls || '').toLowerCase().includes('mfa')
    || String(selected.grantControls || '').toLowerCase().includes('authentication strength');
  const hasCompliant = String(selected.grantControls || '').toLowerCase().includes('compliant');
  const hasSession = String(selected.sessionControls || '').toLowerCase() !== 'none';
  const hasRiskSignals = /risk|token protection|phishing-resistant/i.test(selected.name)
    || /risk|token/i.test(selected.conditions || '');
  const enabledState = selected.state === 'enabled';
  const allApps = /all cloud apps/i.test(selected.apps || '');
  const platformScoped = !/all platforms/i.test(selected.conditions || '');
  const hasSignInFrequency = /sign-in frequency/i.test(selected.sessionControls || '');
  const hasTokenProtection = /token/i.test(`${selected.name} ${selected.grantControls} ${selected.sessionControls}`);
  const hasAuthStrength = /authentication strength|phishing-resistant|mfa/i.test(selected.grantControls || '');
  const guestOrExternalScope = /guest|external|b2b/i.test(`${selected.name} ${selected.conditions}`);
  const signalTone = (ok, warn = false) => (ok ? 'good' : warn ? 'warn' : 'bad');
  const compensationLabel = comp => (comp?.status === 'covered' ? 'Covered' : comp?.status === 'compensated' ? 'Compensated' : 'Unmitigated');
  const compensationTone = comp => (comp?.status === 'covered' ? 'good' : comp?.status === 'compensated' ? 'warn' : 'bad');
  const scoreWithComp = (score, comp, cap = 84) => (comp?.status === 'compensated' ? Math.min(cap, score + 18) : score);

  const scopeComp = evaluateControlCompensation(selected, 'guestExternal', guestOrExternalScope);
  const authComp = evaluateControlCompensation(selected, 'authStrength', hasAuthStrength);
  const deviceComp = evaluateControlCompensation(selected, 'deviceCompliance', hasCompliant);
  const sessionComp = evaluateControlCompensation(selected, 'sessionToken', hasSession);
  const riskComp = evaluateControlCompensation(selected, 'riskSignals', hasRiskSignals);
  const enforcementComp = enabledState
    ? { status: 'covered', tone: 'good', label: 'Covered', residual: 'Policy is directly enforcing outcomes.', evidence: [] }
    : evaluateControlCompensation(selected, 'enforcementState', false);

  const stageTone = score => (score >= 80 ? 'good' : score >= 55 ? 'warn' : 'bad');
  const laneDetails = [
    {
      icon: 'ðŸ‘¤',
      name: 'Identity',
      options: 'Users/Groups, Roles, Guests/External, Workload IDs',
      status: `Guest scope: ${guestOrExternalScope ? 'Explicit' : 'Not explicit'} Â· ${compensationLabel(scopeComp)}`
    },
    {
      icon: 'ðŸ”‘',
      name: 'MFA / Auth',
      options: 'MFA, Auth Strength, Phishing-resistant, Passwordless',
      status: `Auth requirement: ${hasAuthStrength ? 'Present' : 'Missing'} Â· ${compensationLabel(authComp)}`
    },
    {
      icon: 'ðŸ’»',
      name: 'OS / Device',
      options: 'Compliant Device, Hybrid Join, Platforms, Device Filters',
      status: `Device trust: ${hasCompliant ? 'Required' : 'Not required'} Â· ${compensationLabel(deviceComp)}`
    },
    {
      icon: 'ðŸ§©',
      name: 'Application',
      options: 'All Apps, Selected Apps, User Actions, Exclusions',
      status: `App scope: ${allApps ? 'All cloud apps' : 'Targeted'}`
    },
    {
      icon: 'ðŸ”',
      name: 'Session',
      options: 'Sign-in Frequency, Persistent Browser, Token Controls',
      status: `Session controls: ${hasSession ? 'Enabled' : 'None'} Â· ${compensationLabel(sessionComp)}`
    },
    {
      icon: 'ðŸŒ',
      name: 'Context',
      options: 'Locations, Sign-in Risk, User Risk, Client App Types',
      status: `Risk signals: ${hasRiskSignals ? 'Integrated' : 'Limited'} Â· ${compensationLabel(riskComp)}`
    },
    {
      icon: 'ðŸ›¡ï¸',
      name: 'Decision + Outcome',
      options: 'Grant Logic, Block/Allow, Report-only/Enabled, Monitoring',
      status: `Policy state: ${selected.state} Â· ${compensationLabel(enforcementComp)}`
    }
  ];
  const stagePlaybooks = {
    scopeTargeting: {
      controlArea: 'Assignments > Users / Workload identities',
      status: guestOrExternalScope
        ? 'Guest/external users appear to be explicitly included.'
        : 'Guest/external users are not explicitly included.',
      targetConfig: 'Include all users plus guest/external users. Keep exclusions to emergency access accounts only.',
      steps: [
        'Open the policy and go to Assignments > Users.',
        'Set Include to All users and enable Guest or external users.',
        'Review Exclude and keep only approved break-glass identities.',
        'Document scope rationale for privileged, workforce, and guest cohorts.'
      ],
      validation: 'Check sign-in logs for guest users and confirm this policy is evaluated and enforced.',
      apiField: 'conditions.users (includeUsers, excludeUsers, includeGuestsOrExternalUsers)'
    },
    identityProofing: {
      controlArea: 'Access controls > Grant',
      status: hasAuthStrength
        ? 'Strong authentication requirement is present.'
        : 'No explicit MFA/authentication strength requirement found.',
      targetConfig: 'Require MFA or phishing-resistant authentication strength for targeted users and high-risk roles.',
      steps: [
        'Open Access controls > Grant for this policy.',
        'Enable Require authentication strength or Require multifactor authentication.',
        'For admin scope, prefer phishing-resistant methods where possible.',
        'Test with pilot users before broad enforcement.'
      ],
      validation: 'Run test sign-ins and confirm MFA/auth strength challenge is consistently applied.',
      apiField: 'grantControls (builtInControls, authenticationStrength)'
    },
    devicePlatform: {
      controlArea: 'Conditions > Device platforms + Filter for devices; Access controls > Grant',
      status: hasCompliant
        ? 'Compliant-device enforcement is present.'
        : 'Compliant-device requirement is missing.',
      targetConfig: 'Require compliant or hybrid-joined devices and apply explicit platform targeting for sensitive apps.',
      steps: [
        'In Conditions > Device platforms, explicitly scope supported OS sets.',
        'Add device filters for high-risk scenarios where needed.',
        'In Grant controls, require device to be marked as compliant (or hybrid joined).',
        'Review exceptions for BYOD and document compensating controls.'
      ],
      validation: 'Confirm unmanaged test devices are blocked and compliant devices succeed for intended apps.',
      apiField: 'conditions.platforms, conditions.devices, grantControls'
    },
    appScope: {
      controlArea: 'Assignments > Cloud apps or actions',
      status: allApps
        ? 'All cloud apps are in scope.'
        : 'Policy covers a targeted app set only.',
      targetConfig: 'Protect all high-value cloud apps and admin entry points; avoid unmanaged app blind spots.',
      steps: [
        'Review Cloud apps assignment against critical business and admin services.',
        'Expand scope to all cloud apps where policy objective is baseline protection.',
        'Where targeted scope is required, add companion policies to cover adjacent services.',
        'Track app onboarding so new SaaS services inherit baseline controls.'
      ],
      validation: 'Cross-check app sign-in logs and confirm each critical app is covered by at least one enforced policy.',
      apiField: 'conditions.applications (includeApplications, excludeApplications)'
    },
    sessionToken: {
      controlArea: 'Access controls > Session',
      status: hasSession
        ? 'Session controls are configured.'
        : 'Session controls are not configured.',
      targetConfig: 'Set sign-in frequency and token/session restrictions appropriate to risk and data sensitivity.',
      steps: [
        'Open Access controls > Session.',
        'Set sign-in frequency for privileged and high-risk sessions.',
        'Enable available token protection/session restrictions for token theft reduction.',
        'Align browser/session controls with data protection requirements.'
      ],
      validation: 'Verify token replay and long-lived session scenarios are reduced in sign-in and session telemetry.',
      apiField: 'sessionControls (signInFrequency, persistentBrowser, tokenProtection where available)'
    },
    riskDecision: {
      controlArea: 'Conditions > Sign-in risk and User risk',
      status: hasRiskSignals
        ? 'Risk-based controls are in use.'
        : 'Risk-based conditions are limited or absent.',
      targetConfig: 'Use sign-in risk and user risk to drive adaptive MFA/block/password-reset decisions.',
      steps: [
        'Enable sign-in risk and/or user risk conditions in policy assignments.',
        'Bind high risk outcomes to stronger controls (block, password change, stronger auth).',
        'Ensure risk-based policy does not remain indefinitely in report-only mode.',
        'Tune thresholds using observed false positive rates.'
      ],
      validation: 'Review risky sign-in events and confirm policy response matches intended risk thresholds.',
      apiField: 'conditions.signInRiskLevels, conditions.userRiskLevels, grantControls'
    },
    enforcementOutcome: {
      controlArea: 'Policy state + Monitoring',
      status: enabledState
        ? 'Policy is enforcing outcomes.'
        : 'Policy is not fully enforced.',
      targetConfig: 'Run report-only briefly for validation, then move to enabled and monitor drift continuously.',
      steps: [
        'Set policy state to Enabled after pilot validation.',
        'Track policy impact and failures in sign-in logs and Conditional Access insights.',
        'Review exclusions monthly and remove stale exceptions.',
        'Define rollback criteria and owner accountability for each policy.'
      ],
      validation: 'Confirm policy state is enabled and enforcement outcomes match expected business controls.',
      apiField: 'state, templateId/id, modifiedDateTime, conditionalAccessStatus in sign-in logs'
    }
  };

  const stages = [
    {
      id: 'scope-targeting',
      icon: 'ðŸŽ¯',
      name: 'Scope & Targeting',
      actor: 'Identities',
      score: scoreWithComp(selected.coverage >= 90 ? 88 : selected.coverage >= 70 ? 66 : 38, scopeComp, 80),
      summary: `Users and workload targeting are ${selected.coverage >= 90 ? 'well-covered' : 'partially scoped'} (${selected.coverage}% coverage).`,
      config: `Users: ${Number(selected.users || 0).toLocaleString()} Â· Conditions: ${selected.conditions || 'None'}`,
      bestPractice: 'Target all applicable identities with minimal exclusion sets and explicit segmentation for admin/guest cohorts.',
      gap: guestOrExternalScope
        ? (selected.coverage >= 90 ? 'Scope is close to best-practice baseline.' : `Coverage gap detected (${selected.coverage}%) indicating potential bypass segments.`)
        : (scopeComp.status === 'compensated'
          ? `Guest/external scope is not explicit in this policy, but overlapping policy coverage is compensating. ${scopeComp.residual}`
          : 'Guest/external scope is not explicit and no reliable compensating policy was found.'),
      signals: [
        { icon: 'ðŸ‘¤', key: 'Identities', value: `${Number(selected.users || 0).toLocaleString()} in scope`, tone: signalTone(selected.coverage >= 90, selected.coverage >= 70) },
        { icon: 'ðŸ‘¥', key: 'Guest / External', value: guestOrExternalScope ? 'Explicitly addressed' : 'Not explicit', tone: signalTone(guestOrExternalScope, true) },
        { icon: 'ðŸ§­', key: 'Coverage', value: `${selected.coverage}%`, tone: signalTone(selected.coverage >= 90, selected.coverage >= 70) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(scopeComp), tone: compensationTone(scopeComp) }
      ],
      compensation: scopeComp,
      playbook: stagePlaybooks.scopeTargeting,
      mitre: {
        tactics: ['Initial Access', 'Credential Access'],
        techniques: ['T1078 Valid Accounts', 'T1110 Brute Force'],
        threats: ['Credential stuffing', 'Password spray']
      }
    },
    {
      id: 'identity-auth',
      icon: 'ðŸ”‘',
      name: 'Identity Proofing',
      actor: 'Authentication',
      score: scoreWithComp(hasAuthStrength ? 93 : 34, authComp, 82),
      summary: hasAuthStrength ? 'MFA / auth strength controls are enforced at sign-in.' : 'Identity assurance is weak due to missing MFA/auth-strength requirements.',
      config: `Grant controls: ${selected.grantControls || 'None'}`,
      bestPractice: 'Enforce MFA or phishing-resistant authentication strength for privileged and high-risk identity paths.',
      gap: hasAuthStrength
        ? 'Authentication controls align with baseline requirements.'
        : (authComp.status === 'compensated'
          ? `No strong identity proofing gate in this policy, but compensating policy coverage exists. ${authComp.residual}`
          : 'No strong identity proofing gate detected in grant controls.'),
      signals: [
        { icon: 'ðŸ”', key: 'MFA / Auth Strength', value: hasAuthStrength ? 'Required' : 'Missing', tone: signalTone(hasAuthStrength) },
        { icon: 'âš ï¸', key: 'Policy State', value: selected.state === 'report-only' ? 'Report-only' : selected.state, tone: signalTone(selected.state === 'enabled', selected.state === 'report-only') },
        { icon: 'ðŸ§ª', key: 'Risk-Aware Auth', value: hasRiskSignals ? 'Present' : 'Limited', tone: signalTone(hasRiskSignals, true) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(authComp), tone: compensationTone(authComp) }
      ],
      compensation: authComp,
      playbook: stagePlaybooks.identityProofing,
      mitre: {
        tactics: ['Credential Access', 'Initial Access'],
        techniques: ['T1110 Brute Force', 'T1556 Modify Authentication Process'],
        threats: ['Password spray', 'Auth bypass attempts']
      }
    },
    {
      id: 'device-platform',
      icon: 'ðŸ’»',
      name: 'Device, OS & Platform',
      actor: 'Endpoint Context',
      score: scoreWithComp(hasCompliant && platformScoped ? 86 : hasCompliant || platformScoped ? 62 : 36, deviceComp, 80),
      summary: `Device trust ${hasCompliant ? 'is' : 'is not'} enforced; platform conditions are ${platformScoped ? 'scoped' : 'broad/all-platform'}.`,
      config: `Conditions: ${selected.conditions || 'All platforms'} Â· Grant controls: ${selected.grantControls || 'None'}`,
      bestPractice: 'Bind access to compliant/hybrid-joined endpoints and explicit OS/platform conditions for sensitive app access.',
      gap: hasCompliant
        ? (platformScoped ? 'Device and platform controls are in place.' : 'Device trust is present but platform segmentation can be tighter.')
        : (deviceComp.status === 'compensated'
          ? `Compliant-device requirement is missing here but compensated by overlapping policy coverage. ${deviceComp.residual}`
          : 'Compliant-device requirement is missing.'),
      signals: [
        { icon: 'ðŸ–¥ï¸', key: 'Compliant Device', value: hasCompliant ? 'Required' : 'Not required', tone: signalTone(hasCompliant) },
        { icon: 'ðŸ§¬', key: 'OS / Platform Scope', value: platformScoped ? selected.conditions : 'All platforms', tone: signalTone(platformScoped, true) },
        { icon: 'ðŸ“±', key: 'Endpoint Path', value: hasCompliant ? 'Managed-first' : 'Mixed / unmanaged', tone: signalTone(hasCompliant, true) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(deviceComp), tone: compensationTone(deviceComp) }
      ],
      compensation: deviceComp,
      playbook: stagePlaybooks.devicePlatform,
      mitre: {
        tactics: ['Execution', 'Persistence'],
        techniques: ['T1204 User Execution', 'T1547 Boot or Logon Autostart'],
        threats: ['Unmanaged endpoint access', 'Persistence on non-compliant hosts']
      }
    },
    {
      id: 'app-targeting',
      icon: 'ðŸ§©',
      name: 'Application Scope',
      actor: 'Cloud Apps',
      score: allApps || String(selected.apps || '').split(',').length >= 2 ? 82 : 55,
      summary: allApps ? 'All cloud apps are covered by this policy.' : `Application scope is targeted: ${selected.apps}`,
      config: `Applications: ${selected.apps || 'All cloud apps'}`,
      bestPractice: 'Protect all critical SaaS entry points and remove blind spots across high-value cloud apps.',
      gap: allApps ? 'Coverage is broad across apps.' : 'Targeted app scope may leave adjacent cloud workflows uncovered.',
      signals: [
        { icon: 'ðŸ§©', key: 'App Coverage', value: selected.apps || 'All cloud apps', tone: signalTone(allApps, true) },
        { icon: 'ðŸ“¦', key: 'Scope Type', value: allApps ? 'Global app scope' : 'Targeted app list', tone: signalTone(allApps, true) },
        { icon: 'ðŸ”—', key: 'Cross-App Consistency', value: allApps ? 'High' : 'Medium', tone: signalTone(allApps, true) }
      ],
      playbook: stagePlaybooks.appScope,
      mitre: {
        tactics: ['Lateral Movement', 'Command and Control'],
        techniques: ['T1021 Remote Services', 'T1133 External Remote Services'],
        threats: ['Cloud app pivoting', 'Service-to-service abuse']
      }
    },
    {
      id: 'session-controls',
      icon: 'ðŸ”',
      name: 'Session & Token Controls',
      actor: 'Session Security',
      score: scoreWithComp(hasSession && hasTokenProtection ? 88 : hasSession ? 68 : 33, sessionComp, 80),
      summary: hasSession ? `Session controls active (${selected.sessionControls}).` : 'No session controls configured for token/session hardening.',
      config: `Session controls: ${selected.sessionControls || 'None'}`,
      bestPractice: 'Use sign-in frequency, token protection, and session restrictions to reduce replay and long-lived token abuse.',
      gap: hasSession
        ? (hasTokenProtection ? 'Session and token controls both present.' : 'Session controls active but token-specific controls are limited.')
        : (sessionComp.status === 'compensated'
          ? `Session controls are missing in this policy, but overlapping enforced policy coverage is compensating. ${sessionComp.residual}`
          : 'Session controls missing.'),
      signals: [
        { icon: 'â±ï¸', key: 'Sign-in Frequency', value: hasSignInFrequency ? 'Configured' : 'Not explicit', tone: signalTone(hasSignInFrequency, true) },
        { icon: 'ðŸªª', key: 'Token Protection', value: hasTokenProtection ? 'Present' : 'Absent', tone: signalTone(hasTokenProtection, true) },
        { icon: 'ðŸ”’', key: 'Session Restriction', value: hasSession ? 'Enabled' : 'Disabled', tone: signalTone(hasSession) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(sessionComp), tone: compensationTone(sessionComp) }
      ],
      compensation: sessionComp,
      playbook: stagePlaybooks.sessionToken,
      mitre: {
        tactics: ['Defense Evasion', 'Credential Access'],
        techniques: ['T1528 Steal Application Access Token', 'T1550 Use Alternate Authentication Material'],
        threats: ['Token replay', 'Session theft']
      }
    },
    {
      id: 'risk-decision',
      icon: 'ðŸ›¡ï¸',
      name: 'Risk Decision Engine',
      actor: 'Adaptive Decision',
      score: scoreWithComp(hasRiskSignals ? 84 : 52, riskComp, 82),
      summary: hasRiskSignals ? 'Risk-aware policy signals detected in current control design.' : 'Limited explicit risk signal usage.',
      config: `State: ${selected.state} Â· Conditions: ${selected.conditions || 'None'}`,
      bestPractice: 'Blend static controls (MFA/device) with adaptive risk decisioning for sign-in and token risk.',
      gap: hasRiskSignals
        ? 'Risk signal integration present.'
        : (riskComp.status === 'compensated'
          ? `Risk-adaptive logic is not explicit in this policy, but another enforced policy is compensating. ${riskComp.residual}`
          : 'Risk-adaptive decision controls should be expanded.'),
      signals: [
        { icon: 'ðŸ“Š', key: 'Risk Signals', value: hasRiskSignals ? 'Integrated' : 'Minimal', tone: signalTone(hasRiskSignals, true) },
        { icon: 'âš¡', key: 'Response Mode', value: enabledState ? 'Enforced' : selected.state, tone: signalTone(enabledState, selected.state === 'report-only') },
        { icon: 'ðŸŽšï¸', key: 'Decision Quality', value: hasRiskSignals ? 'Adaptive' : 'Static', tone: signalTone(hasRiskSignals, true) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(riskComp), tone: compensationTone(riskComp) }
      ],
      compensation: riskComp,
      playbook: stagePlaybooks.riskDecision,
      mitre: {
        tactics: assessment.mitre.tactics,
        techniques: assessment.mitre.techniques,
        threats: assessment.mitre.threats
      }
    },
    {
      id: 'enforcement-outcome',
      icon: 'âœ…',
      name: 'Enforcement & Monitoring',
      actor: 'Control Outcome',
      score: scoreWithComp(enabledState ? (selected.coverage >= 90 ? 92 : 72) : selected.state === 'report-only' ? 44 : 18, enforcementComp, 78),
      summary: enabledState ? 'Policy actively blocks/challenges traffic according to control path.' : (selected.state === 'report-only' ? 'Policy is monitor-only (report-only).' : 'Policy disabled.'),
      config: `Policy state: ${selected.state} Â· Gap score: ${assessment.score}`,
      bestPractice: 'Move report-only controls to enforced mode after pilot validation; avoid long-lived disabled controls.',
      gap: enabledState
        ? 'Enforcement active.'
        : (enforcementComp.status === 'compensated'
          ? `This policy is not fully enforced, but overlapping enabled policies currently compensate. ${enforcementComp.residual}`
          : 'Control is not fully enforced; outcome relies on monitoring only.'),
      signals: [
        { icon: 'ðŸš¦', key: 'Enforcement State', value: selected.state, tone: signalTone(enabledState, selected.state === 'report-only') },
        { icon: 'ðŸ“ˆ', key: 'Coverage', value: `${selected.coverage}%`, tone: signalTone(selected.coverage >= 90, selected.coverage >= 70) },
        { icon: 'ðŸ§ ', key: 'Gap Score', value: String(assessment.score), tone: signalTone(assessment.score < 25, assessment.score < 45) },
        { icon: 'ðŸ§©', key: 'Effective Coverage', value: compensationLabel(enforcementComp), tone: compensationTone(enforcementComp) }
      ],
      compensation: enforcementComp,
      playbook: stagePlaybooks.enforcementOutcome,
      mitre: {
        tactics: ['Impact', 'Defense Evasion'],
        techniques: ['T1562 Impair Defenses', 'T1070 Indicator Removal on Host'],
        threats: ['Control bypass due to non-enforced policy state']
      }
    }
  ];

  const overall = Math.round(stages.reduce((sum, stage) => sum + stage.score, 0) / stages.length);
  const policyOptions = filteredPolicies.map(p => `
    <option value="${encodeURIComponent(p.name)}" ${p.name === selected.name ? 'selected' : ''}>${p.name}</option>
  `).join('');
  const stageWidthPx = 240;
  const journeyWidth = container.clientWidth || window.innerWidth || 1200;
  const connectorWidth = 30;
  const itemGap = 10;
  const perStageFootprint = stageWidthPx + connectorWidth + (itemGap * 2);
  let stagesPerRow = Math.floor((journeyWidth + connectorWidth + (itemGap * 2)) / perStageFootprint);
  if (!Number.isFinite(stagesPerRow) || stagesPerRow < 1) stagesPerRow = 1;
  stagesPerRow = Math.min(stagesPerRow, stages.length);
  const fullRowWidth = (stagesPerRow * stageWidthPx)
    + (Math.max(0, stagesPerRow - 1) * connectorWidth)
    + (Math.max(0, (stagesPerRow * 2) - 2) * itemGap);
  const stageRows = [];
  for (let i = 0; i < stages.length; i += stagesPerRow) {
    stageRows.push(stages.slice(i, i + stagesPerRow));
  }
  policyJourneyModel = {
    policyName: selected.name,
    state: selected.state,
    coverage: selected.coverage,
    gapScore: assessment.score,
    mitre: assessment.mitre,
    recommendations: assessment.recommendations,
    stages
  };

  container.innerHTML = `
    <div class="policy-journey-wrap">
      <div class="policy-journey-overview">
        <div class="policy-journey-overview-head">
          <div class="policy-journey-controls">
            <select class="policy-journey-select" onchange="selectPolicyFromJourney(this.value)" aria-label="Select policy for journey map">
              ${policyOptions}
            </select>
            <div class="policy-journey-score">Journey Score ${overall} Â· Gap ${assessment.score}</div>
          </div>
        </div>
        <div class="policy-journey-lanes">
          ${laneDetails.map(lane => `
            <div class="policy-lane-chip">
              <div class="policy-lane-head"><span class="ic">${lane.icon}</span><span>${lane.name}</span></div>
              <div class="policy-lane-options">${lane.options}</div>
              <div class="policy-lane-status">${lane.status}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="policy-journey-stages" style="--journey-track-width:${fullRowWidth}px;">
        ${stageRows.map((row, rowIdx) => {
          const reverse = rowIdx % 2 === 1;
          const displayRow = reverse ? [...row].reverse() : row;
          const connectorClass = reverse ? 'policy-flow-link reverse' : 'policy-flow-link';
          const connectorSvg = reverse
            ? '<svg viewBox="0 0 30 16"><path d="M24 8 L2 8"/><circle cx="2" cy="8" r="2.5"/></svg>'
            : '<svg viewBox="0 0 30 16"><path d="M2 8 L24 8"/><circle cx="24" cy="8" r="2.5"/></svg>';
          const hasNextRow = rowIdx < stageRows.length - 1;
          const rowDropClass = reverse ? 'policy-row-drop left' : 'policy-row-drop right';
          const rowDropSvg = reverse
            ? '<svg viewBox="0 0 18 26"><path d="M9 2 L9 22"/><circle cx="9" cy="22" r="2.5"/></svg>'
            : '<svg viewBox="0 0 18 26"><path d="M9 2 L9 22"/><circle cx="9" cy="22" r="2.5"/></svg>';
          return `
            <div class="policy-journey-row ${reverse ? 'reverse' : ''}">
              ${displayRow.map((stage, idx) => `
                <div class="policy-journey-stage ${stageTone(stage.score)}" style="width:${stageWidthPx}px;min-width:${stageWidthPx}px;max-width:${stageWidthPx}px;" role="button" tabindex="0" onclick="openPolicyJourneyStageDetail('${stage.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openPolicyJourneyStageDetail('${stage.id}')}">
                  <div class="policy-journey-stage-head">
                    <div class="policy-journey-stage-name"><span class="policy-stage-title"><span class="policy-stage-icon">${stage.icon}</span><span>${stage.name}</span></span></div>
                    <div class="policy-journey-stage-meta">${stage.score}/100 Â· ${stage.actor}</div>
                  </div>
                  <div class="policy-journey-stage-desc">${stage.summary}</div>
                  <div class="policy-stage-signals">
                    ${(stage.signals || []).map(s => `<div class="policy-stage-signal ${s.tone || ''}"><span class="k">${s.icon || 'â€¢'} ${s.key}</span><span class="v">${s.value}</span></div>`).join('')}
                  </div>
                </div>
                ${idx < displayRow.length - 1 ? `<div class="${connectorClass}" aria-hidden="true">${connectorSvg}</div>` : ''}
              `).join('')}
            </div>
            ${hasNextRow ? `<div class="${rowDropClass}" aria-hidden="true">${rowDropSvg}</div>` : ''}
          `;
        }).join('')}
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div style="font-size:10px;color:var(--text-muted);">Click any stage for full control-path detail, best-practice checks, and ATT&amp;CK references.</div>
        <button class="card-action-btn" type="button" onclick="openCADetail('${selected.name.replace(/'/g, "\\'")}')">Open Full Policy Detail</button>
      </div>
    </div>
  `;
}

function openPolicyJourneyStageDetail(stageId) {
  if (!policyJourneyModel || !Array.isArray(policyJourneyModel.stages)) return;
  const stage = policyJourneyModel.stages.find(item => item.id === stageId);
  if (!stage) return;
  const fmtRefs = items => (Array.isArray(items) && items.length ? items.join(', ') : 'Not mapped');
  const policyPath = `Entra admin center > Protection > Conditional Access > Policies > ${policyJourneyModel.policyName}`;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  const stageTone = stage.score >= 80 ? 'var(--status-compliant)' : stage.score >= 55 ? 'var(--severity-medium)' : 'var(--severity-critical)';
  const refs = stage.mitre || { tactics: [], techniques: [], threats: [] };
  const playbook = stage.playbook || null;
  const comp = stage.compensation || { status: 'covered', label: 'Covered', residual: 'Control is directly enforced in this policy.', evidence: [] };
  const compColor = comp.status === 'covered'
    ? 'var(--status-compliant)'
    : comp.status === 'compensated'
      ? 'var(--severity-medium)'
      : 'var(--severity-critical)';

  title.textContent = `${policyJourneyModel.policyName} â€” ${stage.name}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Journey Stage Score</div>
      <div style="font-size:42px;font-weight:800;color:${stageTone};font-family:'JetBrains Mono';margin:6px 0;">${stage.score}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${stage.actor} validation point in the conditional access journey.</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Current Configuration Signal</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${stage.config}</div>
      <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;">${stage.summary}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Stage Elements</div>
      ${
        Array.isArray(stage.signals) && stage.signals.length
          ? stage.signals.map(s => `<div class="detail-row"><span class="label">${s.icon || 'â€¢'} ${s.key}</span><span class="value" style="font-family:JetBrains Mono;">${s.value}</span></div>`).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No stage element details available.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Best-Practice Reference</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${stage.bestPractice}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Detected Misconfiguration / Gap</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${stage.gap}</div>
    </div>
    ${
      playbook
        ? `
          <div class="detail-section">
            <div class="detail-section-title">Stage Remediation Playbook</div>
            <div class="detail-row"><span class="label">Where to Change</span><span class="value">${policyPath}</span></div>
            <div class="detail-row"><span class="label">Control Area</span><span class="value">${playbook.controlArea}</span></div>
            <div class="detail-row"><span class="label">Current Finding</span><span class="value">${playbook.status}</span></div>
            <div class="detail-row"><span class="label">Target Configuration</span><span class="value">${playbook.targetConfig}</span></div>
            <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;">
              <strong style="color:var(--text-primary);">Exact Change Steps</strong><br>
              ${playbook.steps.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;"><strong style="color:var(--text-primary);">Validation</strong>: ${playbook.validation}</div>
            <div style="margin-top:8px;font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;background:var(--bg-elevated);padding:8px 10px;border-radius:6px;word-break:break-word;">API field check: ${playbook.apiField}</div>
          </div>
        `
        : ''
    }
    <div class="detail-section">
      <div class="detail-section-title">Effective Control Coverage</div>
      <div style="font-size:22px;font-weight:800;color:${compColor};font-family:'JetBrains Mono';margin:4px 0 8px;">
        ${comp.label || (comp.status === 'covered' ? 'Covered' : comp.status === 'compensated' ? 'Compensated' : 'Unmitigated Gap')}
      </div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${comp.residual || 'No additional residual risk detail available.'}</div>
      ${
        Array.isArray(comp.evidence) && comp.evidence.length
          ? `
            <div style="margin-top:8px;font-size:12px;color:var(--text-secondary);line-height:1.7;"><strong style="color:var(--text-primary);">Compensating Policies</strong></div>
            ${comp.evidence.map(item => `
              <div class="detail-row">
                <span class="label">${item.name}</span>
                <span class="value">${item.state} Â· overlap ${item.overlap}%${Number.isFinite(item.contribution) ? ` Â· contribution ${item.contribution}%` : ''}</span>
              </div>
            `).join('')}
          `
          : '<div style="margin-top:8px;font-size:12px;color:var(--text-muted);">No compensating policy evidence found for this stage.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">MITRE ATT&amp;CK References</div>
      <div class="detail-row"><span class="label">Tactics</span><span class="value">${fmtRefs(refs.tactics)}</span></div>
      <div class="detail-row"><span class="label">Techniques</span><span class="value">${fmtRefs(refs.techniques)}</span></div>
      <div class="detail-row"><span class="label">Threat Patterns</span><span class="value">${fmtRefs(refs.threats)}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Next Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        ${policyJourneyModel.recommendations.map((action, idx) => `${idx + 1}. ${action}`).join('<br>')}
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function selectPolicyFocus(policyName) {
  selectedPolicyName = policyName;
  renderCAPolicies();
  renderPolicyGapInsights();
  renderPolicyMitreCoverage();
}

function selectPolicyFromJourney(encodedPolicyName) {
  if (!encodedPolicyName) return;
  const policyName = decodeURIComponent(encodedPolicyName);
  selectPolicyFocus(policyName);
}

function openPolicyDetailFromList(policyName) {
  selectPolicyFocus(policyName);
  openCADetail(policyName);
}

function renderAppGrid() {
  const container = document.getElementById('appGrid');
  if (!container) return;

  const isList = appInventoryViewMode === 'list';
  container.style.gridTemplateColumns = isList ? '1fr' : '1fr 1fr';

  if (isList) {
    container.innerHTML = softwareInventory.map(app => `
      <div class="app-item" onclick="openDetail('app:${encodeURIComponent(app.name)}')" style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
        <div style="min-width:0;">
          <div class="app-name">${app.name}</div>
          <div class="app-vendor">${app.vendor} Â· v${app.version}</div>
        </div>
        <div style="display:flex;gap:14px;flex-wrap:wrap;justify-content:flex-end;">
          <div class="app-stat">ðŸ’» <span class="num">${app.devices}</span> devices</div>
          <div class="app-stat" style="${app.vulns > 10 ? 'color:var(--severity-critical);' : app.vulns > 5 ? 'color:var(--severity-high);' : ''}">âš  <span class="num">${app.vulns}</span> vulns</div>
        </div>
      </div>
    `).join('');
    return;
  }

  container.innerHTML = softwareInventory.map(app => `
    <div class="app-item" onclick="openDetail('app:${encodeURIComponent(app.name)}')">
      <div class="app-name">${app.name}</div>
      <div class="app-vendor">${app.vendor} Â· v${app.version}</div>
      <div class="app-stats">
        <div class="app-stat">ðŸ’» <span class="num">${app.devices}</span> devices</div>
        <div class="app-stat" style="${app.vulns > 10 ? 'color:var(--severity-critical);' : app.vulns > 5 ? 'color:var(--severity-high);' : ''}">âš  <span class="num">${app.vulns}</span> vulns</div>
      </div>
    </div>
  `).join('');
}

function setupSoftwareViewInteractions() {
  const gridBtn = document.getElementById('appViewGridBtn');
  const listBtn = document.getElementById('appViewListBtn');
  if (!gridBtn || !listBtn || gridBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    appInventoryViewMode = mode;
    gridBtn.classList.toggle('active', mode === 'grid');
    listBtn.classList.toggle('active', mode === 'list');
    renderAppGrid();
  };

  gridBtn.addEventListener('click', () => setMode('grid'));
  listBtn.addEventListener('click', () => setMode('list'));
  gridBtn.dataset.bound = 'true';
}

function setupVulnerabilityViewInteractions() {
  const summaryBtn = document.getElementById('vulnViewSummaryBtn');
  const byOsBtn = document.getElementById('vulnViewByOsBtn');
  if (!summaryBtn || !byOsBtn || summaryBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    vulnSeverityViewMode = mode;
    renderVulnSeverityPanel();
    renderVulnList();
  };

  summaryBtn.addEventListener('click', () => setMode('summary'));
  byOsBtn.addEventListener('click', () => setMode('os'));
  summaryBtn.dataset.bound = 'true';
}

function setupRemediationViewInteractions() {
  const actionableBtn = document.getElementById('remediationActionableBtn');
  const reductionBtn = document.getElementById('remediationReductionBtn');
  if (!actionableBtn || !reductionBtn || actionableBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    remediationViewMode = mode;
    renderRemediationQueue();
  };

  actionableBtn.addEventListener('click', () => setMode('actionable'));
  reductionBtn.addEventListener('click', () => setMode('reduction'));
  actionableBtn.dataset.bound = 'true';
}

function setupThreatWorkbenchInteractions() {
  const riskBtn = document.getElementById('threatWorkbenchRiskBtn');
  const remediationBtn = document.getElementById('threatWorkbenchRemediationBtn');
  if (!riskBtn || !remediationBtn || riskBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    threatWorkbenchMode = mode;
    renderThreatWorkbench();
  };

  riskBtn.addEventListener('click', () => setMode('risk'));
  remediationBtn.addEventListener('click', () => setMode('remediation'));
  riskBtn.dataset.bound = 'true';
}

function setupDeviceInventoryInteractions() {
  const allBtn = document.getElementById('deviceFilterAllBtn');
  const nonCompliantBtn = document.getElementById('deviceFilterNonCompliantBtn');
  const exportBtn = document.getElementById('deviceExportCsvBtn');
  if (!allBtn || !nonCompliantBtn || !exportBtn || allBtn.dataset.bound === 'true') return;

  allBtn.addEventListener('click', () => {
    deviceInventoryFilterMode = 'all';
    renderDeviceTable();
  });
  nonCompliantBtn.addEventListener('click', () => {
    deviceInventoryFilterMode = 'non-compliant';
    renderDeviceTable();
  });
  exportBtn.addEventListener('click', () => {
    exportDeviceInventoryCsv();
  });

  allBtn.dataset.bound = 'true';
}

function setupDeviceMixInteractions() {
  const typeBtn = document.getElementById('deviceMixTypeBtn');
  const osBtn = document.getElementById('deviceMixOsBtn');
  if (!typeBtn || !osBtn || typeBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    deviceMixMode = mode;
    renderDeviceMixCard();
  };

  typeBtn.addEventListener('click', () => setMode('type'));
  osBtn.addEventListener('click', () => setMode('os'));
  typeBtn.dataset.bound = 'true';
}

function setupDefenderVersionInteractions() {
  const platformBtn = document.getElementById('defenderMetricPlatformBtn');
  const engineBtn = document.getElementById('defenderMetricEngineBtn');
  const intelBtn = document.getElementById('defenderMetricIntelBtn');
  if (!platformBtn || !engineBtn || !intelBtn || platformBtn.dataset.bound === 'true') return;

  const setMode = (mode) => {
    defenderVersionMetricMode = mode;
    renderDefenderVersionChart();
  };

  platformBtn.addEventListener('click', () => setMode('platform'));
  engineBtn.addEventListener('click', () => setMode('engine'));
  intelBtn.addEventListener('click', () => setMode('intel'));
  platformBtn.dataset.bound = 'true';
}

function renderDefenderVersionChart() {
  const metricConfig = defenderVersionMetricMode === 'engine'
    ? { key: 'defenderEngineVer', flavor: 'engine', latestLabel: 'Latest Engine Version' }
    : defenderVersionMetricMode === 'intel'
      ? { key: 'defenderSecurityIntelVer', flavor: 'security-intel', latestLabel: 'Latest Security Intel Version' }
      : { key: 'defenderPlatformVer', flavor: 'platform', latestLabel: 'Latest Platform Version' };

  const metricButtons = {
    platform: document.getElementById('defenderMetricPlatformBtn'),
    engine: document.getElementById('defenderMetricEngineBtn'),
    intel: document.getElementById('defenderMetricIntelBtn')
  };
  if (metricButtons.platform) metricButtons.platform.classList.toggle('active', defenderVersionMetricMode === 'platform');
  if (metricButtons.engine) metricButtons.engine.classList.toggle('active', defenderVersionMetricMode === 'engine');
  if (metricButtons.intel) metricButtons.intel.classList.toggle('active', defenderVersionMetricMode === 'intel');

  const versionCounts = {};
  devices.forEach(device => {
    const version = String(device?.[metricConfig.key] || 'n/a');
    versionCounts[version] = (versionCounts[version] || 0) + 1;
  });

  const rows = Object.entries(versionCounts)
    .map(([label, value]) => ({
      label,
      value,
      status: classifyVersionBadge(label, metricConfig.flavor)
    }))
    .sort((a, b) => b.value - a.value)
    .slice(0, 6)
    .map(row => ({
      ...row,
      color: row.status === 'current'
        ? 'var(--status-compliant)'
        : row.status === 'critical'
          ? 'var(--severity-critical)'
          : 'var(--status-warning)'
    }));

  const data = rows.length ? rows : [{ label: 'No version data', value: 0, color: 'var(--text-muted)' }];
  const maxVal = Math.max(1, ...data.map(d => Number(d.value) || 0));

  const chart = document.getElementById('defenderVersionChart');
  if (!chart) return;

  chart.innerHTML = data.map(d => `
    <div class="bar-row">
      <div class="bar-label">${d.label}</div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${(d.value / maxVal) * 100}%;background:${d.color};">${d.value}</div>
      </div>
    </div>
  `).join('');

  const latestLabelEl = document.getElementById('defenderMetricLatestLabel');
  const latestValueEl = document.getElementById('defenderMetricLatestValue');
  const coverageEl = document.getElementById('defenderMetricCoverageValue');
  if (latestLabelEl) latestLabelEl.textContent = metricConfig.latestLabel;

  const latestVersion = Object.keys(versionCounts)
    .filter(version => String(version || '').trim() && String(version).toLowerCase() !== 'n/a' && String(version).toLowerCase() !== 'unknown')
    .sort(compareVersionStrings)
    .pop() || 'n/a';
  if (latestValueEl) latestValueEl.textContent = latestVersion;

  const totalDevices = Math.max(devices.length, 1);
  const currentDevices = devices.filter(d => classifyVersionBadge(d?.[metricConfig.key], metricConfig.flavor) === 'current').length;
  const coverage = ((currentDevices / totalDevices) * 100).toFixed(1);
  if (coverageEl) {
    coverageEl.textContent = `${coverage}%`;
    coverageEl.style.color = Number(coverage) >= 90
      ? 'var(--status-compliant)'
      : Number(coverage) >= 75
        ? 'var(--status-warning)'
        : 'var(--severity-high)';
  }
}

function clampExposureScore(v) {
  return Math.max(20, Math.min(95, v));
}

function buildExposureTrendSeries(anchorScore) {
  const points = new Array(90);
  points[89] = clampExposureScore(anchorScore);

  for (let i = 88; i >= 0; i--) {
    const seasonal = Math.sin(i * 0.29) * 0.35;
    const cycle = ((i % 9) - 4) * 0.18;
    const prev = points[i + 1];
    points[i] = clampExposureScore(prev - seasonal - cycle);
  }

  // Keep the final point exactly tied to the current dashboard score.
  points[89] = clampExposureScore(anchorScore);
  return points;
}

function getExposureTrendPoints() {
  const filtered = getFilteredVulnerabilities();
  const criticalCount = filtered.filter(v => getSeverityBucket(v) === 'critical').length;
  const highCount = filtered.filter(v => getSeverityBucket(v) === 'high').length;
  const exploitedCount = filtered.filter(v => v.exploited).length;
  const avgCvss = filtered.length
    ? filtered.reduce((sum, v) => sum + Number(v.cvss || 0), 0) / filtered.length
    : 0;
  const avgDeviceRisk = devices.length
    ? devices.reduce((sum, d) => sum + Number(d.riskScore || 0), 0) / devices.length
    : 45;
  const modeledExposure = clampExposureScore(
    24 +
    (criticalCount * 2.1) +
    (highCount * 1.2) +
    (exploitedCount * 1.7) +
    (avgCvss * 0.85) +
    (avgDeviceRisk * 0.28)
  );
  const anchor = Number.isFinite(liveExposureScore) ? liveExposureScore : modeledExposure;
  const signature = [
    activeDataFilter,
    activeSeverityFilter,
    filtered.length,
    criticalCount,
    highCount,
    exploitedCount,
    Number(avgCvss).toFixed(2),
    Number(avgDeviceRisk).toFixed(2),
    Number(anchor).toFixed(2)
  ].join('|');

  if (
    !exposureTrendPoints.length ||
    exposureTrendAnchorScore === null ||
    Math.abs(anchor - exposureTrendAnchorScore) > 0.05 ||
    signature !== exposureTrendSignature
  ) {
    exposureTrendPoints = buildExposureTrendSeries(anchor);
    exposureTrendAnchorScore = anchor;
    exposureTrendSignature = signature;
  }

  return exposureTrendPoints;
}

function renderTrendChart() {
  const svg = document.getElementById('trendChart');
  const points = getExposureTrendPoints();
  if (!svg || !points.length) return;

  const w = 400, h = 180, padding = 20;
  const xStep = (w - padding * 2) / (points.length - 1);
  const minPoint = Math.min(...points);
  const maxPoint = Math.max(...points);
  const yPad = Math.max(4, (maxPoint - minPoint) * 0.2);
  const minY = Math.max(10, Math.floor(minPoint - yPad));
  const maxY = Math.min(100, Math.ceil(maxPoint + yPad));
  const scaleY = (v) => h - padding - ((v - minY) / (maxY - minY)) * (h - padding * 2);

  let pathD = '';
  let areaD = '';
  points.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = scaleY(p);
    if (i === 0) { pathD += `M ${x} ${y}`; areaD += `M ${x} ${h - padding} L ${x} ${y}`; }
    else { pathD += ` L ${x} ${y}`; areaD += ` L ${x} ${y}`; }
  });
  areaD += ` L ${padding + (points.length - 1) * xStep} ${h - padding} Z`;

  // Grid lines
  let grid = '';
  const yTicks = 4;
  for (let t = 0; t <= yTicks; t++) {
    const v = minY + ((maxY - minY) * t / yTicks);
    const y = scaleY(v);
    grid += `<line x1="${padding}" y1="${y}" x2="${w - padding}" y2="${y}" stroke="var(--border-subtle)" stroke-width="0.5"/>`;
    grid += `<text x="${padding - 4}" y="${y + 3}" text-anchor="end" fill="var(--text-muted)" font-size="8" font-family="JetBrains Mono">${Math.round(v)}</text>`;
  }

  // Month labels based on current date.
  const now = new Date();
  const monthOffsets = [89, 59, 29, 0];
  monthOffsets.forEach((offset, i) => {
    const d = new Date(now);
    d.setDate(now.getDate() - offset);
    const label = d.toLocaleString('en-US', { month: 'short' });
    const x = padding + (i / (monthOffsets.length - 1)) * (w - padding * 2);
    grid += `<text x="${x}" y="${h - 4}" text-anchor="middle" fill="var(--text-muted)" font-size="8" font-family="JetBrains Mono">${label}</text>`;
  });

  // Current value indicator
  const lastX = padding + (points.length - 1) * xStep;
  const lastY = scaleY(points[points.length - 1]);

  svg.innerHTML = `
    ${grid}
    <defs>
      <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="var(--severity-high)" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="var(--severity-high)" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <path d="${areaD}" fill="url(#areaGrad)"/>
    <path d="${pathD}" fill="none" stroke="var(--severity-high)" stroke-width="2" stroke-linecap="round"/>
    <circle cx="${lastX}" cy="${lastY}" r="4" fill="var(--severity-high)" stroke="var(--bg-card)" stroke-width="2"/>
    <text x="${lastX + 8}" y="${lastY + 4}" fill="var(--severity-high)" font-size="11" font-weight="700" font-family="JetBrains Mono">${points[points.length - 1].toFixed(1)}</text>
  `;
}

function getCurrentSecureScore() {
  if (Number.isFinite(liveSecureScore)) {
    return Math.max(0, Math.min(100, Math.round(liveSecureScore)));
  }
  const policyCoverage = caPolicies.length
    ? caPolicies.reduce((sum, policy) => sum + Number(policy.coverage || 0), 0) / caPolicies.length
    : 0;
  const enabledRatio = caPolicies.length
    ? (caPolicies.filter(policy => policy.state === 'enabled').length / caPolicies.length) * 100
    : 0;
  const deviceCompliance = devices.length
    ? (devices.filter(device => String(device.health).toLowerCase() === 'healthy').length / devices.length) * 100
    : 0;
  const score = (policyCoverage * 0.45) + (enabledRatio * 0.25) + (deviceCompliance * 0.30);
  return Math.max(0, Math.min(100, Math.round(score)));
}

function renderSecureScoreChart() {
  const container = document.getElementById('secureScoreChart');
  const currentEl = document.getElementById('secureScoreCurrentValue');
  if (!container || !currentEl) return;

  const current = getCurrentSecureScore();
  currentEl.textContent = `${current}%`;

  const labels = ['Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Now'];
  const seed = [current - 12, current - 9, current - 7, current - 4, current - 2, current]
    .map(v => Math.max(0, Math.min(100, v)));

  container.innerHTML = seed.map((value, idx) => {
    const intensity = value / 100;
    const topLight = 94 - (intensity * 24);
    const bottomLight = 84 - (intensity * 36);
    const topColor = `hsl(49 95% ${topLight}%)`;
    const bottomColor = `hsl(43 92% ${bottomLight}%)`;
    return `
    <div class="secure-score-col">
      <div class="secure-score-val">${value}%</div>
      <div class="secure-score-bar-wrap">
        <div class="secure-score-bar" style="height:${value}%;--score-color-top:${topColor};--score-color-bottom:${bottomColor};"></div>
      </div>
      <div class="secure-score-label">${labels[idx]}</div>
    </div>
  `;
  }).join('');
}

function renderStandardsView() {
  const cisCoverageEl = document.getElementById('cisCoverageValue');
  const cisCoverageSubEl = document.getElementById('cisCoverageSub');
  const cisListEl = document.getElementById('cisControlList');
  const nistCoverageEl = document.getElementById('nistCoverageValue');
  const nistCoverageSubEl = document.getElementById('nistCoverageSub');
  const nistListEl = document.getElementById('nistFunctionList');
  const identityListEl = document.getElementById('identityBaselineList');
  const nis2OverallEl = document.getElementById('nis2OverallValue');
  const nis2ListEl = document.getElementById('nis2List');
  if (!cisCoverageEl || !cisCoverageSubEl || !cisListEl || !nistCoverageEl || !nistCoverageSubEl || !nistListEl || !identityListEl || !nis2OverallEl || !nis2ListEl) return;

  const clampPct = (value) => Math.max(0, Math.min(100, Math.round(value)));
  const criticalCount = vulnerabilities.filter(v => getSeverityBucket(v) === 'critical').length;
  const highCount = vulnerabilities.filter(v => getSeverityBucket(v) === 'high').length;
  const mediumCount = vulnerabilities.filter(v => getSeverityBucket(v) === 'medium').length;
  const enabledPolicies = caPolicies.filter(p => p.state === 'enabled').length;
  const enabledRatio = caPolicies.length ? (enabledPolicies / caPolicies.length) * 100 : 0;
  const avgPolicyCoverage = caPolicies.length ? (caPolicies.reduce((sum, p) => sum + Number(p.coverage || 0), 0) / caPolicies.length) : 0;
  const defenderCoverage = devices.length
    ? (devices.filter(d => String(d.defenderVer).includes('24110') || String(d.defenderVer).includes('24112')).length / devices.length) * 100
    : 0;
  const healthyRatio = devices.length
    ? (devices.filter(d => String(d.health).toLowerCase() === 'healthy').length / devices.length) * 100
    : 0;

  const criticalSla = clampPct(100 - (criticalCount * 2.2));
  const highSla = clampPct(100 - (highCount * 0.9));
  const mediumSla = clampPct(100 - (mediumCount * 0.35));
  const weightedPatchSla = clampPct((criticalSla * 0.5) + (highSla * 0.3) + (mediumSla * 0.2));

  const cisRows = [
    {
      id: 'asset_inventory',
      name: 'Asset Inventory',
      score: clampPct((devices.length / 1400) * 100),
      detail: `${devices.length.toLocaleString()} managed assets discovered`,
      rationale: `Score is based on known managed assets (${devices.length.toLocaleString()}) against a demo baseline target of 1,400 assets.`,
      subcontrols: [
        { id: 'CIS 1.1', name: 'Establish and maintain detailed enterprise asset inventory', status: clampPct((devices.length / 1400) * 100), evidence: `${devices.length.toLocaleString()} assets currently inventoried.` },
        { id: 'CIS 1.2', name: 'Address unauthorized assets', status: clampPct(100 - ((devices.filter(d => String(d.health).toLowerCase() !== 'healthy').length / Math.max(devices.length, 1)) * 100)), evidence: `${devices.filter(d => String(d.health).toLowerCase() !== 'healthy').length} assets flagged unhealthy or requiring review.` },
        { id: 'CIS 1.3', name: 'Use active discovery mechanisms', status: clampPct((devices.filter(d => d.lastSeen).length / Math.max(devices.length, 1)) * 100), evidence: `${devices.filter(d => d.lastSeen).length} assets reporting recent telemetry.` }
      ]
    },
    {
      id: 'vuln_mgmt',
      name: 'Vulnerability Management',
      score: clampPct((criticalSla * 0.7) + (highSla * 0.3)),
      detail: `${criticalCount} critical open findings`,
      rationale: 'Weighted toward critical vulnerability SLA adherence and high-severity backlog control.',
      subcontrols: [
        { id: 'CIS 7.1', name: 'Establish and maintain vulnerability management process', status: criticalSla, evidence: `${criticalCount} critical vulnerabilities open.` },
        { id: 'CIS 7.4', name: 'Remediate vulnerabilities', status: weightedPatchSla, evidence: `Weighted patch SLA is ${weightedPatchSla}%.` },
        { id: 'CIS 7.7', name: 'Remediate detected vulnerabilities promptly', status: highSla, evidence: `${highCount} high-severity vulnerabilities open.` }
      ]
    },
    {
      id: 'identity_access',
      name: 'Identity & Access',
      score: clampPct((enabledRatio * 0.45) + (avgPolicyCoverage * 0.55)),
      detail: `${enabledPolicies}/${caPolicies.length} CA policies enabled`,
      rationale: 'Derived from Conditional Access enablement ratio and average policy coverage.',
      subcontrols: [
        { id: 'CIS 5.1', name: 'Establish identity and account lifecycle', status: enabledRatio, evidence: `${enabledPolicies}/${caPolicies.length} policies are actively enforced.` },
        { id: 'CIS 6.3', name: 'Require MFA', status: avgPolicyCoverage, evidence: `Average CA policy coverage is ${clampPct(avgPolicyCoverage)}%.` },
        { id: 'CIS 6.7', name: 'Establish role-based access control', status: clampPct((enabledRatio * 0.6) + (avgPolicyCoverage * 0.4)), evidence: 'Role-focused controls inferred from admin and directory-role policies.' }
      ]
    },
    {
      id: 'endpoint_protection',
      name: 'Endpoint Protection',
      score: clampPct((defenderCoverage * 0.6) + (healthyRatio * 0.4)),
      detail: `${clampPct(defenderCoverage)}% current Defender coverage`,
      rationale: 'Combines current Defender agent/version coverage and healthy endpoint ratio.',
      subcontrols: [
        { id: 'CIS 10.1', name: 'Deploy and maintain anti-malware protections', status: defenderCoverage, evidence: `${clampPct(defenderCoverage)}% of endpoints running current Defender builds.` },
        { id: 'CIS 10.7', name: 'Use centrally managed endpoint security', status: healthyRatio, evidence: `${clampPct(healthyRatio)}% endpoints report healthy telemetry.` },
        { id: 'CIS 12.2', name: 'Maintain and monitor endpoint configurations', status: clampPct((defenderCoverage + healthyRatio) / 2), evidence: 'Posture inferred from Defender health and telemetry completeness.' }
      ]
    },
    {
      id: 'monitoring_response',
      name: 'Monitoring & Response',
      score: clampPct(100 - (criticalCount * 1.4)),
      detail: `${vulnerabilities.filter(v => v.exploited).length} actively exploited CVEs`,
      rationale: 'Penalized by outstanding critical vulnerabilities and active exploitation signals.',
      subcontrols: [
        { id: 'CIS 8.2', name: 'Collect audit logs', status: clampPct(100 - (criticalCount * 1.1)), evidence: `${criticalCount} critical vulnerabilities drive elevated monitoring burden.` },
        { id: 'CIS 17.3', name: 'Perform incident response', status: clampPct(100 - (vulnerabilities.filter(v => v.exploited).length * 8)), evidence: `${vulnerabilities.filter(v => v.exploited).length} vulnerabilities flagged as exploited.` },
        { id: 'CIS 17.6', name: 'Define communication and escalation workflow', status: clampPct(100 - (criticalCount * 0.8)), evidence: 'Escalation pressure inferred from unresolved critical backlog.' }
      ]
    }
  ];
  const cisCoverage = clampPct(cisRows.reduce((sum, row) => sum + row.score, 0) / cisRows.length);

  cisCoverageEl.textContent = `${cisCoverage}%`;
  cisCoverageSubEl.textContent = `${cisRows.filter(row => row.score < 75).length} control domains need hardening focus.`;
  standardsDetailModel.cis = Object.fromEntries(cisRows.map(row => [row.id, row]));
  cisListEl.innerHTML = cisRows.map(row => `
    <article class="standards-row" role="button" tabindex="0" onclick="openStandardsDetail('cis','${row.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openStandardsDetail('cis','${row.id}')}">
      <div class="standards-row-top">
        <div class="standards-row-name">${row.name}</div>
        <div class="standards-row-meta">${row.score}%</div>
      </div>
      <div class="standards-bar"><div style="width:${row.score}%;"></div></div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${row.detail}</div>
    </article>
  `).join('');

  const nistItems = [
    {
      id: 'govern',
      key: 'Govern',
      value: clampPct((enabledRatio * 0.5) + (avgPolicyCoverage * 0.5)),
      rationale: 'Governance score combines policy enablement and policy coverage breadth.',
      subcontrols: [
        { id: 'GV.OC', name: 'Organizational context and risk strategy', status: clampPct(enabledRatio), evidence: `${enabledPolicies}/${caPolicies.length} core security policies enabled.` },
        { id: 'GV.RR', name: 'Roles, responsibilities, and authorities', status: clampPct((enabledRatio * 0.7) + (avgPolicyCoverage * 0.3)), evidence: 'Role-oriented controls inferred from admin policy posture.' },
        { id: 'GV.PO', name: 'Policy and oversight mechanisms', status: clampPct(avgPolicyCoverage), evidence: `Average CA policy coverage at ${clampPct(avgPolicyCoverage)}%.` }
      ]
    },
    {
      id: 'identify',
      key: 'Identify',
      value: clampPct((devices.length / 14)),
      rationale: 'Identify score reflects asset visibility and telemetry inventory coverage.',
      subcontrols: [
        { id: 'ID.AM', name: 'Asset management', status: clampPct((devices.length / 14)), evidence: `${devices.length.toLocaleString()} inventoried managed assets in telemetry.` },
        { id: 'ID.RA', name: 'Risk assessment', status: clampPct(100 - (criticalCount * 1.5)), evidence: `${criticalCount} critical vulnerabilities impacting current risk baseline.` },
        { id: 'ID.IM', name: 'Improvement from discovered context', status: clampPct((devices.filter(d => d.lastSeen).length / Math.max(devices.length, 1)) * 100), evidence: `${devices.filter(d => d.lastSeen).length} assets with recent signal updates.` }
      ]
    },
    {
      id: 'protect',
      key: 'Protect',
      value: clampPct((healthyRatio * 0.45) + (avgPolicyCoverage * 0.55)),
      rationale: 'Protect score is driven by endpoint health and access policy enforcement.',
      subcontrols: [
        { id: 'PR.AA', name: 'Identity management and access control', status: clampPct(avgPolicyCoverage), evidence: `CA coverage ${clampPct(avgPolicyCoverage)}% across policy set.` },
        { id: 'PR.PS', name: 'Platform security', status: clampPct(healthyRatio), evidence: `${clampPct(healthyRatio)}% endpoints currently healthy.` },
        { id: 'PR.DS', name: 'Data and control safeguards', status: clampPct((enabledRatio * 0.45) + (avgPolicyCoverage * 0.55)), evidence: 'Control enforcement inferred from policy enablement and coverage breadth.' }
      ]
    },
    {
      id: 'detect',
      key: 'Detect',
      value: clampPct((defenderCoverage * 0.7) + ((100 - (criticalCount * 1.8)) * 0.3)),
      rationale: 'Detect score combines Defender signal quality and unresolved critical risk pressure.',
      subcontrols: [
        { id: 'DE.CM', name: 'Continuous monitoring', status: clampPct(defenderCoverage), evidence: `${clampPct(defenderCoverage)}% Defender signal coverage from endpoint telemetry.` },
        { id: 'DE.AE', name: 'Anomalies and events', status: clampPct(100 - (criticalCount * 1.8)), evidence: `${criticalCount} critical vulnerabilities reduce anomaly confidence baseline.` },
        { id: 'DE.DP', name: 'Detection process maturity', status: clampPct((defenderCoverage * 0.6) + ((100 - (criticalCount * 1.4)) * 0.4)), evidence: 'Derived from signal quality and severe-risk backlog pressure.' }
      ]
    },
    {
      id: 'respond',
      key: 'Respond',
      value: clampPct((weightedPatchSla * 0.65) + ((100 - (vulnerabilities.filter(v => v.exploited).length * 5)) * 0.35)),
      rationale: 'Respond score weights patch SLA execution and active exploit backlog.',
      subcontrols: [
        { id: 'RS.RP', name: 'Response planning', status: clampPct(weightedPatchSla), evidence: `Weighted remediation SLA currently ${weightedPatchSla}%.` },
        { id: 'RS.AN', name: 'Incident analysis', status: clampPct(100 - (vulnerabilities.filter(v => v.exploited).length * 5)), evidence: `${vulnerabilities.filter(v => v.exploited).length} actively exploited CVEs require rapid triage.` },
        { id: 'RS.MI', name: 'Mitigation execution', status: clampPct((weightedPatchSla * 0.7) + (highSla * 0.3)), evidence: `Critical/High SLA mix: ${criticalSla}% / ${highSla}%.` }
      ]
    },
    {
      id: 'recover',
      key: 'Recover',
      value: clampPct((getCurrentSecureScore() * 0.5) + (weightedPatchSla * 0.5)),
      rationale: 'Recover score blends secure posture maturity and remediation consistency.',
      subcontrols: [
        { id: 'RC.RP', name: 'Recovery planning and readiness', status: clampPct(getCurrentSecureScore()), evidence: `Secure score posture currently ${getCurrentSecureScore()}%.` },
        { id: 'RC.IM', name: 'Improvements from response outcomes', status: clampPct(weightedPatchSla), evidence: `Patch SLA consistency at ${weightedPatchSla}%.` },
        { id: 'RC.CO', name: 'Recovery communications', status: clampPct((getCurrentSecureScore() * 0.4) + (weightedPatchSla * 0.6)), evidence: 'Recovery confidence inferred from posture + remediation consistency.' }
      ]
    }
  ];
  const nistRows = nistItems.map(item => ({
    ...item,
    name: item.key,
    detail: `${(item.subcontrols || []).filter(sub => sub.status < 75).length} mapped sub-categories below 75%`
  }));
  const nistCoverage = clampPct(nistRows.reduce((sum, row) => sum + row.value, 0) / nistRows.length);
  nistCoverageEl.textContent = `${nistCoverage}%`;
  nistCoverageSubEl.textContent = `${nistRows.filter(row => row.value < 75).length} functions need additional hardening focus.`;
  standardsDetailModel.nist = Object.fromEntries(nistRows.map(item => [item.id, item]));
  nistListEl.innerHTML = nistRows.map(item => `
    <article class="standards-row" role="button" tabindex="0" onclick="openStandardsDetail('nist','${item.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openStandardsDetail('nist','${item.id}')}">
      <div class="standards-row-top">
        <div class="standards-row-name">${item.name}</div>
        <div class="standards-row-meta">${item.value}%</div>
      </div>
      <div class="standards-bar"><div style="width:${item.value}%;"></div></div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${item.detail}</div>
    </article>
  `).join('');

  const phishPolicy = caPolicies.find(p => /phishing-resistant/i.test(p.name));
  const legacyPolicy = caPolicies.find(p => /legacy/i.test(p.name));
  const adminPolicy = caPolicies.find(p => /admin mfa/i.test(p.name));
  const identityChecks = [
    { id: 'phish_mfa', label: 'Phishing-resistant MFA for admins', state: phishPolicy ? (phishPolicy.state === 'enabled' ? 'good' : 'warn') : 'bad', text: phishPolicy ? (phishPolicy.state === 'enabled' ? 'Enabled' : 'Report-only') : 'Not configured', rationale: 'Mapped from phishing-resistant MFA policy state and coverage.' },
    { id: 'legacy_auth', label: 'Legacy authentication blocked', state: legacyPolicy ? (legacyPolicy.state === 'enabled' ? 'good' : 'warn') : 'bad', text: legacyPolicy ? (legacyPolicy.state === 'enabled' ? 'Enforced' : 'Partial') : 'Missing', rationale: 'Mapped from legacy authentication blocking policy effectiveness.' },
    { id: 'privileged_access', label: 'Privileged access baseline', state: adminPolicy ? (adminPolicy.state === 'enabled' ? 'good' : 'warn') : 'bad', text: adminPolicy ? (adminPolicy.state === 'enabled' ? 'Protected' : 'Needs enforcement') : 'Gap', rationale: 'Derived from admin-focused policy posture and enforcement state.' },
    { id: 'ca_coverage', label: 'Conditional Access coverage', state: avgPolicyCoverage >= 90 ? 'good' : avgPolicyCoverage >= 75 ? 'warn' : 'bad', text: `${clampPct(avgPolicyCoverage)}%`, rationale: 'Computed from average policy coverage across configured CA controls.' }
  ];
  standardsDetailModel.identity = Object.fromEntries(identityChecks.map(item => [item.id, item]));
  identityListEl.innerHTML = identityChecks.map(item => `
    <article class="identity-item" role="button" tabindex="0" onclick="openStandardsDetail('identity','${item.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openStandardsDetail('identity','${item.id}')}">
      <div class="name">${item.label}</div>
      <span class="identity-status ${item.state}">${item.text}</span>
    </article>
  `).join('');

  const incidentExposure = vulnerabilities.filter(v => v.exploited).length;
  const unhealthyCount = devices.filter(d => String(d.health).toLowerCase() !== 'healthy').length;
  const policyReportOnlyCount = caPolicies.filter(p => p.state === 'report-only').length;
  const nonCompliantPolicyCount = caPolicies.length - enabledPolicies;
  const staleDefenderCount = devices.filter(d => !String(d.defenderVer).includes('24110') && !String(d.defenderVer).includes('24112')).length;
  const businessContinuityScore = clampPct((getCurrentSecureScore() * 0.45) + (weightedPatchSla * 0.55));
  const nis2Rows = [
    {
      id: 'risk_mgmt',
      name: 'Risk Management Measures',
      value: clampPct((criticalSla * 0.45) + (highSla * 0.25) + (avgPolicyCoverage * 0.3)),
      note: `${criticalCount} critical + ${highCount} high open`,
      rationale: 'Measures readiness against open severe vulnerabilities and preventive control coverage.',
      requirements: [
        { id: 'RM-1', name: 'Risk analysis and baseline controls', status: clampPct((criticalSla * 0.5) + (avgPolicyCoverage * 0.5)), evidence: `${criticalCount} critical findings and ${clampPct(avgPolicyCoverage)}% CA coverage influence risk baseline maturity.` },
        { id: 'RM-2', name: 'Vulnerability handling discipline', status: weightedPatchSla, evidence: `Current weighted remediation performance is ${weightedPatchSla}%.` },
        { id: 'RM-3', name: 'Security hygiene across managed assets', status: clampPct((defenderCoverage * 0.55) + (healthyRatio * 0.45)), evidence: `${staleDefenderCount} endpoints are not on current Defender builds and ${unhealthyCount} devices are not healthy.` }
      ],
      gaps: [
        `${criticalCount} unresolved critical vulnerabilities continue to suppress this score.`,
        `${policyReportOnlyCount} policies are still in report-only mode and reduce preventive control confidence.`
      ],
      actions: [
        'Close critical findings first and enforce remediation SLAs for high severity.',
        'Move report-only access controls to enforce mode after validation.',
        'Raise endpoint baseline conformance by updating stale Defender versions.'
      ]
    },
    {
      id: 'incident_handling',
      name: 'Incident Handling & Reporting',
      value: clampPct((100 - (incidentExposure * 6)) * 0.6 + (defenderCoverage * 0.4)),
      note: `${incidentExposure} actively exploited findings`,
      rationale: 'Lower scores indicate active exploit pressure and weaker high-confidence detection/triage readiness.',
      requirements: [
        { id: 'IR-1', name: 'Detection and triage readiness', status: clampPct((defenderCoverage * 0.7) + ((100 - (criticalCount * 1.6)) * 0.3)), evidence: `Detection confidence is tied to ${clampPct(defenderCoverage)}% Defender coverage with ${criticalCount} critical findings.` },
        { id: 'IR-2', name: 'Incident response execution', status: clampPct(100 - (incidentExposure * 6)), evidence: `${incidentExposure} actively exploited vulnerabilities require immediate containment.` },
        { id: 'IR-3', name: 'Operational reporting posture', status: clampPct((enabledRatio * 0.6) + (avgPolicyCoverage * 0.4)), evidence: `${enabledPolicies}/${caPolicies.length} policies are enabled to provide stronger event attribution and control context.` }
      ],
      gaps: [
        'Active exploit indicators remain open and increase incident response pressure.',
        `${nonCompliantPolicyCount} access policies are not fully enforced, creating response blind spots.`
      ],
      actions: [
        'Create a fast-track workflow for exploited vulnerabilities with same-day containment.',
        'Validate incident reporting runbooks and assignment ownership per severity tier.',
        'Increase telemetry confidence by resolving sensor and policy enforcement gaps.'
      ]
    },
    {
      id: 'supply_chain',
      name: 'Supply Chain Security',
      value: clampPct((mediumSla * 0.35) + (weightedPatchSla * 0.35) + (enabledRatio * 0.3)),
      note: `${mediumCount} medium-risk exposures pending`,
      rationale: 'Uses patch velocity and policy enforcement as a proxy for third-party and dependency risk governance.',
      requirements: [
        { id: 'SC-1', name: 'Third-party software risk visibility', status: clampPct(100 - (mediumCount * 0.4)), evidence: `${mediumCount} medium-severity findings imply supplier/dependency backlog risk.` },
        { id: 'SC-2', name: 'Supplier patch and hardening assurance', status: weightedPatchSla, evidence: `Remediation execution is currently ${weightedPatchSla}% across severity tiers.` },
        { id: 'SC-3', name: 'Supplier access governance', status: clampPct((enabledRatio * 0.65) + (avgPolicyCoverage * 0.35)), evidence: `${enabledPolicies}/${caPolicies.length} policy controls are active for external/internal access paths.` }
      ],
      gaps: [
        'Medium-risk backlog suggests delayed closure of dependency-related weaknesses.',
        'Partial policy enforcement limits assurance over third-party access pathways.'
      ],
      actions: [
        'Track supplier-origin vulnerabilities separately and enforce closure deadlines.',
        'Require patch/attestation evidence for critical software vendors.',
        'Review all external access policies for MFA and conditional restrictions.'
      ]
    },
    {
      id: 'bcdr',
      name: 'Business Continuity & Crisis',
      value: businessContinuityScore,
      note: `Secure posture ${getCurrentSecureScore()}%`,
      rationale: 'Derived from overall secure posture and remediation consistency to estimate resilience maturity.',
      requirements: [
        { id: 'BC-1', name: 'Operational resilience baseline', status: clampPct(getCurrentSecureScore()), evidence: `Secure Score posture currently ${getCurrentSecureScore()}%.` },
        { id: 'BC-2', name: 'Recovery preparedness through control maturity', status: clampPct((avgPolicyCoverage * 0.5) + (healthyRatio * 0.5)), evidence: `Policy coverage at ${clampPct(avgPolicyCoverage)}% with ${clampPct(healthyRatio)}% healthy endpoints.` },
        { id: 'BC-3', name: 'Crisis recovery execution reliability', status: weightedPatchSla, evidence: `Recovery confidence is constrained by ${weightedPatchSla}% remediation consistency.` }
      ],
      gaps: [
        'Control maturity is uneven between policy posture and endpoint hygiene.',
        'Recovery confidence is reduced where critical remediation remains outstanding.'
      ],
      actions: [
        'Define crisis playbooks with clear RTO/RPO and ownership handoffs.',
        'Run tabletop exercises focused on exploited vulnerability scenarios.',
        'Use post-incident lessons to update technical controls and recovery procedures.'
      ]
    }
  ];
  const nis2Overall = clampPct(nis2Rows.reduce((sum, row) => sum + row.value, 0) / nis2Rows.length);
  nis2OverallEl.textContent = `${nis2Overall}%`;
  standardsDetailModel.nis2 = Object.fromEntries(nis2Rows.map(row => [row.id, row]));
  nis2ListEl.innerHTML = nis2Rows.map(row => `
    <article class="standards-row" role="button" tabindex="0" onclick="openStandardsDetail('nis2','${row.id}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openStandardsDetail('nis2','${row.id}')}">
      <div class="standards-row-top">
        <div class="standards-row-name">${row.name}</div>
        <div class="standards-row-meta">${row.value}%</div>
      </div>
      <div class="standards-bar"><div style="width:${row.value}%;"></div></div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${row.note}</div>
    </article>
  `).join('');
}

function openStandardsDetail(group, id) {
  const item = standardsDetailModel[group] ? standardsDetailModel[group][id] : null;
  if (!item) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  if (group === 'cis') {
    title.textContent = `CIS Controls â€” ${item.name}`;
    body.innerHTML = `
      <div class="detail-section">
        <div class="detail-section-title">Score Summary</div>
        <div style="font-size:44px;font-weight:800;color:${item.score >= 75 ? 'var(--status-compliant)' : item.score >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:6px 0;">${item.score}%</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${item.rationale}</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Mapped Sub-controls</div>
        ${item.subcontrols.map(sub => `
          <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-elevated);margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
              <div style="font-size:11px;font-weight:700;color:var(--text-primary);">${sub.id} â€” ${sub.name}</div>
              <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:${sub.status >= 75 ? 'var(--status-compliant)' : sub.status >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-weight:700;">${sub.status}%</div>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);line-height:1.55;">${sub.evidence}</div>
          </div>
        `).join('')}
      </div>
    `;
  } else if (group === 'nist') {
    const fnContext = NIST_FUNCTION_DETAILS[item.id] || {
      focus: 'NIST function context.',
      primaryGap: 'No specific gap mapped.',
      priorityAction: 'No specific action mapped.'
    };
    title.textContent = `NIST CSF 2.0 â€” ${item.key}`;
    body.innerHTML = `
      <div class="detail-section">
        <div class="detail-section-title">Function Score</div>
        <div style="font-size:44px;font-weight:800;color:${item.value >= 75 ? 'var(--status-compliant)' : item.value >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:6px 0;">${item.value}%</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${item.rationale}</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Function Context</div>
        <div class="detail-row"><span class="label">Control focus</span><span class="value">${fnContext.focus}</span></div>
        <div class="detail-row"><span class="label">Primary gap</span><span class="value">${fnContext.primaryGap}</span></div>
        <div class="detail-row"><span class="label">Priority action</span><span class="value">${fnContext.priorityAction}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Mapped Sub-categories</div>
        ${(item.subcontrols || []).map(sub => `
          ${(() => {
            const controlMeta = NIST_CONTROL_DETAILS[sub.id] || {
              owner: 'Security Team',
              cadence: 'Monthly',
              whyLow: 'No detailed rationale mapped.',
              action: 'Review control evidence and define follow-up actions.'
            };
            return `
          <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-elevated);margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
              <div style="font-size:11px;font-weight:700;color:var(--text-primary);">${sub.id} â€” ${sub.name}</div>
              <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:${sub.status >= 75 ? 'var(--status-compliant)' : sub.status >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-weight:700;">${sub.status}%</div>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);line-height:1.55;">${sub.evidence}</div>
            <div class="detail-row" style="margin-top:6px;"><span class="label">Control owner</span><span class="value">${controlMeta.owner}</span></div>
            <div class="detail-row"><span class="label">Review cadence</span><span class="value">${controlMeta.cadence}</span></div>
            <div class="detail-row"><span class="label">Why score is low</span><span class="value">${controlMeta.whyLow}</span></div>
            <div class="detail-row"><span class="label">Recommended action</span><span class="value">${controlMeta.action}</span></div>
          </div>
        `;
          })()}
        `).join('')}
      </div>
    `;
  } else if (group === 'identity') {
    title.textContent = `Identity Baseline â€” ${item.label}`;
    body.innerHTML = `
      <div class="detail-section">
        <div class="detail-section-title">Control Status</div>
        <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono';margin:6px 0;color:${item.state === 'good' ? 'var(--status-compliant)' : item.state === 'warn' ? 'var(--severity-medium)' : 'var(--severity-high)'};">${item.text}</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${item.rationale}</div>
      </div>
    `;
  } else if (group === 'nis2') {
    title.textContent = `NIS2.0 â€” ${item.name}`;
    body.innerHTML = `
      <div class="detail-section">
        <div class="detail-section-title">Alignment Estimate</div>
        <div style="font-size:44px;font-weight:800;color:${item.value >= 75 ? 'var(--status-compliant)' : item.value >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:6px 0;">${item.value}%</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${item.rationale}</div>
        <div class="detail-row"><span class="label">Current evidence</span><span class="value" style="font-family:JetBrains Mono;">${item.note}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Mapped NIS2 Control Areas</div>
        ${(item.requirements || []).map(req => `
          <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-elevated);margin-bottom:8px;">
            <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
              <div style="font-size:11px;font-weight:700;color:var(--text-primary);">${req.id} â€” ${req.name}</div>
              <div style="font-family:'JetBrains Mono',monospace;font-size:11px;color:${req.status >= 75 ? 'var(--status-compliant)' : req.status >= 50 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-weight:700;">${req.status}%</div>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);line-height:1.55;">${req.evidence}</div>
          </div>
        `).join('')}
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Why This Score Is Low</div>
        ${(item.gaps || []).map(gap => `<div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:6px;">â€¢ ${gap}</div>`).join('')}
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Priority Actions</div>
        ${(item.actions || []).map((action, idx) => `<div style="font-size:11px;color:var(--text-secondary);line-height:1.6;margin-bottom:6px;">${idx + 1}. ${action}</div>`).join('')}
      </div>
    `;
  }

  overlay.classList.add('visible');
}

function renderDefenderStack() {
  const stack = [
    { label: 'Defender for Endpoint Coverage', value: '94.2%', sub: '1,169 / 1,241 devices healthy telemetry' },
    { label: 'Defender for Identity Sensor Coverage', value: '88.6%', sub: '31 / 35 domain controllers reporting' },
    { label: 'Engine / Signature Currency', value: '92.1%', sub: 'Engine 1.1.24090.11 Â· Sig 1.421.1889.0 baseline' },
  ];

  document.getElementById('defenderStackGrid').innerHTML = stack.map(item => `
    <article class="defender-cell">
      <div class="k">${item.label}</div>
      <div class="v">${item.value}</div>
      <div class="s">${item.sub}</div>
    </article>
  `).join('');

  const issues = [
    { issue: 'Endpoint sensor heartbeat delay >15m', impact: '22 devices', severity: 'var(--severity-high)' },
    { issue: 'Outdated endpoint engine versions', impact: '34 devices', severity: 'var(--severity-medium)' },
    { issue: 'Defender for Identity sensor disconnected', impact: '4 domain controllers', severity: 'var(--severity-critical)' },
    { issue: 'Conditional Access signal ingestion latency', impact: '11 mins avg', severity: 'var(--severity-medium)' },
    { issue: 'Proxy/TLS inspection causing telemetry drop', impact: '7 network segments', severity: 'var(--severity-high)' },
  ];
  document.getElementById('defenderCommIssues').innerHTML = issues.map(i => `
    <div class="defender-row">
      <span>${i.issue}</span>
      <span style="color:${i.severity};font-family:'JetBrains Mono',monospace;font-weight:700;">${i.impact}</span>
    </div>
  `).join('');
}

function renderMitreCoverage() {
  const tactics = MITRE_TACTICS;

  document.getElementById('mitreTacticList').innerHTML = tactics.map(t => `
    <article class="mitre-tactic-row" role="button" tabindex="0" onclick="openMitreTacticDetail('${t.name}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openMitreTacticDetail('${t.name}')}">
      <div class="mitre-top">
        <div class="mitre-name">${t.name}</div>
        <div class="mitre-gap">${t.coverage}% coverage Â· ${t.gaps} gaps</div>
      </div>
      <div class="mitre-bar"><div class="mitre-fill" style="width:${t.coverage}%"></div></div>
    </article>
  `).join('');

  const heatCells = tactics.slice(0, 6).concat(tactics.slice(6, 10)).map(t => {
    const isHigh = t.coverage >= 80 && t.gaps <= 4;
    const isMedium = t.coverage >= 65 && t.gaps <= 7;
    const bg = isHigh
      ? 'linear-gradient(135deg, #0b8a49 0%, #22d47a 100%)'
      : isMedium
        ? 'linear-gradient(135deg, #f39a00 0%, #ffd000 100%)'
        : 'linear-gradient(135deg, #b3002d 0%, #ff2d55 100%)';
    const color = isHigh ? '#ffffff' : isMedium ? '#2d2100' : '#ffffff';
    const border = isHigh ? '#0a733e' : isMedium ? '#d48600' : '#970025';
    const risk = isHigh ? 'Low Risk' : isMedium ? 'Medium Risk' : 'High Risk';
    return `
      <div class="mitre-cell" data-tactic="${t.name}" role="button" tabindex="0" style="background:${bg};color:${color};border-color:${border};">
        <div class="tactic">${t.name}</div>
        <div class="meta"><span class="k">Coverage</span><span class="v">${t.coverage}%</span></div>
        <div class="meta"><span class="k">Gaps</span><span class="v">${t.gaps}</span></div>
        <div class="risk">${risk}</div>
      </div>
    `;
  });
  document.getElementById('mitreHeatmap').innerHTML = heatCells.join('');
}

function setupMitreInteractions() {
  const heatmap = document.getElementById('mitreHeatmap');
  if (!heatmap) return;

  heatmap.addEventListener('click', (event) => {
    const cell = event.target.closest('.mitre-cell');
    if (!cell) return;
    const tactic = cell.dataset.tactic;
    if (tactic) openMitreTacticDetail(tactic);
  });

  heatmap.addEventListener('keydown', (event) => {
    if (event.key !== 'Enter' && event.key !== ' ') return;
    const cell = event.target.closest('.mitre-cell');
    if (!cell) return;
    event.preventDefault();
    const tactic = cell.dataset.tactic;
    if (tactic) openMitreTacticDetail(tactic);
  });
}

function openMitreTacticDetail(tacticName) {
  const tacticMap = {
    'Initial Access': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['edge', 'windows', 'browser'], identitySignals: ['MFA gaps', 'Legacy auth attempts'], policyFilters: ['phishing', 'mfa', 'admin'] },
    'Execution': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['windows', 'management', 'kernel'], identitySignals: ['Suspicious process execution'], policyFilters: ['compliant', 'device'] },
    'Persistence': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['kernel', 'update', 'driver'], identitySignals: ['Service account anomalies'], policyFilters: ['admin', 'session'] },
    'Privilege Escalation': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['kernel', 'elevation', 'privilege'], identitySignals: ['Privileged role activations'], policyFilters: ['directory roles', 'admin'] },
    'Defense Evasion': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['spoofing', 'management', 'update'], identitySignals: ['Sensor tamper alerts'], policyFilters: ['token', 'sign-in'] },
    'Credential Access': { deviceTypes: ['Workstation', 'Server'], cveKeywords: ['winlogon', 'auth', 'credential'], identitySignals: ['Password spray / impossible travel'], policyFilters: ['mfa', 'authentication strength'] },
    'Lateral Movement': { deviceTypes: ['Server', 'Workstation'], cveKeywords: ['tcp/ip', 'remote', 'rce'], identitySignals: ['Abnormal east-west authentication'], policyFilters: ['network', 'location'] },
    'Command and Control': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['scripting', 'browser', 'remote'], identitySignals: ['Beaconing / anomalous outbound'], policyFilters: ['session controls', 'sign-in frequency'] },
    'Exfiltration': { deviceTypes: ['Workstation', 'Server', 'Mobile'], cveKeywords: ['management', 'edge', 'windows'], identitySignals: ['Large data egress by identity'], policyFilters: ['app protection', 'session controls'] },
    'Impact': { deviceTypes: ['Server', 'Workstation'], cveKeywords: ['rce', 'critical', 'kernel'], identitySignals: ['Business-critical service disruption'], policyFilters: ['break-glass', 'incident response'] }
  };

  const map = tacticMap[tacticName] || { deviceTypes: [], cveKeywords: [], identitySignals: [], policyFilters: [] };

  const relatedDevices = devices
    .filter(device => map.deviceTypes.includes(device.type))
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const relatedVulns = vulnerabilities
    .filter(vuln => {
      const t = `${vuln.title} ${vuln.software}`.toLowerCase();
      return map.cveKeywords.some(key => t.includes(key));
    })
    .sort((a, b) => (b.exploited === a.exploited ? b.cvss - a.cvss : (b.exploited ? 1 : -1)))
    .slice(0, 8);

  const tacticKbRows = relatedVulns
    .flatMap(v => (KB_PATCH_MAP[v.id] || []).map(kb => ({ cveId: v.id, ...kb })))
    .slice(0, 12);

  const tacticRemediationActions = relatedVulns
    .slice(0, 4)
    .map(v => ({ cveId: v.id, actions: remediationPlaybook(v).slice(0, 2) }));

  const relatedPolicies = caPolicies
    .filter(policy => {
      const text = `${policy.name} ${policy.conditions} ${policy.grantControls} ${policy.sessionControls}`.toLowerCase();
      return map.policyFilters.some(key => text.includes(key.toLowerCase()));
    })
    .slice(0, 6);

  const identityFindings = map.identitySignals.map((signal, idx) => ({
    signal,
    value: idx === 0 ? `${Math.max(3, relatedDevices.length)} events` : idx === 1 ? `${Math.max(2, relatedPolicies.length)} control gaps` : `${Math.max(1, Math.round(relatedVulns.length / 2))} high-risk clusters`
  }));

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `MITRE ATT&CK â€” ${tacticName}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Tactic Context</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.65;">
        This view maps relevant devices, vulnerabilities, and identity/policy signals for the <strong style="color:var(--text-primary);">${tacticName}</strong> tactic to help identify detection and control gaps quickly.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Identity and Policy Signals</div>
      ${identityFindings.map(f => `<div class="detail-row"><span class="label">${f.signal}</span><span class="value">${f.value}</span></div>`).join('')}
      ${relatedPolicies.length ? `<div style="margin-top:8px;font-size:11px;color:var(--text-muted);">Mapped CA policies: ${relatedPolicies.map(p => p.name).join(', ')}</div>` : '<div style="margin-top:8px;font-size:11px;color:var(--text-muted);">No directly mapped CA policies in sample data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Vulnerabilities</div>
      ${relatedVulns.length ? relatedVulns.map(v => `
        <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);">
          <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${v.id}</span>
          Â· ${v.title}
          <span style="float:right;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;">CVSS ${v.cvss.toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</span>
          <div style="margin-top:6px;color:var(--text-muted);font-size:10px;">
            ${(KB_PATCH_MAP[v.id] && KB_PATCH_MAP[v.id].length)
              ? `KB/Update: ${KB_PATCH_MAP[v.id].map(k => `${k.kb} (${k.target})`).join(' Â· ')}`
              : 'KB/Update: Validate in Microsoft Security Update Guide'}
          </div>
        </div>
      `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No mapped CVEs in sample data.</div>'}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Packages</div>
      ${
        tacticKbRows.length
          ? tacticKbRows.map(item => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
                <span><span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${item.cveId}</span> Â· <strong>${item.kb}</strong> Â· ${item.note}</span>
                <span style="font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;">${item.target}</span>
              </div>
            `).join('')
          : `<div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
               No KB mapped in current tactic sample. Validate exact packages in
               <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>.
             </div>`
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      ${
        tacticRemediationActions.length
          ? tacticRemediationActions.map(item => `
              <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);line-height:1.6;">
                <div style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;margin-bottom:4px;">${item.cveId}</div>
                ${item.actions.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No patch actions available for mapped vulnerabilities.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Related Devices</div>
      ${relatedDevices.length ? relatedDevices.map(d => `
        <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
          <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${d.name}</span>
          <span>${d.os} Â· ${d.location} Â· Risk ${d.riskScore} Â· ${d.vulns} vuln(s)</span>
        </div>
      `).join('') : '<div style="font-size:12px;color:var(--text-muted);">No related devices for this tactic in sample mapping.</div>'}
    </div>
  `;

  overlay.classList.add('visible');
}

// ===== DETAIL PANEL / DRILL-DOWN =====

function openDetail(type) {
  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  let html = '';
  const filteredVulns = getFilteredVulnerabilities();
  const criticalVulns = filteredVulns.filter(v => getSeverityBucket(v) === 'critical');
  const highVulns = filteredVulns.filter(v => getSeverityBucket(v) === 'high');
  const exploitedVulns = filteredVulns.filter(v => v.exploited);
  const totalDevices = devices.length;
  const healthyDevices = devices.filter(d => String(d.health).toLowerCase() === 'healthy').length;
  const warningDevices = devices.filter(d => String(d.health).toLowerCase() === 'warning').length;
  const criticalDevices = devices.filter(d => String(d.health).toLowerCase() === 'critical').length;
  const compliancePct = totalDevices ? Math.round((healthyDevices / totalDevices) * 100) : 0;
  const enabledPolicies = caPolicies.filter(p => p.state === 'enabled');
  const reportOnlyPolicies = caPolicies.filter(p => p.state === 'report-only');
  const lowCoveragePolicies = caPolicies.filter(p => Number(p.coverage || 0) < 80);
  const likelyCurrentDefender = devices.filter(d => String(d.defenderVer).includes('24110') || String(d.defenderVer).includes('24112')).length;
  const defenderCoverage = totalDevices ? Math.round((likelyCurrentDefender / totalDevices) * 100) : 0;
  const outdatedDefenderDevices = devices
    .filter(d => !String(d.defenderVer).includes('24110') && !String(d.defenderVer).includes('24112'))
    .sort((a, b) => Number(b.riskScore || 0) - Number(a.riskScore || 0));

  if (type === 'exposure') {
    title.textContent = 'Exposure Score Breakdown';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Score</div>
        <div style="font-size:48px;font-weight:800;color:var(--severity-high);font-family:'JetBrains Mono';margin:8px 0;">72.4</div>
        <div style="font-size:12px;color:var(--text-secondary);">Your exposure score has increased by 3.2 points this week, primarily driven by 5 new critical CVEs affecting Windows endpoints.</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Contributing Factors</div>
        <div class="detail-row"><span class="label">Unpatched Critical CVEs</span><span class="value" style="color:var(--severity-critical);">23 (High Impact)</span></div>
        <div class="detail-row"><span class="label">Outdated Defender Agents</span><span class="value" style="color:var(--severity-high);">78 devices</span></div>
        <div class="detail-row"><span class="label">Non-compliant Devices</span><span class="value" style="color:var(--severity-medium);">162 devices</span></div>
        <div class="detail-row"><span class="label">Legacy OS (Unsupported)</span><span class="value" style="color:var(--severity-high);">23 devices</span></div>
        <div class="detail-row"><span class="label">Missing CA Policy Coverage</span><span class="value" style="color:var(--severity-medium);">3 gaps identified</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Recommendations</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
          1. Prioritise patching CVE-2024-38063 and CVE-2024-43491 â€” both are actively exploited.<br>
          2. Update Defender agents on 78 devices running versions older than 4.18.24090.<br>
          3. Migrate 23 Windows Server 2019 instances to Server 2022.<br>
          4. Enable the BYOD App Protection CA policy (currently report-only).
        </div>
      </div>
    `;
  } else if (type === 'secureScore') {
    const current = getCurrentSecureScore();
    title.textContent = 'Microsoft Secure Score';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Secure Score</div>
        <div style="font-size:48px;font-weight:800;color:${current >= 75 ? 'var(--status-compliant)' : current >= 60 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:8px 0;">${current}%</div>
        <div style="font-size:12px;color:var(--text-secondary);">This card trends your secure score posture and helps track hardening progress over time.</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Recommended API Path</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
          1. <strong>Microsoft Graph Security secureScores</strong><br>
          Endpoint: <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">GET graph.microsoft.com/v1.0/security/secureScores?$top=1</span><br>
          Optional control detail: <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">GET graph.microsoft.com/v1.0/security/secureScoreControlProfiles</span>
        </div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Permissions</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
          <strong>Graph (Application permission):</strong> <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">SecurityEvents.Read.All</span><br>
          <strong>Graph (Delegated alternative):</strong> <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">SecurityEvents.Read.All</span><br>
          Admin consent required for application permissions.
        </div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Configuration Notes</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
          1. Add the Graph permission in Entra App Registration and grant admin consent.<br>
          2. If using browser-only auth, ensure the app has SPA redirect URI configured exactly for this dashboard host.<br>
          3. Add a new Graph fetch task for <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">/security/secureScores</span> and map the latest score into <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);">liveSecureScore</span>.<br>
          4. Keep fallback logic (currently used) so the chart still renders when API data is unavailable.
        </div>
      </div>
    `;
  } else if (type === 'mitreCompliance') {
    const avgCoverage = MITRE_TACTICS.length
      ? Math.round(MITRE_TACTICS.reduce((sum, tactic) => sum + tactic.coverage, 0) / MITRE_TACTICS.length)
      : 0;
    const lowCoverage = MITRE_TACTICS
      .filter(tactic => tactic.coverage < 70)
      .sort((a, b) => a.coverage - b.coverage)
      .slice(0, 5);
    const totalGaps = MITRE_TACTICS.reduce((sum, tactic) => sum + tactic.gaps, 0);
    title.textContent = 'MITRE ATT&CK Compliance Snapshot';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Overall Coverage</div>
        <div style="font-size:48px;font-weight:800;color:${avgCoverage >= 75 ? 'var(--status-compliant)' : avgCoverage >= 65 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:8px 0;">${avgCoverage}%</div>
        <div style="font-size:12px;color:var(--text-secondary);">Average ATT&amp;CK tactic coverage based on current control and detection posture.</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Key Gaps</div>
        <div class="detail-row"><span class="label">Total mapped tactic gaps</span><span class="value" style="font-family:JetBrains Mono;">${totalGaps}</span></div>
        <div class="detail-row"><span class="label">Tactics below 70% coverage</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-high);">${MITRE_TACTICS.filter(tactic => tactic.coverage < 70).length}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Lowest Coverage Tactics</div>
        ${
          lowCoverage.length
            ? lowCoverage.map(tactic => `
                <div class="detail-row">
                  <span class="label">${tactic.name}</span>
                  <span class="value" style="font-family:JetBrains Mono;">${tactic.coverage}% Â· ${tactic.gaps} gaps</span>
                </div>
              `).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No low-coverage tactics identified.</div>'
        }
      </div>
    `;
  } else if (type === 'vulnCritical' || type === 'vulnHigh' || type === 'vulnMedium' || type === 'vulnLow') {
    const bucketMap = {
      vulnCritical: 'critical',
      vulnHigh: 'high',
      vulnMedium: 'medium',
      vulnLow: 'low'
    };
    const labelMap = {
      critical: 'Critical',
      high: 'High',
      medium: 'Medium',
      low: 'Low'
    };
    const colorMap = {
      critical: 'var(--severity-critical)',
      high: 'var(--severity-high)',
      medium: 'var(--severity-medium)',
      low: 'var(--severity-low)'
    };

    const bucket = bucketMap[type];
    const severityLabel = labelMap[bucket];
    const severityColor = colorMap[bucket];
    const matching = filteredVulns
      .filter(v => getSeverityBucket(v) === bucket)
      .sort((a, b) => Number(b.cvss || 0) - Number(a.cvss || 0) || Number(b.affectedDevices || 0) - Number(a.affectedDevices || 0));
    const exploited = matching.filter(v => v.exploited).length;
    const totalAffected = matching.reduce((sum, v) => sum + Number(v.affectedDevices || 0), 0);
    const avgCvss = matching.length
      ? (matching.reduce((sum, v) => sum + Number(v.cvss || 0), 0) / matching.length).toFixed(1)
      : '0.0';

    title.textContent = `${severityLabel} Vulnerability Detail`;
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Snapshot</div>
        <div style="font-size:42px;font-weight:800;color:${severityColor};font-family:'JetBrains Mono';margin:6px 0;">${matching.length}</div>
        <div style="font-size:12px;color:var(--text-secondary);">Count in current filter scope (${activeDataFilter.toUpperCase()} Â· ${activeSeverityFilter.toUpperCase()})</div>
        <div class="detail-row"><span class="label">Actively exploited</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${exploited}</span></div>
        <div class="detail-row"><span class="label">Total affected devices</span><span class="value" style="font-family:JetBrains Mono;">${totalAffected.toLocaleString()}</span></div>
        <div class="detail-row"><span class="label">Average CVSS</span><span class="value" style="font-family:JetBrains Mono;">${avgCvss}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top ${severityLabel} Findings</div>
        ${
          matching.length
            ? matching.slice(0, 8).map(v => `
                <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);cursor:pointer;" onclick="openVulnDetail('${encodeURIComponent(v.id)}')">
                  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                    <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${v.id}</div>
                    <div style="font-size:10px;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;font-weight:700;">CVSS ${Number(v.cvss || 0).toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</div>
                  </div>
                  <div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">${v.title}</div>
                  <div style="font-size:10px;color:var(--text-muted);">${Number(v.affectedDevices || 0).toLocaleString()} affected devices Â· ${v.software || 'Software not specified'}</div>
                </div>
              `).join('')
            : `<div style="font-size:12px;color:var(--text-muted);">No ${severityLabel.toLowerCase()} vulnerabilities match the current filters.</div>`
        }
      </div>
    `;
  } else if (type === 'criticalVulns') {
    title.textContent = 'Critical Vulnerability Detail';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Snapshot</div>
        <div class="detail-row"><span class="label">Critical</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${criticalVulns.length}</span></div>
        <div class="detail-row"><span class="label">High</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-high);">${highVulns.length}</span></div>
        <div class="detail-row"><span class="label">Actively exploited</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${exploitedVulns.length}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top Critical CVEs</div>
        ${
          criticalVulns.length
            ? criticalVulns
                .sort((a, b) => Number(b.cvss || 0) - Number(a.cvss || 0))
                .slice(0, 6)
                .map(v => `<div class="detail-row"><span class="label">${v.id}</span><span class="value" style="font-family:JetBrains Mono;">CVSS ${Number(v.cvss || 0).toFixed(1)} Â· ${Number(v.affectedDevices || 0)} affected</span></div>`)
                .join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No critical vulnerabilities in the current filter view.</div>'
        }
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Priority Actions</div>
        <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
          1. Patch exploited critical CVEs first and validate closure with rescans.<br>
          2. Prioritize critical CVEs affecting internet-facing and privileged devices.<br>
          3. Track exception approvals and SLA breaches for overdue critical items.
        </div>
      </div>
    `;
  } else if (type === 'deviceCompliance') {
    title.textContent = 'Device Compliance Detail';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Compliance Snapshot</div>
        <div style="font-size:48px;font-weight:800;color:${compliancePct >= 90 ? 'var(--status-compliant)' : compliancePct >= 75 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:8px 0;">${compliancePct}%</div>
        <div class="detail-row"><span class="label">Healthy</span><span class="value" style="font-family:JetBrains Mono;color:var(--status-compliant);">${healthyDevices}</span></div>
        <div class="detail-row"><span class="label">Warning</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-medium);">${warningDevices}</span></div>
        <div class="detail-row"><span class="label">Critical</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${criticalDevices}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top Non-compliant Devices</div>
        ${
          devices
            .filter(d => String(d.health).toLowerCase() !== 'healthy')
            .sort((a, b) => Number(b.riskScore || 0) - Number(a.riskScore || 0))
            .slice(0, 6)
            .map(d => `<div class="detail-row"><span class="label">${d.name}</span><span class="value" style="font-family:JetBrains Mono;">${d.health} Â· Risk ${d.riskScore}</span></div>`)
            .join('') || '<div style="font-size:12px;color:var(--text-muted);">No non-compliant devices in current sample.</div>'
        }
      </div>
    `;
  } else if (type === 'totalDevices') {
    title.textContent = 'Managed Device Estate';
    const byType = devices.reduce((acc, d) => {
      const key = d.type || 'Other';
      acc[key] = (acc[key] || 0) + 1;
      return acc;
    }, {});
    const byOs = devices.reduce((acc, d) => {
      const key = d.os || 'Unknown';
      acc[key] = (acc[key] || 0) + 1;
      return acc;
    }, {});
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Estate Summary</div>
        <div class="detail-row"><span class="label">Total managed devices</span><span class="value" style="font-family:JetBrains Mono;">${totalDevices}</span></div>
        ${Object.entries(byType)
          .sort((a, b) => b[1] - a[1])
          .map(([k, v]) => `<div class="detail-row"><span class="label">${k}</span><span class="value" style="font-family:JetBrains Mono;">${v}</span></div>`)
          .join('')}
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top Operating Systems</div>
        ${Object.entries(byOs)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8)
          .map(([k, v]) => `<div class="detail-row"><span class="label">${k}</span><span class="value" style="font-family:JetBrains Mono;">${v}</span></div>`)
          .join('')}
      </div>
    `;
  } else if (type === 'caPolicies') {
    title.textContent = 'Conditional Access Policy Coverage';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Policy State Summary</div>
        <div class="detail-row"><span class="label">Enabled</span><span class="value" style="font-family:JetBrains Mono;color:var(--status-compliant);">${enabledPolicies.length}</span></div>
        <div class="detail-row"><span class="label">Report-only</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-medium);">${reportOnlyPolicies.length}</span></div>
        <div class="detail-row"><span class="label">Low coverage (&lt;80%)</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-high);">${lowCoveragePolicies.length}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Policies Requiring Attention</div>
        ${
          caPolicies
            .map(policy => ({ policy, assessment: assessPolicyGap(policy) }))
            .sort((a, b) => b.assessment.score - a.assessment.score)
            .slice(0, 6)
            .map(item => `<div class="detail-row"><span class="label">${item.policy.name}</span><span class="value" style="font-family:JetBrains Mono;">${item.policy.coverage}% Â· Gap ${item.assessment.score}</span></div>`)
            .join('')
        }
      </div>
    `;
  } else if (type === 'defenderCoverage') {
    title.textContent = 'Defender Coverage Detail';
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Coverage Snapshot</div>
        <div style="font-size:48px;font-weight:800;color:${defenderCoverage >= 90 ? 'var(--status-compliant)' : defenderCoverage >= 75 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:8px 0;">${defenderCoverage}%</div>
        <div class="detail-row"><span class="label">Current build coverage</span><span class="value" style="font-family:JetBrains Mono;">${likelyCurrentDefender}/${totalDevices}</span></div>
        <div class="detail-row"><span class="label">Outdated endpoints</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-high);">${outdatedDefenderDevices.length}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Highest-Risk Outdated Endpoints</div>
        ${
          outdatedDefenderDevices.length
            ? outdatedDefenderDevices
                .slice(0, 6)
                .map(d => `<div class="detail-row"><span class="label">${d.name}</span><span class="value" style="font-family:JetBrains Mono;">${d.defenderVer} Â· Risk ${d.riskScore}</span></div>`)
                .join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No outdated endpoints detected.</div>'
        }
      </div>
    `;
  } else if (type === 'defenderVersionHealth') {
    const metricConfig = defenderVersionMetricMode === 'engine'
      ? { key: 'defenderEngineVer', flavor: 'engine', title: 'Defender Engine Health' }
      : defenderVersionMetricMode === 'intel'
        ? { key: 'defenderSecurityIntelVer', flavor: 'security-intel', title: 'Defender Security Intelligence Health' }
        : { key: 'defenderPlatformVer', flavor: 'platform', title: 'Defender Platform Health' };
    const versionCounts = {};
    devices.forEach(d => {
      const key = String(d[metricConfig.key] || 'Unknown');
      versionCounts[key] = (versionCounts[key] || 0) + 1;
    });
    const rows = Object.entries(versionCounts)
      .map(([version, count]) => ({ version, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 8);
    const outdated = devices
      .filter(d => classifyVersionBadge(d[metricConfig.key], metricConfig.flavor) !== 'current')
      .sort((a, b) => Number(b.riskScore || 0) - Number(a.riskScore || 0))
      .slice(0, 8);
    const metricCurrentCount = devices.filter(d => classifyVersionBadge(d[metricConfig.key], metricConfig.flavor) === 'current').length;
    const metricCoverage = totalDevices ? ((metricCurrentCount / totalDevices) * 100) : 0;
    title.textContent = metricConfig.title;
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Current Build Coverage</div>
        <div style="font-size:42px;font-weight:800;color:${metricCoverage >= 90 ? 'var(--status-compliant)' : metricCoverage >= 75 ? 'var(--severity-medium)' : 'var(--severity-high)'};font-family:'JetBrains Mono';margin:6px 0;">${metricCoverage.toFixed(1)}%</div>
        <div class="detail-row"><span class="label">Current build devices</span><span class="value" style="font-family:JetBrains Mono;">${metricCurrentCount}/${totalDevices}</span></div>
        <div class="detail-row"><span class="label">Outdated devices</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-high);">${Math.max(0, totalDevices - metricCurrentCount)}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Version Distribution</div>
        ${
          rows.length
            ? rows.map(item => `<div class="detail-row"><span class="label">${item.version}</span><span class="value" style="font-family:JetBrains Mono;">${item.count}</span></div>`).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No version data available.</div>'
        }
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Highest-Risk Outdated Devices</div>
        ${
          outdated.length
            ? outdated.map(d => `<div class="detail-row"><span class="label">${d.name}</span><span class="value" style="font-family:JetBrains Mono;">${d[metricConfig.key] || 'n/a'} Â· Risk ${d.riskScore}</span></div>`).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">All devices are on current builds for this metric.</div>'
        }
      </div>
    `;
  } else if (type.startsWith('os-')) {
    const osLabel = type.slice(3);
    const norm = value => String(value || '').toLowerCase().replace(/\s+/g, ' ').trim();
    const osNorm = norm(osLabel);
    const matchingDevices = devices.filter(device => norm(device.os) === osNorm || norm(device.os).includes(osNorm) || osNorm.includes(norm(device.os)));
    const osDeviceCount = matchingDevices.length;
    const health = { healthy: 0, warning: 0, critical: 0 };
    matchingDevices.forEach(device => {
      const key = String(device.health || '').toLowerCase();
      if (health[key] !== undefined) health[key] += 1;
    });
    const avgRisk = osDeviceCount
      ? (matchingDevices.reduce((sum, device) => sum + Number(device.riskScore || 0), 0) / osDeviceCount).toFixed(1)
      : '0.0';
    const totalVulns = matchingDevices.reduce((sum, device) => sum + Number(device.vulns || 0), 0);
    const staleTelemetry = matchingDevices.filter(device => {
      const seen = new Date(device.lastSeen).getTime();
      return Number.isFinite(seen) ? (Date.now() - seen) > (24 * 60 * 60 * 1000) : false;
    }).length;
    const outdatedDefender = matchingDevices.filter(device => {
      const ver = String(device.defenderVer || '');
      return !ver.includes('24110') && !ver.includes('24112');
    }).length;

    const mappedVulnMap = new Map();
    matchingDevices.forEach(device => {
      mapVulnerabilitiesForDevice(device).forEach(vuln => {
        if (!mappedVulnMap.has(vuln.id)) mappedVulnMap.set(vuln.id, vuln);
      });
    });
    const relatedVulns = Array.from(mappedVulnMap.values())
      .sort((a, b) => {
        if (a.exploited !== b.exploited) return a.exploited ? -1 : 1;
        return Number(b.cvss || 0) - Number(a.cvss || 0);
      })
      .slice(0, 8);

    const topImpactedDevices = matchingDevices
      .filter(device => Number(device.vulns || 0) > 0)
      .sort((a, b) => Number(b.riskScore || 0) - Number(a.riskScore || 0) || Number(b.vulns || 0) - Number(a.vulns || 0))
      .slice(0, 10);

    title.textContent = `${osLabel} â€” OS Risk & Exposure`;
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Coverage</div>
        <div style="font-size:40px;font-weight:800;color:var(--chart-3);font-family:'JetBrains Mono';margin:6px 0;">${osDeviceCount}</div>
        <div style="font-size:12px;color:var(--text-secondary);">${totalDevices ? ((osDeviceCount / totalDevices) * 100).toFixed(1) : '0.0'}% of managed devices Â· ${totalVulns} total open vulnerabilities</div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Security Posture</div>
        <div class="detail-row"><span class="label">Healthy</span><span class="value" style="font-family:JetBrains Mono;color:var(--status-compliant);">${health.healthy}</span></div>
        <div class="detail-row"><span class="label">Warning</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-medium);">${health.warning}</span></div>
        <div class="detail-row"><span class="label">Critical</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${health.critical}</span></div>
        <div class="detail-row"><span class="label">Average Risk Score</span><span class="value" style="font-family:JetBrains Mono;">${avgRisk}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Telemetry & Agent Health</div>
        <div class="detail-row"><span class="label">Outdated Defender versions</span><span class="value" style="font-family:JetBrains Mono;${outdatedDefender ? 'color:var(--severity-high);' : 'color:var(--status-compliant);'}">${outdatedDefender}</span></div>
        <div class="detail-row"><span class="label">Stale telemetry &gt;24h</span><span class="value" style="font-family:JetBrains Mono;${staleTelemetry ? 'color:var(--severity-high);' : 'color:var(--status-compliant);'}">${staleTelemetry}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top Related Vulnerabilities & KB Updates</div>
        ${
          relatedVulns.length
            ? relatedVulns.map(v => `
                <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                    <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${v.id}</div>
                    <div style="font-size:10px;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;font-weight:700;">CVSS ${Number(v.cvss || 0).toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</div>
                  </div>
                  <div style="font-size:11px;color:var(--text-secondary);margin-bottom:6px;">${v.title}</div>
                  <div style="font-size:10px;color:var(--text-muted);line-height:1.5;">
                    ${(KB_PATCH_MAP[v.id] && KB_PATCH_MAP[v.id].length)
                      ? `KB/Update: ${KB_PATCH_MAP[v.id].map(k => `${k.kb} (${k.target})`).join(' Â· ')}`
                      : 'KB/Update: Validate in Microsoft Security Update Guide'}
                  </div>
                </div>
              `).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No mapped vulnerabilities for this OS group in current sample data.</div>'
        }
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Highest-Risk Devices in this OS Group</div>
        ${
          topImpactedDevices.length
            ? topImpactedDevices.map(device => `
                <div style="padding:8px 10px;border:1px solid var(--border-subtle);border-radius:7px;background:var(--bg-elevated);margin-bottom:6px;font-size:11px;color:var(--text-secondary);display:flex;justify-content:space-between;gap:8px;">
                  <span style="font-family:'JetBrains Mono',monospace;color:var(--text-primary);font-weight:700;">${device.name}</span>
                  <span>${device.location} Â· Risk ${device.riskScore} Â· ${device.vulns} vuln(s)</span>
                </div>
              `).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No impacted devices in this OS group based on current sample dataset.</div>'
        }
      </div>
    `;
  } else if (type.startsWith('app:') || type.startsWith('app-')) {
    const appName = type.startsWith('app:')
      ? decodeURIComponent(type.slice(4))
      : type.slice(4);
    const appNorm = String(appName || '').toLowerCase().trim();
    const app = softwareInventory.find(item => String(item.name || '').toLowerCase().trim() === appNorm)
      || softwareInventory.find(item => String(item.name || '').toLowerCase().includes(appNorm))
      || softwareInventory.find(item => appNorm.includes(String(item.name || '').toLowerCase()));
    const relatedVulns = getFilteredVulnerabilities()
      .filter(v => {
        const txt = `${v.title || ''} ${v.software || ''}`.toLowerCase();
        return appNorm && txt.includes(appNorm);
      })
      .sort((a, b) => Number(b.cvss || 0) - Number(a.cvss || 0))
      .slice(0, 10);
    const exploitedCount = relatedVulns.filter(v => v.exploited).length;
    const avgCvss = relatedVulns.length
      ? (relatedVulns.reduce((sum, v) => sum + Number(v.cvss || 0), 0) / relatedVulns.length).toFixed(1)
      : '0.0';

    title.textContent = `${appName} â€” Software Risk Detail`;
    html = `
      <div class="detail-section">
        <div class="detail-section-title">Inventory Snapshot</div>
        <div class="detail-row"><span class="label">Software</span><span class="value" style="font-family:JetBrains Mono;">${appName}</span></div>
        <div class="detail-row"><span class="label">Vendor</span><span class="value">${app?.vendor || 'Unknown'}</span></div>
        <div class="detail-row"><span class="label">Installed devices</span><span class="value" style="font-family:JetBrains Mono;">${Number(app?.devices || 0).toLocaleString()}</span></div>
        <div class="detail-row"><span class="label">Known vulnerabilities</span><span class="value" style="font-family:JetBrains Mono;color:${Number(app?.vulns || 0) >= 10 ? 'var(--severity-high)' : 'var(--text-primary)'};">${Number(app?.vulns || 0).toLocaleString()}</span></div>
        <div class="detail-row"><span class="label">Version</span><span class="value" style="font-family:JetBrains Mono;">${app?.version || 'n/a'}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Related CVEs (Current Filter Scope)</div>
        <div class="detail-row"><span class="label">Matched findings</span><span class="value" style="font-family:JetBrains Mono;">${relatedVulns.length}</span></div>
        <div class="detail-row"><span class="label">Actively exploited</span><span class="value" style="font-family:JetBrains Mono;color:var(--severity-critical);">${exploitedCount}</span></div>
        <div class="detail-row"><span class="label">Average CVSS</span><span class="value" style="font-family:JetBrains Mono;">${avgCvss}</span></div>
      </div>
      <div class="detail-section">
        <div class="detail-section-title">Top Related Vulnerabilities</div>
        ${
          relatedVulns.length
            ? relatedVulns.map(v => `
                <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);cursor:pointer;" onclick="openVulnDetail('${encodeURIComponent(v.id)}')">
                  <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:5px;">
                    <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${v.id}</div>
                    <div style="font-size:10px;color:${v.exploited ? 'var(--severity-critical)' : 'var(--text-muted)'};font-family:'JetBrains Mono',monospace;font-weight:700;">CVSS ${Number(v.cvss || 0).toFixed(1)}${v.exploited ? ' Â· Exploited' : ''}</div>
                  </div>
                  <div style="font-size:11px;color:var(--text-secondary);">${v.title}</div>
                </div>
              `).join('')
            : '<div style="font-size:12px;color:var(--text-muted);">No CVEs currently mapped for this software in the active filters.</div>'
        }
      </div>
    `;
  } else {
    title.textContent = type;
    html = `<div class="detail-section">
      <div class="detail-section-title">Information</div>
      <div style="font-size:12px;color:var(--text-secondary);">
        Click any item in the dashboard to see detailed drill-down information here.
        In the live version, this panel will show real-time data from Microsoft Defender XDR via the Graph Security API.
      </div>
    </div>`;
  }

  body.innerHTML = html;
  overlay.classList.add('visible');
}

function decodeUriComponentSafe(value) {
  try {
    return decodeURIComponent(String(value || ''));
  } catch (_err) {
    return String(value || '');
  }
}

function openVulnDetail(cveId) {
  const decodedId = decodeUriComponentSafe(cveId);
  const vuln = vulnerabilities.find(v => v.id === decodedId);
  if (!vuln) return;
  const sevClass = getSeverityBucket(vuln);
  const sevLabel = getSeverityLabel(sevClass);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = vuln.id;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Vulnerability Details</div>
      <div style="font-size:14px;font-weight:600;margin-bottom:8px;">${vuln.title}</div>
      ${vuln.exploited ? '<div style="padding:6px 12px;background:linear-gradient(135deg,#ff2d55 0%,#b3002d 100%);border:1px solid #970025;border-radius:6px;color:#ffffff;font-size:12px;font-weight:600;margin-bottom:12px;">âš¡ Actively Exploited in the Wild</div>' : ''}
      <div class="detail-row"><span class="label">CVE ID</span><span class="value" style="font-family:JetBrains Mono;">${vuln.id}</span></div>
      <div class="detail-row"><span class="label">Severity</span><span class="value" style="color:var(--severity-${sevClass});">${sevLabel}</span></div>
      <div class="detail-row"><span class="label">CVSS Score</span><span class="value" style="font-family:JetBrains Mono;">${vuln.cvss.toFixed(1)}</span></div>
      <div class="detail-row"><span class="label">Affected Software</span><span class="value">${vuln.software}</span></div>
      <div class="detail-row"><span class="label">Affected Devices</span><span class="value" style="font-family:JetBrains Mono;">${vuln.affectedDevices}</span></div>
      <div class="detail-row"><span class="label">Published</span><span class="value">${vuln.published}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Affected Device Types</div>
      <div class="bar-chart">
        <div class="bar-row"><div class="bar-label">Workstations</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.6 / 5)}%;background:var(--chart-1);">${Math.round(vuln.affectedDevices * 0.6)}</div></div></div>
        <div class="bar-row"><div class="bar-label">Servers</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.3 / 5)}%;background:var(--chart-2);">${Math.round(vuln.affectedDevices * 0.3)}</div></div></div>
        <div class="bar-row"><div class="bar-label">Other</div><div class="bar-track"><div class="bar-fill" style="width:${Math.min(100, vuln.affectedDevices * 0.1 / 5)}%;background:var(--chart-3);">${Math.round(vuln.affectedDevices * 0.1)}</div></div></div>
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Remediation</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        Apply the latest security update from Microsoft. This vulnerability is addressed in the ${vuln.published.substring(0,7)} Patch Tuesday cumulative update. Prioritise deployment to internet-facing devices and servers.
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function openThreatRelevanceDetail(cveId) {
  const vuln = vulnerabilities.find(v => v.id === cveId);
  if (!vuln) return;

  const { score, relatedDevices, avgRisk } = threatRelevanceScore(vuln);
  const kbPatches = KB_PATCH_MAP[vuln.id] || [];
  const playbook = remediationPlaybook(vuln);
  const topDevices = relatedDevices
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 8);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${vuln.id} â€” Threat Relevance`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Priority Summary</div>
      <div style="font-size:40px;font-weight:800;color:${score >= 80 ? 'var(--severity-critical)' : score >= 65 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono';margin:6px 0;">${score}</div>
      <div style="font-size:12px;color:var(--text-secondary);">${vuln.title}</div>
      <div class="detail-row"><span class="label">CVSS</span><span class="value">${vuln.cvss.toFixed(1)}</span></div>
      <div class="detail-row"><span class="label">Exploit Status</span><span class="value" style="color:${vuln.exploited ? 'var(--severity-critical)' : 'var(--text-primary)'};">${vuln.exploited ? 'Actively exploited' : 'Not currently flagged as exploited'}</span></div>
      <div class="detail-row"><span class="label">Affected Devices (global estimate)</span><span class="value">${vuln.affectedDevices}</span></div>
      <div class="detail-row"><span class="label">Avg Risk of Related Devices</span><span class="value">${avgRisk.toFixed(1)}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Impacted Devices in Environment (Sample Mapping)</div>
      ${
        topDevices.length
          ? topDevices.map(device => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${device.os} Â· ${device.location} Â· ${device.vulns} vuln(s)</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No matching devices found in current sample data mapping.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Package</div>
      ${
        kbPatches.length
          ? kbPatches.map(item => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${item.kb}</div>
                  <div style="font-size:10px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${item.target}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${item.note}</div>
              </div>
            `).join('')
          : `
              <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
                No KB mapped in local model. Validate exact package in Microsoft Security Update Guide:
                <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>
              </div>
            `
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        ${playbook.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function openRemediationDetail(cveId) {
  const vuln = vulnerabilities.find(v => v.id === cveId);
  if (!vuln) return;

  const details = remediationPriority(vuln);
  const playbook = remediationPlaybook(vuln);
  const kbPatches = KB_PATCH_MAP[vuln.id] || [];
  const impacted = details.relatedDevices
    .sort((a, b) => b.riskScore - a.riskScore || b.vulns - a.vulns)
    .slice(0, 10);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = `${vuln.id} â€” Remediation Plan`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Priority Decision</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <span class="prio-tag ${details.priority.toLowerCase()}">${details.priority} Â· ${priorityLabel(details.priority)}</span>
        <span style="font-size:12px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">Score ${details.score}</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.6;">
        ${details.action}
      </div>
      <div class="detail-row"><span class="label">Estimated Risk Reduction</span><span class="value" style="font-family:JetBrains Mono;">${details.reductionEstimate} pts</span></div>
      <div class="detail-row"><span class="label">Exploit Status</span><span class="value" style="color:${vuln.exploited ? 'var(--severity-critical)' : 'var(--text-primary)'};">${vuln.exploited ? 'Actively exploited' : 'Not currently flagged as exploited'}</span></div>
      <div class="detail-row"><span class="label">Affected Devices</span><span class="value">${vuln.affectedDevices}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Sequence</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        1. Validate patch/package availability and rollback plan.<br>
        2. Patch highest risk devices first (critical or internet-facing cohorts).<br>
        3. Apply compensating controls until patch completion (CA policy, isolation, block indicators).<br>
        4. Recalculate exposure and confirm reduction target.
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Required KB / Update Package</div>
      ${
        kbPatches.length
          ? kbPatches.map(item => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${item.kb}</div>
                  <div style="font-size:10px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${item.target}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${item.note}</div>
              </div>
            `).join('')
          : `
              <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
                No KB mapped in local model. Validate exact package in Microsoft Security Update Guide:
                <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">msrc.microsoft.com/update-guide</a>
              </div>
            `
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Patch / Configuration Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        ${playbook.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Top Impacted Devices (Sample Mapping)</div>
      ${
        impacted.length
          ? impacted.map(device => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${device.name}</div>
                  <div style="font-size:10px;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--severity-medium)'};font-family:'JetBrains Mono',monospace;font-weight:700;">Risk ${device.riskScore}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);">${device.os} Â· ${device.location} Â· ${device.vulns} vuln(s)</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No matching impacted devices in current sample data mapping.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function openDeviceDetail(deviceName) {
  const decodedName = decodeUriComponentSafe(deviceName);
  const device = devices.find(d => d.name === decodedName);
  if (!device) return;

  const platformClass = classifyVersionBadge(device.defenderPlatformVer, 'platform');
  const engineClass = classifyVersionBadge(device.defenderEngineVer, 'engine');
  const intelClass = classifyVersionBadge(device.defenderSecurityIntelVer, 'security-intel');
  const staleMs = Date.now() - new Date(device.lastSeen).getTime();
  const staleHours = Number.isFinite(staleMs) ? Math.max(0, Math.round(staleMs / (1000 * 60 * 60))) : 0;
  const complianceState = isDeviceNonCompliant(device) ? 'Non-compliant' : 'Compliant';
  const complianceColor = complianceState === 'Compliant' ? 'var(--status-compliant)' : 'var(--severity-high)';
  const mappedVulns = mapVulnerabilitiesForDevice(device)
    .sort((a, b) => {
      if (a.exploited !== b.exploited) return a.exploited ? -1 : 1;
      return Number(b.cvss || 0) - Number(a.cvss || 0);
    })
    .slice(0, 8);
  const missingOsPatchList = getMissingOsPatchesForDevice(device, mappedVulns);

  const nonCompliantReasons = [];
  if (String(device.health || '').toLowerCase() !== 'healthy') nonCompliantReasons.push(`Health status is ${device.health}`);
  if (Number(device.riskScore || 0) >= 55) nonCompliantReasons.push(`Risk score is ${device.riskScore}/100`);
  if (platformClass !== 'current') nonCompliantReasons.push('Defender platform version is not current');
  if (engineClass !== 'current') nonCompliantReasons.push('Defender engine version is not current');
  if (intelClass !== 'current') nonCompliantReasons.push('Defender security intelligence is not current');

  const appliedPolicies = caPolicies
    .slice(0, Number(device.caPolicies || 0))
    .map(policy => {
      const stateClass = policy.state === 'enabled' ? 'enabled' : policy.state === 'report-only' ? 'report-only' : 'disabled';
      return `<div class="detail-row"><span class="label">${policy.name}</span><span class="value"><span class="ca-status-badge ${stateClass}">${policy.state === 'report-only' ? 'Report Only' : policy.state.charAt(0).toUpperCase() + policy.state.slice(1)}</span> Â· ${policy.coverage}% coverage</span></div>`;
    })
    .join('');

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = device.name;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Inventory Record</div>
      <div class="detail-row"><span class="label">Device Name</span><span class="value" style="font-family:JetBrains Mono;">${device.name}</span></div>
      <div class="detail-row"><span class="label">Type</span><span class="value">${device.type}</span></div>
      <div class="detail-row"><span class="label">Operating System</span><span class="value">${device.os}</span></div>
      <div class="detail-row"><span class="label">Location</span><span class="value">${device.location}</span></div>
      <div class="detail-row"><span class="label">Last Seen</span><span class="value">${new Date(device.lastSeen).toLocaleString()}</span></div>
      <div class="detail-row"><span class="label">Telemetry Freshness</span><span class="value" style="font-family:JetBrains Mono;color:${staleHours <= 12 ? 'var(--status-compliant)' : staleHours <= 24 ? 'var(--severity-medium)' : 'var(--severity-high)'};">${staleHours}h since last check-in</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Compliance & Risk</div>
      <div class="detail-row"><span class="label">Compliance State</span><span class="value" style="font-family:JetBrains Mono;color:${complianceColor};">${complianceState}</span></div>
      <div class="detail-row"><span class="label">Health Status</span><span class="value"><span class="health-indicator"><span class="health-dot ${device.health.toLowerCase()}"></span>${device.health}</span></span></div>
      <div class="detail-row"><span class="label">Risk Score</span><span class="value" style="font-family:JetBrains Mono;color:${device.riskScore > 70 ? 'var(--severity-critical)' : device.riskScore > 40 ? 'var(--severity-high)' : 'var(--status-compliant)'};">${device.riskScore}/100</span></div>
      <div class="detail-row"><span class="label">Open Vulnerabilities</span><span class="value" style="font-family:JetBrains Mono;${device.vulns > 10 ? 'color:var(--severity-critical);' : ''}">${device.vulns}</span></div>
      <div class="detail-row"><span class="label">Missing OS Patches</span><span class="value" style="font-family:JetBrains Mono;color:${missingOsPatchList.length ? 'var(--severity-high)' : 'var(--status-compliant)'};">${missingOsPatchList.length}</span></div>
      <div class="detail-row"><span class="label">CA Policies Applied</span><span class="value" style="font-family:JetBrains Mono;">${device.caPolicies}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Defender Endpoint Version Health</div>
      <div class="detail-row"><span class="label">Platform Version</span><span class="value"><span class="version-badge ${platformClass}">${device.defenderPlatformVer || 'n/a'}</span></span></div>
      <div class="detail-row"><span class="label">Engine Version</span><span class="value"><span class="version-badge ${engineClass}">${device.defenderEngineVer || 'n/a'}</span></span></div>
      <div class="detail-row"><span class="label">Security Intelligence</span><span class="value"><span class="version-badge ${intelClass}">${device.defenderSecurityIntelVer || 'n/a'}</span></span></div>
      <div class="detail-row"><span class="label">App Version (Reported)</span><span class="value" style="font-family:JetBrains Mono;">${device.defenderVer || 'n/a'}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Missing OS Patches</div>
      ${
        missingOsPatchList.length
          ? missingOsPatchList.map(item => `
              <div style="padding:10px 12px;border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:8px;background:var(--bg-elevated);">
                <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;">
                  <div style="font-size:12px;font-weight:700;color:var(--text-primary);font-family:'JetBrains Mono',monospace;">${item.kb}</div>
                  <div style="font-size:10px;color:var(--text-secondary);font-family:'JetBrains Mono',monospace;">${item.target}</div>
                </div>
                <div style="font-size:11px;color:var(--text-muted);line-height:1.6;">${item.note} Â· Source: ${item.cveId}</div>
              </div>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);line-height:1.7;">No OS-specific patch gap is currently mapped for this device. Validate latest cumulative updates in <a href="https://msrc.microsoft.com/update-guide/" target="_blank" rel="noopener noreferrer">Microsoft Security Update Guide</a>.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Applied Conditional Access Policies</div>
      ${
        appliedPolicies
          ? appliedPolicies
          : '<div style="font-size:12px;color:var(--text-muted);">No policy assignments were mapped for this device in current data.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Mapped Vulnerabilities</div>
      ${
        mappedVulns.length
          ? mappedVulns.map(v => `<div class="detail-row"><span class="label">${v.id}${v.exploited ? ' âš¡' : ''}</span><span class="value" style="font-family:JetBrains Mono;">CVSS ${Number(v.cvss || 0).toFixed(1)} Â· ${v.title}</span></div>`).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No direct vulnerability mapping found for this endpoint.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Priority Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        ${
          nonCompliantReasons.length
            ? nonCompliantReasons.map((reason, idx) => `${idx + 1}. ${reason}`).join('<br>')
            : '1. Keep current defender baselines and continue monitoring telemetry consistency.<br>2. Revalidate version and policy posture after each platform/engine/signature update cycle.'
        }
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function openCADetail(policyName) {
  const policy = caPolicies.find(p => p.name === policyName);
  if (!policy) return;
  const assessment = assessPolicyGap(policy);

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = policy.name;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Policy Configuration</div>
      <div class="detail-row"><span class="label">State</span><span class="value"><span class="ca-status-badge ${policy.state === 'enabled' ? 'enabled' : 'report-only'}">${policy.state === 'report-only' ? 'Report Only' : 'Enabled'}</span></span></div>
      <div class="detail-row"><span class="label">Coverage</span><span class="value" style="font-family:JetBrains Mono;">${policy.coverage}%</span></div>
      <div class="detail-row"><span class="label">Affected Users</span><span class="value" style="font-family:JetBrains Mono;">${policy.users.toLocaleString()}</span></div>
      <div class="detail-row"><span class="label">Gap Score</span><span class="value"><span class="policy-pill ${assessment.severity}">${assessment.score}</span></span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Conditions</div>
      <div class="detail-row"><span class="label">Cloud Apps</span><span class="value">${policy.apps}</span></div>
      <div class="detail-row"><span class="label">Platforms / Conditions</span><span class="value">${policy.conditions}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Controls</div>
      <div class="detail-row"><span class="label">Grant Controls</span><span class="value">${policy.grantControls}</span></div>
      <div class="detail-row"><span class="label">Session Controls</span><span class="value">${policy.sessionControls}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Identified Gaps</div>
      ${
        assessment.gaps.length
          ? assessment.gaps.map(gap => `<div style="font-size:12px;color:var(--text-secondary);line-height:1.6;margin-bottom:6px;">â€¢ ${gap}</div>`).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No significant gaps detected in current model.</div>'
      }
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Actions</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        ${assessment.recommendations.map((action, idx) => `${idx + 1}. ${action}`).join('<br>')}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">MITRE ATT&amp;CK References</div>
      <div class="detail-row"><span class="label">Tactics</span><span class="value">${assessment.mitre.tactics.join(', ') || 'Not mapped'}</span></div>
      <div class="detail-row"><span class="label">Techniques</span><span class="value">${assessment.mitre.techniques.join(', ') || 'Not mapped'}</span></div>
      <div class="detail-row"><span class="label">Threat Patterns</span><span class="value">${assessment.mitre.threats.join(', ') || 'Not mapped'}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">API Reference</div>
      <div style="font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono';background:var(--bg-elevated);padding:10px;border-radius:6px;word-break:break-all;">
        GET https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies/{id}
      </div>
    </div>
  `;
  overlay.classList.add('visible');
}

function openPolicyGapBucketDetail(bucket) {
  const assessed = getFilteredPolicies()
    .map(policy => ({ policy, ...assessPolicyGap(policy) }))
    .sort((a, b) => b.score - a.score);

  let titleText = '';
  let subtitle = '';
  let rows = [];

  if (bucket === 'critical') {
    titleText = 'Policy Gaps â€” Critical';
    rows = assessed.filter(item => item.severity === 'critical');
    subtitle = `${rows.length} policy gap${rows.length === 1 ? '' : 's'} requiring immediate hardening.`;
  } else if (bucket === 'high') {
    titleText = 'Policy Gaps â€” High';
    rows = assessed.filter(item => item.severity === 'high');
    subtitle = `${rows.length} high-priority policy gap${rows.length === 1 ? '' : 's'} to address in the current sprint.`;
  } else {
    titleText = 'Policy Coverage Details';
    rows = assessed
      .filter(item => item.policy.coverage < 95 || item.policy.state === 'report-only')
      .sort((a, b) => a.policy.coverage - b.policy.coverage || b.score - a.score);
    const avgCoverage = assessed.length ? Math.round(assessed.reduce((sum, item) => sum + item.policy.coverage, 0) / assessed.length) : 0;
    const reportOnlyCount = assessed.filter(item => item.policy.state === 'report-only').length;
    subtitle = `Average coverage is ${avgCoverage}% with ${reportOnlyCount} policy${reportOnlyCount === 1 ? '' : 'ies'} still report-only.`;
  }

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');

  title.textContent = titleText;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Summary</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${subtitle}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Policies</div>
      ${
        rows.length
          ? rows.map(item => `
              <article class="policy-gap-item" role="button" tabindex="0" onclick="openCADetail('${item.policy.name.replace(/'/g, "\\'")}')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();openCADetail('${item.policy.name.replace(/'/g, "\\'")}')}">
                <div class="policy-gap-head">
                  <div class="policy-gap-title">${item.policy.name}</div>
                  <span class="policy-pill ${item.severity}">Gap ${item.score}</span>
                </div>
                <div class="policy-gap-meta">
                  State: ${item.policy.state === 'report-only' ? 'Report-only' : 'Enabled'} Â· Coverage: ${item.policy.coverage}%<br>
                  ${item.gaps[0] || 'No material gaps identified.'}<br>
                  Recommended: ${item.recommendations[0]}
                </div>
              </article>
            `).join('')
          : '<div style="font-size:12px;color:var(--text-muted);">No matching policy gaps for this bucket.</div>'
      }
    </div>
  `;

  overlay.classList.add('visible');
}

function openPolicyOverlapDetail(pairId) {
  if (!pairId) return;
  const overlap = buildPolicyOverlapInsights(getFilteredPolicies());
  const target = overlap.pairs.find(item => item.id === pairId);
  if (!target) return;

  const overlay = document.getElementById('detailOverlay');
  const title = document.getElementById('detailTitle');
  const body = document.getElementById('detailBody');
  const label = overlapClassLabel(target.classification);
  const pillColor = target.classification === 'exact'
    ? 'var(--severity-critical)'
    : target.classification === 'conflict'
      ? 'var(--severity-high)'
      : 'var(--severity-medium)';

  title.textContent = `Policy Overlap â€” ${target.a.name} vs ${target.b.name}`;
  body.innerHTML = `
    <div class="detail-section">
      <div class="detail-section-title">Overlap Classification</div>
      <div style="font-size:32px;font-weight:800;color:${pillColor};font-family:'JetBrains Mono';margin:6px 0;">${target.overlapScore}%</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">${label}: ${target.reasons[0] || 'Control overlap detected.'}</div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Similarity Breakdown</div>
      <div class="detail-row"><span class="label">Cloud App Scope</span><span class="value">${target.metrics.appsSim}%</span></div>
      <div class="detail-row"><span class="label">Conditions</span><span class="value">${target.metrics.conditionSim}%</span></div>
      <div class="detail-row"><span class="label">Grant Controls</span><span class="value">${target.metrics.grantSim}%</span></div>
      <div class="detail-row"><span class="label">Session Controls</span><span class="value">${target.metrics.sessionSim}%</span></div>
      <div class="detail-row"><span class="label">Coverage Similarity</span><span class="value">${target.metrics.coverageSim}%</span></div>
      <div class="detail-row"><span class="label">Policy A State</span><span class="value">${target.a.state}</span></div>
      <div class="detail-row"><span class="label">Policy B State</span><span class="value">${target.b.state}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Policies Compared</div>
      <div class="detail-row"><span class="label">${target.a.name}</span><span class="value">${target.a.apps} Â· ${target.a.conditions}</span></div>
      <div class="detail-row"><span class="label">${target.b.name}</span><span class="value">${target.b.apps} Â· ${target.b.conditions}</span></div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Recommended Remediation</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.75;">
        ${target.actions.map((step, idx) => `${idx + 1}. ${step}`).join('<br>')}
      </div>
    </div>
    <div class="detail-section">
      <div class="detail-section-title">Change Control Path</div>
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.7;">
        Entra admin center &gt; Protection &gt; Conditional Access &gt; Policies. Normalize duplicated controls into a baseline policy, then keep narrowly scoped exception policies only where justified.
      </div>
    </div>
  `;

  overlay.classList.add('visible');
}

function closeDetail(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('detailOverlay').classList.remove('visible');
}

// ===== FILTER CHIPS =====
document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-filter]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    activeDataFilter = chip.dataset.filter || 'all';
    rerenderDashboard();
  });
});

document.querySelectorAll('.filter-chip[data-sev]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-sev]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    activeSeverityFilter = chip.dataset.sev || 'all';
    rerenderDashboard();
  });
});

document.querySelectorAll('.filter-chip[data-policy-filter]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-policy-filter]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    activePolicyFilter = chip.dataset.policyFilter || 'all';
    renderCAPolicies();
    renderPolicyGapInsights();
    renderPolicyMitreCoverage();
  });
});

document.querySelectorAll('.filter-chip[data-comp-strictness]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('.filter-chip[data-comp-strictness]').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    compensationStrictness = chip.dataset.compStrictness || 'standard';
    renderPolicyGapInsights();
    renderPolicyMitreCoverage();
  });
});

const customizeMenuBtn = document.getElementById('customizeMenuBtn');
const customizeDropdown = document.getElementById('customizeDropdown');

if (customizeMenuBtn && customizeDropdown) {
  customizeMenuBtn.addEventListener('click', (event) => {
    event.stopPropagation();
    const open = customizeDropdown.classList.toggle('open');
    customizeMenuBtn.classList.toggle('active', open);
    customizeMenuBtn.setAttribute('aria-expanded', open ? 'true' : 'false');
  });

  customizeDropdown.addEventListener('click', (event) => {
    event.stopPropagation();
  });

  document.addEventListener('click', () => {
    customizeDropdown.classList.remove('open');
    customizeMenuBtn.classList.remove('active');
    customizeMenuBtn.setAttribute('aria-expanded', 'false');
  });
}

document.querySelectorAll('.customize-option input[data-ui-option]').forEach(input => {
  input.addEventListener('change', () => {
    const option = input.dataset.uiOption;
    if (option === 'toprow') {
      uiShowTopRow = input.checked;
    } else {
      if (input.checked) {
        uiHiddenViews.delete(option);
      } else {
        const visibleCount = document.querySelectorAll('.topnav-tab[data-view]').length - (uiHiddenViews.size + 1);
        if (visibleCount < 1) {
          input.checked = true;
          return;
        }
        uiHiddenViews.add(option);
      }
    }
    applyUiPreferences();
    saveUiPreferences();
  });
});

const nightModeBtn = document.getElementById('nightModeBtn');
if (nightModeBtn) {
  nightModeBtn.addEventListener('click', () => {
    uiTheme = uiTheme === 'dark-mode' ? 'light' : 'dark-mode';
    applyUiTheme();
    saveUiPreferences();
  });
}

const mitreViewCoverageBtn = document.getElementById('mitreViewCoverageBtn');
const mitreViewHeatmapBtn = document.getElementById('mitreViewHeatmapBtn');
if (mitreViewCoverageBtn && mitreViewHeatmapBtn) {
  mitreViewCoverageBtn.addEventListener('click', () => {
    standardsMitreView = 'coverage';
    applyStandardsMitreView();
    saveUiPreferences();
  });
  mitreViewHeatmapBtn.addEventListener('click', () => {
    standardsMitreView = 'heatmap';
    applyStandardsMitreView();
    saveUiPreferences();
  });
}

// ===== VIEW SWITCHING =====
function applyView(view) {
  const grid = document.querySelector('.dashboard-grid');
  if (grid) {
    if (view === 'overview') grid.classList.add('overview-layout');
    else grid.classList.remove('overview-layout');
  }

  const nextRiskMode = 'full';
  if (riskMatrixMode !== nextRiskMode) {
    riskMatrixMode = nextRiskMode;
    renderRiskMatrix();
  }

  document.body.setAttribute('data-active-view', view);

  document.querySelectorAll('.dashboard-grid .card').forEach(card => {
    const views = (card.dataset.views || 'overview').split(',').map(v => v.trim());
    if (views.includes(view)) card.classList.remove('view-hidden');
    else card.classList.add('view-hidden');
  });
}

function switchView(view, el) {
  document.querySelectorAll('.topnav-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  applyView(view);
  if (view === 'policies') {
    requestAnimationFrame(() => {
      renderCAPolicies();
      renderPolicyGapInsights();
      renderPolicyMitreCoverage();
    });
  }
}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', (e) => {
  if (e.key !== 'Escape') return;
  const helpOverlay = document.getElementById('helpOverlay');
  if (helpOverlay && helpOverlay.classList.contains('visible')) {
    closeHelpPanel();
    return;
  }
  closeDetail();
});

let policyJourneyResizeTimer = null;
window.addEventListener('resize', () => {
  clearTimeout(policyJourneyResizeTimer);
  policyJourneyResizeTimer = setTimeout(() => {
    const panel = document.getElementById('policyFocusPanel');
    if (!panel || panel.offsetParent === null) return;
    renderPolicyMitreCoverage();
  }, 120);
});

// ===== INIT =====
function rerenderDashboard() {
  renderExecutiveSummary();
  renderVulnSeverityPanel();
  renderVulnList();
  renderDeviceTypeSummary();
  renderDeviceOsSummary();
  renderDeviceTypeChart();
  renderDeviceOsChart();
  renderThreatWorkbench();
  renderMissingPatchesCard();
  renderRiskMatrix();
  renderSecureScoreChart();
  renderDeviceTable();
  renderCAPolicies();
  renderPolicyGapInsights();
  renderPolicyMitreCoverage();
  renderStandardsView();
  renderAppGrid();
  renderDeviceMixCard();
  renderDefenderVersionChart();
  renderDefenderStack();
  renderMitreCoverage();
  setupMitreInteractions();
  applyStandardsMitreView();
  renderTrendChart();
}

function init() {
  loadUiPreferences();
  applyUiPreferences();
  applyUiTheme();
  setupSoftwareViewInteractions();
  setupVulnerabilityViewInteractions();
  setupRemediationViewInteractions();
  setupThreatWorkbenchInteractions();
  setupDeviceInventoryInteractions();
  setupDeviceMixInteractions();
  setupDefenderVersionInteractions();
  rerenderDashboard();
  applyView('overview');
}

init();
</script>
</body>
</html>
